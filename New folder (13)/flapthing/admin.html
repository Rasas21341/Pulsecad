<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FlapThing — Admin</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .admin-wrap{max-width:960px;margin:28px auto;padding:18px}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:8px;border-bottom:1px solid #eee;text-align:left}
    .controls{display:flex;gap:8px;align-items:center;justify-content:flex-end}
    .note{font-size:13px;color:#666;margin-top:8px}
  </style>
</head>
<body>
  <div class="admin-wrap">
    <h1>FlapThing — Admin</h1>
    <p class="note">This page is the admin area. For production, host this page on a secure backend. The credential here is client-side for demo only.</p>

    <div id="loginBox">
      <label>Username</label>
      <input id="adminUser" value="admin">
      <label style="margin-top:8px">Password</label>
      <input id="adminPass" type="password" placeholder="password">
      <div style="margin-top:10px" class="controls">
        <button id="loginBtn" class="link-like">Login</button>
      </div>
    </div>

    <div id="panel" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <strong>Local best:</strong> <span id="localBest">0</span>
        </div>
        <div class="controls">
          <button id="exportCsv" class="link-like">Export CSV</button>
          <button id="resetLocal" class="link-like">Reset Local Best</button>
          <button id="resetRemote" class="link-like">Reset Remote Scores</button>
          <button id="logoutBtn" class="link-like">Logout</button>
        </div>
      </div>

      <h3 style="margin-top:18px">Leaderboard</h3>
      <div id="remoteNote" class="note">Remote (Firebase) leaderboard will appear here when `firebase-config.js` is added.</div>
      <table id="leaderboard">
        <thead><tr><th>#</th><th>Player</th><th>Best</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Firebase SDKs (optional) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script>
    // attempt to load firebase-config if present
    try{ var s = document.createElement('script'); s.src = 'firebase-config.js'; document.head.appendChild(s); }catch(e){}
  </script>
  <script>
  (function(){
    const ADMIN_USER = 'admin';
    const ADMIN_PASS = 'flapmaster2025';

    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const panel = document.getElementById('panel');
    const loginBox = document.getElementById('loginBox');
    const localBestEl = document.getElementById('localBest');
    const tblBody = document.querySelector('#leaderboard tbody');
    const remoteNote = document.getElementById('remoteNote');

    let firebaseApp=null, firebaseDb=null, dbScoresRef=null;

    function loadLocal(){ const b = parseInt(localStorage.getItem('flapthing_best')||'0',10)||0; localBestEl.innerText = b; }

    function showPanel(){ loginBox.style.display='none'; panel.style.display='block'; loadLocal(); loadRemote(); }

    loginBtn.addEventListener('click', ()=>{
      const u = document.getElementById('adminUser').value||'';
      const p = document.getElementById('adminPass').value||'';
      if(u===ADMIN_USER && p===ADMIN_PASS){ showPanel(); } else { alert('Invalid credentials'); }
    });

    logoutBtn && logoutBtn.addEventListener('click', ()=>{ panel.style.display='none'; loginBox.style.display='block'; });

    document.getElementById('resetLocal').addEventListener('click', ()=>{
      if(confirm('Reset local best?')){ localStorage.setItem('flapthing_best','0'); loadLocal(); alert('Local best reset'); }
    });

    document.getElementById('exportCsv').addEventListener('click', ()=>{
      // gather rows from table
      const rows = [['rank','player','best']];
      Array.from(tblBody.querySelectorAll('tr')).forEach(r=>{ const cols = r.querySelectorAll('td'); rows.push([cols[0].innerText, cols[1].innerText, cols[2].innerText]); });
      const csv = rows.map(r=>r.map(c=>'"'+String(c).replace(/"/g,'""')+'"').join(',')).join('\n');
      const blob = new Blob([csv],{type:'text/csv'}); const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'flapthing_leaderboard.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    document.getElementById('resetRemote').addEventListener('click', ()=>{
      if(!dbScoresRef){ alert('No Firebase configured. Add firebase-config.js to enable remote reset.'); return; }
      if(confirm('Delete all remote scores? This cannot be undone.')){
        dbScoresRef.remove().then(()=>{ alert('Remote scores removed'); loadRemote(); }).catch(err=>{ alert('Failed: '+err.message); });
      }
    });

    function loadRemote(){
      if(window.FIREBASE_CONFIG && window.firebase){
        try{
          firebaseApp = firebase.initializeApp(window.FIREBASE_CONFIG);
          firebaseDb = firebase.database(); dbScoresRef = firebaseDb.ref('flapthing/scores');
          remoteNote.innerText = 'Loading remote leaderboard...';
          dbScoresRef.once('value').then(snap=>{
            const data = snap.val() || {};
            const arr = Object.keys(data).map(k=>({id:k,email:data[k].email||k,best: data[k].best||0}));
            arr.sort((a,b)=>b.best - a.best);
            tblBody.innerHTML = '';
            arr.forEach((r,i)=>{ const tr = document.createElement('tr'); tr.innerHTML = `<td>${i+1}</td><td>${r.email}</td><td>${r.best}</td>`; tblBody.appendChild(tr); });
            if(arr.length===0) remoteNote.innerText = 'No remote scores yet.'; else remoteNote.innerText = '';
          }).catch(e=>{ remoteNote.innerText = 'Failed to load remote leaderboard: '+(e.message||e); });
        }catch(e){ remoteNote.innerText = 'Firebase init failed: '+(e.message||e); }
      } else {
        remoteNote.innerText = 'No firebase-config.js found — remote leaderboard disabled.';
      }
    }

  })();
  </script>
</body>
</html>
