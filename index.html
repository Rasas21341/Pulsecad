                                <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0c0e12">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Pulsecad">
    <title>Pulsecad</title>
    <link rel="icon" type="image/webp" href="https://cdn.discordapp.com/icons/1455410644634304725/75220689ed872e2ee4c7101f479813a5.webp?size=512">
    <link rel="apple-touch-icon" href="https://cdn.discordapp.com/icons/1455410644634304725/75220689ed872e2ee4c7101f479813a5.webp?size=512">
    <link rel="manifest" href="data:application/json,%7B%22name%22%3A%22Pulsecad%22%2C%22short_name%22%3A%22Pulsecad%22%2C%22description%22%3A%22Police%20CAD%20System%22%2C%22start_url%22%3A%22.%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%230c0e12%22%2C%22theme_color%22%3A%22%230c0e12%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22https%3A%2F%2Fcdn.discordapp.com%2Ficons%2F1455410644634304725%2F75220689ed872e2ee4c7101f479813a5.webp%3Fsize%3D512%22%2C%22sizes%22%3A%22512x512%22%2C%22type%22%3A%22image%2Fwebp%22%7D%5D%7D">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #0c0e12;
            min-height: 100vh;
            color: #e4e4e7;
        }

        header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 64px;
            background: rgba(12,14,18,.92);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid #1e222d;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 32px;
            z-index: 50;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .brand img {
            width: 36px;
            height: 36px;
            border-radius: 50%;
        }

        .brand span {
            font-size: 18px;
            font-weight: 600;
            letter-spacing: -.3px;
        }

        .nav-btn {
            padding: 9px 20px;
            background: #3b82f6;
            border: none;
            border-radius: 8px;
            color: #fff;
            font-size: 13px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
        }

        .nav-btn:hover { background: #2563eb; }

        .nav-links {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }

        .nav-link {
            background: none;
            border: none;
            color: #a1a1aa;
            font-size: 14px;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            padding: 8px 16px;
            border-radius: 6px;
        }

        .nav-link:hover {
            color: #e4e4e7;
            background: rgba(255,255,255,.06);
        }

        .hero {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 100px 24px 60px;
            position: relative;
            overflow: hidden;
        }

        .hero h1 {
            font-size: 42px;
            font-weight: 700;
            letter-spacing: -.5px;
            margin-bottom: 14px;
        }

        .hero p {
            color: #71717a;
            font-size: 16px;
            max-width: 420px;
        }

        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.75);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 99;
            padding: 20px;
        }

        .overlay.active { display: flex; }

        .modal {
            background: #14171f;
            border: 1px solid #1e222d;
            border-radius: 12px;
            width: 100%;
            max-width: 380px;
            padding: 32px 28px;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            color: #71717a;
            cursor: pointer;
            padding: 4px;
        }

        .modal-close:hover { color: #a1a1aa; }

        .modal-close svg { width: 20px; height: 20px; }

        .modal-logo {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: block;
            margin: 0 auto 16px;
        }

        .modal h2 {
            color: #e4e4e7;
            font-size: 18px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 4px;
        }

        .modal .sub {
            color: #71717a;
            font-size: 13px;
            text-align: center;
            margin-bottom: 22px;
        }

        .field { margin-bottom: 14px; text-align: left; }

        .field label {
            display: block;
            color: #a1a1aa;
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 5px;
        }

        .field input {
            width: 100%;
            padding: 11px 13px;
            background: #0c0e12;
            border: 1px solid #27272a;
            border-radius: 8px;
            color: #fafafa;
            font-size: 13px;
            font-family: inherit;
        }

        .field input:focus { outline: none; border-color: #3b82f6; }
        .field input::placeholder { color: #52525b; }

        .btn-primary {
            width: 100%;
            padding: 11px;
            background: #3b82f6;
            border: none;
            border-radius: 8px;
            color: #fff;
            font-size: 13px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            margin-top: 6px;
        }

        .btn-primary:hover { background: #2563eb; }

        .sep {
            display: flex;
            align-items: center;
            margin: 20px 0;
            color: #52525b;
            font-size: 11px;
        }

        .sep::before, .sep::after { content: ''; flex: 1; height: 1px; background: #27272a; }
        .sep::before { margin-right: 10px; }
        .sep::after { margin-left: 10px; }

        .btn-secondary {
            width: 100%;
            padding: 11px;
            background: transparent;
            border: 1px solid #27272a;
            border-radius: 8px;
            color: #a1a1aa;
            font-size: 13px;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
        }

        .btn-secondary:hover { background: #18181b; border-color: #3f3f46; }

        .panel { display: none; }
        .panel.active { display: block; }

        .alert {
            padding: 10px 12px;
            border-radius: 8px;
            font-size: 12px;
            margin-bottom: 14px;
            display: none;
        }

        .alert-error { background: rgba(239,68,68,.12); border: 1px solid #991b1b; color: #fca5a5; }
        .alert-success { background: rgba(34,197,94,.12); border: 1px solid #166534; color: #86efac; }

        .link {
            color: #3b82f6;
            font-size: 13px;
            cursor: pointer;
            display: inline-block;
            margin-top: 16px;
        }

        .link:hover { text-decoration: underline; }

        .dashboard {
            min-height: 100vh;
            padding: 88px 32px 40px;
            display: none;
        }

        .dashboard.active { display: block; }

        .dash-header {
            max-width: 600px;
            margin: 0 auto 28px;
        }

        .dash-header h1 { font-size: 24px; font-weight: 600; margin-bottom: 4px; }
        .dash-header p { color: #71717a; font-size: 14px; }

        .dash-content { max-width: 600px; margin: 0 auto; }

        .actions { display: flex; flex-direction: row; gap: 12px; margin-bottom: 28px; }

        .btn-action {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 14px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
        }

        .btn-action svg { width: 18px; height: 18px; }

        .btn-join { background: #3b82f6; border: none; color: #fff; }
        .btn-join:hover { background: #2563eb; }

        .btn-create { background: transparent; border: 1px solid #22c55e; color: #4ade80; }
        .btn-create:hover { background: rgba(34,197,94,.1); }

        .section-title {
            color: #71717a;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: .6px;
            margin-bottom: 12px;
        }

        .list { display: flex; flex-direction: column; gap: 8px; }

        .item {
            background: #14171f;
            border: 1px solid #1e222d;
            border-radius: 8px;
            padding: 14px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .item:hover { border-color: #27272a; }
        .item-info { text-align: left; }
        .item-name { color: #e4e4e7; font-size: 14px; font-weight: 500; }
        .item-url { color: #3b82f6; font-size: 12px; text-decoration: none; margin-top: 2px; display: block; }
        .item-url:hover { text-decoration: underline; }

        .btn-enter {
            background: #3b82f6;
            border: none;
            border-radius: 6px;
            color: #fff;
            padding: 7px 14px;
            font-size: 12px;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
        }

        .btn-enter:hover { background: #2563eb; }

        .empty { color: #52525b; font-size: 13px; text-align: center; padding: 20px; }

        .opt { color: #52525b; font-weight: 400; }

        .modal-sm { max-width: 360px; padding: 26px 24px; }
        .modal-sm h2 { font-size: 16px; margin-bottom: 18px; text-align: left; }

        .modal-btns { display: flex; gap: 10px; margin-top: 18px; }
        .modal-btns button { flex: 1; padding: 10px; border-radius: 8px; font-size: 13px; font-weight: 500; font-family: inherit; cursor: pointer; }

        .btn-cancel { background: transparent; border: 1px solid #27272a; color: #a1a1aa; }
        .btn-cancel:hover { background: #18181b; }

        .btn-confirm { background: #22c55e; border: none; color: #fff; font-weight: 600; }
        .btn-confirm:hover { background: #16a34a; }

        .logged-in .hero { display: none !important; }
        .logged-in .pricing-section { display: none !important; }
        .logged-in .team-section { display: none !important; }
        
        .logged-in .dashboard:not(.hidden) { display: block; }
        .logged-in .dashboard.hidden { display: none !important; }
        .logged-in .nav-btn { display: none; }
        .logged-in .nav-links { display: none; }

        .nav-user {
            display: none;
            align-items: center;
            gap: 14px;
        }

        .nav-user span { color: #a1a1aa; font-size: 13px; }

        .nav-logout {
            padding: 8px 16px;
            background: transparent;
            border: 1px solid #27272a;
            border-radius: 8px;
            color: #a1a1aa;
            font-size: 12px;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
        }

        .nav-logout:hover { background: #18181b; border-color: #3f3f46; }

        .logged-in .nav-user { display: flex; }

        .in-community header { display: none; }
        .in-community .community-screen { padding-top: 40px; }
        .in-community #staffDashboardBtn { display: none !important; }

        .pricing-section {
            display: none;
            min-height: 100vh;
            padding: 100px 32px 60px;
        }

        .pricing-section.active { display: block; }
        .pricing-section.active ~ .hero { display: none; }

        .pricing-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .pricing-header h1 { font-size: 32px; margin-bottom: 8px; }
        .pricing-header p { color: #71717a; font-size: 15px; }

        .pricing-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            max-width: 960px;
            margin: 0 auto;
        }

        .price-card {
            background: linear-gradient(145deg, #151921 0%, #111318 100%);
            border: 1px solid #1e2530;
            border-radius: 12px;
            padding: 28px 26px;
        }

        .price-card h3 {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #f0f0f2;
        }

        .price-card .desc {
            color: #6b7280;
            font-size: 13px;
            line-height: 1.5;
            min-height: 54px;
            margin-bottom: 20px;
        }

        .price-amount {
            margin-bottom: 22px;
        }

        .price-amount span {
            font-size: 38px;
            font-weight: 700;
            color: #fff;
        }

        .price-amount small {
            color: #6b7280;
            font-size: 14px;
            margin-left: 4px;
        }

        .price-btn {
            width: 100%;
            padding: 12px;
            background: #2563eb;
            border: none;
            border-radius: 8px;
            color: #fff;
            font-size: 13px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            margin-bottom: 24px;
        }

        .price-btn:hover { background: #1d4ed8; }

        .features-title {
            color: #e4e4e7;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 14px;
        }

        .features-list {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .features-list li {
            color: #9ca3af;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .features-list li svg {
            width: 16px;
            height: 16px;
            color: #22c55e;
            flex-shrink: 0;
        }

        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: none;
            border: none;
            color: #71717a;
            font-size: 13px;
            font-family: inherit;
            cursor: pointer;
            margin-bottom: 24px;
        }

        .back-btn:hover { color: #a1a1aa; }
        .back-btn svg { width: 16px; height: 16px; }

        .community-screen {
            display: none;
            min-height: 100vh;
            padding: 88px 32px 40px;
        }

        .community-screen.active { display: block; }

        .btn-back-dashboard {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: #374151;
            border: none;
            border-radius: 8px;
            color: #fff;
            font-size: 13px;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            margin-bottom: 16px;
        }

        .btn-back-dashboard:hover { background: #4b5563; }

        /* User Hub Styles */
        .user-hub {
            min-height: 100vh;
            padding: 100px 20px 40px;
            background: #0c0e12;
        }

        .hub-container {
            max-width: 700px;
            margin: 0 auto;
        }

        .hub-greeting {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 24px;
        }

        .hub-avatar {
            width: 56px;
            height: 56px;
            border-radius: 50%;
        }

        .hub-welcome {
            display: flex;
            flex-direction: column;
        }

        .hub-hey {
            color: #3b82f6;
            font-size: 22px;
            font-weight: 600;
        }

        .hub-username {
            color: #e4e4e7;
            font-size: 22px;
            font-weight: 600;
        }

        .hub-credits {
            color: #3b82f6;
            font-size: 14px;
        }

        .hub-card {
            background: #111827;
            border: 1px solid #1e293b;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .hub-actions {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .hub-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 18px;
            background: transparent;
            border: 1px solid #374151;
            border-radius: 8px;
            color: #e4e4e7;
            font-size: 13px;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            text-decoration: none;
            transition: background 0.2s, border-color 0.2s;
        }

        .hub-btn:hover {
            background: rgba(255,255,255,0.05);
            border-color: #4b5563;
        }

        .hub-credits-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;
            padding: 8px 16px;
            background: #1e293b;
            border-radius: 20px;
            color: #22c55e;
            font-size: 13px;
            font-weight: 500;
        }

        .credit-dot {
            width: 8px;
            height: 8px;
            background: #22c55e;
            border-radius: 50%;
        }

        .hub-progress-bar {
            height: 4px;
            background: #374151;
            border-radius: 2px;
            margin-bottom: 16px;
            display: flex;
        }

        .hub-progress-fill {
            height: 100%;
            background: #3b82f6;
            border-radius: 2px;
            transition: width 0.3s;
        }

        .hub-redeem-label {
            color: #9ca3af;
            font-size: 13px;
            margin-bottom: 12px;
        }

        .hub-redeem-input {
            display: flex;
            gap: 10px;
            margin-bottom: 8px;
        }

        .hub-redeem-input input {
            flex: 1;
            padding: 12px 16px;
            background: #0c0e12;
            border: 1px solid #27272a;
            border-radius: 8px;
            color: #fafafa;
            font-size: 14px;
            font-family: inherit;
        }

        .hub-redeem-input input::placeholder {
            color: #52525b;
        }

        .hub-redeem-input input:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .hub-redeem-btn {
            padding: 12px 24px;
            background: #fafafa;
            border: none;
            border-radius: 8px;
            color: #0c0e12;
            font-size: 14px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: background 0.2s;
        }

        .hub-redeem-btn:hover {
            background: #e4e4e7;
        }

        .hub-redeem-hint {
            color: #3b82f6;
            font-size: 12px;
            margin: 0;
        }

        .hub-error {
            color: #ef4444;
            font-size: 13px;
            margin-top: 8px;
            display: none;
        }

        .hub-success {
            color: #22c55e;
            font-size: 13px;
            margin-top: 8px;
            display: none;
        }

        .hub-section-title {
            font-size: 16px;
            font-weight: 600;
            color: #e4e4e7;
            margin-bottom: 16px;
        }

        .hub-quick-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        /* Live Map Styles */
        .live-map-container {
            background: #0a0d14;
            border: 1px solid #1e293b;
            border-radius: 12px;
            width: 95vw;
            max-width: 1400px;
            height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .live-map-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid #1e293b;
        }

        .live-map-header h2 {
            font-size: 18px;
            font-weight: 600;
            color: #e4e4e7;
            margin: 0;
        }

        .live-map-controls {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .live-map-controls span {
            color: #22c55e;
            font-size: 13px;
        }

        .live-map-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .live-map-wrapper {
            flex: 1;
            position: relative;
            overflow: auto;
            background: #111827;
        }

        .live-map-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
        }

        #liveMapPlayers {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        #liveMapPlayers .map-marker {
            pointer-events: auto;
        }

        .live-map-sidebar {
            width: 280px;
            background: #111827;
            border-left: 1px solid #1e293b;
            padding: 16px;
            overflow-y: auto;
        }

        .live-map-sidebar h3 {
            font-size: 14px;
            font-weight: 600;
            color: #e4e4e7;
            margin-bottom: 12px;
        }

        .live-map-player-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .live-map-player {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 10px;
            background: #1e293b;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .live-map-player:hover {
            background: #374151;
        }

        .live-map-player-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #22c55e;
        }

        .live-map-player-name {
            color: #e4e4e7;
            font-size: 13px;
            flex: 1;
        }

        .live-map-player-team {
            color: #6b7280;
            font-size: 11px;
        }

        .map-marker {
            position: absolute;
            width: 16px;
            height: 16px;
            background: #3b82f6;
            border: 3px solid #fff;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            cursor: pointer;
            z-index: 10;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.5);
            animation: markerPulse 2s infinite;
        }

        @keyframes markerPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.5); }
            50% { box-shadow: 0 0 0 8px rgba(59, 130, 246, 0); }
        }

        .map-marker:hover {
            transform: translate(-50%, -50%) scale(1.5);
            z-index: 20;
        }

        .map-marker.police { background: #3b82f6; }
        .map-marker.civilian { background: #22c55e; animation-name: markerPulseCivilian; }
        .map-marker.fire { background: #ef4444; animation-name: markerPulseFire; }

        @keyframes markerPulseCivilian {
            0%, 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.5); }
            50% { box-shadow: 0 0 0 8px rgba(34, 197, 94, 0); }
        }

        @keyframes markerPulseFire {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.5); }
            50% { box-shadow: 0 0 0 8px rgba(239, 68, 68, 0); }
        }

        .map-marker-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #0a0d14;
            border: 1px solid #374151;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 11px;
            color: #e4e4e7;
            white-space: nowrap;
            display: none;
            z-index: 30;
        }

        .map-marker:hover .map-marker-tooltip {
            display: block;
        }

        .community-header {
            max-width: 800px;
            margin: 0 auto 32px;
        }

        .community-info-header {
            margin-top: 16px;
        }

        .community-info-header h1 {
            font-size: 26px;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .community-info-header p {
            color: #52525b;
            font-size: 13px;
        }

        .community-content {
            max-width: 800px;
            margin: 0 auto;
        }

        .community-actions {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
        }

        .btn-police {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: #3b82f6;
            border: none;
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
        }

        .btn-police:hover { background: #2563eb; }

        .btn-dispatch {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: #10b981;
            border: none;
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
        }

        .btn-dispatch:hover { background: #059669; }

        .dispatch-mdt {
            display: none;
            min-height: 100vh;
            padding: 30px;
            background: #0a0d14;
        }

        .dispatch-mdt.active { display: block; }

        .dispatch-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .dispatch-header .identifier {
            font-size: 16px;
            color: #e4e4e7;
            margin-bottom: 8px;
        }

        .dispatch-header .identifier span {
            color: #9ca3af;
        }

        .dispatch-header .status {
            font-size: 15px;
            color: #e4e4e7;
        }

        .dispatch-header .status span {
            color: #9ca3af;
        }

        .dispatch-actions {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .dispatch-btn {
            padding: 10px 20px;
            border: 2px solid;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            background: transparent;
            transition: background 0.2s;
        }

        .dispatch-btn.green { border-color: #22c55e; color: #22c55e; }
        .dispatch-btn.green:hover { background: rgba(34,197,94,.2); }
        .dispatch-btn.orange { border-color: #f97316; color: #f97316; }
        .dispatch-btn.orange:hover { background: rgba(249,115,22,.2); }
        .dispatch-btn.cyan { border-color: #06b6d4; color: #06b6d4; }
        .dispatch-btn.cyan:hover { background: rgba(6,182,212,.2); }
        .dispatch-btn.red { border-color: #ef4444; color: #ef4444; }
        .dispatch-btn.red:hover { background: rgba(239,68,68,.2); }
        .dispatch-btn.blue { border-color: #3b82f6; color: #3b82f6; }
        .dispatch-btn.blue:hover { background: rgba(59,130,246,.2); }

        .dispatch-panels {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 30px;
        }

        .dispatch-panel {
            background: #111827;
            border: 1px solid #1e293b;
            border-radius: 10px;
            padding: 20px;
        }

        .dispatch-panel h3 {
            font-size: 18px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 20px;
            color: #e4e4e7;
        }

        .dispatch-table {
            width: 100%;
            border-collapse: collapse;
        }

        .dispatch-table th {
            color: #6b7280;
            font-size: 12px;
            font-weight: 500;
            text-align: left;
            padding: 10px 12px;
            border-bottom: 1px solid #1e293b;
        }

        .dispatch-table td {
            color: #e4e4e7;
            font-size: 13px;
            padding: 12px;
            border-bottom: 1px solid #1e293b;
        }

        .dispatch-table .view-btn {
            padding: 6px 14px;
            border: 1px solid #06b6d4;
            border-radius: 4px;
            background: transparent;
            color: #06b6d4;
            font-size: 12px;
            font-family: inherit;
            cursor: pointer;
        }

        .dispatch-table .view-btn:hover {
            background: rgba(6,182,212,.15);
        }

        .no-bolos {
            text-align: center;
            color: #22c55e;
            font-size: 14px;
            padding: 20px;
        }

        .dispatch-off-duty {
            position: absolute;
            top: 20px;
            right: 30px;
            padding: 10px 20px;
            background: #ef4444;
            border: none;
            border-radius: 8px;
            color: #fff;
            font-size: 13px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
        }

        .dispatch-off-duty:hover { background: #dc2626; }

        .btn-admin {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: #f59e0b;
            border: none;
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
        }

        .btn-admin:hover { background: #d97706; }

        .police-login-modal .modal { max-width: 400px; }

        .police-mdt {
            display: none;
            min-height: 100vh;
            padding: 20px;
            background: #0a0d14;
        }

        .police-mdt.active { display: block; }

        .mdt-grid {
            display: grid;
            grid-template-columns: 250px 1fr 320px;
            gap: 16px;
            margin-bottom: 16px;
        }

        .mdt-panel {
            background: #111827;
            border: 1px solid #1e293b;
            border-radius: 10px;
            padding: 20px;
        }

        .mdt-panel h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            text-align: center;
        }

        .officer-timer {
            font-size: 32px;
            font-weight: 300;
            color: #6b7280;
            text-align: center;
            margin-bottom: 24px;
            font-family: monospace;
        }

        .officer-info-item {
            text-align: center;
            margin-bottom: 16px;
        }

        .officer-info-item .label {
            color: #6b7280;
            font-size: 12px;
            margin-bottom: 4px;
        }

        .officer-info-item .value {
            color: #e4e4e7;
            font-size: 14px;
            font-weight: 500;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-10-8 { background: #22c55e; color: #fff; }
        .status-10-7 { background: #ef4444; color: #fff; }
        .status-10-6 { background: #eab308; color: #000; }
        .status-10-11 { background: #3b82f6; color: #fff; }
        .status-10-15 { background: #3b82f6; color: #fff; }
        .status-10-23 { background: #3b82f6; color: #fff; }
        .status-10-26 { background: #f97316; color: #fff; }
        .status-10-45 { background: #f97316; color: #fff; }
        .status-10-97 { background: #f97316; color: #fff; }
        .status-10-99 { background: #ef4444; color: #fff; }
        .status-signal { background: #a855f7; color: #fff; }
        .status-panic { background: #dc2626; color: #fff; animation: panic-flash 0.5s infinite; }
        @keyframes panic-flash { 0%, 100% { background: #dc2626; } 50% { background: #7f1d1d; } }

        .control-section {
            margin-bottom: 20px;
        }

        .control-section .section-label {
            color: #6b7280;
            font-size: 12px;
            text-align: center;
            margin-bottom: 12px;
        }

        .status-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .status-btn {
            padding: 8px 16px;
            border: 1px solid;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            background: transparent;
        }

        .status-btn.green { border-color: #22c55e; color: #22c55e; }
        .status-btn.green:hover { background: rgba(34,197,94,.15); }
        .status-btn.red { border-color: #ef4444; color: #ef4444; }
        .status-btn.red:hover { background: rgba(239,68,68,.15); }
        .status-btn.yellow { border-color: #eab308; color: #eab308; }
        .status-btn.yellow:hover { background: rgba(234,179,8,.15); }
        .status-btn.blue { border-color: #3b82f6; color: #3b82f6; }
        .status-btn.blue:hover { background: rgba(59,130,246,.15); }
        .status-btn.orange { border-color: #f97316; color: #f97316; }
        .status-btn.orange:hover { background: rgba(249,115,22,.15); }
        .status-btn.purple { border-color: #a855f7; color: #a855f7; }
        .status-btn.purple:hover { background: rgba(168,85,247,.15); }

        .quick-actions {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .quick-btn {
            padding: 8px 16px;
            background: transparent;
            border: 1px solid #3b82f6;
            border-radius: 6px;
            color: #3b82f6;
            font-size: 12px;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
        }

        .quick-btn:hover { background: rgba(59,130,246,.15); }

        .chat-messages {
            height: 280px;
            overflow-y: auto;
            margin-bottom: 12px;
            padding: 10px;
            background: #0a0d14;
            border-radius: 6px;
        }

        .chat-message {
            font-size: 12px;
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .chat-message .time { color: #6b7280; }
        .chat-message .sender { color: #fff; font-weight: 600; }
        .chat-message .text { color: #9ca3af; }

        .chat-input-wrap {
            display: flex;
            gap: 8px;
        }

        .chat-input {
            flex: 1;
            padding: 10px 14px;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 6px;
            color: #fff;
            font-size: 13px;
            font-family: inherit;
        }

        .chat-input::placeholder { color: #6b7280; }
        .chat-input:focus { outline: none; border-color: #3b82f6; }

        .chat-send {
            padding: 10px 20px;
            background: #3b82f6;
            border: none;
            border-radius: 6px;
            color: #fff;
            font-size: 13px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
        }

        .chat-send:hover { background: #2563eb; }

        .mdt-bottom-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .calls-table, .bolos-table {
            width: 100%;
            border-collapse: collapse;
        }

        .calls-table th, .bolos-table th {
            background: #1e293b;
            color: #6b7280;
            font-size: 12px;
            font-weight: 500;
            padding: 10px 12px;
            text-align: left;
        }

        .calls-table td, .bolos-table td {
            padding: 12px;
            font-size: 13px;
            color: #9ca3af;
            border-bottom: 1px solid #1e293b;
        }

        .btn-details {
            padding: 6px 14px;
            background: transparent;
            border: 1px solid #3b82f6;
            border-radius: 4px;
            color: #3b82f6;
            font-size: 11px;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
        }

        .btn-details:hover { background: rgba(59,130,246,.15); }

        .mdt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 0 10px;
        }

        .mdt-header h2 {
            font-size: 20px;
            font-weight: 600;
        }

        .btn-off-duty {
            padding: 10px 20px;
            background: #ef4444;
            border: none;
            border-radius: 8px;
            color: #fff;
            font-size: 13px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
        }

        .btn-off-duty:hover { background: #dc2626; }

        .lookup-result {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 14px;
            margin-bottom: 10px;
        }

        .lookup-result:hover { border-color: #3b82f6; }

        .lookup-result .name {
            font-size: 14px;
            font-weight: 600;
            color: #e4e4e7;
            margin-bottom: 6px;
        }

        .lookup-result .info {
            font-size: 12px;
            color: #9ca3af;
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }

        .lookup-result .info span { display: flex; align-items: center; gap: 4px; }

        .lookup-empty {
            text-align: center;
            color: #6b7280;
            font-size: 13px;
            padding: 20px;
        }

        .btn-civilian {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: #22c55e;
            border: none;
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
        }

        .btn-civilian:hover { background: #16a34a; }

        .civilian-page {
            display: none;
            min-height: 100vh;
            background: #0a0d14;
        }

        .civilian-page.active { display: block; }

        .civilian-toolbar {
            background: #1a1a1a;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid #333;
        }

        .toolbar-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 18px;
            border: none;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            text-transform: uppercase;
        }

        .toolbar-btn svg { width: 16px; height: 16px; }

        .toolbar-btn.green { background: #22c55e; color: #fff; }
        .toolbar-btn.green:hover { background: #16a34a; }

        .toolbar-btn.teal { background: #14b8a6; color: #fff; }
        .toolbar-btn.teal:hover { background: #0d9488; }

        .toolbar-btn.gray { background: #4b5563; color: #fff; }
        .toolbar-btn.gray:hover { background: #374151; }

        .toolbar-btn.orange { background: #f97316; color: #fff; }
        .toolbar-btn.orange:hover { background: #ea580c; }

        .toolbar-btn.red { background: #ef4444; color: #fff; }
        .toolbar-btn.red:hover { background: #dc2626; }

        .toolbar-divider {
            width: 1px;
            height: 32px;
            background: #333;
            margin: 0 8px;
        }

        .civilian-content {
            padding: 30px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .civilian-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .civilian-header h2 {
            font-size: 24px;
            font-weight: 600;
        }

        .btn-back-community {
            padding: 10px 20px;
            background: #374151;
            border: none;
            border-radius: 8px;
            color: #fff;
            font-size: 13px;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
        }

        .btn-back-community:hover { background: #4b5563; }

        .characters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
        }

        .character-card {
            background: #111827;
            border: 1px solid #1e293b;
            border-radius: 10px;
            padding: 20px;
        }

        .character-card .name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .character-card .info {
            font-size: 13px;
            color: #9ca3af;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .character-card .actions {
            margin-top: 16px;
            display: flex;
            gap: 10px;
        }

        .no-characters {
            text-align: center;
            color: #6b7280;
            padding: 60px 20px;
            font-size: 14px;
        }

        .btn-ticket {
            margin-top: 10px;
            padding: 8px 16px;
            background: #f97316;
            border: none;
            border-radius: 6px;
            color: #fff;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-ticket:hover { background: #ea580c; }

        .charges-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 12px;
        }

        .charge-item {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .charge-item input {
            flex: 1;
        }

        .btn-add-charge {
            padding: 8px 14px;
            background: #22c55e;
            border: none;
            border-radius: 6px;
            color: #fff;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
        }

        .btn-add-charge:hover { background: #16a34a; }

        .btn-remove-charge {
            padding: 6px 10px;
            background: #ef4444;
            border: none;
            border-radius: 4px;
            color: #fff;
            font-size: 11px;
            cursor: pointer;
        }

        .btn-remove-charge:hover { background: #dc2626; }

        .signature-pad {
            width: 100%;
            height: 100px;
            background: #0c0e12;
            border: 1px solid #27272a;
            border-radius: 8px;
            cursor: crosshair;
        }

        .signature-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .btn-clear-sig {
            padding: 6px 12px;
            background: #374151;
            border: none;
            border-radius: 4px;
            color: #fff;
            font-size: 11px;
            cursor: pointer;
        }

        .btn-clear-sig:hover { background: #4b5563; }

        .civilian-tabs {
            display: flex;
            gap: 0;
            margin-bottom: 20px;
            border-bottom: 1px solid #333;
        }

        .civilian-tab {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            color: #6b7280;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
        }

        .civilian-tab:hover { color: #9ca3af; }

        .civilian-tab.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .ticket-card {
            background: #111827;
            border: 1px solid #1e293b;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 12px;
        }

        .ticket-card .ticket-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .ticket-card .ticket-id {
            font-size: 14px;
            font-weight: 600;
            color: #f97316;
        }

        .ticket-card .ticket-date {
            font-size: 12px;
            color: #6b7280;
        }

        .ticket-card .ticket-info {
            font-size: 13px;
            color: #9ca3af;
            margin-bottom: 8px;
        }

        .ticket-card .ticket-charges {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #1e293b;
        }

        .ticket-card .ticket-charges h4 {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 8px;
        }

        .ticket-card .charge {
            padding: 6px 10px;
            background: #1e293b;
            border-radius: 4px;
            font-size: 12px;
            color: #e4e4e7;
            margin-bottom: 6px;
        }

        .ticket-card .ticket-signature {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #1e293b;
        }

        .ticket-card .ticket-signature h4 {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 8px;
        }

        .ticket-card .ticket-signature img {
            max-width: 200px;
            max-height: 60px;
            border: 1px solid #333;
            border-radius: 4px;
            background: #0c0e12;
        }

        .no-tickets {
            text-align: center;
            color: #6b7280;
            padding: 40px 20px;
            font-size: 14px;
        }

        .team-section {
            display: none;
            min-height: 100vh;
            padding: 100px 32px 60px;
        }

        .team-section.active { display: block; }

        .team-header {
            text-align: center;
            margin-bottom: 50px;
        }

        .team-header h1 {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .team-header p {
            color: #71717a;
            font-size: 15px;
        }

        .team-grid {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
            max-width: 1000px;
            margin: 0 auto;
        }

        .team-card {
            background: linear-gradient(145deg, #151921 0%, #111318 100%);
            border: 1px solid #1e2530;
            border-radius: 16px;
            padding: 30px;
            text-align: center;
            width: 280px;
        }

        .team-card .team-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #3b82f6;
            margin-bottom: 16px;
        }

        .team-card .team-name {
            font-size: 22px;
            font-weight: 600;
            color: #f0f0f2;
            margin-bottom: 6px;
        }

        .team-card .team-role {
            font-size: 14px;
            font-weight: 600;
            color: #3b82f6;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
        }

        .team-card .team-role.owner {
            color: #f59e0b;
        }

        .team-card .team-role.coowner {
            color: #a855f7;
        }

        .team-card .team-role.director {
            color: #ef4444;
        }

        .team-card .team-role.admin {
            color: #22c55e;
        }

        .team-card .team-role.support {
            color: #3b82f6;
        }

        .team-card .vacant-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 3px dashed #6b7280;
            margin: 0 auto 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            color: #6b7280;
            background: #1e2530;
        }

        .team-card .team-desc {
            color: #6b7280;
            font-size: 13px;
            line-height: 1.5;
        }

        .tones-context-menu {
            position: fixed;
            background: #1f2937;
            border: 1px solid #374151;
            border-radius: 8px;
            padding: 8px 0;
            min-width: 180px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            z-index: 10000;
            display: none;
        }

        .tones-context-menu.active {
            display: block;
        }

        .tones-context-menu .menu-title {
            padding: 8px 16px;
            font-size: 11px;
            font-weight: 600;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid #374151;
            margin-bottom: 4px;
        }

        .tones-context-menu .tone-item {
            padding: 10px 16px;
            font-size: 13px;
            color: #e4e4e7;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.15s;
        }

        .tones-context-menu .tone-item:hover {
            background: #374151;
        }

        .tones-context-menu .tone-item .tone-icon {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .tones-context-menu .tone-item.tone-1 .tone-icon { background: #ef4444; }
        .tones-context-menu .tone-item.tone-2 .tone-icon { background: #f59e0b; }
        .tones-context-menu .tone-item.tone-3 .tone-icon { background: #3b82f6; }

        /* Staff Dropdown */
        .staff-dropdown {
            position: relative;
            z-index: 1000;
        }

        .staff-dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: #1f2937;
            border: 1px solid #374151;
            border-radius: 8px;
            padding: 8px 0;
            min-width: 180px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            z-index: 1001;
        }

        .staff-dropdown-menu.active {
            display: block;
        }

        .staff-dropdown-menu .dropdown-item {
            display: block;
            width: 100%;
            padding: 10px 16px;
            background: none;
            border: none;
            color: #e4e4e7;
            font-size: 13px;
            text-align: left;
            cursor: pointer;
            transition: background 0.15s;
        }

        .staff-dropdown-menu .dropdown-item:hover {
            background: #374151;
        }

        .dropdown-submenu {
            position: relative;
        }

        .dropdown-submenu-content {
            display: none;
            position: absolute;
            left: 100%;
            top: 0;
            background: #1f2937;
            border: 1px solid #374151;
            border-radius: 8px;
            padding: 8px 0;
            min-width: 160px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            z-index: 1002;
        }

        .dropdown-submenu:hover .dropdown-submenu-content {
            display: block;
        }

        .dropdown-submenu .dropdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Staff Settings Modal */
        .staff-settings-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .staff-settings-modal.active {
            display: flex;
        }

        .staff-settings-content {
            background: #14171f;
            border: 1px solid #1e222d;
            border-radius: 16px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .staff-settings-content h3 {
            font-size: 20px;
            margin-bottom: 20px;
            color: #e4e4e7;
        }

        /* Snow Effect */
        .snowflakes {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            overflow: hidden;
        }

        .hero h1, .hero p {
            position: relative;
            z-index: 2;
        }

        .snowflake {
            position: absolute;
            top: -10px;
            color: #fff;
            font-size: 1em;
            text-shadow: 0 0 5px rgba(255,255,255,0.5);
            animation: snowfall linear infinite;
            opacity: 0.8;
        }

        @keyframes snowfall {
            0% {
                transform: translateY(0) rotate(0deg);
            }
            100% {
                transform: translateY(100vh) rotate(360deg);
            }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Staff Sidebar */
        .staff-sidebar {
            width: 180px;
            background: #0c0e12;
            border-right: 1px solid #1e222d;
            padding: 80px 16px 16px 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .sidebar-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #1a1d2e;
            border: 1px solid #27272a;
            border-radius: 8px;
            color: #e4e4e7;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .sidebar-btn:hover {
            background: #252b3d;
            border-color: #374151;
        }

        .sidebar-btn.active {
            background: #3b82f6;
            border-color: #3b82f6;
            color: #fff;
        }

        /* Staff Pages Container */
        .staff-pages-container {
            flex: 1;
        }

        .staff-page {
            display: none !important;
        }

        .staff-page.active {
            display: block !important;
        }

        .staff-page-header {
            font-size: 28px;
            font-weight: 700;
            color: #e4e4e7;
            margin-bottom: 24px;
        }

        .staff-list {
            display: grid;
            gap: 12px;
        }

        .staff-item {
            padding: 16px;
            background: #14171f;
            border: 1px solid #1e222d;
            border-radius: 8px;
            color: #e4e4e7;
            transition: all 0.2s;
        }

        .staff-item:hover {
            border-color: #374151;
            background: #1a1d2e;
        }

        .staff-item-title {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .staff-item-desc {
            font-size: 13px;
            color: #a1a1aa;
        }

        header {
            z-index: 50;
        }

        .staff-dashboard {
            display: flex !important;
        }

        .staff-dashboard[style*="display:none"] {
            display: none !important;
        }

    </style>
</head>
<body>
    <!-- Tones Context Menu -->
     <div class="tones-context-menu" id="tonesContextMenu">
         <div class="menu-title">Tones</div>
         <div id="tonesMenuContainer">
             <div class="tone-item tone-1" data-tone="1">
                 <span class="tone-icon"></span>
                 <span>Tone 1 - Priority</span>
             </div>
             <div class="tone-item tone-2" data-tone="2">
                 <span class="tone-icon"></span>
                 <span>Tone 2 - Alert</span>
             </div>
             <div class="tone-item tone-3" data-tone="3">
                 <span class="tone-icon"></span>
                 <span>Tone 3 - Routine</span>
             </div>
         </div>
     </div>

     <!-- Unit Status Context Menu -->
     <div class="tones-context-menu" id="unitStatusContextMenu" style="display:none;position:fixed;z-index:1000;">
         <div class="menu-title">Change Status</div>
         <div id="statusMenuContainer">
             <div class="tone-item" data-status="10-8">
                 <span>10-8 (On Duty)</span>
             </div>
             <div class="tone-item" data-status="10-7">
                 <span>10-7 (Off Duty)</span>
             </div>
             <div class="tone-item" data-status="10-6">
                 <span>10-6 (Busy)</span>
             </div>
             <div class="tone-item" data-status="10-4">
                 <span>10-4 (Available)</span>
             </div>
             <div class="tone-item" data-status="10-23">
                 <span>10-23 (Traffic Stop)</span>
             </div>
             <div class="tone-item" data-status="10-27">
                 <span>10-27 (Investigating)</span>
             </div>
             <div class="tone-item" data-status="10-97">
                 <span>10-97 (In Station)</span>
             </div>
         </div>
     </div>

    <header>
         <div class="brand">
             <img src="https://cdn.discordapp.com/icons/1455410644634304725/75220689ed872e2ee4c7101f479813a5.webp?size=512" alt="Pulsecad">
             <span>Pulsecad</span>
         </div>
         <nav class="nav-links">
             <button class="nav-link" id="homeBtn">Home</button>
             <button class="nav-link" id="pricesBtn">Prices</button>
             <a class="nav-link" href="https://discord.gg/FXNTFaQWt9" target="_blank" style="text-decoration: none;">Discord</a>
             <button class="nav-link" id="teamBtn">Team</button>
         </nav>
         <button class="nav-btn" id="openLogin">Login</button>
         <div class="nav-user">
             <span id="navUsername"></span>
             <button class="nav-logout" id="staffDashboardBtn">Staff Dashboard</button>
             <button class="nav-logout" id="logoutBtn">Log out</button>
         </div>
     </header>

    <section class="pricing-section" id="pricingSection">
        <button class="back-btn" id="backFromPricing">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
            Back
        </button>
        <div class="pricing-header">
            <h1>Pricing</h1>
            <p>Choose the plan that fits your community</p>
        </div>
        <div class="pricing-grid">
            <div class="price-card">
                <h3>Starter</h3>
                <p class="desc">Perfect for small teams just getting started. Everything you need to launch your community.</p>
                <div class="price-amount">
                    <span>$10.00</span><small>/ 3 months</small>
                </div>
                <button class="price-btn">Login to Subscribe</button>
                <div class="features-title">What is Included?</div>
                <ul class="features-list">
                    <li>30 Members</li>
                    <li>50 Civilian characters</li>
                    <li>50 Vehicles</li>
                    <li>50 Reports</li>
                    <li>2 Departments</li>
                    <li>2 Businesses</li>
                    <li> Webhooks</li>
                    <li><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>Permission Keys</li>
                    <li><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>Internal Messaging</li>
                    <li><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>Department Rosters</li>
                </ul>
            </div>
            <div class="price-card">
                <h3>Standard</h3>
                <p class="desc">Ideal for established groups ready to scale. Unlock more features and capacity for your growing team.</p>
                <div class="price-amount">
                    <span>$30.00</span><small>/ 3 months</small>
                </div>
                <button class="price-btn">Login to Subscribe</button>
                <div class="features-title">What is Included?</div>
                <ul class="features-list">
                    <li>150 Members</li>
                    <li>500 Civilian characters</li>
                    <li>500 Vehicles</li>
                    <li>500 Reports</li>
                    <li>6 Departments</li>
                    <li>6 Businesses</li>
                    <li> Webhooks</li>
                    <li><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>Permission Keys</li>
                    <li><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>Internal Messaging</li>
                    <li><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>Department Rosters</li>
                    <li><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>FiveM Integration (Basic)</li>
                </ul>
            </div>
            <div class="price-card">
                <h3>Advanced</h3>
                <p class="desc">Built for serious communities that demand the best. Maximum power, priority support, full integration.</p>
                <div class="price-amount">
                    <span>$55.00</span><small>/ 3 months</small>
                </div>
                <button class="price-btn">Login to Subscribe</button>
                <div class="features-title">What is Included?</div>
                <ul class="features-list">
                    <li>250 Members</li>
                    <li>1,000 Civilian characters</li>
                    <li>1,000 Vehicles</li>
                    <li>1,000 Reports</li>
                    <li>12 Departments</li>
                    <li> Businesses</li>
                    <li> Webhooks</li>
                    <li><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>Permission Keys</li>
                    <li><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>Internal Messaging</li>
                    <li><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>Department Rosters</li>
                    <li><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>FiveM Integration (Advanced)</li>
                </ul>
            </div>
        </div>
    </section>

    <section class="team-section" id="teamSection">
        <button class="back-btn" id="backFromTeam">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
            Back
        </button>
        <div class="team-header">
            <h1>Our Team</h1>
            <p>Meet the people behind Pulsecad</p>
        </div>
        <div class="team-grid">
            <div class="team-card">
                <img src="https://media1.tenor.com/m/2yNT5ibnFU8AAAAC/driving-fast.gif" alt="Ryan" class="team-avatar">
                <div class="team-name">Ryan</div>
                <div class="team-role owner">Owner</div>
                <div class="team-desc">Founder and owner of Pulsecad. Building the future of CAD/MDT systems.</div>
            </div>
            <div class="team-card">
                <img src="https://cdn.discordapp.com/avatars/926889740345679903/a_2cb92e0fe61cf965b984eadbd740fab8.gif?size=1024&animated=true" alt="Devin" class="team-avatar">
                <div class="team-name">Devin</div>
                <div class="team-role coowner">Co-Owner</div>
                <div class="team-desc">Co-owner of Pulsecad. Helping shape the vision and direction of the platform.</div>
            </div>
            <div class="team-card">
                <img src="https://cdn.discordapp.com/avatars/1249645229141659658/a_f4476c98c388dd0194c4ee0e38bc6161.gif?size=1024&animated=true" alt="Cayden" class="team-avatar">
                <div class="team-name">Cayden</div>
                <div class="team-role director">Operations Director</div>
                <div class="team-desc">Operations Director of Pulsecad. Overseeing daily operations and team coordination.</div>
            </div>
            <div class="team-card">
                <img src="https://cdn.discordapp.com/avatars/937822760091156591/8010fe9317f640d842a8201a7b33ade0.webp?size=1024" alt="Joseh" class="team-avatar">
                <div class="team-name">Joseh</div>
                <div class="team-role support">Senior Support</div>
                <div class="team-desc">Senior support team member helping users with any questions or issues.</div>
            </div>
            <div class="team-card">
                <div class="team-avatar vacant-avatar">?</div>
                <div class="team-name">Vacant</div>
                <div class="team-role support">Support</div>
                <div class="team-desc">This position is currently open. Join our Discord to apply!</div>
            </div>
            <div class="team-card">
                <div class="team-avatar vacant-avatar">?</div>
                <div class="team-name">Vacant</div>
                <div class="team-role support">Support</div>
                <div class="team-desc">This position is currently open. Join our Discord to apply!</div>
            </div>
            <div class="team-card">
                <div class="team-avatar vacant-avatar">?</div>
                <div class="team-name">Vacant</div>
                <div class="team-role support">Support</div>
                <div class="team-desc">This position is currently open. Join our Discord to apply!</div>
            </div>
        </div>
    </section>

    <section class="contact-section" id="contactSection" style="display:none;min-height:100vh;padding:100px 32px 60px;">
        <button class="back-btn" id="backFromContact">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
            Back
        </button>
        <div style="max-width:500px;margin:0 auto;">
            <div style="text-align:center;margin-bottom:40px;">
                <h1 style="font-size:32px;margin-bottom:8px;">Contact Us</h1>
                <p style="color:#71717a;font-size:15px;">Have a question? Send us a message!</p>
            </div>
            <div class="mdt-panel" style="padding:30px;">
                <form id="contactForm">
                    <div class="field">
                        <label>Your Name</label>
                        <input type="text" id="contactName" placeholder="Enter your name" required>
                    </div>
                    <div class="field">
                        <label>Email</label>
                        <input type="email" id="contactEmail" placeholder="Enter your email" required>
                    </div>
                    <div class="field">
                        <label>Subject</label>
                        <input type="text" id="contactSubject" placeholder="What is this about?" required>
                    </div>
                    <div class="field">
                        <label>Message</label>
                        <textarea id="contactMessage" placeholder="Your message..." rows="5" style="width:100%;padding:11px 13px;background:#0c0e12;border:1px solid #27272a;border-radius:8px;color:#fafafa;font-size:13px;font-family:inherit;resize:vertical;" required></textarea>
                    </div>
                    <button type="submit" class="btn-primary" style="width:100%;margin-top:10px;">Send Message</button>
                </form>
                <div id="contactStatus" style="text-align:center;margin-top:16px;font-size:13px;"></div>
            </div>
            <div style="text-align:center;margin-top:30px;">
                <p style="color:#71717a;font-size:13px;">Or reach us on Discord</p>
                <a href="https://discord.gg/FXNTFaQWt9" target="_blank" style="display:inline-block;margin-top:10px;padding:10px 20px;background:#5865F2;border-radius:8px;color:#fff;font-size:13px;font-weight:600;text-decoration:none;">Join Discord</a>
            </div>
        </div>
    </section>

    <main class="hero" id="heroSection">
        <div class="snowflakes" id="snowflakes"></div>
        <h1>Welcome to Pulsecad</h1>
        <p>Create and join communities. Connect with others and build something together.</p>
    </main>

    <section class="user-hub" id="userHubSection" style="display:none;">
        <div class="hub-container">
            <div class="hub-greeting">
                <img src="https://cdn.discordapp.com/icons/1455410644634304725/75220689ed872e2ee4c7101f479813a5.webp?size=512" alt="Avatar" class="hub-avatar">
                <div class="hub-welcome">
                    <span class="hub-hey">Hey, </span><span class="hub-username" id="hubUsername">User</span><span class="hub-hey">!</span>
                    <div class="hub-credits"><span id="hubCredits">0</span> credits</div>
                </div>
            </div>
            
            <div class="hub-card">
                <div class="hub-actions">
                    <button class="hub-btn" id="hubJoinCommunity">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                        Join Community
                    </button>
                </div>
            </div>
            
            <div class="hub-card" id="hubRedeemSection" style="display:none;margin-top:16px;">
                <div class="hub-section-title" style="margin-bottom:10px;">Redeem Access Key</div>
                <div style="display:flex;gap:8px;">
                    <input type="text" id="hubKeyInput" placeholder="XXXX-XXXX-XXXX-XXXX" style="flex:1;padding:10px;background:#0c0e12;border:1px solid #27272a;border-radius:6px;color:#fff;font-size:13px;font-family:monospace;text-transform:uppercase;">
                    <button id="hubRedeemBtn" style="padding:10px 20px;background:#3b82f6;border:none;border-radius:6px;color:#fff;font-size:13px;font-weight:600;cursor:pointer;">Redeem</button>
                </div>
                <div id="hubRedeemError" style="display:none;color:#ef4444;font-size:12px;margin-top:8px;"></div>
                <div id="hubRedeemSuccess" style="display:none;color:#22c55e;font-size:12px;margin-top:8px;"></div>
            </div>
            
                <!-- CAD content removed from Open MDT -->
            
            <!-- Quick Actions removed from Open MDT -->
                        <!-- Communities list now shown when Open MDT button is clicked -->
                        <div class="hub-card">
                            <div class="hub-section-title">Your Communities</div>
                            <div class="list" id="communityList">
                                <div class="empty">No communities yet</div>
                            </div>
                        </div>
            
            <!-- Your Communities section removed -->
        </div>
    </section>
    
    <section class="dashboard" id="dashboardSection" style="display:none;">
        <div class="dash-content">
            <div class="actions">
                <button class="btn-action btn-join" id="joinCommunityOld">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 00-4-4H6a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/></svg>
                    Join Community
                </button>
                <button class="btn-action btn-create" id="createCommunityOld">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
                    Create Community
                </button>
                <button class="btn-action btn-staff" id="staffDashboardBtnOld" style="display:none;background:#a855f7;border:none;color:#fff;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
                    Staff Dashboard
                </button>
            </div>
            <div class="section-title">Your Communities</div>
            <div class="list" id="communityListOld">
                <div class="empty">No communities yet</div>
            </div>
        </div>
    </section>

    <div class="overlay" id="authModal">
        <div class="modal">
            <button class="modal-close" id="closeAuth"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
            <img src="https://cdn.discordapp.com/icons/1455410644634304725/75220689ed872e2ee4c7101f479813a5.webp?size=512" alt="Pulsecad" class="modal-logo">

            <div id="loginPanel" class="panel active">
                <h2>Welcome back</h2>
                <p class="sub">Sign in to continue</p>
                <div id="loginError" class="alert alert-error"></div>
                <div id="loginSuccess" class="alert alert-success"></div>
                <form id="loginForm">
                    <div class="field">
                        <label>Username</label>
                        <input type="text" id="loginUsername" placeholder="Enter username" required>
                    </div>
                    <div class="field">
                        <label>Password</label>
                        <input type="password" id="loginPassword" placeholder="Enter password" required>
                    </div>
                    <button type="submit" class="btn-primary">Log In</button>
                </form>
                <button class="btn-secondary" id="showRegister" style="margin-top:12px;">Create Account</button>
            </div>

            <div id="registerPanel" class="panel">
                <h2>Create Account</h2>
                <p class="sub">Join Pulsecad</p>
                <div id="registerError" class="alert alert-error"></div>
                <form id="registerForm">
                    <div class="field">
                        <label>Username</label>
                        <input type="text" id="regUsername" placeholder="Choose username" required>
                    </div>
                    <div class="field">
                        <label>Password</label>
                        <input type="password" id="regPassword" placeholder="Create password" required>
                    </div>
                    <div class="field">
                        <label>Confirm Password</label>
                        <input type="password" id="regConfirm" placeholder="Confirm password" required>
                    </div>
                    <button type="submit" class="btn-primary">Create Account</button>
                </form>
                <span class="link" id="showLogin">Back to Login</span>
            </div>
        </div>
    </div>

    <div class="overlay" id="createModal">
        <div class="modal modal-sm">
            <h2>Create Community</h2>
            <form id="createCommunityForm">
                <div class="field">
                    <label>Community Name</label>
                    <input type="text" id="communityName" placeholder="Enter name" required>
                </div>
                <div class="field">
                    <label>Website <span class="opt">(optional)</span></label>
                    <input type="url" id="communityWebsite" placeholder="https://www.pulsecadsystems.xyz/">
                </div>
                <div class="modal-btns">
                    <button type="button" class="btn-cancel" id="cancelCreate">Cancel</button>
                    <button type="submit" class="btn-confirm">Create</button>
                </div>
            </form>
        </div>
    </div>

    <div class="overlay" id="joinModal">
        <div class="modal modal-sm">
            <h2>Join Community</h2>
            <form id="joinCommunityForm">
                <div class="field">
                    <label>Community Code</label>
                    <input type="text" id="joinCode" placeholder="Enter community code" required>
                </div>
                <div id="joinError" class="alert alert-error"></div>
                <div class="modal-btns">
                    <button type="button" class="btn-cancel" id="cancelJoin">Cancel</button>
                    <button type="submit" class="btn-confirm">Join</button>
                </div>
            </form>
        </div>
    </div>

    <section class="community-screen" id="communityScreen">
        <div class="community-header">
            <div style="position:relative;margin-bottom:20px;">
                <img id="communityBannerImage" style="display:none;width:100%;height:250px;object-fit:cover;border-radius:8px;">
                <!-- Banner overlay with community name -->
                <div id="bannerOverlay" style="position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(135deg, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0.3) 100%);border-radius:8px;display:flex;align-items:center;padding:30px;color:#fff;display:none;">
                    <div style="flex:1;">
                        <h2 id="bannerCommunityName" style="font-size:32px;font-weight:700;margin:0;margin-bottom:8px;text-shadow:0 2px 8px rgba(0,0,0,0.8);"></h2>
                        <p id="bannerCommunitySubtitle" style="font-size:16px;color:#e4e4e7;margin:0;text-shadow:0 1px 4px rgba(0,0,0,0.8);">Choose how you want to enter this server</p>
                    </div>
                </div>
            </div>
            <button class="btn-back-dashboard" id="backToDashboard">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                Back to Dashboard
            </button>
            <div class="community-info-header">
                <h1 id="communityViewName"></h1>
                <p id="communityViewCode"></p>
            </div>
        </div>
        <div class="community-content">
            <div class="community-actions">
                <button class="btn-police" id="policeBtn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                    Police
                </button>
                <button class="btn-dispatch" id="dispatchBtn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
                    Dispatch
                </button>
                <button class="btn-civilian" id="civilianBtn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                    Civilian
                </button>
                <button class="btn-admin" id="adminBtn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1Z"/></svg>
                    Admin
                </button>
            </div>
        </div>
    </section>

    <section class="admin-page" id="adminPage" style="display:none;min-height:100vh;padding:30px;background:#0a0d14;">
        <div style="max-width:1000px;margin:0 auto;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:30px;">
                <h2 style="font-size:24px;font-weight:600;">Community Admin</h2>
                <button class="btn-back-community" id="backFromAdmin">Back to Community</button>
            </div>
            <div class="mdt-panel" style="margin-bottom:24px;" id="erlcApiPanel">
                <div style="display:flex;align-items:center;gap:10px;margin-bottom:4px;">
                    <h3 style="margin:0;">ERLC API Integration</h3>
                </div>
                <p style="color:#6b7280;font-size:13px;margin-bottom:16px;">Connect your ERLC server to enable Live Map tracking</p>
                
                <!-- Staff Access Required Message -->
                <div id="erlcStaffRequired" style="display:none;text-align:center;padding:30px 20px;background:#1e222d;border-radius:8px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2" width="40" height="40" style="margin-bottom:12px;"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                    <h4 id="erlcApiLockStatus" style="color:#e4e4e7;font-size:16px;margin-bottom:8px;"> Locked  PulseCAD Staff Only</h4>
                    <p style="color:#6b7280;font-size:13px;">This feature is currently in beta and only available to PulseCAD staff members.</p>
                    <button id="unlockErlcApiBtn" style="margin-top:10px;padding:8px 18px;background:#22c55e;border:none;border-radius:6px;color:#fff;font-size:13px;font-weight:600;cursor:pointer;display:none;">Unlock API for this Community</button>
                </div>
                    <script>
                    // ...existing code...
                    // Unlock API logic
                    async function checkAndShowUnlockApi() {
                        if (!isPulseStaff || !currentCommunityId) return;
                        // Check if unlocked in DB
                        const { data: community } = await db
                            .from('communities')
                            .select('api_unlocked')
                            .eq('id', currentCommunityId)
                            .single();
                        const unlocked = community?.api_unlocked;
                        const unlockBtn = document.getElementById('unlockErlcApiBtn');
                        const lockStatus = document.getElementById('erlcApiLockStatus');
                        if (unlocked) {
                            unlockBtn.style.display = 'none';
                            lockStatus.textContent = ' API Unlocked for this Community';
                            lockStatus.style.color = '#22c55e';
                            document.getElementById('erlcStaffSettings').style.display = 'block';
                        } else {
                            unlockBtn.style.display = 'inline-block';
                            lockStatus.textContent = ' Locked  PulseCAD Staff Only';
                            lockStatus.style.color = '#e4e4e7';
                            document.getElementById('erlcStaffSettings').style.display = 'none';
                        }
                    }
                    document.getElementById('unlockErlcApiBtn').onclick = async function() {
                        if (!isPulseStaff || !currentCommunityId) return;
                        const { error } = await db
                            .from('communities')
                            .update({ api_unlocked: true })
                            .eq('id', currentCommunityId);
                        if (!error) {
                            alert('API unlocked for this community!');
                            checkAndShowUnlockApi();
                        } else {
                            alert('Error unlocking API: ' + error.message);
                        }
                    };
                    // Call this after staff login or community switch
                    // ...existing code...
                    </script>
                
                <!-- ERLC Settings (Now Unlocked) -->
                <div id="erlcStaffSettings" style="display:block;">
                    <div class="field" style="margin-bottom:12px;">
                        <label style="display:block;color:#a1a1aa;font-size:12px;margin-bottom:6px;">ERLC API Key</label>
                        <input type="text" id="erlcApiKey" placeholder="Enter your ERLC API key" style="width:100%;padding:10px;background:#0c0e12;border:1px solid #27272a;border-radius:6px;color:#fff;font-size:13px;">
                    </div>
                    <div style="display:flex;gap:10px;">
                        <button id="saveErlcApiKey" style="padding:10px 20px;background:#22c55e;border:none;border-radius:6px;color:#fff;font-size:13px;font-weight:600;cursor:pointer;">Save API Key</button>
                        <button id="testErlcApi" style="padding:10px 20px;background:#3b82f6;border:none;border-radius:6px;color:#fff;font-size:13px;font-weight:600;cursor:pointer;">Test Connection</button>
                    </div>
                    <div id="erlcApiStatus" style="color:#6b7280;font-size:12px;margin-top:10px;"></div>
                </div>
            </div>
            <div class="mdt-panel">
                <h3>Webhooks</h3>
                <p style="color:#6b7280;font-size:13px;margin-bottom:16px;">Set Discord webhooks for notifications</p>
                <button class="btn-primary" id="openWebhooksModal" style="margin-bottom:10px;">Discord Webhooks</button>
                <div id="webhookStatus" style="color:#6b7280;font-size:12px;"></div>
                <!-- Discord Webhooks Modal -->
                <div class="overlay" id="webhooksModal">
                    <div class="modal" style="max-width:400px;">
                        <button class="modal-close" id="closeWebhooksModal"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
                        <h2>Discord Webhooks</h2>
                        <p class="sub">Set the webhooks for logging character and ticket creation</p>
                        <div class="field" style="margin-bottom:16px;">
                            <label style="display:block;color:#a1a1aa;font-size:12px;margin-bottom:6px;">Character Created Webhook</label>
                            <input type="text" id="webhookCharacterCreated" placeholder="https://discord.com/api/webhooks/..." style="width:100%;padding:10px;background:#0c0e12;border:1px solid #27272a;border-radius:6px;color:#fff;font-size:13px;">
                        </div>
                        <div class="field" style="margin-bottom:16px;">
                            <label style="display:block;color:#a1a1aa;font-size:12px;margin-bottom:6px;">Ticket Created Webhook</label>
                            <input type="text" id="webhookTicketCreated" placeholder="https://discord.com/api/webhooks/..." style="width:100%;padding:10px;background:#0c0e12;border:1px solid #27272a;border-radius:6px;color:#fff;font-size:13px;">
                        </div>
                        <button id="saveWebhookBtn" style="width:100%;padding:10px 0;background:#3b82f6;border:none;border-radius:6px;color:#fff;font-size:13px;font-weight:600;cursor:pointer;">Save Webhooks</button>
                    </div>
                </div>
            </div>
            <div class="mdt-panel">
                <h3>Community Banner</h3>
                <p style="color:#6b7280;font-size:13px;margin-bottom:16px;">Upload a banner image to display on your community page</p>
                <div style="margin-bottom:16px;border:2px dashed #374151;border-radius:8px;padding:20px;text-align:center;cursor:pointer;" id="adminBannerDropZone">
                    <img id="adminBannerPreview" style="max-width:100%;max-height:200px;display:none;margin-bottom:10px;border-radius:4px;">
                    <div id="adminBannerUploadPrompt">
                        <p style="color:#a1a1aa;margin:0;font-size:13px;">Click or drag image here</p>
                        <p style="color:#6b7280;margin:5px 0 0 0;font-size:12px;">Max 5MB  PNG, JPG, WebP</p>
                    </div>
                    <input type="file" id="adminBannerFileInput" accept="image/png,image/jpeg,image/webp" style="display:none;">
                </div>
                <div style="display:flex;gap:10px;">
                    <button class="btn-primary" id="saveAdminBanner" style="background:#3b82f6;">Save Banner</button>
                    <button class="btn-primary" id="removeAdminBanner" style="background:#ef4444;">Remove Banner</button>
                </div>
            </div>
            <div class="mdt-panel" style="margin-top:24px;" id="rosterSection">
                <h3>Department Rosters</h3>
                <p style="color:#6b7280;font-size:13px;margin-bottom:12px;">Create and manage multiple rosters for your community.</p>
                
                <!-- Upgrade Required Message -->
                <div id="rosterUpgradeRequired" style="display:none;text-align:center;padding:30px 20px;background:#1e222d;border-radius:8px;margin-bottom:16px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2" width="40" height="40" style="margin-bottom:12px;"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
                    <h4 style="color:#e4e4e7;font-size:16px;margin-bottom:8px;">Starter Plan Required</h4>
                    <p style="color:#6b7280;font-size:13px;margin-bottom:8px;">Upgrade to the Starter plan or higher to access:</p>
                    <p style="color:#a1a1aa;font-size:13px;margin:0;">Internal Messaging</p>
                    <p style="color:#a1a1aa;font-size:13px;margin-bottom:16px;">Department Rosters</p>
                    <a href="?prices" style="display:inline-block;padding:10px 24px;background:#f59e0b;border-radius:6px;color:#fff;font-size:13px;font-weight:600;text-decoration:none;">View Plans</a>
                </div>
                
                <!-- Roster Content (hidden if no plan) -->
                <div id="rosterContent">
                <!-- Create New Roster -->
                <div style="display:flex;gap:10px;align-items:center;margin-bottom:16px;">
                    <input type="text" id="newRosterName" placeholder="New roster name (e.g., Police, Fire, EMS)" style="flex:1;padding:10px;background:#0c0e12;border:1px solid #27272a;border-radius:6px;color:#fff;font-size:13px;">
                    <button id="createRosterBtn" style="padding:10px 20px;background:#22c55e;border:none;border-radius:6px;color:#fff;font-size:13px;font-weight:600;cursor:pointer;">Create Roster</button>
                </div>
                
                <!-- Roster Selection -->
                <div style="display:flex;gap:10px;align-items:center;margin-bottom:16px;">
                    <select id="currentRosterSelect" style="flex:1;padding:10px;background:#0c0e12;border:1px solid #27272a;border-radius:6px;color:#fff;font-size:13px;">
                        <option value="">-- Select a Roster --</option>
                    </select>
                    <button id="deleteRosterBtn" style="padding:10px 16px;background:#ef4444;border:none;border-radius:6px;color:#fff;font-size:12px;font-weight:600;cursor:pointer;">Delete Roster</button>
                </div>
                
                <!-- Roster Link -->
                <div id="rosterLinkSection" style="display:none;margin-bottom:16px;">
                    <label style="display:block;color:#a1a1aa;font-size:12px;margin-bottom:6px;">Public Roster Link:</label>
                    <div style="display:flex;gap:10px;align-items:center;">
                        <input type="text" id="rosterPublicLink" readonly style="flex:1;padding:10px;background:#0c0e12;border:1px solid #27272a;border-radius:6px;color:#a1a1aa;font-size:12px;">
                        <button id="copyRosterLink" style="padding:10px 16px;background:#3b82f6;border:none;border-radius:6px;color:#fff;font-size:12px;font-weight:600;cursor:pointer;">Copy Link</button>
                    </div>
                </div>
                
                <!-- Add Entry Form (hidden until roster selected) -->
                <div id="rosterEntryForm" style="display:none;">
                    <div style="display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap;">
                        <input type="text" id="rosterMemberName" placeholder="Name" style="flex:1;min-width:120px;padding:10px;background:#0c0e12;border:1px solid #27272a;border-radius:6px;color:#fff;font-size:13px;">
                        <input type="text" id="rosterRank" placeholder="Rank" style="flex:1;min-width:100px;padding:10px;background:#0c0e12;border:1px solid #27272a;border-radius:6px;color:#fff;font-size:13px;">
                        <input type="text" id="rosterCallsign" placeholder="Callsign" style="width:100px;padding:10px;background:#0c0e12;border:1px solid #27272a;border-radius:6px;color:#fff;font-size:13px;">
                        <input type="text" id="rosterBadge" placeholder="Badge #" style="width:80px;padding:10px;background:#0c0e12;border:1px solid #27272a;border-radius:6px;color:#fff;font-size:13px;">
                        <select id="rosterDepartment" style="min-width:120px;padding:10px;background:#0c0e12;border:1px solid #27272a;border-radius:6px;color:#fff;font-size:13px;">
                            <option value="">Department</option>
                        </select>
                        <select id="rosterStatus" style="min-width:100px;padding:10px;background:#0c0e12;border:1px solid #27272a;border-radius:6px;color:#fff;font-size:13px;">
                            <option value="Active">Active</option>
                            <option value="LOA">LOA</option>
                            <option value="Suspended">Suspended</option>
                            <option value="Inactive">Inactive</option>
                        </select>
                        <button id="addRosterEntry" style="padding:10px 20px;background:#22c55e;border:none;border-radius:6px;color:#fff;font-size:13px;font-weight:600;cursor:pointer;">Add</button>
                    </div>
                    <table id="rosterTable" style="width:100%;border-collapse:collapse;background:#14171f;border-radius:8px;">
                        <thead>
                            <tr style="background:#1e222d;">
                                <th style="padding:12px;text-align:left;font-size:12px;color:#a1a1aa;">Name</th>
                                <th style="padding:12px;text-align:left;font-size:12px;color:#a1a1aa;">Rank</th>
                                <th style="padding:12px;text-align:left;font-size:12px;color:#a1a1aa;">Callsign</th>
                                <th style="padding:12px;text-align:left;font-size:12px;color:#a1a1aa;">Badge</th>
                                <th style="padding:12px;text-align:left;font-size:12px;color:#a1a1aa;">Department</th>
                                <th style="padding:12px;text-align:left;font-size:12px;color:#a1a1aa;">Status</th>
                                <th style="padding:12px;text-align:left;font-size:12px;color:#a1a1aa;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="rosterTableBody">
                            <tr><td colspan="7" style="text-align:center;color:#6b7280;padding:20px;">No roster entries yet</td></tr>
                        </tbody>
                    </table>
                </div>
                </div>
            </div>
            <div class="mdt-panel" style="margin-top:24px;">
                <h3>Tones</h3>
                <p style="color:#6b7280;font-size:13px;margin-bottom:16px;">Upload custom tones for your police units</p>
                <div style="display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap;">
                    <input type="text" id="toneName" placeholder="Tone name (e.g. Priority, Alert)" style="flex:1;min-width:150px;padding:10px 14px;background:#0c0e12;border:1px solid #27272a;border-radius:8px;color:#fafafa;font-size:13px;">
                    <input type="file" id="toneFile" accept="audio/*" style="flex:1;min-width:150px;padding:10px 14px;background:#0c0e12;border:1px solid #27272a;border-radius:8px;color:#fafafa;font-size:13px;">
                    <input type="number" id="toneMaxUses" placeholder="Max uses ()" min="1" style="width:120px;padding:10px 14px;background:#0c0e12;border:1px solid #27272a;border-radius:8px;color:#fafafa;font-size:13px;">
                    <button id="uploadToneBtn" style="padding:10px 20px;background:#22c55e;border:none;border-radius:6px;color:#fff;font-size:13px;font-weight:600;cursor:pointer;">Upload Tone</button>
                </div>
                 <div id="tonesTableContainer">
                     <table id="adminTonesTable" style="width:100%;border-collapse:collapse;background:#14171f;border-radius:8px;">
                         <thead>
                             <tr>
                                 <th style="color:#a1a1aa;padding:8px 12px;text-align:left;">Name</th>
                                 <th style="color:#a1a1aa;padding:8px 12px;text-align:left;">File Size</th>
                                 <th style="color:#a1a1aa;padding:8px 12px;text-align:left;">Times Played</th>
                                 <th style="color:#a1a1aa;padding:8px 12px;text-align:left;">Max Uses</th>
                                 <th style="color:#a1a1aa;padding:8px 12px;text-align:left;">Actions</th>
                             </tr>
                         </thead>
                         <tbody id="adminTonesTableBody">
                             <tr><td colspan="3" style="text-align:center;color:#6b7280;padding:20px;">No tones uploaded yet</td></tr>
                         </tbody>
                     </table>
                 </div>
             </div>
             <div class="mdt-panel" style="margin-top:24px;">
                 <h3>Departments</h3>
                 <table id="adminDepartmentsTable" style="width:100%;margin-top:10px;border-collapse:collapse;background:#14171f;border-radius:8px;">
                     <thead>
                         <tr>
                             <th style="color:#a1a1aa;padding:8px 12px;text-align:left;">Code</th>
                             <th style="color:#a1a1aa;padding:8px 12px;text-align:left;">Name</th>
                             <th style="color:#a1a1aa;padding:8px 12px;text-align:left;">Actions</th>
                         </tr>
                     </thead>
                     <tbody>
                         <!-- Departments will be rendered here by JS -->
                     </tbody>
                 </table>
             </div>
            <div class="mdt-panel" style="margin-top:24px;">
                <!-- Discord Settings section removed as requested -->
            </div>
        </div>
    </section>

    <div class="overlay police-login-modal" id="policeLoginModal">
        <div class="modal">
            <button class="modal-close" id="closePoliceLogin"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
            <img src="https://cdn.discordapp.com/icons/1455410644634304725/75220689ed872e2ee4c7101f479813a5.webp?size=512" alt="Pulsecad" class="modal-logo">
            <h2>Police Login</h2>
            <p class="sub">Enter your officer information</p>
            <form id="policeLoginForm">
                <div class="field">
                    <label>Name</label>
                    <input type="text" id="officerName" placeholder="Enter your name" required>
                </div>
                <div class="field">
                    <label>Callsign</label>
                    <input type="text" id="officerCallsign" placeholder="e.g. 1B-01" required>
                </div>
                <div class="field">
                    <label>Rank</label>
                    <input type="text" id="officerRank" placeholder="e.g. Deputy, Sergeant" required>
                </div>
                <button type="submit" class="btn-primary" style="background:#22c55e;margin-top:12px;">Go on Duty</button>
            </form>
        </div>
    </div>

    <div class="overlay dispatch-login-modal" id="dispatchLoginModal">
        <div class="modal">
            <button class="modal-close" id="closeDispatchLogin"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
            <img src="https://cdn.discordapp.com/icons/1455410644634304725/75220689ed872e2ee4c7101f479813a5.webp?size=512" alt="Pulsecad" class="modal-logo">
            <h2>Dispatch Login</h2>
            <p class="sub">Enter your dispatcher information</p>
            <form id="dispatchLoginForm">
                <div class="field">
                    <label>Name</label>
                    <input type="text" id="dispatcherName" placeholder="Enter your name" required>
                </div>
                <div class="field">
                    <label>Callsign</label>
                    <input type="text" id="dispatcherCallsign" placeholder="e.g. 1L-01" required>
                </div>
                <button type="submit" class="btn-primary" style="background:#10b981;margin-top:12px;">Go on Duty</button>
            </form>
        </div>
    </div>

    <section class="staff-dashboard" id="staffDashboard" style="display:none;min-height:100vh;padding:30px;background:#0a0d14;flex-direction:row;">
        <!-- Staff Sidebar -->
         <div class="staff-sidebar" id="staffSidebar" style="position:relative;width:180px;margin-right:20px;">
             <button class="sidebar-btn active" id="communitiesNavBtn" data-page="communities">
                 <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                 Communities
             </button>
             <button class="sidebar-btn" id="usersNavBtn" data-page="users">
                 <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                 Users
             </button>
             <button class="sidebar-btn" id="activeUsersNavBtn" data-page="active-users">
                 <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                 Active Users
             </button>
             <button class="sidebar-btn" id="accessCodesNavBtn" data-page="access-codes">
                 <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                 Access Codes
             </button>
         </div>

        <div style="flex:1;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:30px;">
                <h2 style="font-size:24px;font-weight:600;">Staff Dashboard</h2>
                <div style="display:flex;gap:10px;">
                    <button id="globalRefreshBtn" style="padding:9px 20px;background:#22c55e;border:none;border-radius:8px;color:#fff;font-size:13px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:6px;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
                        Refresh
                    </button>
                    <button class="btn-back-community" id="backFromStaff">Back to Dashboard</button>
                </div>
            </div>

            <!-- Active Users Stat Card -->
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:30px;">
                <div style="background:#14171f;border:1px solid #1e222d;border-radius:8px;padding:24px;text-align:center;">
                    <div style="color:#a1a1aa;font-size:13px;font-weight:500;margin-bottom:12px;">Active Users</div>
                    <div id="activeUsersCount" style="font-size:48px;font-weight:700;color:#3b82f6;">0</div>
                </div>
            </div>

            <!-- Staff Pages Container -->
            <div class="staff-pages-container" id="staffPagesContainer">
                <!-- Communities Page -->
                <div class="staff-page" id="communitiesPage" style="display:block;width:100%;">
                    <div class="staff-page-header">All Communities</div>
                    <div class="staff-list" id="allCommunitiesList">
                        <div style="color: #a1a1aa; text-align: center; padding: 40px;">Loading communities...</div>
                    </div>
                </div>

                <!-- Users Page -->
                <div class="staff-page" id="usersPage" style="display:none;width:100%;">
                    <div class="staff-page-header">All Users</div>
                    <div class="staff-list" id="allUsersList">
                        <div style="color: #a1a1aa; text-align: center; padding: 40px;">Loading users...</div>
                    </div>
                </div>

                <!-- Active Users Page -->
                <div class="staff-page" id="activeUsersPage" style="display:none;width:100%;">
                    <div class="staff-page-header">Active Users</div>
                    <div class="staff-list" id="activeUsersList">
                        <div style="color: #a1a1aa; text-align: center; padding: 40px;">Loading active users...</div>
                    </div>
                </div>

                <!-- Access Codes Page -->
                <div class="staff-page" id="accessCodesPage" style="display:none;width:100%;">
                    <div class="staff-page-header">Access Codes</div>
                    <div class="staff-list" id="accessCodesList">
                        <div style="color: #a1a1aa; text-align: center; padding: 40px;">Loading access codes...</div>
                    </div>
                </div>
            </div>
            <div id="oldStaffContent" style="display:none;">
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-bottom:30px;">
                    <div class="mdt-panel">
                        <h3>Total Users</h3>
                        <div id="totalUsers" style="font-size:36px;font-weight:700;color:#3b82f6;text-align:center;margin-top:10px;">0</div>
                    </div>
                    <div class="mdt-panel">
                        <h3>Total Communities</h3>
                        <div id="totalCommunities" style="font-size:36px;font-weight:700;color:#22c55e;text-align:center;margin-top:10px;">0</div>
                    </div>
                    <div class="mdt-panel">
                        <h3>Total Characters</h3>
                        <div id="totalCharacters" style="font-size:36px;font-weight:700;color:#a855f7;text-align:center;margin-top:10px;">0</div>
                    </div>
                </div>
                <div class="mdt-panel" style="margin-bottom:20px;">
                    <h3>All Communities</h3>
                    <table class="calls-table" style="margin-top:16px;">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Code</th>
                            <th>Owner</th>
                            <th>Website</th>
                            <th>Plan</th>
                            <th>Actions</th>
                            <th>API</th>
                        </tr>
                    </thead>
                    <tbody id="staffCommunitiesTable">
                        <tr><td colspan="6" style="text-align:center;color:#6b7280;">Loading...</td></tr>
                    </tbody>
                    <script>
                    // ...existing code...
                    // Render Unlock API button in staff dashboard for each community
                    async function renderStaffCommunitiesTable() {
                        const { data: communities } = await db.from('communities').select('*');
                        const tbody = document.getElementById('staffCommunitiesTable');
                        if (!communities || communities.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#6b7280;">No communities found.</td></tr>';
                            return;
                        }
                        tbody.innerHTML = '';
                        for (const c of communities) {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td>${c.name}</td>
                                <td>${c.code}</td>
                                <td>${c.owner_id}</td>
                                <td>${c.website || ''}</td>
                                <td>${c.plan || ''}</td>
                                <td><!-- Actions here if needed --></td>
                                <td>
                                    <button class="btn-primary" style="padding:4px 12px;font-size:12px;${c.api_unlocked ? 'background:#22c55e;' : ''}" onclick="unlockApiForCommunity('${c.id}', this)" ${c.api_unlocked ? 'disabled' : ''}>${c.api_unlocked ? 'Unlocked' : 'Unlock API'}</button>
                                </td>
                            `;
                            tbody.appendChild(tr);
                        }
                    }
                    async function unlockApiForCommunity(communityId, btn) {
                        const { error } = await db.from('communities').update({ api_unlocked: true }).eq('id', communityId);
                        if (!error) {
                            btn.textContent = 'Unlocked';
                            btn.style.background = '#22c55e';
                            btn.disabled = true;
                            alert('API unlocked for this community!');
                        } else {
                            alert('Error unlocking API: ' + error.message);
                        }
                    }
                    // Call renderStaffCommunitiesTable() when staff dashboard is opened
                    // Always render the staff communities table when the staff dashboard is shown
                    function showStaffDashboard() {
                        document.getElementById('staffDashboard').style.display = 'block';
                        renderStaffCommunitiesTable();
                    }
                    document.getElementById('staffDashboardBtn').addEventListener('click', showStaffDashboard);
                    // Also call on navigation or reload if needed
                    // ...existing code...
                    </script>
                </table>
            </div>
            <div class="mdt-panel">
                <h3>All Users</h3>
                <table class="calls-table" style="margin-top:16px;">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Username</th>
                            <th>Display Name</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="staffUsersTable">
                        <tr><td colspan="5" style="text-align:center;color:#6b7280;">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="mdt-panel" style="margin-top:20px;">
                <h3>Access Codes</h3>
                <p style="color:#6b7280;font-size:13px;margin-bottom:16px;">Generate access codes for users to access the CAD</p>
                <div style="display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap;">
                    <input type="text" id="accessCodeNote" placeholder="Note (e.g. user name)" style="flex:1;min-width:140px;padding:10px 14px;background:#0c0e12;border:1px solid #27272a;border-radius:8px;color:#fafafa;font-size:13px;">
                    <input type="number" id="accessCodeDuration" min="1" placeholder="Duration (hours)" style="width:140px;padding:10px 14px;background:#0c0e12;border:1px solid #27272a;border-radius:8px;color:#fafafa;font-size:13px;">
                    <input type="number" id="accessCodeMaxUses" min="1" placeholder="Max uses ()" style="width:130px;padding:10px 14px;background:#0c0e12;border:1px solid #27272a;border-radius:8px;color:#fafafa;font-size:13px;">
                    <button class="btn-primary" id="generateAccessCode" style="background:#a855f7;">Generate Code</button>
                </div>
                <table class="calls-table" style="margin-top:16px;">
                    <thead>
                        <tr>
                            <th>Code</th>
                            <th>Note</th>
                            <th>Uses</th>
                            <th>Created</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="accessCodesTable">
                        <tr><td colspan="5" style="text-align:center;color:#6b7280;">No access codes yet</td></tr>
                    </tbody>
                </table>
                </div>
            </div>
        </div>
    </section>

    <!-- Discord Settings Modal -->
    <div class="staff-settings-modal" id="discordSettingsModal">
        <div class="staff-settings-content">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                <h3 style="margin:0;">Discord Settings</h3>
                <button class="modal-close" id="closeDiscordSettings"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
            </div>
            <div class="discord-settings-tabs" style="display:flex;gap:10px;margin-bottom:18px;">
                 <button class="discord-settings-tab active" id="discordSettingsTabBtn">Settings</button>
                 <button class="discord-settings-tab" id="charactersSettingsTabBtn">Characters</button>
             </div>
            <div class="discord-settings-panel" id="discordSettingsPanel">
                <div class="field">
                    <label>Discord Webhook URL</label>
                    <input type="text" id="discordWebhookUrl" placeholder="https://discord.com/api/webhooks/..." style="width:100%;padding:11px 13px;background:#0c0e12;border:1px solid #27272a;border-radius:8px;color:#fafafa;font-size:13px;">
                </div>
                <div class="field">
                    <label>Bot Token</label>
                    <input type="password" id="discordBotToken" placeholder="Enter bot token" style="width:100%;padding:11px 13px;background:#0c0e12;border:1px solid #27272a;border-radius:8px;color:#fafafa;font-size:13px;">
                </div>
                <div class="field">
                    <label>Server ID</label>
                    <input type="text" id="discordServerId" placeholder="Enter server ID" style="width:100%;padding:11px 13px;background:#0c0e12;border:1px solid #27272a;border-radius:8px;color:#fafafa;font-size:13px;">
                </div>
                <button class="btn-primary" id="saveDiscordSettings" style="margin-top:10px;">Save Settings</button>
            </div>
            <div class="discord-settings-panel" id="charactersSettingsPanel" style="display:none;max-height:400px;overflow-y:auto;">
                <h4 style="margin-bottom:10px;">Character Management</h4>
                <div class="characters-grid" id="adminCharactersGrid">
                    <!-- Character cards will be rendered here -->
                </div>
            </div>
            </div>
            </div>

    <!-- Accounts Modal -->
    <div class="staff-settings-modal" id="accountsModal">
        <div class="staff-settings-content">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                <h3 style="margin:0;">Accounts</h3>
                <button class="modal-close" id="closeAccountsModal"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
            </div>
            <p style="color:#6b7280;margin-bottom:16px;">Manage user accounts and access.</p>
            <div id="accountsListContainer">
                <p style="color:#6b7280;text-align:center;">Loading accounts...</p>
            </div>
        </div>
    </div>

    <!-- Permissions Key Modal -->
    <div class="staff-settings-modal" id="permissionsKeyModal">
        <div class="staff-settings-content">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                <h3 style="margin:0;">Permissions Key</h3>
                <button class="modal-close" id="closePermissionsKeyModal"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
            </div>
            <div class="field">
                <label>Current Permissions Key</label>
                <div style="display:flex;gap:10px;">
                    <input type="text" id="permissionsKeyDisplay" readonly style="flex:1;padding:11px 13px;background:#0c0e12;border:1px solid #27272a;border-radius:8px;color:#fafafa;font-size:13px;">
                    <button class="btn-primary" id="copyPermissionsKey" style="padding:11px 16px;">Copy</button>
                </div>
            </div>
            <div class="field" style="margin-top:16px;">
                <label>Generate New Key</label>
                <button class="btn-primary" id="generateNewKey" style="background:#f59e0b;">Generate New Permissions Key</button>
            </div>
            <p style="color:#ef4444;font-size:12px;margin-top:12px;">Warning: Generating a new key will invalidate the old one.</p>
        </div>
    </div>

    <!-- Public Roster Page -->
    <section id="publicRosterPage" style="display:none;min-height:100vh;padding:40px 20px;background:#0a0d14;">
        <div style="max-width:1000px;margin:0 auto;">
            <div style="text-align:center;margin-bottom:40px;">
                <img src="https://cdn.discordapp.com/icons/1455410644634304725/75220689ed872e2ee4c7101f479813a5.webp?size=512" alt="Pulsecad" style="width:64px;height:64px;border-radius:50%;margin-bottom:16px;">
                <h1 id="publicRosterTitle" style="font-size:28px;font-weight:700;color:#e4e4e7;margin-bottom:8px;">Department Roster</h1>
                <p id="publicRosterCommunity" style="color:#6b7280;font-size:14px;">Loading...</p>
            </div>
            <div style="background:#14171f;border:1px solid #1e222d;border-radius:12px;overflow:hidden;">
                <table style="width:100%;border-collapse:collapse;">
                    <thead>
                        <tr style="background:#1e222d;">
                            <th style="padding:14px 16px;text-align:left;font-size:12px;color:#a1a1aa;font-weight:600;">Name</th>
                            <th style="padding:14px 16px;text-align:left;font-size:12px;color:#a1a1aa;font-weight:600;">Rank</th>
                            <th style="padding:14px 16px;text-align:left;font-size:12px;color:#a1a1aa;font-weight:600;">Callsign</th>
                            <th style="padding:14px 16px;text-align:left;font-size:12px;color:#a1a1aa;font-weight:600;">Badge</th>
                            <th style="padding:14px 16px;text-align:left;font-size:12px;color:#a1a1aa;font-weight:600;">Department</th>
                            <th style="padding:14px 16px;text-align:left;font-size:12px;color:#a1a1aa;font-weight:600;">Status</th>
                        </tr>
                    </thead>
                    <tbody id="publicRosterBody">
                        <tr><td colspan="6" style="text-align:center;color:#6b7280;padding:40px;">Loading roster...</td></tr>
                    </tbody>
                </table>
            </div>
            <div style="text-align:center;margin-top:30px;">
                <a href="?" style="color:#3b82f6;font-size:13px;text-decoration:none;"> Back to Pulsecad</a>
            </div>
        </div>
    </section>

    <div id="maintenancePage" style="display:none;position:fixed;inset:0;background:#0c0e12;z-index:9999;align-items:center;justify-content:center;">
        <div style="text-align:center;padding:40px;">
            <img src="https://cdn.discordapp.com/icons/1455410644634304725/75220689ed872e2ee4c7101f479813a5.webp?size=512" alt="Pulsecad" style="width:80px;height:80px;border-radius:50%;margin-bottom:20px;">
            <h1 style="font-size:32px;font-weight:700;color:#e4e4e7;margin-bottom:12px;">Under Maintenance</h1>
            <p style="color:#6b7280;font-size:16px;">Pulsecad is currently undergoing maintenance. Please check back soon.</p>
        </div>
    </div>



    <section class="civilian-page" id="civilianPage">
        <div class="civilian-toolbar">
            <button class="toolbar-btn green" id="newCharacterBtn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                New Character
            </button>
            <button class="toolbar-btn teal" id="editCharacterBtn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                Edit Character
            </button>
            <button class="toolbar-btn gray" id="recordsBtn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                Records
            </button>
            <div class="toolbar-divider"></div>
            <button class="toolbar-btn orange" id="dmvBtn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="3" width="15" height="13" rx="2"/><path d="M16 8h4a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2v-2"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg>
                DMV
            </button>
            <button class="toolbar-btn red" id="call911Btn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
                911
            </button>
        </div>
        <div class="civilian-content">
            <div class="civilian-header">
                <h2>Civilian Portal</h2>
                <button class="btn-back-community" id="backFromCivilian">Back to Community</button>
            </div>
            <div class="civilian-tabs">
                <button class="civilian-tab active" data-tab="characters">My Characters</button>
                <button class="civilian-tab" data-tab="tickets">My Tickets</button>
            </div>
            <div class="tab-content active" id="charactersTab">
                <div class="characters-grid" id="charactersGrid">
                    <div class="no-characters">No characters yet. Click "New Character" to create one.</div>
                </div>
            </div>
            <div class="tab-content" id="ticketsTab">
                <div id="ticketsList">
                    <div class="no-tickets">No tickets issued to your characters.</div>
                </div>
            </div>
        </div>
    </section>

    <div class="overlay" id="newCharacterModal">
        <div class="modal" style="max-width:450px;">
            <button class="modal-close" id="closeNewCharacter"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
            <h2>New Character</h2>
            <p class="sub">Create a new civilian character</p>
            <form id="newCharacterForm">
                <div class="field">
                    <label>First Name</label>
                    <input type="text" id="charFirstName" placeholder="Enter first name" required>
                </div>
                <div class="field">
                    <label>Last Name</label>
                    <input type="text" id="charLastName" placeholder="Enter last name" required>
                </div>
                <div class="field">
                    <label>Date of Birth</label>
                    <input type="date" id="charDob" required>
                </div>
                <div class="field">
                    <label>Gender</label>
                    <select id="charGender" style="width:100%;padding:11px 13px;background:#0c0e12;border:1px solid #27272a;border-radius:8px;color:#fafafa;font-size:13px;font-family:inherit;">
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="field">
                    <label>Phone Number</label>
                    <input type="text" id="charPhone" placeholder="e.g. 555-1234">
                </div>
                <div class="modal-btns">
                    <button type="button" class="btn-cancel" id="cancelNewCharacter">Cancel</button>
                    <button type="submit" class="btn-confirm">Create</button>
                </div>
            </form>
        </div>
    </div>

    <div class="overlay" id="call911Modal">
        <div class="modal modal-sm">
            <button class="modal-close" id="closeCall911"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
            <h2 style="color:#ef4444;">Emergency 911 Call</h2>
            <form id="call911Form">
                <div class="field">
                    <label>Location</label>
                    <input type="text" id="emergency911Location" placeholder="Where is the emergency?" required>
                </div>
                <div class="field">
                    <label>Description</label>
                    <textarea id="emergency911Desc" placeholder="Describe the emergency..." rows="4" style="width:100%;padding:11px 13px;background:#0c0e12;border:1px solid #27272a;border-radius:8px;color:#fafafa;font-size:13px;font-family:inherit;resize:vertical;"></textarea>
                </div>
                <div class="modal-btns">
                    <button type="button" class="btn-cancel" id="cancelCall911">Cancel</button>
                    <button type="submit" class="btn-confirm" style="background:#ef4444;">Call 911</button>
                </div>
            </form>
        </div>
    </div>

    <div class="overlay" id="lookupModal">
        <div class="modal" style="max-width:500px;">
            <button class="modal-close" id="closeLookup"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
            <h2>Civilian Lookup</h2>
            <p class="sub">Search for civilian records</p>
            <div style="display:flex;gap:10px;">
                <div class="field" style="flex:1;">
                    <label>First Name</label>
                    <input type="text" id="lookupFirstName" placeholder="First name">
                </div>
                <div class="field" style="flex:1;">
                    <label>Last Name</label>
                    <input type="text" id="lookupLastName" placeholder="Last name">
                </div>
            </div>
            <button type="button" class="btn-primary" id="lookupSearchBtn" style="width:100%;margin-top:10px;">Search</button>
            <div style="display:flex;gap:10px;margin-top:20px;">
                <button type="button" class="btn-primary" id="issueCitationBtn">Issue Citation</button>
                <button type="button" class="btn-primary" id="issueWarrantBtn" style="background:#dc2626;">Issue Warrant</button>
            </div>
                <div class="overlay" id="warrantModal" style="display:none;">
                    <div class="modal" style="max-width:520px;">
                        <button class="modal-close" id="closeWarrant"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
                        <h2 style="color:#dc2626;">Issue Warrant</h2>
                        <p class="sub">Fill out the warrant details for: <span id="warrantCivilianName" style="color:#e4e4e7;font-weight:600;"></span></p>
                        <form id="warrantForm">
                            <input type="hidden" id="warrantCivilianId">
                            <div class="field">
                                <label>Warrant Type</label>
                                <select id="warrantType" style="width:100%;padding:11px 13px;background:#0c0e12;border:1px solid #27272a;border-radius:8px;color:#fafafa;font-size:13px;font-family:inherit;">
                                    <option value="Arrest">Arrest</option>
                                    <option value="Search">Search</option>
                                    <option value="Bench">Bench</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="field">
                                <label>Reason</label>
                                <input type="text" id="warrantReason" placeholder="Reason for warrant" required>
                            </div>
                            <div class="field">
                                <label>Location</label>
                                <input type="text" id="warrantLocation" placeholder="Location related to warrant" required>
                            </div>
                            <div class="field">
                                <label>Judge Name</label>
                                <input type="text" id="warrantJudge" placeholder="Judge's name" required>
                            </div>
                            <div class="field">
                                <label>Officer Name</label>
                                <input type="text" id="warrantOfficer" placeholder="Issuing officer's name" required>
                            </div>
                            <div class="field">
                                <label>Expiration Date</label>
                                <input type="date" id="warrantExpiration" required>
                            </div>
                            <button type="submit" class="btn-primary" style="background:#dc2626;margin-top:16px;">Submit Warrant</button>
                        </form>
                        <!-- Warrant link section removed -->
                    </div>
                </div>
                <script>
                // ...existing code...
                document.getElementById('issueWarrantBtn').onclick = () => {
                    document.getElementById('warrantModal').style.display = 'block';
                    // Optionally set civilian name if available
                    const name = document.getElementById('lookupFirstName').value + ' ' + document.getElementById('lookupLastName').value;
                    document.getElementById('warrantCivilianName').textContent = name.trim();
                };
                document.getElementById('closeWarrant').onclick = () => {
                    document.getElementById('warrantModal').style.display = 'none';
                    document.getElementById('warrantForm').reset();
                    document.getElementById('warrantLinkSection').style.display = 'none';
                };
                document.getElementById('warrantForm').onsubmit = async function(e) {
                    e.preventDefault();
                    // Gather warrant data
                    const warrantData = {
                        civilian_id: document.getElementById('warrantCivilianId').value || Math.random().toString(36).substr(2, 8),
                        civilian_name: document.getElementById('warrantCivilianName').textContent,
                        type: document.getElementById('warrantType').value,
                        reason: document.getElementById('warrantReason').value,
                        location: document.getElementById('warrantLocation').value,
                        judge: document.getElementById('warrantJudge').value,
                        officer: document.getElementById('warrantOfficer').value,
                        expiration: document.getElementById('warrantExpiration').value,
                        issued_at: new Date().toISOString()
                    };
                    // Save to Supabase
                    const { data, error } = await supabase
                        .from('warrants')
                        .insert([warrantData]);
                    if (error) {
                        alert('Error saving warrant: ' + error.message);
                    } else {
                        alert('Warrant submitted and saved!');
                        document.getElementById('warrantModal').style.display = 'none';
                        document.getElementById('warrantForm').reset();
                    }
                };
                const copyWarrantLink = document.getElementById('copyWarrantLink');
                if (copyWarrantLink) {
                    copyWarrantLink.onclick = function() {
                        const linkInput = document.getElementById('warrantLink');
                        if (linkInput) {
                            linkInput.select();
                            document.execCommand('copy');
                            alert('Warrant link copied!');
                        }
                    };
                }
                // ...existing code...
                </script>
            <div id="lookupResults" style="margin-top:20px;">
                <div class="section-label">Results</div>
                <div id="lookupResultsList" style="max-height:300px;overflow-y:auto;"></div>
            </div>
        </div>
    </div>

    <div class="overlay" id="ticketModal">
        <div class="modal" style="max-width:500px;">
            <button class="modal-close" id="closeTicket"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
            <h2 style="color:#f97316;">Issue Citation/Ticket</h2>
            <p class="sub">Issue a ticket to: <span id="ticketCivilianName" style="color:#e4e4e7;font-weight:600;"></span></p>
            <form id="ticketForm">
                <input type="hidden" id="ticketCivilianId">
                <div class="field">
                    <label>Ticket Type</label>
                    <select id="ticketType" style="width:100%;padding:11px 13px;background:#0c0e12;border:1px solid #27272a;border-radius:8px;color:#fafafa;font-size:13px;font-family:inherit;">
                        <option value="Speeding">Speeding</option>
                        <option value="Reckless Driving">Reckless Driving</option>
                        <option value="Running Red Light">Running Red Light</option>
                        <option value="Illegal Parking">Illegal Parking</option>
                        <option value="Failure to Yield">Failure to Yield</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="field">
                    <label>Location</label>
                    <input type="text" id="ticketLocation" placeholder="Location of offense" required>
                </div>
                <div class="field">
                    <label>Fine Amount ($)</label>
                    <input type="number" id="ticketFine" placeholder="e.g. 150" required>
                </div>
                <div class="field">
                    <label>Charges</label>
                    <div class="charges-list" id="chargesList">
                        <div class="charge-item">
                            <input type="text" class="charge-input" placeholder="Enter charge (e.g. 10+ MPH over limit)">
                            <button type="button" class="btn-remove-charge" onclick="this.parentElement.remove()"></button>
                        </div>
                    </div>
                    <button type="button" class="btn-add-charge" id="addChargeBtn">+ Add Charge</button>
                </div>
                <div class="field">
                    <label>Notes</label>
                    <textarea id="ticketNotes" placeholder="Additional notes..." rows="2" style="width:100%;padding:11px 13px;background:#0c0e12;border:1px solid #27272a;border-radius:8px;color:#fafafa;font-size:13px;font-family:inherit;resize:vertical;"></textarea>
                </div>
                <div class="field">
                    <label>Officer E-Signature</label>
                    <canvas id="signaturePad" class="signature-pad"></canvas>
                    <div class="signature-actions">
                        <button type="button" class="btn-clear-sig" id="clearSignature">Clear Signature</button>
                    </div>
                </div>
                <div class="modal-btns">
                    <button type="button" class="btn-cancel" id="cancelTicket">Cancel</button>
                    <button type="submit" class="btn-confirm" style="background:#f97316;">Issue Ticket</button>
                </div>
            </form>
        </div>
    </div>

    <div class="overlay" id="createCallModal">
        <div class="modal modal-sm">
            <button class="modal-close" id="closeCreateCall"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
            <h2>Create Call</h2>
            <form id="createCallForm">
                <div class="field">
                    <label>Call Number</label>
                    <input type="text" id="callNumber" readonly style="background:#1e293b;color:#6b7280;">
                </div>
                <div class="field">
                    <label>Call Type</label>
                    <input type="text" id="callType" placeholder="e.g. Traffic Stop, Domestic" required>
                </div>
                <div class="field">
                    <label>Location</label>
                    <input type="text" id="callLocation" placeholder="Enter location" required>
                </div>
                <div class="field">
                    <label>Postal</label>
                    <input type="text" id="callPostal" placeholder="Enter postal code" required>
                </div>
                <div class="modal-btns">
                    <button type="button" class="btn-cancel" id="cancelCreateCall">Cancel</button>
                    <button type="submit" class="btn-confirm">Create</button>
                </div>
            </form>
        </div>
    </div>

    <div class="overlay" id="createBoloModal">
        <div class="modal modal-sm">
            <button class="modal-close" id="closeCreateBolo"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
            <h2 style="color:#f59e0b;">Create BOLO</h2>
            <p class="sub">Be On the Lookout</p>
            <form id="createBoloForm">
                <div class="field">
                    <label>Type</label>
                    <select id="boloType" style="width:100%;padding:11px 13px;background:#0c0e12;border:1px solid #27272a;border-radius:8px;color:#fafafa;font-size:13px;font-family:inherit;">
                        <option value="Person">Person</option>
                        <option value="Vehicle">Vehicle</option>
                    </select>
                </div>
                <div class="field">
                    <label>Details</label>
                    <textarea id="boloDetails" placeholder="Enter BOLO details (description, plate, clothing, etc.)" rows="4" style="width:100%;padding:11px 13px;background:#0c0e12;border:1px solid #27272a;border-radius:8px;color:#fafafa;font-size:13px;font-family:inherit;resize:vertical;" required></textarea>
                </div>
                <div class="modal-btns">
                    <button type="button" class="btn-cancel" id="cancelCreateBolo">Cancel</button>
                    <button type="submit" class="btn-confirm" style="background:#f59e0b;">Create BOLO</button>
                </div>
            </form>
        </div>
    </div>

    <section class="police-mdt" id="policeMdt">
        <div class="mdt-header">
            <h2>Police MDT</h2>
            <button class="btn-off-duty" id="offDutyBtn">Go Off Duty</button>
        </div>
        <div class="mdt-grid">
            <div class="mdt-panel">
                <h3>Officer Information</h3>
                <div class="officer-timer" id="dutyTimer">00:00:00</div>
                <div class="officer-info-item">
                    <div class="label">Identifier</div>
                    <div class="value" id="mdtCallsign">1B-01</div>
                </div>
                <div class="officer-info-item">
                    <div class="label">Department</div>
                    <div class="value" id="mdtDepartment">BCSO</div>
                </div>
                <div class="officer-info-item">
                    <div class="label">Status</div>
                    <div class="value"><span class="status-badge status-10-8" id="currentStatus">10-8</span></div>
                </div>
                <div class="officer-info-item">
                    <div class="label">Subdivision</div>
                    <div class="value" id="mdtSubdivision">None</div>
                </div>
            </div>
            <div class="mdt-panel">
                <h3>Control Panel</h3>
                <div class="control-section">
                    <div class="section-label">Status Controls</div>
                    <div class="status-buttons">
                        <button class="status-btn green" data-status="10-8">10-8 | In Service</button>
                        <button class="status-btn red" data-status="10-7">10-7 | Out of Service</button>
                    </div>
                </div>
                <div class="control-section">
                    <div class="status-buttons">
                        <button class="status-btn yellow" data-status="10-6">10-6 | Busy</button>
                        <button class="status-btn yellow" data-status="10-6">10-6 | Busy / Unavailable</button>
                        <button class="status-btn blue" data-status="10-11">10-11 | Traffic Stop</button>
                        <button class="status-btn blue" data-status="10-15">10-15 | Subject in Custody</button>
                        <button class="status-btn blue" data-status="10-23">10-23 | Arrived on Scene</button>
                    </div>
                </div>
                <div class="control-section">
                    <div class="status-buttons">
                        <button class="status-btn orange" data-status="10-26">10-26 | Detaining Subject</button>
                        <button class="status-btn orange" data-status="10-45">10-45 | Meal Break</button>
                        <button class="status-btn orange" data-status="10-97">10-97 | En Route to Scene</button>
                    </div>
                </div>
                <div class="control-section">
                    <div class="status-buttons">
                        <button class="status-btn red" data-status="10-99">10-99 | Emergency</button>
                        <button class="status-btn purple" data-status="Signal 11">Signal 11 | Running Radar</button>
                        <button class="status-btn purple" data-status="Signal 7">Signal 7 | Investigation</button>
                        <button class="status-btn red" data-status="PANIC">Panic Button</button>
                    </div>
                </div>
                <div class="control-section">
                    <div class="section-label">Quick Actions</div>
                    <div class="quick-actions">
                        <button class="quick-btn">10 Codes</button>
                        <button class="quick-btn">Notepad</button>
                        <button class="quick-btn">Select Subdivision</button>
                        <button class="quick-btn" id="createBoloBtn">Create Bolo</button>
                        <button class="quick-btn" id="createCallBtn">Create Call</button>
                        <button class="quick-btn" id="lookupBtn">Lookup</button>
                        <button class="quick-btn" id="policeLiveMap" style="background:#22c55e;color:#fff;">Live Map <span style="background:#f59e0b;color:#000;font-size:8px;padding:1px 4px;border-radius:3px;margin-left:4px;">BETA</span></button>
                    </div>
                </div>
            </div>
            <div class="mdt-panel">
                <h3>Live Chat</h3>
                <div class="chat-messages" id="chatMessages">
                    <div class="chat-message"><span class="time">10:41 AM</span> <span class="text">test</span></div>
                </div>
                <div class="chat-input-wrap">
                    <input type="text" class="chat-input" id="chatInput" placeholder="Type a message...">
                    <button class="chat-send" id="chatSend">Send</button>
                </div>
            </div>
        </div>
        <div class="mdt-bottom-grid">
            <div class="mdt-panel">
                <h3>Active Units</h3>
                <table class="calls-table">
                    <thead>
                        <tr>
                            <th>Callsign</th>
                            <th>Name</th>
                            <th>Status</th>
                            <th>Subdivision</th>
                        </tr>
                    </thead>
                    <tbody id="activeUnitsTableBody">
                        
                    </tbody>
                </table>
            </div>
            <div class="mdt-panel">
                <h3>Your Calls</h3>
                <table class="calls-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Type</th>
                            <th>Location</th>
                            <th>Postal</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="callsTableBody">
                        
                    </tbody>
                </table>
            </div>
            <div class="mdt-panel">
                <h3>Active Bolos</h3>
                <table class="bolos-table">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Details</th>
                            <th>Date & Time</th>
                            <th>Issued By</th>
                        </tr>
                    </thead>
                    <tbody id="bolosTableBody">
                        
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Assign Units to Call Modal -->
    <div class="overlay" id="assignUnitsModal">
        <div class="modal modal-sm">
            <button class="modal-close" id="closeAssignUnits"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
            <h2>Assign Units to Call</h2>
            <p class="sub">Select a call and units to assign</p>
            <div class="field">
                <label>Select Call</label>
                <select id="assignCallSelect" style="width:100%;padding:11px 13px;background:#0c0e12;border:1px solid #27272a;border-radius:8px;color:#fafafa;font-size:13px;font-family:inherit;">
                    <option value="">-- Select a Call --</option>
                </select>
            </div>
            <div class="field">
                <label>Select Units</label>
                <div id="assignUnitsCheckboxes" style="max-height:200px;overflow-y:auto;background:#0c0e12;border:1px solid #27272a;border-radius:8px;padding:10px;"></div>
            </div>
            <div class="modal-btns">
                <button type="button" class="btn-cancel" id="cancelAssignUnits">Cancel</button>
                <button type="button" class="btn-confirm" id="confirmAssignUnits">Assign</button>
            </div>
        </div>
    </div>

    <section class="dispatch-mdt" id="dispatchMdt">
        <button class="dispatch-off-duty" id="dispatchOffDutyBtn">Go Off Duty</button>
        <div class="dispatch-header">
            <div class="identifier"><span>Identifier:</span> <span id="dispatchIdentifier">[1L-01] Dispatcher</span></div>
            <div class="status"><span>Status:</span> <span id="dispatchStatus">10-8</span></div>
        </div>

        <div class="dispatch-actions">
            <button class="dispatch-btn green" id="dispatch10-8">10-8 | In Service</button>
            <button class="dispatch-btn orange" id="dispatch10-7">10-7 | Out of Service</button>
            <button class="dispatch-btn cyan" id="dispatchSignal100">Activate Signal 100</button>
            <button class="dispatch-btn red" id="dispatchDisablePanics">Disable All Panics</button>
        </div>

        <div class="dispatch-actions">
            <button class="dispatch-btn cyan" id="dispatchChangeStatus">Change Unit Status</button>
            <button class="dispatch-btn green" id="dispatchCreateBolo">Create Bolo</button>
            <button class="dispatch-btn blue" id="dispatchCreateCall">Create Call</button>
            <button class="dispatch-btn orange" id="dispatchAssignUnits">Assign Units to Call</button>
        </div>

        <div class="dispatch-actions">
            <button class="dispatch-btn blue" id="dispatchPenalCode">Penal Code</button>
            <button class="dispatch-btn green" id="dispatchLiveMap">Live Map <span style="background:#f59e0b;color:#000;font-size:8px;padding:1px 4px;border-radius:3px;margin-left:4px;">BETA</span></button>
            <button class="dispatch-btn orange" id="dispatchNotepad">Notepad</button>
        </div>

        <div class="dispatch-panels">
            <div class="dispatch-panel">
                <h3>Active LEO Units</h3>
                <table class="dispatch-table">
                    <thead>
                        <tr>
                            <th>Unit Identifier</th>
                            <th>Current Status</th>
                            <th>Current Division</th>
                            <th>Assigned Call #</th>
                        </tr>
                    </thead>
                    <tbody id="dispatchLeoUnits">
                    </tbody>
                </table>
            </div>

            <div class="dispatch-panel">
                <h3>Officers in Police Panel</h3>
                <table class="dispatch-table">
                    <thead>
                        <tr>
                            <th>Unit Identifier</th>
                            <th>Officer Name</th>
                            <th>Rank</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="dispatchOfficersInPanel">
                        <tr><td colspan="4" style="text-align:center;color:#6b7280;">No officers in panel</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="dispatch-panel">
                <h3>Active Calls</h3>
                <table class="dispatch-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Type</th>
                            <th>Location & Postal</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="dispatchActiveCalls">
                    </tbody>
                </table>
            </div>

            <div class="dispatch-panel">
                <h3>Active EMS/FIRE Units</h3>
                <table class="dispatch-table">
                    <thead>
                        <tr>
                            <th>Unit Identifier</th>
                            <th>Current Status</th>
                            <th>Current Division</th>
                            <th>Assigned Call #</th>
                        </tr>
                    </thead>
                    <tbody id="dispatchEmsUnits">
                    </tbody>
                </table>
            </div>

            <div class="dispatch-panel">
                <h3>Active Bolos</h3>
                <div class="no-bolos" id="dispatchNoBolos">Great :) No Current Bolo's</div>
                <table class="dispatch-table" id="dispatchBolosTable" style="display:none;">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Details</th>
                            <th>Issued By</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="dispatchBolos">
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Live Map Modal -->
    <div class="overlay" id="liveMapModal">
        <div class="live-map-container">
            <div class="live-map-header">
                <h2>ERLC Live Map <span style="background:linear-gradient(135deg,#f59e0b,#d97706);color:#000;font-size:10px;font-weight:700;padding:2px 8px;border-radius:4px;text-transform:uppercase;vertical-align:middle;">BETA</span></h2>
                <div class="live-map-controls">
                    <span id="liveMapPlayerCount">0 players online</span>
                    <span id="liveMapLastUpdate" style="color:#6b7280;font-size:11px;"></span>
                    <button id="testLiveMap" style="padding:6px 14px;background:#f97316;border:none;border-radius:6px;color:#fff;font-size:12px;cursor:pointer;">Test Map</button>
                    <button class="modal-close" id="closeLiveMap"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
                </div>
            </div>
            <div class="live-map-content">
                <div class="live-map-wrapper" id="liveMapWrapper">
                    <canvas id="liveMapCanvas" class="live-map-image" width="1024" height="1024"></canvas>
                    <div id="liveMapPlayers"></div>
                </div>
                <div class="live-map-sidebar">
                    <h3>Players Online</h3>
                    <div class="live-map-legend" style="display:flex;gap:12px;margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid #1e293b;">
                        <div style="display:flex;align-items:center;gap:4px;font-size:11px;color:#6b7280;">
                            <span style="width:8px;height:8px;background:#3b82f6;border-radius:50%;"></span> Police
                        </div>
                        <div style="display:flex;align-items:center;gap:4px;font-size:11px;color:#6b7280;">
                            <span style="width:8px;height:8px;background:#ef4444;border-radius:50%;"></span> Fire
                        </div>
                        <div style="display:flex;align-items:center;gap:4px;font-size:11px;color:#6b7280;">
                            <span style="width:8px;height:8px;background:#22c55e;border-radius:50%;"></span> Civilian
                        </div>
                    </div>
                    <div id="liveMapPlayerList" class="live-map-player-list">
                        <p style="color:#6b7280;font-size:13px;">No API key configured</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://lfyooplqmyrqebefiomf.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxmeW9vcGxxbXlycWViZWZpb21mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2NjY2NjUsImV4cCI6MjA4MzI0MjY2NX0.j7ORtHhF2qWSJEhURXd2891JKUP9umijCo3SaDHTmGA';
        const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Maintenance mode disabled
        async function checkMaintenanceMode() {
            // Disabled
        }
        checkMaintenanceMode();

        const body = document.body;
        const authModal = document.getElementById('authModal');
        const createModal = document.getElementById('createModal');
        const loginPanel = document.getElementById('loginPanel');
        const registerPanel = document.getElementById('registerPanel');
        const openLogin = document.getElementById('openLogin');
        const closeAuth = document.getElementById('closeAuth');
        const showRegister = document.getElementById('showRegister');
        const showLogin = document.getElementById('showLogin');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const loginError = document.getElementById('loginError');
        const loginSuccess = document.getElementById('loginSuccess');
        const registerError = document.getElementById('registerError');
        const navUsername = document.getElementById('navUsername');
        const logoutBtn = document.getElementById('logoutBtn');
        const createCommunityBtn = document.getElementById('createCommunity');
        const cancelCreate = document.getElementById('cancelCreate');
        const createCommunityForm = document.getElementById('createCommunityForm');
        const communityList = document.getElementById('communityList');
        const joinModal = document.getElementById('joinModal');
        const joinCommunityBtn = document.getElementById('joinCommunity');
        const cancelJoin = document.getElementById('cancelJoin');
        const joinCommunityForm = document.getElementById('joinCommunityForm');
        const joinError = document.getElementById('joinError');
        const communityScreen = document.getElementById('communityScreen');
        const communityViewName = document.getElementById('communityViewName');
        const communityViewCode = document.getElementById('communityViewCode');
        const dashboardSection = document.getElementById('dashboardSection');

        let currentUser = null;

        const homeBtn = document.getElementById('homeBtn');
        const pricesBtn = document.getElementById('pricesBtn');
        const pricingSection = document.getElementById('pricingSection');
        const heroSection = document.getElementById('heroSection');
        const backFromPricing = document.getElementById('backFromPricing');
        const teamBtn = document.getElementById('teamBtn');
        const teamSection = document.getElementById('teamSection');
        const backFromTeam = document.getElementById('backFromTeam');

        homeBtn.onclick = () => {
            pricingSection.classList.remove('active');
            teamSection.classList.remove('active');
            heroSection.style.display = 'flex';
        };

        pricesBtn.onclick = () => {
            pricingSection.classList.add('active');
            teamSection.classList.remove('active');
            heroSection.style.display = 'none';
        };

        backFromPricing.onclick = () => {
            pricingSection.classList.remove('active');
            heroSection.style.display = 'flex';
        };

        teamBtn.onclick = () => {
            teamSection.classList.add('active');
            pricingSection.classList.remove('active');
            heroSection.style.display = 'none';
        };

        backFromTeam.onclick = () => {
            teamSection.classList.remove('active');
            heroSection.style.display = 'flex';
        };

        async function loadCommunities() {
            if (!currentUser) {
                communityList.innerHTML = '<div class="empty">No communities yet</div>';
                return;
            }
            
            const { data: owned, error: ownedError } = await db
                .from('communities')
                .select('*')
                .eq('owner_id', currentUser.id);
            
            if (ownedError) console.error('Error loading owned communities:', ownedError);
            
            const { data: memberOf, error: memberError } = await db
                .from('community_members')
                .select('community_id, communities(id, name, website, code, owner_id, banner_url, suspended)')
                .eq('user_id', currentUser.id);
            
            if (memberError) console.error('Error loading joined communities:', memberError);
            
            const ownedCommunities = (owned || []).map(c => ({ ...c, type: 'owned' }));
            const joinedCommunities = (memberOf || [])
                .filter(m => m.communities)
                .map(m => ({ ...m.communities, type: 'joined' }));
            
            const all = [...ownedCommunities, ...joinedCommunities];
            
            if (all.length === 0) {
                communityList.innerHTML = '<div class="empty">No communities yet</div>';
                return;
            }
            
            communityList.innerHTML = all.map(c => `
                <div class="item" data-id="${c.id}" data-type="${c.type}" style="position:relative;overflow:hidden;border-radius:8px;">
                    ${c.banner_url ? `<img src="${c.banner_url}" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;opacity:0.3;z-index:0;">` : ''}
                    <div class="item-info" style="position:relative;z-index:1;">
                        <div class="item-name">${c.name} <span style="color:#52525b;font-size:11px;">${c.type === 'owned' ? '(Owner)' : '(Member)'}</span></div>
                        ${c.website ? `<a href="${c.website}" target="_blank" class="item-url">${c.website}</a>` : ''}
                        <!-- Code display removed from community item -->
                                    <!-- Staff Dashboard button removed from community items -->
                        ${c.official_partner ? '<div style="margin-top:4px;background:#3b2c00;color:#ffb300;padding:2px 8px;border-radius:4px;font-size:12px;">Pulsecad Official Partner</div>' : ''}
                    </div>
                    <div style="position:relative;z-index:2;display:flex;gap:8px;">
                        <button class="btn-enter" data-id="${c.id}" data-name="${c.name}" data-code="${c.code}" data-website="${c.website || ''}" style="${c.suspended ? 'opacity:0.5;cursor:not-allowed;' : ''}" ${c.suspended ? 'disabled' : ''}>${c.suspended ? 'Suspended' : 'Enter'}</button>
                        ${c.type === 'owned' ? `<button class="btn-delete-community" data-id="${c.id}" title="Delete Community" style="padding:11px;background:#ef4444;border:none;border-radius:8px;color:#fff;font-size:13px;font-weight:600;cursor:pointer;font-family:inherit;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16" style="display:block;"><path d="M3 6h18M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2m3 0v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6h16zM10 11v6M14 11v6"/></svg>
                        </button>` : `<button class="btn-leave-community" data-id="${c.id}" title="Leave Community" style="padding:11px;background:#6b7280;border:none;border-radius:8px;color:#fff;font-size:13px;font-weight:600;cursor:pointer;font-family:inherit;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16" style="display:block;"><path d="M9 3h-2a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h2M15 17l4-4m0 0l-4-4m4 4H9"/></svg>
                        </button>`}
                    </div>
                </div>
            `).join('');

            document.querySelectorAll('.btn-enter').forEach(btn => {
                btn.onclick = () => openCommunity(btn.dataset.id, btn.dataset.name, btn.dataset.code, btn.dataset.website);
            });

            document.querySelectorAll('.btn-delete-community').forEach(btn => {
                btn.onclick = async (e) => {
                    e.stopPropagation();
                    if (confirm('Are you sure you want to delete this community? This action cannot be undone.')) {
                        try {
                            const communityId = btn.dataset.id;
                            const { error } = await db.from('communities').delete().eq('id', communityId);
                            if (error) throw error;
                            loadCommunities();
                        } catch (err) {
                            console.error('Error deleting community:', err);
                            alert('Failed to delete community');
                        }
                    }
                };
            });

            document.querySelectorAll('.btn-leave-community').forEach(btn => {
                btn.onclick = async (e) => {
                    e.stopPropagation();
                    if (confirm('Are you sure you want to leave this community?')) {
                        try {
                            const communityId = btn.dataset.id;
                            const { error } = await db.from('community_members').delete().eq('community_id', communityId).eq('user_id', currentUser.id);
                            if (error) throw error;
                            loadCommunities();
                        } catch (err) {
                            console.error('Error leaving community:', err);
                            alert('Failed to leave community');
                        }
                    }
                };
            });
        }

        async function openCommunity(id, name, code, website) {
             // Check if community is suspended
             const { data: community } = await db.from('communities').select('suspended').eq('id', id).single();
             if (community && community.suspended) {
                 alert('This community is suspended and cannot be accessed');
                 return;
             }
             
             currentCommunityId = id;
             currentErlcApiKey = '';
             // Show only CAD page
             document.getElementById('userHubSection').style.display = 'none';
             dashboardSection.classList.add('hidden');
             communityScreen.classList.add('active');
             body.classList.add('in-community');
             // Optionally set community name
             communityViewName.textContent = name;
             
             // Load and display community banner
             const bannerImg = document.getElementById('communityBannerImage');
             const bannerOverlay = document.getElementById('bannerOverlay');
             const bannerCommunityName = document.getElementById('bannerCommunityName');
             const { data } = await db.from('communities').select('banner_url').eq('id', id).single();
             
             if (data && data.banner_url) {
                 bannerImg.src = data.banner_url;
                 bannerImg.style.display = 'block';
                 bannerCommunityName.textContent = name;
                 bannerOverlay.style.display = 'flex';
             } else {
                 bannerImg.style.display = 'none';
                 bannerOverlay.style.display = 'none';
             }
         }

        let currentCommunityId = null;
        let currentErlcApiKey = ''; // ERLC API key for current community (stored in SQL)
        let isPulseStaff = false; // Whether current user is PulseCAD staff

        const backToDashboard = document.getElementById('backToDashboard');
        backToDashboard.onclick = () => {
            communityScreen.classList.remove('active');
            document.getElementById('userHubSection').style.display = 'block';
            dashboardSection.classList.remove('hidden');
            body.classList.remove('in-community');
        };

        openLogin.onclick = () => authModal.classList.add('active');
        closeAuth.onclick = () => { authModal.classList.remove('active'); resetAuthForms(); };
        authModal.onclick = e => { if (e.target === authModal) { authModal.classList.remove('active'); resetAuthForms(); } };

        function resetAuthForms() {
            loginForm.reset(); registerForm.reset();
            loginError.style.display = 'none'; loginSuccess.style.display = 'none'; registerError.style.display = 'none';
            loginPanel.classList.add('active'); registerPanel.classList.remove('active');
        }

        showRegister.onclick = () => { loginPanel.classList.remove('active'); registerPanel.classList.add('active'); loginError.style.display = 'none'; loginSuccess.style.display = 'none'; };
        showLogin.onclick = () => { registerPanel.classList.remove('active'); loginPanel.classList.add('active'); registerError.style.display = 'none'; };

        if (createCommunityBtn) {
            createCommunityBtn.onclick = () => createModal.classList.add('active');
        }
        cancelCreate.onclick = () => { createModal.classList.remove('active'); createCommunityForm.reset(); };
        createModal.onclick = e => { if (e.target === createModal) { createModal.classList.remove('active'); createCommunityForm.reset(); } };

        createCommunityForm.onsubmit = async e => {
            e.preventDefault();
            const name = document.getElementById('communityName').value.trim();
            const website = document.getElementById('communityWebsite').value.trim();
            const code = Math.random().toString(36).substr(2, 8).toUpperCase();
            
            const { data, error } = await db
                .from('communities')
                .insert([{ name, website, code, owner_id: currentUser.id }])
                .select();
            
            if (error) {
                alert('Error creating community: ' + error.message);
                return;
            }
            
            createModal.classList.remove('active');
            createCommunityForm.reset();
            loadCommunities();
        };

        if (joinCommunityBtn) {
            joinCommunityBtn.onclick = () => joinModal.classList.add('active');
        }
        document.getElementById('hubJoinCommunity').onclick = () => joinModal.classList.add('active');
        cancelJoin.onclick = () => { joinModal.classList.remove('active'); joinCommunityForm.reset(); joinError.style.display = 'none'; };
        joinModal.onclick = e => { if (e.target === joinModal) { joinModal.classList.remove('active'); joinCommunityForm.reset(); joinError.style.display = 'none'; } };

        joinCommunityForm.onsubmit = async e => {
            e.preventDefault();
            const code = document.getElementById('joinCode').value.trim().toUpperCase();
            
            const { data: community, error: findError } = await db
                .from('communities')
                .select('*')
                .eq('code', code)
                .single();
            
            if (findError || !community) {
                joinError.textContent = 'Community not found';
                joinError.style.display = 'block';
                return;
            }
            
            if (community.suspended) {
                joinError.textContent = 'This community is suspended';
                joinError.style.display = 'block';
                return;
            }
            
            if (community.owner_id === currentUser.id) {
                joinError.textContent = 'You already own this community';
                joinError.style.display = 'block';
                return;
            }
            
            const { data: existing } = await db
                .from('community_members')
                .select('*')
                .eq('community_id', community.id)
                .eq('user_id', currentUser.id)
                .single();
            
            if (existing) {
                joinError.textContent = 'Already a member of this community';
                joinError.style.display = 'block';
                return;
            }
            
            const { error: joinErr } = await db
                .from('community_members')
                .insert([{ community_id: community.id, user_id: currentUser.id }]);
            
            if (joinErr) {
                joinError.textContent = 'Error joining community: ' + joinErr.message;
                joinError.style.display = 'block';
                return;
            }
            
            joinModal.classList.remove('active');
            joinCommunityForm.reset();
            joinError.style.display = 'none';
            loadCommunities();
        };

        registerForm.onsubmit = async e => {
            e.preventDefault();
            const username = document.getElementById('regUsername').value.trim();
            const password = document.getElementById('regPassword').value;
            const confirm = document.getElementById('regConfirm').value;

            if (password !== confirm) { registerError.textContent = 'Passwords do not match'; registerError.style.display = 'block'; return; }
            if (password.length < 6) { registerError.textContent = 'Password must be at least 6 characters'; registerError.style.display = 'block'; return; }

            const { data: existing } = await db
                .from('users')
                .select('id')
                .eq('username', username.toLowerCase())
                .single();
            
            if (existing) {
                registerError.textContent = 'Username already exists';
                registerError.style.display = 'block';
                return;
            }

            const { data, error } = await db
                .from('users')
                .insert([{ username: username.toLowerCase(), display_name: username, password }])
                .select()
                .single();

            if (error) {
                registerError.textContent = error.message;
                registerError.style.display = 'block';
                return;
            }

            registerForm.reset();
            registerPanel.classList.remove('active');
            loginPanel.classList.add('active');
            loginSuccess.textContent = 'Account created. Please log in.';
            loginSuccess.style.display = 'block';
        };

        loginForm.onsubmit = async e => {
            e.preventDefault();
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            const { data: user, error } = await db
                .from('users')
                .select('*')
                .eq('username', username.toLowerCase())
                .eq('password', password)
                .single();

            if (error || !user) {
                loginError.textContent = 'Invalid username or password';
                loginError.style.display = 'block';
                loginSuccess.style.display = 'none';
                return;
            }

            currentUser = user;
             body.classList.add('logged-in');
             navUsername.textContent = user.display_name;
             authModal.classList.remove('active');
             resetAuthForms();
             document.getElementById('userHubSection').style.display = 'block';
             document.getElementById('dashboardSection').style.display = 'none';
             loadCommunities();
             updateCreditsDisplay();
             // Show user hub
             showUserHub(user);
             
             // Add user to login_sessions table
             try {
                 // Delete any existing sessions for this user first
                 await db.from('login_sessions').delete().eq('user_id', user.id);
                 
                 // Then add new session
                 const { error } = await db.from('login_sessions').insert([{
                     user_id: user.id,
                     username: user.username,
                     display_name: user.display_name,
                     session_id: Date.now().toString()
                 }]);
                 if (error) console.error('Session error:', error);
                 loadActiveUsers();
             } catch (e) {
                 console.error('Session insert error:', e);
             }

            const staffBtn = document.getElementById('staffDashboardBtn');
            console.log('Logged in user:', user.username, user.display_name);
            
            // Check if user has staff access (hardcoded 'rya' OR in staff_access table)
            const isHardcodedStaff = user.username.toLowerCase() === 'rya';
            
            const { data: staffAccess } = await db
                .from('staff_access')
                .select('*')
                .eq('user_id', user.id)
                .single();
            
            const isStaff = isHardcodedStaff || !!staffAccess;
            
            if (isStaff) {
                staffBtn.style.display = 'flex';
            } else {
                staffBtn.style.display = 'none';
            }
        };

        logoutBtn.onclick = async () => {
            if (currentUser) {
                // Remove user from login_sessions table
                try {
                    const { error } = await db.from('login_sessions').delete().eq('user_id', currentUser.id);
                    if (error) console.error('Logout error:', error);
                } catch (e) {
                    console.error('Logout delete error:', e);
                }
            }
            await db.auth.signOut();
            currentUser = null;
            body.classList.remove('logged-in');
            navUsername.textContent = '';
            document.getElementById('staffDashboardBtn').style.display = 'none';
            // Hide user hub and show hero
            document.getElementById('userHubSection').style.display = 'none';
            document.getElementById('heroSection').style.display = 'flex';
            loadActiveUsers();
        };

        // Check for OAuth callback and existing session on page load
        async function checkAuthSession() {
            const { data: { session } } = await db.auth.getSession();
            
            if (session && session.user) {
                const discordUser = session.user;
                const discordName = discordUser.user_metadata?.full_name || discordUser.user_metadata?.name || discordUser.email?.split('@')[0] || 'Discord User';
                const discordUsername = (discordUser.user_metadata?.preferred_username || discordName).toLowerCase().replace(/\s+/g, '_');
                
                // Check if user exists in our users table
                let { data: existingUser } = await db
                    .from('users')
                    .select('*')
                    .eq('discord_id', discordUser.id)
                    .single();
                
                if (!existingUser) {
                    // Create user in our table
                    const { data: newUser, error: createError } = await db
                        .from('users')
                        .insert([{
                            username: discordUsername,
                            display_name: discordName,
                            password: 'discord_oauth',
                            discord_id: discordUser.id,
                            discord_avatar: discordUser.user_metadata?.avatar_url
                        }])
                        .select()
                        .single();
                    
                    if (createError) {
                        console.error('Error creating Discord user:', createError);
                        return;
                    }
                    existingUser = newUser;
                }
                
                // Log in the user
                currentUser = existingUser;
                body.classList.add('logged-in');
                navUsername.textContent = existingUser.display_name;
                authModal.classList.remove('active');
                loadCommunities();
                
                // Check staff access
                const staffBtn = document.getElementById('staffDashboardBtn');
                const isHardcodedStaff = existingUser.username.toLowerCase() === 'rya';
                const { data: staffAccess } = await db
                    .from('staff_access')
                    .select('*')
                    .eq('user_id', existingUser.id)
                    .single();
                const isStaff = isHardcodedStaff || !!staffAccess;
                staffBtn.style.display = isStaff ? 'flex' : 'none';
            }
        }
        
        // Check for staff panel URL access
        async function checkStaffPanelAccess() {
            // Check if URL contains ?staffpanel or /staffpanel
            const urlParams = new URLSearchParams(window.location.search);
            const pathname = window.location.pathname;
            const isStaffPanelUrl = urlParams.has('staffpanel') || pathname.includes('staffpanel');
            
            if (!isStaffPanelUrl) {
                return; // Not staff panel URL, skip this check
            }
            
            // User must be logged in
            if (!currentUser) {
                // Create permission denied overlay
                const overlay = document.createElement('div');
                overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.9);display:flex;justify-content:center;align-items:center;z-index:9999;';
                
                const content = document.createElement('div');
                content.style.cssText = 'background:#14171f;border:1px solid #1e222d;border-radius:12px;padding:40px;max-width:400px;text-align:center;color:#e4e4e7;';
                content.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="48" height="48" style="margin:0 auto 16px;color:#ef4444;">
                        <circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/>
                    </svg>
                    <h2 style="margin:0 0 8px 0;font-size:20px;font-weight:600;">Access Denied</h2>
                    <p style="color:#a1a1aa;margin:0 0 20px 0;font-size:14px;">You don't have permission to access the staff panel.</p>
                    <button onclick="window.location.href='/';" style="padding:10px 20px;background:#3b82f6;border:none;border-radius:6px;color:#fff;font-size:13px;font-weight:600;cursor:pointer;">Back to Home</button>
                `;
                overlay.appendChild(content);
                document.body.appendChild(overlay);
                return;
            }
            
            // Check if user is staff or owner
            const isHardcodedStaff = currentUser.username?.toLowerCase() === 'rya';
            
            let isStaff = isHardcodedStaff;
            if (!isStaff) {
                // Check staff access table
                const { data: staffAccess } = await db
                    .from('staff_access')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .single();
                isStaff = !!staffAccess;
            }
            
            // Check if user is community owner
            let isOwner = false;
            const { data: ownedCommunities } = await db
                .from('communities')
                .select('id')
                .eq('owner_id', currentUser.id)
                .limit(1);
            isOwner = ownedCommunities && ownedCommunities.length > 0;
            
            if (!isStaff && !isOwner) {
                // Create permission denied overlay
                const overlay = document.createElement('div');
                overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.9);display:flex;justify-content:center;align-items:center;z-index:9999;';
                
                const content = document.createElement('div');
                content.style.cssText = 'background:#14171f;border:1px solid #1e222d;border-radius:12px;padding:40px;max-width:400px;text-align:center;color:#e4e4e7;';
                content.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="48" height="48" style="margin:0 auto 16px;color:#ef4444;">
                        <circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/>
                    </svg>
                    <h2 style="margin:0 0 8px 0;font-size:20px;font-weight:600;">Access Denied</h2>
                    <p style="color:#a1a1aa;margin:0 0 20px 0;font-size:14px;">You don't have permission to access the staff panel.</p>
                    <button onclick="window.location.href='/';" style="padding:10px 20px;background:#3b82f6;border:none;border-radius:6px;color:#fff;font-size:13px;font-weight:600;cursor:pointer;">Back to Home</button>
                `;
                overlay.appendChild(content);
                document.body.appendChild(overlay);
                return;
            }
            
            // User has permission, show staff dashboard
            if (isStaff || isOwner) {
                document.getElementById('staffDashboard').style.display = 'flex';
                document.getElementById('userHubSection').style.display = 'none';
                document.getElementById('heroSection').style.display = 'none';
                showStaffDashboardPages();
            }
        }
        
        checkAuthSession();
        
        // Check staff panel access after auth check
        setTimeout(() => {
            checkStaffPanelAccess();
        }, 500);

        const policeBtn = document.getElementById('policeBtn');
        const policeLoginModal = document.getElementById('policeLoginModal');
        const closePoliceLogin = document.getElementById('closePoliceLogin');
        const policeLoginForm = document.getElementById('policeLoginForm');
        const policeMdt = document.getElementById('policeMdt');
        const offDutyBtn = document.getElementById('offDutyBtn');
        const dutyTimer = document.getElementById('dutyTimer');
        const mdtCallsign = document.getElementById('mdtCallsign');
        const currentStatusBadge = document.getElementById('currentStatus');
        const chatInput = document.getElementById('chatInput');
        const chatSend = document.getElementById('chatSend');
        const chatMessages = document.getElementById('chatMessages');

        let dutyStartTime = null;
        let timerInterval = null;
        let activeUnits = [];
        const activeUnitsTableBody = document.getElementById('activeUnitsTableBody');

        // Save officer to Supabase active_units table
        async function saveActiveUnit(officer) {
            if (!currentCommunityId) return;
            await db.from('active_units').upsert({
                id: String(officer.id),
                community_id: currentCommunityId,
                name: officer.name,
                callsign: officer.callsign,
                rank: officer.rank || '',
                status: officer.status,
                subdivision: officer.subdivision || 'None',
                user_id: currentUser?.id || null
            });
        }

        // Remove officer from Supabase active_units table
        async function removeActiveUnit(officerId) {
            if (!currentCommunityId) return;
            await db.from('active_units').delete().eq('id', String(officerId));
        }

        // Update officer status in Supabase
        async function updateActiveUnitStatus(officerId, status) {
            await db.from('active_units').update({ status: status }).eq('id', String(officerId));
        }

        // Fetch active units from Supabase for the current community
        async function fetchActiveUnits() {
            if (!currentCommunityId) return [];
            const { data } = await db.from('active_units').select('*').eq('community_id', currentCommunityId);
            return data || [];
        }

        async function renderActiveUnits() {
             // Fetch from Supabase so all sessions see all units
             const dbUnits = await fetchActiveUnits();
             // Filter out off-duty units (10-7)
             activeUnits = dbUnits.filter(u => u.status !== '10-7');

             if (activeUnits.length === 0) {
                 activeUnitsTableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#6b7280;">No active units</td></tr>';
             } else {
                 activeUnitsTableBody.innerHTML = activeUnits.map(u => `
                     <tr class="unit-row" data-unit-id="${u.id}" data-callsign="${u.callsign}" style="cursor:pointer;">
                         <td><span style="padding:4px 8px;background:#3b82f6;border-radius:4px;font-size:11px;color:#fff;">${u.callsign}</span></td>
                         <td>${u.name}</td>
                         <td><span class="status-badge status-${u.status.replace(/\s+/g, '-').toLowerCase()}">${u.status}</span></td>
                         <td>${u.subdivision || 'None'}</td>
                     </tr>
                 `).join('');
                 
                 // Add right-click handlers to unit rows
                 activeUnitsTableBody.querySelectorAll('.unit-row').forEach(row => {
                     row.addEventListener('contextmenu', e => showUnitContextMenu(e));
                 });
             }
             // Also update dispatch view if it exists
             if (typeof renderDispatchUnits === 'function') {
                 renderDispatchUnits();
             }
         }

        policeBtn.onclick = () => policeLoginModal.classList.add('active');
        closePoliceLogin.onclick = () => { policeLoginModal.classList.remove('active'); policeLoginForm.reset(); };
        policeLoginModal.onclick = e => { if (e.target === policeLoginModal) { policeLoginModal.classList.remove('active'); policeLoginForm.reset(); } };

        const mdtDepartment = document.getElementById('mdtDepartment');

        let currentOfficer = null;

        policeLoginForm.onsubmit = async e => {
            e.preventDefault();
            const name = document.getElementById('officerName').value.trim();
            const callsign = document.getElementById('officerCallsign').value.trim();
            const rank = document.getElementById('officerRank').value.trim();
            
            mdtCallsign.textContent = callsign;
            
            currentOfficer = {
                id: Date.now(),
                name: name,
                callsign: callsign,
                rank: rank,
                status: '10-8',
                subdivision: 'None',
                inPanel: true
            };
            
            await saveActiveUnit(currentOfficer);
            await renderActiveUnits();
            
            policeLoginModal.classList.remove('active');
            policeLoginForm.reset();
            communityScreen.classList.remove('active');
            policeMdt.classList.add('active');
            
            // Update dispatch view to show officer in panel
            if (typeof renderDispatchUnits === 'function') {
                renderDispatchUnits();
            }
            
            dutyStartTime = Date.now();
            timerInterval = setInterval(updateTimer, 1000);
            updateTimer();
        };

        function updateTimer() {
            const elapsed = Math.floor((Date.now() - dutyStartTime) / 1000);
            const hours = String(Math.floor(elapsed / 3600)).padStart(2, '0');
            const minutes = String(Math.floor((elapsed % 3600) / 60)).padStart(2, '0');
            const seconds = String(elapsed % 60).padStart(2, '0');
            dutyTimer.textContent = `${hours}:${minutes}:${seconds}`;
        }

        offDutyBtn.onclick = async () => {
            clearInterval(timerInterval);
            timerInterval = null;
            dutyStartTime = null;
            dutyTimer.textContent = '00:00:00';
            
            if (currentOfficer) {
                await removeActiveUnit(currentOfficer.id);
                await renderActiveUnits();
                currentOfficer = null;
                
                // Update dispatch view
                if (typeof renderDispatchUnits === 'function') {
                    renderDispatchUnits();
                }
            }
            
            policeMdt.classList.remove('active');
            communityScreen.classList.add('active');
        };

        // Dispatch MDT
        const dispatchBtn = document.getElementById('dispatchBtn');
        const dispatchLoginModal = document.getElementById('dispatchLoginModal');
        const closeDispatchLogin = document.getElementById('closeDispatchLogin');
        const dispatchLoginForm = document.getElementById('dispatchLoginForm');
        const dispatchMdt = document.getElementById('dispatchMdt');
        const dispatchOffDutyBtn = document.getElementById('dispatchOffDutyBtn');
        const dispatchIdentifier = document.getElementById('dispatchIdentifier');
        const dispatchStatusEl = document.getElementById('dispatchStatus');

        let currentDispatcher = null;
        let dispatchLeoUnits = [];
        let dispatchEmsCalls = [];
        let dispatchActiveCalls = [];

        dispatchBtn.onclick = () => dispatchLoginModal.classList.add('active');
        closeDispatchLogin.onclick = () => { dispatchLoginModal.classList.remove('active'); dispatchLoginForm.reset(); };
        dispatchLoginModal.onclick = e => { if (e.target === dispatchLoginModal) { dispatchLoginModal.classList.remove('active'); dispatchLoginForm.reset(); } };

        dispatchLoginForm.onsubmit = e => {
            e.preventDefault();
            const name = document.getElementById('dispatcherName').value.trim();
            const callsign = document.getElementById('dispatcherCallsign').value.trim();
            
            currentDispatcher = {
                id: Date.now(),
                name: name,
                callsign: callsign,
                status: '10-8'
            };
            
            dispatchIdentifier.textContent = `[${callsign}] ${name}`;
            dispatchStatusEl.textContent = '10-8';
            
            dispatchLoginModal.classList.remove('active');
            dispatchLoginForm.reset();
            communityScreen.classList.remove('active');
            dispatchMdt.classList.add('active');
            
            renderDispatchUnits();
            // Auto-refresh dispatch units every 2 seconds to pick up new police units
            if (dispatchRefreshInterval) clearInterval(dispatchRefreshInterval);
            dispatchRefreshInterval = setInterval(renderDispatchUnits, 2000);
        };

        let dispatchRefreshInterval = null;

        dispatchOffDutyBtn.onclick = () => {
            currentDispatcher = null;
            if (dispatchRefreshInterval) { clearInterval(dispatchRefreshInterval); dispatchRefreshInterval = null; }
            dispatchMdt.classList.remove('active');
            communityScreen.classList.add('active');
        };

        let dispatchCallCounter = 1;

        async function renderDispatchUnits() {
             const leoBody = document.getElementById('dispatchLeoUnits');
             const emsBody = document.getElementById('dispatchEmsUnits');
             const callsBody = document.getElementById('dispatchActiveCalls');
             const officersInPanelBody = document.getElementById('dispatchOfficersInPanel');
             
             if (!leoBody) return;

             // Always fetch latest units from Supabase
             const dbUnits = await fetchActiveUnits();
             activeUnits = dbUnits.filter(u => u.status !== '10-7');
             
             if (activeUnits.length === 0) {
                 leoBody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#6b7280;">No active units</td></tr>';
             } else {
                 leoBody.innerHTML = activeUnits.map(u => {
                     const assignedCall = dispatchActiveCalls.find(c => c.assignedUnits && c.assignedUnits.includes(u.callsign));
                     return `
                     <tr class="unit-row" data-unit-id="${u.id}" data-callsign="${u.callsign}" style="cursor:pointer;">
                         <td style="font-weight:500;">[${u.callsign}] ${u.name}</td>
                         <td>${u.status}</td>
                         <td>${u.subdivision || 'None'}</td>
                         <td>${assignedCall ? '#' + assignedCall.number : 'None'}</td>
                         <td><button class="kick-btn" data-unit-id="${u.id}" style="background:#ef4444;border:none;color:#fff;padding:4px 10px;border-radius:4px;font-size:11px;cursor:pointer;">Kick</button></td>
                     </tr>
                 `;}).join('');
                 
                 // Add right-click handlers to unit rows
                 leoBody.querySelectorAll('.unit-row').forEach(row => {
                     row.addEventListener('contextmenu', e => showUnitContextMenu(e));
                 });
                 
                 // Add kick button handlers
                 leoBody.querySelectorAll('.kick-btn').forEach(btn => {
                     btn.addEventListener('click', async (e) => {
                         e.stopPropagation();
                         const unitId = btn.dataset.unitId;
                         if (confirm('Kick this unit from the CAD?')) {
                             await db.from('active_units').delete().eq('id', unitId);
                             renderDispatchUnits();
                         }
                     });
                 });
                 }
             
             // Check which officers are currently in the police panel
             // Officers who are currently logged in and viewing the police MDT
             if (currentOfficer && currentOfficer.inPanel) {
                 // Show the current officer in the dispatch view
                 const officeringPanel = activeUnits.filter(u => {
                     // If the current officer matches, they're in the panel
                     return u.callsign === currentOfficer.callsign || u.id === String(currentOfficer.id);
                 });
                 
                 if (officeringPanel.length > 0) {
                     officersInPanelBody.innerHTML = officeringPanel.map(u => `
                         <tr>
                             <td style="font-weight:500;">[${u.callsign}]</td>
                             <td>${u.name}</td>
                             <td>${u.rank || 'N/A'}</td>
                             <td><span class="status-badge status-${u.status.replace(/\s+/g, '-').toLowerCase()}">${u.status}</span></td>
                         </tr>
                     `).join('');
                 } else {
                     officersInPanelBody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#6b7280;">No officers in panel</td></tr>';
                 }
             } else {
                 officersInPanelBody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#6b7280;">No officers in panel</td></tr>';
             }
             
             if (emsBody) emsBody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#6b7280;">No active units</td></tr>';
            
            if (callsBody) {
                if (dispatchActiveCalls.length === 0) {
                    callsBody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#6b7280;">No active calls</td></tr>';
                } else {
                    callsBody.innerHTML = dispatchActiveCalls.map(c => `
                        <tr>
                            <td>${c.number}</td>
                            <td>${c.type}</td>
                            <td>${c.location} (${c.postal})</td>
                            <td>
                                <button class="btn-delete" style="background:#ef4444;border:none;color:#fff;padding:4px 10px;border-radius:4px;font-size:11px;cursor:pointer;" onclick="deleteDispatchCall(${c.id})">Delete</button>
                            </td>
                        </tr>
                    `).join('');
                }
            }
        }

        function deleteDispatchCall(callId) {
             dispatchActiveCalls = dispatchActiveCalls.filter(c => c.id !== callId);
             renderDispatchUnits();
         }

         // Unit Status Context Menu Handler
         let selectedUnitId = null;
         function showUnitContextMenu(e) {
             e.preventDefault();
             selectedUnitId = e.currentTarget.dataset.unitId;
             const menu = document.getElementById('unitStatusContextMenu');
             menu.style.display = 'block';
             menu.style.left = e.pageX + 'px';
             menu.style.top = e.pageY + 'px';
         }

         // Handle status menu clicks
         document.getElementById('statusMenuContainer').addEventListener('click', async (e) => {
             const statusItem = e.target.closest('[data-status]');
             if (statusItem && selectedUnitId) {
                 const newStatus = statusItem.dataset.status;
                 await updateActiveUnitStatus(selectedUnitId, newStatus);
                 await renderActiveUnits();
                 document.getElementById('unitStatusContextMenu').style.display = 'none';
                 selectedUnitId = null;
             }
         });

         // Close context menu when clicking elsewhere
         document.addEventListener('click', () => {
             document.getElementById('unitStatusContextMenu').style.display = 'none';
         });

         document.getElementById('dispatch10-8').onclick = () => {
            dispatchStatusEl.textContent = '10-8';
            if (currentDispatcher) currentDispatcher.status = '10-8';
        };

        document.getElementById('dispatch10-7').onclick = () => {
            dispatchStatusEl.textContent = '10-7';
            if (currentDispatcher) currentDispatcher.status = '10-7';
        };

        // Tones System
         const tonesContextMenu = document.getElementById('tonesContextMenu');
         const tonesMenuContainer = document.getElementById('tonesMenuContainer');
         const uploadToneBtn = document.getElementById('uploadToneBtn');
         const toneName = document.getElementById('toneName');
         const toneFile = document.getElementById('toneFile');
         const toneMaxUses = document.getElementById('toneMaxUses');
         const adminTonesTableBody = document.getElementById('adminTonesTableBody');
         
         // Upload Tone Handler
         uploadToneBtn.onclick = async () => {
             const name = toneName.value.trim();
             const file = toneFile.files[0];
             const maxUses = toneMaxUses.value ? parseInt(toneMaxUses.value) : null;
             
             if (!name || !file) {
                 alert('Please enter a tone name and select a file');
                 return;
             }
             
             if (!currentCommunityId) {
                 alert('Please enter a community first');
                 return;
             }
             
             // Read file as base64
             const reader = new FileReader();
             reader.onload = async (e) => {
                 const audioData = e.target.result;
                 const fileSize = file.size ? BigInt(file.size).toString() : '0';
                 
                 const { data, error } = await db
                     .from('tones')
                     .insert([{
                         community_id: currentCommunityId,
                         name: name,
                         audio_data: audioData,
                         file_name: file.name,
                         file_size: parseInt(fileSize),
                         max_uses: maxUses || null,
                         times_played: 0
                     }])
                     .select();
                 
                 if (error) {
                     alert('Error uploading tone: ' + error.message);
                     return;
                 }
                 
                 alert('Tone uploaded successfully!');
                 toneName.value = '';
                 toneFile.value = '';
                 toneMaxUses.value = '';
                 loadAdminTones();
             };
             reader.readAsDataURL(file);
         };
        
        // Load Tones for Admin Panel
        async function loadAdminTones() {
            if (!currentCommunityId) return;
            
            const { data: tones, error } = await db
                .from('tones')
                .select('*')
                .eq('community_id', currentCommunityId)
                .order('name', { ascending: true });
            
            if (error) {
                console.error('Error loading tones:', error);
                adminTonesTableBody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:#ef4444;padding:20px;">Error loading tones</td></tr>';
                return;
            }
            
            if (!tones || tones.length === 0) {
                adminTonesTableBody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:#6b7280;padding:20px;">No tones uploaded yet</td></tr>';
                return;
            }
            
            adminTonesTableBody.innerHTML = tones.map(t => `
                <tr style="border-bottom:1px solid #1e222d;">
                    <td style="padding:12px;color:#e4e4e7;font-size:13px;">${t.name}</td>
                    <td style="padding:12px;color:#a1a1aa;font-size:13px;">${(t.file_size / 1024).toFixed(2)} KB</td>
                    <td style="padding:12px;color:#a1a1aa;font-size:13px;">${t.times_played || 0}</td>
                    <td style="padding:12px;color:#a1a1aa;font-size:13px;">${t.max_uses ? t.max_uses : ''}</td>
                    <td style="padding:12px;">
                        <button onclick="playTonePreview('${t.id}')" style="padding:6px 12px;background:#3b82f6;border:none;border-radius:4px;color:#fff;font-size:11px;cursor:pointer;margin-right:6px;">Play</button>
                        <button onclick="deleteTone('${t.id}')" style="padding:6px 12px;background:#ef4444;border:none;border-radius:4px;color:#fff;font-size:11px;cursor:pointer;">Delete</button>
                    </td>
                </tr>
            `).join('');
            
            // Also load tones for police panel menu
            await loadTonesForPoliceMenu();
        }
        
        // Load Tones for Police Menu
        async function loadTonesForPoliceMenu() {
            if (!currentCommunityId) return;
            
            const { data: tones, error } = await db
                .from('tones')
                .select('*')
                .eq('community_id', currentCommunityId)
                .order('name', { ascending: true });
            
            if (error) {
                console.error('Error loading tones for menu:', error);
                return;
            }
            
            if (!tones || tones.length === 0) {
                tonesMenuContainer.innerHTML = '<div style="color:#6b7280;font-size:13px;padding:8px;">No tones available</div>';
                return;
            }
            
            tonesMenuContainer.innerHTML = tones.map((t, idx) => `
                <div class="tone-item" data-tone="${t.id}" data-audio="${t.audio_data}" data-name="${t.name}">
                    <span class="tone-icon"></span>
                    <span>${t.name}</span>
                </div>
            `).join('');
            
            // Re-attach click handlers
            document.querySelectorAll('.tone-item').forEach(item => {
                item.onclick = () => {
                    const toneName = item.dataset.name;
                    const audioData = item.dataset.audio;
                    
                    if (audioData) {
                        const audio = new Audio(audioData);
                        audio.play();
                        alert(`Playing: ${toneName}`);
                    }
                    tonesContextMenu.classList.remove('active');
                };
            });
        }
        
        // Play Tone Preview (Admin Panel)
         window.playTonePreview = async (toneId) => {
             const { data: tone, error } = await db
                 .from('tones')
                 .select('audio_data, name, times_played, max_uses')
                 .eq('id', toneId)
                 .single();
             
             if (error || !tone) {
                 alert('Error loading tone');
                 return;
             }
             
             // Check if max uses reached
             const timesPlayed = tone.times_played || 0;
             const maxUses = tone.max_uses;
             
             if (maxUses && timesPlayed >= maxUses) {
                 alert(`This tone has reached its maximum plays (${maxUses})`);
                 return;
             }
             
             // Increment times_played
             const newTimesPlayed = timesPlayed + 1;
             await db
                 .from('tones')
                 .update({ times_played: newTimesPlayed })
                 .eq('id', toneId);
             
             const audio = new Audio(tone.audio_data);
             audio.play();
             
             // Refresh table
             loadAdminTones();
         };
        
        // Delete Tone
        window.deleteTone = async (toneId) => {
            if (!confirm('Delete this tone?')) return;
            
            const { error } = await db
                .from('tones')
                .delete()
                .eq('id', toneId);
            
            if (error) {
                alert('Error deleting tone: ' + error.message);
                return;
            }
            
            loadAdminTones();
        };
        
        // Tones Context Menu
        policeMdt.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            tonesContextMenu.style.left = e.clientX + 'px';
            tonesContextMenu.style.top = e.clientY + 'px';
            tonesContextMenu.classList.add('active');
        });

        document.addEventListener('click', () => {
            tonesContextMenu.classList.remove('active');
        });

        document.querySelectorAll('.status-btn[data-status]').forEach(btn => {
            btn.onclick = () => {
                const status = btn.dataset.status;
                currentStatusBadge.textContent = status;
                
                let statusClass = 'status-badge ';
                if (status === '10-8') statusClass += 'status-10-8';
                else if (status === '10-7') statusClass += 'status-10-7';
                else if (status === '10-6') statusClass += 'status-10-6';
                else if (status === '10-11') statusClass += 'status-10-11';
                else if (status === '10-15') statusClass += 'status-10-15';
                else if (status === '10-23') statusClass += 'status-10-23';
                else if (status === '10-26') statusClass += 'status-10-26';
                else if (status === '10-45') statusClass += 'status-10-45';
                else if (status === '10-97') statusClass += 'status-10-97';
                else if (status === '10-99') statusClass += 'status-10-99';
                else if (status.startsWith('Signal')) statusClass += 'status-signal';
                else if (status === 'PANIC') statusClass += 'status-panic';
                else statusClass += 'status-10-7';
                
                currentStatusBadge.className = statusClass;
                
                if (currentOfficer) {
                    currentOfficer.status = status;
                    updateActiveUnitStatus(currentOfficer.id, status);
                    renderActiveUnits();
                }
            };
        });

        chatSend.onclick = () => {
            const msg = chatInput.value.trim();
            if (!msg) return;
            const now = new Date();
            const time = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            const callsign = mdtCallsign.textContent;
            const msgEl = document.createElement('div');
            msgEl.className = 'chat-message';
            msgEl.innerHTML = `<span class="time">${time}</span> <span class="sender">${callsign}</span> <span class="text">${msg}</span>`;
            chatMessages.appendChild(msgEl);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            chatInput.value = '';
        };

        chatInput.onkeypress = e => { if (e.key === 'Enter') chatSend.onclick(); };

        const createCallBtn = document.getElementById('createCallBtn');
        const createCallModal = document.getElementById('createCallModal');
        const closeCreateCall = document.getElementById('closeCreateCall');
        const cancelCreateCall = document.getElementById('cancelCreateCall');
        const createCallForm = document.getElementById('createCallForm');
        const callNumberInput = document.getElementById('callNumber');
        const callsTableBody = document.getElementById('callsTableBody');

        let callCounter = 1;

        function generateCallNumber() {
            const prefix = 'CALL';
            const num = String(callCounter).padStart(4, '0');
            const rand = Math.random().toString(36).substring(2, 6).toUpperCase();
            return `${prefix}-${num}-${rand}`;
        }

        createCallBtn.onclick = () => {
            callNumberInput.value = generateCallNumber();
            createCallModal._fromDispatch = false;
            createCallModal.classList.add('active');
        };

        closeCreateCall.onclick = () => { createCallModal.classList.remove('active'); createCallForm.reset(); };
        cancelCreateCall.onclick = () => { createCallModal.classList.remove('active'); createCallForm.reset(); };
        createCallModal.onclick = e => { if (e.target === createCallModal) { createCallModal.classList.remove('active'); createCallForm.reset(); } };

        // Dispatch Create Call
        document.getElementById('dispatchCreateCall').onclick = () => {
            callNumberInput.value = generateCallNumber();
            createCallModal.classList.add('active');
            createCallModal._fromDispatch = true;
        };

        // Handle call form submit for both police & dispatch
        createCallForm.onsubmit = e => {
            e.preventDefault();
            const type = document.getElementById('callType').value.trim();
            const location = document.getElementById('callLocation').value.trim();
            const postal = document.getElementById('callPostal').value.trim();

            if (createCallModal._fromDispatch) {
                const newCall = {
                    id: Date.now(),
                    number: callCounter,
                    type: type,
                    location: location,
                    postal: postal,
                    assignedUnits: []
                };
                dispatchActiveCalls.push(newCall);
                callCounter++;
                renderDispatchUnits();
                createCallModal._fromDispatch = false;
            } else {
                const existingEmpty = callsTableBody.querySelector('td');
                if (existingEmpty && existingEmpty.textContent === '1') {
                    callsTableBody.innerHTML = '';
                }
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${callCounter}</td>
                    <td>${type}</td>
                    <td>${location}</td>
                    <td>${postal}</td>
                    <td>
                        <button class="btn-details">View Details</button>
                        <button class="btn-delete" style="margin-left:8px;background:#ef4444;border:none;color:#fff;padding:6px 14px;border-radius:4px;font-size:11px;font-weight:500;cursor:pointer;">Delete</button>
                    </td>
                `;
                row.querySelector('.btn-delete').onclick = function() { row.remove(); };
                callsTableBody.appendChild(row);
                callCounter++;
            }
            createCallModal.classList.remove('active');
            createCallForm.reset();
        };

        // Assign Units to Call
        const assignUnitsModal = document.getElementById('assignUnitsModal');
        const assignCallSelect = document.getElementById('assignCallSelect');
        const assignUnitsCheckboxes = document.getElementById('assignUnitsCheckboxes');

        document.getElementById('dispatchAssignUnits').onclick = () => {
            assignCallSelect.innerHTML = '<option value="">-- Select a Call --</option>';
            dispatchActiveCalls.forEach(c => {
                assignCallSelect.innerHTML += `<option value="${c.id}">#${c.number} - ${c.type} (${c.location})</option>`;
            });
            if (activeUnits.length === 0) {
                assignUnitsCheckboxes.innerHTML = '<div style="color:#6b7280;font-size:13px;">No active units</div>';
            } else {
                assignUnitsCheckboxes.innerHTML = activeUnits.map(u => `
                    <label style="display:flex;align-items:center;gap:8px;padding:6px 0;color:#e4e4e7;font-size:13px;cursor:pointer;">
                        <input type="checkbox" value="${u.callsign}" style="accent-color:#3b82f6;">
                        [${u.callsign}] ${u.name}
                    </label>
                `).join('');
            }
            assignUnitsModal.classList.add('active');
        };

        document.getElementById('closeAssignUnits').onclick = () => assignUnitsModal.classList.remove('active');
        document.getElementById('cancelAssignUnits').onclick = () => assignUnitsModal.classList.remove('active');
        assignUnitsModal.onclick = e => { if (e.target === assignUnitsModal) assignUnitsModal.classList.remove('active'); };

        document.getElementById('confirmAssignUnits').onclick = () => {
            const selectedCallId = parseInt(assignCallSelect.value);
            if (!selectedCallId) { alert('Please select a call.'); return; }
            const selectedUnits = [...assignUnitsCheckboxes.querySelectorAll('input[type="checkbox"]:checked')].map(cb => cb.value);
            if (selectedUnits.length === 0) { alert('Please select at least one unit.'); return; }

            const call = dispatchActiveCalls.find(c => c.id === selectedCallId);
            if (!call) return;

            call.assignedUnits = [...new Set([...(call.assignedUnits || []), ...selectedUnits])];
            renderDispatchUnits();
            assignUnitsModal.classList.remove('active');

            // Text-to-speech announcement
            if ('speechSynthesis' in window) {
                const unitNames = selectedUnits.join(', ');
                const text = `New assignment. ${unitNames}, respond to a ${call.type} at ${call.location}, postal ${call.postal}.`;
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 0.95;
                utterance.pitch = 1;
                utterance.volume = 1;
                window.speechSynthesis.cancel();
                window.speechSynthesis.speak(utterance);
            }
        };

        const lookupBtn = document.getElementById('lookupBtn');
        const lookupModal = document.getElementById('lookupModal');
        const closeLookup = document.getElementById('closeLookup');
        const lookupFirstName = document.getElementById('lookupFirstName');
        const lookupLastName = document.getElementById('lookupLastName');
        const lookupSearchBtn = document.getElementById('lookupSearchBtn');
        const lookupResultsList = document.getElementById('lookupResultsList');

        lookupBtn.onclick = () => {
            lookupResultsList.innerHTML = '<div class="lookup-empty">Enter a name to search</div>';
            lookupFirstName.value = '';
            lookupLastName.value = '';
            lookupModal.classList.add('active');
        };

        closeLookup.onclick = () => lookupModal.classList.remove('active');
        lookupModal.onclick = e => { if (e.target === lookupModal) lookupModal.classList.remove('active'); };

        lookupSearchBtn.onclick = async () => {
            const firstName = lookupFirstName.value.trim().toLowerCase();
            const lastName = lookupLastName.value.trim().toLowerCase();
            
            if (!firstName && !lastName) {
                lookupResultsList.innerHTML = '<div class="lookup-empty">Enter a first or last name to search</div>';
                return;
            }

            lookupResultsList.innerHTML = '<div class="lookup-empty">Searching...</div>';

            const { data: allChars, error } = await db
                .from('characters')
                .select('*')
                .eq('community_id', currentCommunityId);

            console.log('All characters from DB:', allChars);
            console.log('Error:', error);

            if (error) {
                lookupResultsList.innerHTML = '<div class="lookup-empty">Error: ' + error.message + '</div>';
                console.error(error);
                return;
            }

            if (!allChars || allChars.length === 0) {
                lookupResultsList.innerHTML = '<div class="lookup-empty">No civilians in database</div>';
                return;
            }

            const results = allChars.filter(c => {
                const matchFirst = !firstName || c.first_name.toLowerCase().includes(firstName);
                const matchLast = !lastName || c.last_name.toLowerCase().includes(lastName);
                return matchFirst && matchLast;
            });

            console.log('Filtered results:', results);

            if (results.length === 0) {
                lookupResultsList.innerHTML = '<div class="lookup-empty">No civilians found</div>';
                return;
            }

            // Fetch tickets for all matching civilians in this community
            const civilianIds = results.map(c => c.id);
            const { data: allTickets } = await db
                .from('tickets')
                .select('*')
                .in('civilian_id', civilianIds)
                .eq('community_id', currentCommunityId)
                .order('issued_at', { ascending: false });

            const ticketsByCivilian = {};
            (allTickets || []).forEach(t => {
                if (!ticketsByCivilian[t.civilian_id]) ticketsByCivilian[t.civilian_id] = [];
                ticketsByCivilian[t.civilian_id].push(t);
            });

            lookupResultsList.innerHTML = results.map(c => {
                const civTickets = ticketsByCivilian[c.id] || [];
                const ticketCount = civTickets.length;
                const totalFines = civTickets.reduce((sum, t) => sum + (t.fine || 0), 0);
                
                return `
                <div class="lookup-result">
                    <div class="name">${c.first_name} ${c.last_name}</div>
                    <div class="info">
                        <span><strong>DOB:</strong> ${c.date_of_birth}</span>
                        <span><strong>Gender:</strong> ${c.gender}</span>
                        <span><strong>Phone:</strong> ${c.phone || 'N/A'}</span>
                        <span><strong>License:</strong> ${c.license_status || 'Valid'}</span>
                    </div>
                    <div class="lookup-tickets-summary" style="margin-top:10px;padding:10px;background:#0f172a;border-radius:6px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                            <span style="color:#f97316;font-weight:600;">Tickets: ${ticketCount}</span>
                            <span style="color:#ef4444;font-weight:600;">Total Fines: $${totalFines.toFixed(2)}</span>
                        </div>
                        ${ticketCount > 0 ? `
                            <div class="lookup-tickets-list" style="max-height:150px;overflow-y:auto;">
                                ${civTickets.map(t => `
                                    <div style="padding:8px;background:#1e293b;border-radius:4px;margin-bottom:6px;font-size:12px;">
                                        <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
                                            <span style="color:#f97316;font-weight:500;">${t.ticket_number}</span>
                                            <span style="color:#6b7280;">${new Date(t.issued_at).toLocaleDateString()}</span>
                                        </div>
                                        <div style="color:#9ca3af;"><strong>Type:</strong> ${t.ticket_type} | <strong>Fine:</strong> $${t.fine.toFixed(2)}</div>
                                        <div style="color:#9ca3af;"><strong>Location:</strong> ${t.location}</div>
                                        ${t.charges && t.charges.length > 0 ? `<div style="color:#9ca3af;margin-top:4px;"><strong>Charges:</strong> ${t.charges.join(', ')}</div>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<div style="color:#6b7280;font-size:12px;">No prior tickets</div>'}
                    </div>
                    <button class="btn-ticket" onclick="openTicketModal('${c.id}', '${c.first_name} ${c.last_name}')">Issue Ticket</button>
                </div>
            `}).join('');
        };

        lookupFirstName.onkeypress = e => { if (e.key === 'Enter') lookupSearchBtn.onclick(); };
        lookupLastName.onkeypress = e => { if (e.key === 'Enter') lookupSearchBtn.onclick(); };

        // Civilian Page
        const civilianBtn = document.getElementById('civilianBtn');
        const civilianPage = document.getElementById('civilianPage');
        const backFromCivilian = document.getElementById('backFromCivilian');
        const newCharacterBtn = document.getElementById('newCharacterBtn');
        const newCharacterModal = document.getElementById('newCharacterModal');
        const closeNewCharacter = document.getElementById('closeNewCharacter');
        const cancelNewCharacter = document.getElementById('cancelNewCharacter');
        const newCharacterForm = document.getElementById('newCharacterForm');
        const charactersGrid = document.getElementById('charactersGrid');
        const call911Btn = document.getElementById('call911Btn');
        const call911Modal = document.getElementById('call911Modal');
        const closeCall911 = document.getElementById('closeCall911');
        const cancelCall911 = document.getElementById('cancelCall911');
        const call911Form = document.getElementById('call911Form');

        let characters = [];

        civilianBtn.onclick = async () => {
            communityScreen.classList.remove('active');
            civilianPage.classList.add('active');
            await loadCharacters();
        };

        backFromCivilian.onclick = () => {
            civilianPage.classList.remove('active');
            communityScreen.classList.add('active');
        };

        async function loadCharacters() {
            if (!currentUser || !currentCommunityId) return;
            
            const { data, error } = await db
                .from('characters')
                .select('*')
                .eq('user_id', currentUser.id)
                .eq('community_id', currentCommunityId);
            
            if (error) {
                console.error('Error loading characters:', error);
                return;
            }
            
            characters = data || [];
            renderCharacters();
        }

        newCharacterBtn.onclick = () => newCharacterModal.classList.add('active');
        closeNewCharacter.onclick = () => { newCharacterModal.classList.remove('active'); newCharacterForm.reset(); };
        cancelNewCharacter.onclick = () => { newCharacterModal.classList.remove('active'); newCharacterForm.reset(); };
        newCharacterModal.onclick = e => { if (e.target === newCharacterModal) { newCharacterModal.classList.remove('active'); newCharacterForm.reset(); } };

        newCharacterForm.onsubmit = async e => {
            e.preventDefault();
            const firstName = document.getElementById('charFirstName').value.trim();
            const lastName = document.getElementById('charLastName').value.trim();
            const dob = document.getElementById('charDob').value;
            const gender = document.getElementById('charGender').value;
            const phone = document.getElementById('charPhone').value.trim() || null;

            console.log('Creating character:', { firstName, lastName, dob, gender, phone });
            console.log('User ID:', currentUser?.id);
            console.log('Community ID:', currentCommunityId);

            const insertData = {
                user_id: currentUser.id,
                first_name: firstName,
                last_name: lastName,
                date_of_birth: dob,
                gender: gender,
                phone: phone
            };

            if (currentCommunityId) {
                insertData.community_id = currentCommunityId;
            }

            const { data, error } = await db
                .from('characters')
                .insert([insertData])
                .select()
                .single();

            console.log('Insert result:', data);
            console.log('Insert error:', error);

            if (error) {
                alert('Error creating character: ' + error.message);
                return;
            }

            alert('Character created successfully!');
            characters.push(data);
            renderCharacters();
            sendCharacterWebhook(data);

            newCharacterModal.classList.remove('active');
            newCharacterForm.reset();
        };

        function renderCharacters() {
            if (characters.length === 0) {
                charactersGrid.innerHTML = '<div class="no-characters">No characters yet. Click "New Character" to create one.</div>';
                return;
            }

            charactersGrid.innerHTML = characters.map(c => `
                <div class="character-card" data-id="${c.id}">
                    <div class="name">${c.first_name} ${c.last_name}</div>
                    <div class="info">
                        <span><strong>DOB:</strong> ${c.date_of_birth}</span>
                        <span><strong>Gender:</strong> ${c.gender}</span>
                        <span><strong>Phone:</strong> ${c.phone || 'N/A'}</span>
                    </div>
                    <div class="actions">
                        <button class="btn-details" onclick="selectCharacter('${c.id}')">Select</button>
                        <button class="btn-delete" style="background:#ef4444;border:none;color:#fff;padding:6px 14px;border-radius:4px;font-size:11px;font-weight:500;cursor:pointer;" onclick="deleteCharacter('${c.id}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        window.selectCharacter = function(id) {
            const char = characters.find(c => c.id === id);
            if (char) alert(`Selected: ${char.first_name} ${char.last_name}`);
        };

        window.deleteCharacter = async function(id) {
            const { error } = await db
                .from('characters')
                .delete()
                .eq('id', id);
            
            if (error) {
                alert('Error deleting character: ' + error.message);
                return;
            }
            
            characters = characters.filter(c => c.id !== id);
            renderCharacters();
        };

        // 911 Call
        call911Btn.onclick = () => call911Modal.classList.add('active');
        closeCall911.onclick = () => { call911Modal.classList.remove('active'); call911Form.reset(); };
        cancelCall911.onclick = () => { call911Modal.classList.remove('active'); call911Form.reset(); };
        call911Modal.onclick = e => { if (e.target === call911Modal) { call911Modal.classList.remove('active'); call911Form.reset(); } };

        call911Form.onsubmit = e => {
            e.preventDefault();
            const location = document.getElementById('emergency911Location').value.trim();
            const desc = document.getElementById('emergency911Desc').value.trim();
            alert(`911 Call Placed!\nLocation: ${location}\nDescription: ${desc}`);
            call911Modal.classList.remove('active');
            call911Form.reset();
        };

        // Staff Dashboard
        const staffDashboardBtn = document.getElementById('staffDashboardBtn');
        const staffDashboard = document.getElementById('staffDashboard');
        const backFromStaff = document.getElementById('backFromStaff');

        // Ensure Staff Dashboard button is enabled and visible
        if (staffDashboardBtn) {
            staffDashboardBtn.disabled = false;
            staffDashboardBtn.style.display = '';
        }

        if (staffDashboardBtn) {
            staffDashboardBtn.onclick = async () => {
                // Hide user hub and show staff dashboard
                document.getElementById('userHubSection').style.display = 'none';
                dashboardSection.classList.add('hidden');
                staffDashboard.style.display = 'block';
                await loadStaffData();
                if (typeof loadStaffSupportTickets === 'function') {
                    loadStaffSupportTickets();
                }
                if (typeof renderAccessCodes === 'function') {
                    renderAccessCodes();
                }
            };
        }

        backFromStaff.onclick = () => {
            staffDashboard.style.display = 'none';
            // Return to user hub if logged in
            if (currentUser) {
                document.getElementById('userHubSection').style.display = 'block';
            } else {
                dashboardSection.classList.remove('hidden');
            }
        };



        function generatePermissionsKey() {
            const key = 'PK-' + Math.random().toString(36).substr(2, 16).toUpperCase();
            localStorage.setItem('permissionsKey', key);
            return key;
        }

        document.getElementById('copyPermissionsKey').onclick = () => {
            const keyInput = document.getElementById('permissionsKeyDisplay');
            keyInput.select();
            document.execCommand('copy');
            alert('Permissions key copied!');
        };

        document.getElementById('generateNewKey').onclick = () => {
            if (confirm('Are you sure? This will invalidate the old key.')) {
                const newKey = generatePermissionsKey();
                document.getElementById('permissionsKeyDisplay').value = newKey;
                alert('New permissions key generated!');
            }
        };

        async function loadStaffData() {
            const { data: users } = await db.from('users').select('*');
            const { data: communities } = await db.from('communities').select('*');
            const { data: chars } = await db.from('characters').select('*');

            document.getElementById('totalUsers').textContent = users?.length || 0;
            document.getElementById('totalCommunities').textContent = communities?.length || 0;
            document.getElementById('totalCharacters').textContent = chars?.length || 0;

            // Load communities table
            const communitiesTable = document.getElementById('staffCommunitiesTable');
            if (!communities || communities.length === 0) {
                communitiesTable.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#6b7280;">No communities found</td></tr>';
            } else {
                communitiesTable.innerHTML = communities.map(c => {
                    const plan = c.plan || 'free';
                    const planColors = {
                        free: '#6b7280',
                        starter: '#3b82f6',
                        standard: '#a855f7',
                        advanced: '#f59e0b'
                    };
                    const owner = users?.find(u => u.id === c.owner_id);
                    const ownerName = owner?.username || 'Unknown';
                    return `
                    <tr>
                        <td>${c.name}</td>
                        <td>
                            <span style="padding:4px 8px;background:#3b82f6;border-radius:4px;font-size:11px;color:#fff;">${c.code}</span>
                            ${c.official_partner ? '<div style="margin-top:4px;background:#3b2c00;color:#ffb300;padding:2px 8px;border-radius:4px;font-size:12px;">Pulsecad Official Partner</div>' : ''}
                        </td>
                        <td style="font-size:11px;color:#a1a1aa;">${ownerName}</td>
                        <td>${c.website || 'N/A'}</td>
                        <td>
                            <select onchange="updateCommunityPlan('${c.id}', this.value)" style="padding:4px 8px;background:#1f2937;border:1px solid #374151;border-radius:4px;color:#fff;font-size:11px;cursor:pointer;">
                                <option value="free" ${plan === 'free' ? 'selected' : ''}>Free</option>
                                <option value="starter" ${plan === 'starter' ? 'selected' : ''}>Starter</option>
                                <option value="standard" ${plan === 'standard' ? 'selected' : ''}>Standard</option>
                                <option value="advanced" ${plan === 'advanced' ? 'selected' : ''}>Advanced</option>
                            </select>
                        </td>
                        <td>
                            ${c.official_partner
                                ? '<button onclick="removePartnerCommunity(\'' + c.id + '\', this)" style="padding:4px 8px;background:#ef4444;border:none;border-radius:4px;color:#fff;font-size:10px;cursor:pointer;">Remove Partner</button>'
                                : '<button onclick="makePartnerCommunity(\'' + c.id + '\')" style="padding:4px 8px;background:#3b82f6;border:none;border-radius:4px;color:#fff;font-size:10px;cursor:pointer;">Make Partner</button>'}
                            <button onclick="deleteCommunity('${c.id}')" style="padding:4px 8px;background:#ef4444;border:none;border-radius:4px;color:#fff;font-size:10px;cursor:pointer;margin-left:6px;">Delete</button>
                        </td>
                    </tr>
                `}).join('');
                    // Make a community an official partner
                    window.makePartnerCommunity = async function(id) {
                        const btn = event.target;
                        btn.disabled = true;
                        btn.textContent = 'Partner';
                        btn.style.background = '#22c55e';
                        const { error } = await db
                            .from('communities')
                            .update({ official_partner: true })
                            .eq('id', id);
                        if (error) {
                            alert('Error updating partner status: ' + error.message);
                            btn.disabled = false;
                            btn.textContent = 'Make Partner';
                            btn.style.background = '#3b82f6';
                        } else {
                            await loadStaffData();
                        }
                    };

                    window.removePartnerCommunity = async function(id, btn) {
                        btn.disabled = true;
                        btn.textContent = 'Removed';
                        btn.style.background = '#6b7280';
                        const { error } = await db
                            .from('communities')
                            .update({ official_partner: false })
                            .eq('id', id);
                        if (error) {
                            alert('Error removing partner status: ' + error.message);
                            btn.disabled = false;
                            btn.textContent = 'Remove Partner';
                            btn.style.background = '#ef4444';
                        } else {
                            await loadStaffData();
                        }
                    };
            }

            // Load users table with staff access info
            const usersTable = document.getElementById('staffUsersTable');
            if (!users || users.length === 0) {
                usersTable.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#6b7280;">No users found</td></tr>';
                return;
            }

            // Get all staff access records
            const { data: staffAccessList } = await db.from('staff_access').select('user_id');
            const staffUserIds = (staffAccessList || []).map(s => s.user_id);

            usersTable.innerHTML = users.map(u => {
                const hasStaffAccess = staffUserIds.includes(u.id);
                const isHardcodedStaff = u.username.toLowerCase() === 'rya';
                return `
                <tr>
                    <td style="font-size:11px;color:#6b7280;">${u.id.substring(0, 8)}...</td>
                    <td>${u.username}</td>
                    <td>${u.display_name}${isHardcodedStaff ? ' <span style="color:#a855f7;font-size:10px;">(Owner)</span>' : hasStaffAccess ? ' <span style="color:#22c55e;font-size:10px;">(Staff)</span>' : ''}</td>
                    <td>${u.created_at ? new Date(u.created_at).toLocaleDateString() : 'N/A'}</td>
                    <td style="display:flex;gap:6px;">
                        ${!isHardcodedStaff ? (hasStaffAccess 
                            ? `<button onclick="revokeStaffAccess('${u.id}')" style="padding:4px 8px;background:#ef4444;border:none;border-radius:4px;color:#fff;font-size:10px;cursor:pointer;">Revoke Staff</button>`
                            : `<button onclick="grantStaffAccess('${u.id}')" style="padding:4px 8px;background:#22c55e;border:none;border-radius:4px;color:#fff;font-size:10px;cursor:pointer;">Make Staff</button>`) 
                        : ''}
                        <button onclick="deleteUser('${u.id}')" style="padding:4px 8px;background:#374151;border:none;border-radius:4px;color:#fff;font-size:10px;cursor:pointer;">Delete</button>
                    </td>
                </tr>
            `}).join('');

        }

        window.deleteUser = async function(id) {
            if (!confirm('Are you sure you want to delete this user?')) return;
            
            const { error } = await db.from('users').delete().eq('id', id);
            if (error) {
                alert('Error deleting user: ' + error.message);
                return;
            }
            loadStaffData();
        };

        window.deleteCommunity = async function(id) {
            if (!confirm('Are you sure you want to delete this community? This will also remove all members.')) return;
            
            // Delete community members first
            await db.from('community_members').delete().eq('community_id', id);
            
            const { error } = await db.from('communities').delete().eq('id', id);
            if (error) {
                alert('Error deleting community: ' + error.message);
                return;
            }
            loadStaffData();
        };

        window.updateCommunityPlan = async function(id, plan) {
            const { error } = await db
                .from('communities')
                .update({ plan: plan })
                .eq('id', id);
            
            if (error) {
                alert('Error updating plan: ' + error.message);
                loadStaffData();
                return;
            }
            
            const planNames = { free: 'Free', starter: 'Starter', standard: 'Standard', advanced: 'Advanced' };
            alert(`Community plan updated to ${planNames[plan]}`);
        };

        // Civilian Tabs
        document.querySelectorAll('.civilian-tab').forEach(tab => {
            tab.onclick = () => {
                document.querySelectorAll('.civilian-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                const tabId = tab.dataset.tab + 'Tab';
                document.getElementById(tabId).classList.add('active');
                if (tab.dataset.tab === 'tickets') {
                    loadMyTickets();
                }
            };
        });

        // Ticket System
        const ticketModal = document.getElementById('ticketModal');
        const closeTicket = document.getElementById('closeTicket');
        const cancelTicket = document.getElementById('cancelTicket');
        const ticketForm = document.getElementById('ticketForm');
        const addChargeBtn = document.getElementById('addChargeBtn');
        const chargesList = document.getElementById('chargesList');
        const signaturePad = document.getElementById('signaturePad');
        const clearSignature = document.getElementById('clearSignature');

        let signatureCtx = null;
        let isDrawing = false;

        function initSignaturePad() {
            signatureCtx = signaturePad.getContext('2d');
            signaturePad.width = signaturePad.offsetWidth;
            signaturePad.height = signaturePad.offsetHeight;
            signatureCtx.strokeStyle = '#3b82f6';
            signatureCtx.lineWidth = 2;
            signatureCtx.lineCap = 'round';

            signaturePad.onmousedown = (e) => {
                isDrawing = true;
                signatureCtx.beginPath();
                signatureCtx.moveTo(e.offsetX, e.offsetY);
            };

            signaturePad.onmousemove = (e) => {
                if (!isDrawing) return;
                signatureCtx.lineTo(e.offsetX, e.offsetY);
                signatureCtx.stroke();
            };

            signaturePad.onmouseup = () => isDrawing = false;
            signaturePad.onmouseleave = () => isDrawing = false;

            signaturePad.ontouchstart = (e) => {
                e.preventDefault();
                const rect = signaturePad.getBoundingClientRect();
                const touch = e.touches[0];
                isDrawing = true;
                signatureCtx.beginPath();
                signatureCtx.moveTo(touch.clientX - rect.left, touch.clientY - rect.top);
            };

            signaturePad.ontouchmove = (e) => {
                if (!isDrawing) return;
                e.preventDefault();
                const rect = signaturePad.getBoundingClientRect();
                const touch = e.touches[0];
                signatureCtx.lineTo(touch.clientX - rect.left, touch.clientY - rect.top);
                signatureCtx.stroke();
            };

            signaturePad.ontouchend = () => isDrawing = false;
        }

        clearSignature.onclick = () => {
            if (signatureCtx) {
                signatureCtx.clearRect(0, 0, signaturePad.width, signaturePad.height);
            }
        };

        window.openTicketModal = function(civilianId, civilianName) {
            document.getElementById('ticketCivilianId').value = civilianId;
            document.getElementById('ticketCivilianName').textContent = civilianName;
            ticketModal.classList.add('active');
            setTimeout(initSignaturePad, 100);
        };

        closeTicket.onclick = () => { ticketModal.classList.remove('active'); ticketForm.reset(); resetCharges(); };
        cancelTicket.onclick = () => { ticketModal.classList.remove('active'); ticketForm.reset(); resetCharges(); };
        ticketModal.onclick = e => { if (e.target === ticketModal) { ticketModal.classList.remove('active'); ticketForm.reset(); resetCharges(); } };

        function resetCharges() {
            chargesList.innerHTML = `
                <div class="charge-item">
                    <input type="text" class="charge-input" placeholder="Enter charge (e.g. 10+ MPH over limit)">
                    <button type="button" class="btn-remove-charge" onclick="this.parentElement.remove()"></button>
                </div>
            `;
        }

        addChargeBtn.onclick = () => {
            const chargeItem = document.createElement('div');
            chargeItem.className = 'charge-item';
            chargeItem.innerHTML = `
                <input type="text" class="charge-input" placeholder="Enter charge">
                <button type="button" class="btn-remove-charge" onclick="this.parentElement.remove()"></button>
            `;
            chargesList.appendChild(chargeItem);
        };

        ticketForm.onsubmit = async e => {
            e.preventDefault();
            
            const civilianId = document.getElementById('ticketCivilianId').value;
            const civilianName = document.getElementById('ticketCivilianName').textContent;
            const ticketType = document.getElementById('ticketType').value;
            const location = document.getElementById('ticketLocation').value.trim();
            const fine = document.getElementById('ticketFine').value;
            const notes = document.getElementById('ticketNotes').value.trim();
            
            const charges = [];
            document.querySelectorAll('.charge-input').forEach(input => {
                if (input.value.trim()) charges.push(input.value.trim());
            });

            const signatureData = signaturePad.toDataURL();
            const ticketNumber = 'TKT-' + Date.now().toString(36).toUpperCase();

            const ticketData = {
                ticket_number: ticketNumber,
                civilian_id: civilianId,
                civilian_name: civilianName,
                ticket_type: ticketType,
                location: location,
                fine: parseFloat(fine),
                charges: charges,
                notes: notes,
                officer_signature: signatureData,
                officer_callsign: mdtCallsign.textContent,
                issued_at: new Date().toISOString(),
                community_id: currentCommunityId
            };

            const { data, error } = await db
                .from('tickets')
                .insert([ticketData])
                .select()
                .single();

            if (error) {
                alert('Error issuing ticket: ' + error.message);
                console.error(error);
                return;
            }

            // Send Discord webhook for ticket creation
            sendTicketWebhook(data);

            alert(`Ticket ${ticketNumber} issued successfully to ${civilianName}!`);
            ticketModal.classList.remove('active');
            ticketForm.reset();
            resetCharges();
            if (signatureCtx) signatureCtx.clearRect(0, 0, signaturePad.width, signaturePad.height);
        };

        async function loadMyTickets() {
            if (!currentUser || !currentCommunityId) return;
            
            const { data: myChars } = await db
                .from('characters')
                .select('id')
                .eq('user_id', currentUser.id)
                .eq('community_id', currentCommunityId);
            
            if (!myChars || myChars.length === 0) {
                document.getElementById('ticketsList').innerHTML = '<div class="no-tickets">No tickets issued to your characters.</div>';
                return;
            }

            const charIds = myChars.map(c => c.id);
            
            const { data: tickets, error } = await db
                .from('tickets')
                .select('*')
                .in('civilian_id', charIds)
                .eq('community_id', currentCommunityId)
                .order('issued_at', { ascending: false });

            if (error) {
                console.error('Error loading tickets:', error);
                document.getElementById('ticketsList').innerHTML = '<div class="no-tickets">Error loading tickets.</div>';
                return;
            }

            if (!tickets || tickets.length === 0) {
                document.getElementById('ticketsList').innerHTML = '<div class="no-tickets">No tickets issued to your characters.</div>';
                return;
            }

            document.getElementById('ticketsList').innerHTML = tickets.map(t => `
                <div class="ticket-card">
                    <div class="ticket-header">
                        <span class="ticket-id">${t.ticket_number}</span>
                        <span class="ticket-date">${new Date(t.issued_at).toLocaleString()}</span>
                    </div>
                    <div class="ticket-info"><strong>Type:</strong> ${t.ticket_type}</div>
                    <div class="ticket-info"><strong>Issued To:</strong> ${t.civilian_name}</div>
                    <div class="ticket-info"><strong>Location:</strong> ${t.location}</div>
                    <div class="ticket-info"><strong>Fine:</strong> $${t.fine.toFixed(2)}</div>
                    ${t.notes ? `<div class="ticket-info"><strong>Notes:</strong> ${t.notes}</div>` : ''}
                    <div class="ticket-charges">
                        <h4>Charges</h4>
                        ${(t.charges || []).map(charge => `<div class="charge">${charge}</div>`).join('')}
                    </div>
                    <div class="ticket-signature">
                        <h4>Officer Signature (${t.officer_callsign})</h4>
                        <img src="${t.officer_signature}" alt="Officer Signature">
                    </div>
                </div>
            `).join('');
        }

        // BOLO System
        const createBoloBtn = document.getElementById('createBoloBtn');
        const createBoloModal = document.getElementById('createBoloModal');
        const closeCreateBolo = document.getElementById('closeCreateBolo');
        const cancelCreateBolo = document.getElementById('cancelCreateBolo');
        const createBoloForm = document.getElementById('createBoloForm');
        const bolosTableBody = document.getElementById('bolosTableBody');

        createBoloBtn.onclick = () => createBoloModal.classList.add('active');
        closeCreateBolo.onclick = () => { createBoloModal.classList.remove('active'); createBoloForm.reset(); };
        cancelCreateBolo.onclick = () => { createBoloModal.classList.remove('active'); createBoloForm.reset(); };
        createBoloModal.onclick = e => { if (e.target === createBoloModal) { createBoloModal.classList.remove('active'); createBoloForm.reset(); } };

        createBoloForm.onsubmit = async e => {
            e.preventDefault();
            const type = document.getElementById('boloType').value;
            const details = document.getElementById('boloDetails').value.trim();
            const issuedBy = mdtCallsign.textContent;

            const { data, error } = await db
                .from('bolos')
                .insert([{
                    type: type,
                    details: details,
                    issued_by: issuedBy,
                    created_at: new Date().toISOString()
                }])
                .select()
                .single();

            if (error) {
                alert('Error creating BOLO: ' + error.message);
                return;
            }

            createBoloModal.classList.remove('active');
            createBoloForm.reset();
            loadBolos();
        };

        async function loadBolos() {
            const { data: bolos, error } = await db
                .from('bolos')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error loading BOLOs:', error);
                bolosTableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#6b7280;">Error loading BOLOs</td></tr>';
                return;
            }

            if (!bolos || bolos.length === 0) {
                bolosTableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#6b7280;">No active BOLOs</td></tr>';
                return;
            }

            bolosTableBody.innerHTML = bolos.map(b => `
                <tr>
                    <td><span style="padding:4px 8px;background:${b.type === 'Person' ? '#3b82f6' : '#22c55e'};border-radius:4px;font-size:11px;color:#fff;">${b.type}</span></td>
                    <td>${b.details}</td>
                    <td>${new Date(b.created_at).toLocaleString()}</td>
                    <td>
                        ${b.issued_by}
                        <button onclick="deleteBolo('${b.id}')" style="margin-left:8px;padding:4px 8px;background:#ef4444;border:none;border-radius:4px;color:#fff;font-size:10px;cursor:pointer;">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        window.deleteBolo = async function(id) {
            const { error } = await db
                .from('bolos')
                .delete()
                .eq('id', id);

            if (error) {
                alert('Error deleting BOLO: ' + error.message);
                return;
            }
            loadBolos();
        };

        loadBolos();

        // Admin Page
                // Webhooks Modal logic
                const openWebhooksModal = document.getElementById('openWebhooksModal');
                const webhooksModal = document.getElementById('webhooksModal');
                const closeWebhooksModal = document.getElementById('closeWebhooksModal');

                openWebhooksModal.onclick = async () => {
                    // Load webhooks for current community from Supabase
                    if (!currentCommunityId) return;
                    const { data, error } = await db
                        .from('community_webhooks')
                        .select('*')
                        .eq('community_id', currentCommunityId)
                        .single();
                    if (data) {
                        document.getElementById('webhookCharacterCreated').value = data.character_created_webhook || '';
                        document.getElementById('webhookTicketCreated').value = data.ticket_created_webhook || '';
                    } else {
                        document.getElementById('webhookCharacterCreated').value = '';
                        document.getElementById('webhookTicketCreated').value = '';
                    }
                    webhooksModal.classList.add('active');
                };
                closeWebhooksModal.onclick = () => webhooksModal.classList.remove('active');
                webhooksModal.onclick = e => { if (e.target === webhooksModal) webhooksModal.classList.remove('active'); };

                document.getElementById('saveWebhookBtn').onclick = async () => {
                    if (!currentCommunityId) {
                        alert('Error: currentCommunityId is not set.');
                        return;
                    }
                    const characterWebhook = document.getElementById('webhookCharacterCreated').value.trim();
                    const ticketWebhook = document.getElementById('webhookTicketCreated').value.trim();
                    console.log('Saving webhooks for community:', currentCommunityId);
                    console.log('Character webhook:', characterWebhook);
                    console.log('Ticket webhook:', ticketWebhook);
                    try {
                        const { data, error } = await db
                            .from('community_webhooks')
                            .upsert({
                                community_id: currentCommunityId,
                                character_created_webhook: characterWebhook,
                                ticket_created_webhook: ticketWebhook
                            }, { onConflict: 'community_id' })
                            .select();
                        console.log('Upsert result:', { data, error });
                        if (error) {
                            console.error('Supabase upsert error:', error);
                            alert('Error saving webhooks: ' + error.message);
                            webhooksModal.classList.remove('active');
                            return;
                        }
                        webhooksModal.classList.remove('active');
                        alert('Webhooks saved!');
                    } catch (e) {
                        console.error('Exception during Supabase upsert:', e);
                        alert('Exception saving webhooks: ' + e.message);
                        webhooksModal.classList.remove('active');
                    }
                };
        const adminBtn = document.getElementById('adminBtn');
        const adminPage = document.getElementById('adminPage');
        const backFromAdmin = document.getElementById('backFromAdmin');
        const openDiscordSettingsFromAdmin = document.getElementById('openDiscordSettingsFromAdmin');

        adminBtn.onclick = async () => {
            communityScreen.classList.remove('active');
            adminPage.style.display = 'block';
            loadAdminTones();
            loadAdminDepartments();
            loadWebhooks();
            loadRosters();
            loadRosterDepartments();
            // Check ERLC beta access (staff only)
            await updateErlcPanelAccess();
        };

        backFromAdmin.onclick = () => {
            adminPage.style.display = 'none';
            communityScreen.classList.add('active');
        };
        // Discord Settings button and logic removed as requested

        // Roster System
        const rosterTableBody = document.getElementById('rosterTableBody');
        const rosterPublicLink = document.getElementById('rosterPublicLink');
        const copyRosterLink = document.getElementById('copyRosterLink');
        const addRosterEntry = document.getElementById('addRosterEntry');
        const rosterDepartmentSelect = document.getElementById('rosterDepartment');
        const currentRosterSelect = document.getElementById('currentRosterSelect');
        const createRosterBtn = document.getElementById('createRosterBtn');
        const deleteRosterBtn = document.getElementById('deleteRosterBtn');
        const rosterEntryForm = document.getElementById('rosterEntryForm');
        const rosterLinkSection = document.getElementById('rosterLinkSection');

        let currentRosterId = null;
        const rosterUpgradeRequired = document.getElementById('rosterUpgradeRequired');
        const rosterContent = document.getElementById('rosterContent');

        async function checkRosterPlanAccess() {
            if (!currentCommunityId) return false;
            
            const { data: community } = await db
                .from('communities')
                .select('plan')
                .eq('id', currentCommunityId)
                .single();
            
            const plan = community?.plan || 'free';
            const allowedPlans = ['starter', 'standard', 'advanced'];
            
            return allowedPlans.includes(plan);
        }

        async function loadRosters() {
            if (!currentCommunityId || !currentRosterSelect) return;
            
            // Check if community has required plan
            const hasAccess = await checkRosterPlanAccess();
            
            if (!hasAccess) {
                if (rosterUpgradeRequired) rosterUpgradeRequired.style.display = 'block';
                if (rosterContent) rosterContent.style.display = 'none';
                return;
            }
            
            if (rosterUpgradeRequired) rosterUpgradeRequired.style.display = 'none';
            if (rosterContent) rosterContent.style.display = 'block';
            
            const { data: rosters, error } = await db
                .from('rosters')
                .select('*')
                .eq('community_id', currentCommunityId)
                .order('name', { ascending: true });

            if (error) {
                console.error('Error loading rosters:', error);
                return;
            }

            currentRosterSelect.innerHTML = '<option value="">-- Select a Roster --</option>';
            if (rosters && rosters.length > 0) {
                currentRosterSelect.innerHTML += rosters.map(r => 
                    `<option value="${r.id}">${r.name}</option>`
                ).join('');
            }
            
            // Reset form visibility
            if (rosterEntryForm) rosterEntryForm.style.display = 'none';
            if (rosterLinkSection) rosterLinkSection.style.display = 'none';
            currentRosterId = null;
        }

        if (currentRosterSelect) {
            currentRosterSelect.onchange = async () => {
                currentRosterId = currentRosterSelect.value;
                if (currentRosterId) {
                    rosterEntryForm.style.display = 'block';
                    rosterLinkSection.style.display = 'block';
                    updateRosterLink();
                    loadRosterEntries();
                } else {
                    rosterEntryForm.style.display = 'none';
                    rosterLinkSection.style.display = 'none';
                }
            };
        }

        if (createRosterBtn) {
            createRosterBtn.onclick = async () => {
                const name = document.getElementById('newRosterName').value.trim();
                if (!name) {
                    alert('Please enter a roster name');
                    return;
                }

                const { error } = await db
                    .from('rosters')
                    .insert([{ community_id: currentCommunityId, name: name }]);

                if (error) {
                    alert('Error creating roster: ' + error.message);
                    return;
                }

                document.getElementById('newRosterName').value = '';
                loadRosters();
            };
        }

        if (deleteRosterBtn) {
            deleteRosterBtn.onclick = async () => {
                if (!currentRosterId) {
                    alert('Please select a roster first');
                    return;
                }
                if (!confirm('Are you sure you want to delete this roster and all its entries?')) return;

                // Delete all entries first
                await db.from('roster_entries').delete().eq('roster_id', currentRosterId);
                // Then delete the roster
                const { error } = await db.from('rosters').delete().eq('id', currentRosterId);

                if (error) {
                    alert('Error deleting roster: ' + error.message);
                    return;
                }

                loadRosters();
            };
        }

        async function loadRosterEntries() {
            if (!currentRosterId || !rosterTableBody) return;
            
            const { data: entries, error } = await db
                .from('roster_entries')
                .select('*')
                .eq('roster_id', currentRosterId)
                .order('name', { ascending: true });

            if (error) {
                console.error('Error loading roster entries:', error);
                rosterTableBody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#ef4444;padding:20px;">Error loading roster</td></tr>';
                return;
            }

            if (!entries || entries.length === 0) {
                rosterTableBody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#6b7280;padding:20px;">No roster entries yet</td></tr>';
                return;
            }

            const statusColors = {
                'Active': '#22c55e',
                'LOA': '#f59e0b',
                'Suspended': '#ef4444',
                'Inactive': '#6b7280'
            };

            rosterTableBody.innerHTML = entries.map(e => `
                <tr style="border-bottom:1px solid #1e222d;">
                    <td style="padding:12px;color:#e4e4e7;font-size:13px;">${e.name}</td>
                    <td style="padding:12px;color:#a1a1aa;font-size:13px;">${e.rank || 'N/A'}</td>
                    <td style="padding:12px;color:#a1a1aa;font-size:13px;">${e.callsign || 'N/A'}</td>
                    <td style="padding:12px;color:#a1a1aa;font-size:13px;">${e.badge || 'N/A'}</td>
                    <td style="padding:12px;color:#a1a1aa;font-size:13px;">${e.department || 'N/A'}</td>
                    <td style="padding:12px;"><span style="padding:4px 10px;border-radius:12px;font-size:11px;font-weight:600;background:${statusColors[e.status] || '#6b7280'}20;color:${statusColors[e.status] || '#6b7280'};">${e.status}</span></td>
                    <td style="padding:12px;"><button onclick="deleteRosterEntry('${e.id}')" style="padding:6px 12px;background:#ef4444;border:none;border-radius:4px;color:#fff;font-size:11px;cursor:pointer;">Delete</button></td>
                </tr>
            `).join('');
        }

        async function loadRosterDepartments() {
            if (!currentCommunityId || !rosterDepartmentSelect) return;
            
            const { data: depts } = await db
                .from('departments')
                .select('*')
                .eq('community_id', currentCommunityId)
                .order('code', { ascending: true });

            if (depts && depts.length > 0) {
                rosterDepartmentSelect.innerHTML = '<option value="">Department</option>' + 
                    depts.map(d => `<option value="${d.code}">${d.code} - ${d.name}</option>`).join('');
            }
        }

        async function updateRosterLink() {
            if (!rosterPublicLink || !currentRosterId) return;
            
            const { data: roster } = await db.from('rosters').select('id').eq('id', currentRosterId).single();
            const { data: community } = await db.from('communities').select('code').eq('id', currentCommunityId).single();
            
            if (roster && community) {
                const baseUrl = window.location.origin + window.location.pathname;
                rosterPublicLink.value = `${baseUrl}?roster=${community.code}&id=${currentRosterId}`;
            }
        }

        if (copyRosterLink) {
            copyRosterLink.onclick = () => {
                rosterPublicLink.select();
                document.execCommand('copy');
                copyRosterLink.textContent = 'Copied!';
                setTimeout(() => { copyRosterLink.textContent = 'Copy Link'; }, 2000);
            };
        }

        if (addRosterEntry) {
            addRosterEntry.onclick = async () => {
                if (!currentRosterId) {
                    alert('Please select a roster first');
                    return;
                }

                const name = document.getElementById('rosterMemberName').value.trim();
                const rank = document.getElementById('rosterRank').value.trim();
                const callsign = document.getElementById('rosterCallsign').value.trim();
                const badge = document.getElementById('rosterBadge').value.trim();
                const department = document.getElementById('rosterDepartment').value;
                const status = document.getElementById('rosterStatus').value;

                if (!name) {
                    alert('Please enter a name');
                    return;
                }

                const { error } = await db
                    .from('roster_entries')
                    .insert([{
                        roster_id: currentRosterId,
                        name: name,
                        rank: rank,
                        callsign: callsign,
                        badge: badge,
                        department: department,
                        status: status
                    }]);

                if (error) {
                    alert('Error adding roster entry: ' + error.message);
                    return;
                }

                document.getElementById('rosterMemberName').value = '';
                document.getElementById('rosterRank').value = '';
                document.getElementById('rosterCallsign').value = '';
                document.getElementById('rosterBadge').value = '';
                document.getElementById('rosterDepartment').value = '';
                document.getElementById('rosterStatus').value = 'Active';
                loadRosterEntries();
            };
        }

        window.deleteRosterEntry = async function(id) {
            if (!confirm('Are you sure you want to remove this roster entry?')) return;
            
            const { error } = await db.from('roster_entries').delete().eq('id', id);
            if (error) {
                alert('Error deleting entry: ' + error.message);
                return;
            }
            loadRosterEntries();
        };

        // Public Roster Page
        async function checkPublicRoster() {
            const params = new URLSearchParams(window.location.search);
            const rosterCode = params.get('roster');
            const rosterId = params.get('id');
            
            if (rosterCode && rosterId) {
                // Hide everything else, show roster page
                document.querySelectorAll('header, .hero, .dashboard, .pricing-section, .team-section').forEach(el => {
                    if (el) el.style.display = 'none';
                });
                document.getElementById('publicRosterPage').style.display = 'block';
                
                // Get roster info
                const { data: roster, error: rosterError } = await db
                    .from('rosters')
                    .select('id, name, community_id')
                    .eq('id', rosterId)
                    .single();

                if (rosterError || !roster) {
                    document.getElementById('publicRosterCommunity').textContent = 'Roster not found';
                    document.getElementById('publicRosterBody').innerHTML = '<tr><td colspan="6" style="text-align:center;color:#ef4444;padding:40px;">Invalid roster link</td></tr>';
                    return;
                }

                // Get community info
                const { data: community } = await db
                    .from('communities')
                    .select('name')
                    .eq('id', roster.community_id)
                    .single();

                document.getElementById('publicRosterTitle').textContent = roster.name;
                document.getElementById('publicRosterCommunity').textContent = community ? community.name : 'Department Roster';

                // Get roster entries
                const { data: entries } = await db
                    .from('roster_entries')
                    .select('*')
                    .eq('roster_id', rosterId)
                    .order('name', { ascending: true });

                if (!entries || entries.length === 0) {
                    document.getElementById('publicRosterBody').innerHTML = '<tr><td colspan="6" style="text-align:center;color:#6b7280;padding:40px;">No roster entries</td></tr>';
                    return;
                }

                const statusColors = {
                    'Active': '#22c55e',
                    'LOA': '#f59e0b',
                    'Suspended': '#ef4444',
                    'Inactive': '#6b7280'
                };

                document.getElementById('publicRosterBody').innerHTML = entries.map(e => `
                    <tr style="border-bottom:1px solid #1e222d;">
                        <td style="padding:14px 16px;color:#e4e4e7;font-size:13px;">${e.name}</td>
                        <td style="padding:14px 16px;color:#a1a1aa;font-size:13px;">${e.rank || 'N/A'}</td>
                        <td style="padding:14px 16px;color:#a1a1aa;font-size:13px;">${e.callsign || 'N/A'}</td>
                        <td style="padding:14px 16px;color:#a1a1aa;font-size:13px;">${e.badge || 'N/A'}</td>
                        <td style="padding:14px 16px;color:#a1a1aa;font-size:13px;">${e.department || 'N/A'}</td>
                        <td style="padding:14px 16px;"><span style="padding:4px 10px;border-radius:12px;font-size:11px;font-weight:600;background:${statusColors[e.status] || '#6b7280'}20;color:${statusColors[e.status] || '#6b7280'};">${e.status}</span></td>
                    </tr>
                `).join('');
            }
        }

        // Check for roster URL on page load
        checkPublicRoster();

        // Departments System
        const officerDepartmentSelect = document.getElementById('officerDepartment');
        const adminDepartmentsTable = document.getElementById('adminDepartmentsTable');
        const adminAddDeptBtn = document.getElementById('adminAddDeptBtn');
        const adminDeptCode = document.getElementById('adminDeptCode');
        const adminDeptName = document.getElementById('adminDeptName');

        async function loadDepartments() {
            if (!officerDepartmentSelect) return;
            
            const { data: depts, error } = await db
                .from('departments')
                .select('*')
                .order('code', { ascending: true });

            if (error) {
                console.error('Error loading departments:', error);
                return;
            }

            if (!depts || depts.length === 0) {
                officerDepartmentSelect.innerHTML = '<option value="">No departments available</option>';
                return;
            }

            officerDepartmentSelect.innerHTML = depts.map(d => 
                `<option value="${d.code}">${d.code} - ${d.name}</option>`
            ).join('');
        }

        async function loadAdminDepartments() {
            const { data: depts, error } = await db
                .from('departments')
                .select('*')
                .order('code', { ascending: true });

            if (error) {
                console.error('Error loading departments:', error);
                adminDepartmentsTable.innerHTML = '<tr><td colspan="3" style="text-align:center;color:#6b7280;">Error loading</td></tr>';
                return;
            }

            if (!depts || depts.length === 0) {
                adminDepartmentsTable.innerHTML = '<tr><td colspan="3" style="text-align:center;color:#6b7280;">No departments yet</td></tr>';
                return;
            }

            adminDepartmentsTable.innerHTML = depts.map(d => `
                <tr>
                    <td>${d.code}</td>
                    <td>${d.name}</td>
                    <td>
                        <button onclick="deleteDepartment('${d.id}')" style="padding:4px 10px;background:#ef4444;border:none;border-radius:4px;color:#fff;font-size:11px;cursor:pointer;">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        if (adminAddDeptBtn) {
            adminAddDeptBtn.onclick = async () => {
                const code = adminDeptCode.value.trim().toUpperCase();
                const name = adminDeptName.value.trim();

                if (!code || !name) {
                    alert('Please enter both code and name');
                    return;
                }

                const { error } = await db
                    .from('departments')
                    .insert([{ code, name }]);

                if (error) {
                    alert('Error adding department: ' + error.message);
                    return;
                }

                adminDeptCode.value = '';
                adminDeptName.value = '';
                loadAdminDepartments();
                loadDepartments();
            };
        }

        window.deleteDepartment = async function(id) {
            if (!confirm('Delete this department?')) return;
            
            const { error } = await db
                .from('departments')
                .delete()
                .eq('id', id);

            if (error) {
                alert('Error deleting department: ' + error.message);
                return;
            }
            loadAdminDepartments();
            loadDepartments();
        };

        loadDepartments();

        // Webhooks System
        const webhookCharacterCreated = document.getElementById('webhookCharacterCreated');
        const saveWebhookBtn = document.getElementById('saveWebhookBtn');
        const webhookStatus = document.getElementById('webhookStatus');

        async function loadWebhooks() {
            const { data, error } = await db
                .from('settings')
                .select('*')
                .eq('key', 'webhook_character_created')
                .single();

            if (data) {
                webhookCharacterCreated.value = data.value || '';
            }
        }

        saveWebhookBtn.onclick = async () => {
            const url = webhookCharacterCreated.value.trim();

            const { data: existing } = await db
                .from('settings')
                .select('*')
                .eq('key', 'webhook_character_created')
                .single();

            let error;
            if (existing) {
                const result = await db
                    .from('settings')
                    .update({ value: url })
                    .eq('key', 'webhook_character_created');
                error = result.error;
            } else {
                const result = await db
                    .from('settings')
                    .insert([{ key: 'webhook_character_created', value: url }]);
                error = result.error;
            }

            if (error) {
                webhookStatus.textContent = 'Error saving webhook: ' + error.message;
                webhookStatus.style.color = '#ef4444';
            } else {
                webhookStatus.textContent = 'Webhook saved!';
                webhookStatus.style.color = '#22c55e';
                setTimeout(() => { webhookStatus.textContent = ''; }, 3000);
            }
        };


        async function sendCharacterWebhook(character) {
            const { data } = await db
                .from('settings')
                .select('value')
                .eq('key', 'webhook_character_created')
                .single();

            if (!data || !data.value) return;

            try {
                await fetch(data.value, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        embeds: [{
                            title: 'New Character Created',
                            color: 3447003,
                            fields: [
                                { name: 'Name', value: `${character.first_name} ${character.last_name}`, inline: true },
                                { name: 'Gender', value: character.gender, inline: true },
                                { name: 'DOB', value: character.date_of_birth, inline: true },
                                { name: 'Phone', value: character.phone || 'N/A', inline: true }
                            ],
                            timestamp: new Date().toISOString()
                        }]
                    })
                });
            } catch (e) {
                console.error('Webhook error:', e);
            }
        }

        // Send Discord webhook for ticket creation
        async function sendTicketWebhook(ticket) {
            console.log('sendTicketWebhook called with:', ticket);
            if (!ticket || !ticket.community_id) {
                console.log('sendTicketWebhook: No ticket or community_id', ticket);
                return;
            }
            // Get webhook for this community from community_webhooks table
            const { data, error } = await db
                .from('community_webhooks')
                .select('ticket_created_webhook')
                .eq('community_id', ticket.community_id)
                .maybeSingle();
            console.log('Webhook lookup result:', { data, error });
            if (error) {
                console.error('Error fetching ticket webhook:', error);
                return;
            }
            if (!data || !data.ticket_created_webhook) {
                console.log('sendTicketWebhook: No webhook URL configured for community:', ticket.community_id);
                return;
            }
            console.log('Sending ticket webhook to:', data.ticket_created_webhook);
            try {
                const response = await fetch(data.ticket_created_webhook, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        embeds: [{
                            title: 'New Ticket Issued',
                            color: 16753920,
                            fields: [
                                { name: 'Ticket Number', value: ticket.ticket_number || 'N/A', inline: true },
                                { name: 'Civilian', value: ticket.civilian_name || 'N/A', inline: true },
                                { name: 'Type', value: ticket.ticket_type || 'N/A', inline: true },
                                { name: 'Location', value: ticket.location || 'N/A', inline: true },
                                { name: 'Fine', value: `$${(ticket.fine || 0).toFixed(2)}`, inline: true },
                                { name: 'Charges', value: (ticket.charges && ticket.charges.length > 0 ? ticket.charges.join(', ') : 'None'), inline: false },
                                { name: 'Notes', value: ticket.notes || 'None', inline: false },
                                { name: 'Officer', value: ticket.officer_callsign || 'N/A', inline: true }
                            ],
                            timestamp: ticket.issued_at
                        }]
                    })
                });
                console.log('Ticket webhook response:', response.status);
            } catch (e) {
                console.error('Ticket webhook error:', e);
            }
        }

        loadWebhooks();

        // =====================
        // STAFF ACCESS MANAGEMENT
        // =====================
        window.grantStaffAccess = async function(userId) {
            const { error } = await db
                .from('staff_access')
                .insert([{ user_id: userId }]);

            if (error) {
                alert('Error granting access: ' + error.message);
                return;
            }

            loadStaffData();
        };

        window.revokeStaffAccess = async function(userId) {
            if (!confirm('Are you sure you want to revoke staff access?')) return;

            const { error } = await db
                .from('staff_access')
                .delete()
                .eq('user_id', userId);

            if (error) {
                alert('Error revoking access: ' + error.message);
                return;
            }

            loadStaffData();
        };

        // Global Refresh System
        async function globalRefresh() {
            const btn = document.getElementById('globalRefreshBtn');
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16" style="animation:spin 1s linear infinite;"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg> Refreshing...';
            }
            try {
                await loadCommunities();
                if (document.getElementById('staffDashboard').style.display === 'block') {
                    await loadStaffData();
                    if (typeof loadAccessCodes === 'function') await loadAccessCodes();
                }
                if (policeMdt.classList.contains('active')) {
                    await renderActiveUnits();
                    await loadBolos();
                }
                if (dispatchMdt.classList.contains('active')) {
                    await renderDispatchUnits();
                }
                if (civilianPage.classList.contains('active')) {
                    await loadCharacters();
                }
                updateCreditsDisplay();
            } catch (e) {
                console.error('Global refresh error:', e);
            }
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg> Refresh';
            }
        }

        document.getElementById('globalRefreshBtn').onclick = globalRefresh;

        // User Hub System
        const userHubSection = document.getElementById('userHubSection');
        let userCredits = parseInt(localStorage.getItem('pulsecad_credits') || '0');

        function showUserHub(user) {
            heroSection.style.display = 'none';
            userHubSection.style.display = 'block';
            
            document.getElementById('hubUsername').textContent = user.display_name || user.username;
            updateCreditsDisplay();
        }

        function hideUserHub() {
            userHubSection.style.display = 'none';
            heroSection.style.display = 'flex';
        }

        function updateCreditsDisplay() {
            const credits = parseInt(localStorage.getItem('pulsecad_credits') || '0');
            const hubCredits = document.getElementById('hubCredits');
            const hubCreditsDisplay = document.getElementById('hubCreditsDisplay');
            const hubProgressFill = document.getElementById('hubProgressFill');
            
            if (hubCredits) hubCredits.textContent = credits;
            if (hubCreditsDisplay) hubCreditsDisplay.textContent = credits + ' credits';
            
            // Update progress bar (max 10 credits for full bar)
            if (hubProgressFill) {
                const progress = Math.min(credits / 10 * 100, 100);
                hubProgressFill.style.width = progress + '%';
            }
        }

        // Hub button handlers
        const hubOpenMDTBtn = document.getElementById('hubOpenMDT');
        if (hubOpenMDTBtn) {
            hubOpenMDTBtn.onclick = () => {
                const credits = parseInt(localStorage.getItem('pulsecad_credits') || '0');
                if (credits < 1) {
                    alert('You need at least 1 credit to access the MDT. Redeem a key to get credits!');
                    return;
                }
                // Show community list or first community
                userHubSection.style.display = 'none';
                communityScreen.classList.add('active');
            };
        }

        const hubRedeemKeyBtn = document.getElementById('hubRedeemKey');
        if (hubRedeemKeyBtn) {
            hubRedeemKeyBtn.onclick = () => {
                const section = document.getElementById('hubRedeemSection');
                if (section) {
                    section.style.display = section.style.display === 'none' ? 'block' : 'none';
                    if (section.style.display === 'block') {
                        const keyInput = document.getElementById('hubKeyInput');
                        if (keyInput) keyInput.focus();
                    }
                }
            };
        }

        // Hub redeem functionality (SQL-backed)
        const hubRedeemBtn = document.getElementById('hubRedeemBtn');
        if (hubRedeemBtn) {
            hubRedeemBtn.onclick = async () => {
            const inputCode = document.getElementById('hubKeyInput').value.trim().toUpperCase();
            const hubError = document.getElementById('hubRedeemError');
            const hubSuccess = document.getElementById('hubRedeemSuccess');
            
            hubError.style.display = 'none';
            hubSuccess.style.display = 'none';
            
            if (!inputCode) {
                hubError.textContent = 'Please enter a code.';
                hubError.style.display = 'block';
                return;
            }
            
            if (!currentUser) {
                hubError.textContent = 'You must be logged in to redeem codes.';
                hubError.style.display = 'block';
                return;
            }
            
            // Check if code exists in database
            const { data: codeData, error: findError } = await db
                .from('access_codes')
                .select('*')
                .eq('code', inputCode)
                .single();
            
            if (findError || !codeData) {
                hubError.textContent = 'Invalid code. Please check and try again.';
                hubError.style.display = 'block';
                return;
            }
            
            // Check if expired
            if (codeData.expires_at && new Date() > new Date(codeData.expires_at)) {
                hubError.textContent = 'This code has expired.';
                hubError.style.display = 'block';
                return;
            }
            
            // Check if max uses reached
            const timesUsed = codeData.times_used || 0;
            const maxUses = codeData.max_uses || null;
            if (maxUses && timesUsed >= maxUses) {
                hubError.textContent = 'This code has reached its maximum number of uses.';
                hubError.style.display = 'block';
                return;
            }
            
            // Increment uses and mark as fully redeemed if max reached
            const newTimesUsed = timesUsed + 1;
            const isFullyUsed = maxUses ? newTimesUsed >= maxUses : false;
            
            const { error: updateError } = await db
                .from('access_codes')
                .update({
                    times_used: newTimesUsed,
                    redeemed: isFullyUsed,
                    redeemed_at: new Date().toISOString(),
                    redeemed_by: currentUser.id
                })
                .eq('id', codeData.id);
            
            if (updateError) {
                hubError.textContent = 'Error redeeming code: ' + updateError.message;
                hubError.style.display = 'block';
                return;
            }
            
            // Update user credits in database
            const { data: userData } = await db
                .from('users')
                .select('credits')
                .eq('id', currentUser.id)
                .single();
            
            const currentCredits = userData?.credits || 0;
            await db
                .from('users')
                .update({ credits: currentCredits + 1 })
                .eq('id', currentUser.id);
            
            // Update local state
            redeemedCodes.push(inputCode);
            await loadAccessCodes();
            
            hubSuccess.textContent = 'Code redeemed! You received 1 credit.';
            hubSuccess.style.display = 'block';
            document.getElementById('hubKeyInput').value = '';
            
            updateCreditsDisplay();
            
            setTimeout(() => {
                hubSuccess.style.display = 'none';
            }, 3000);
            };
        }

        // Access Code System (SQL-backed)
        let accessCodes = [];
        let redeemedCodes = [];

        function generateCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 4; i++) {
                if (i > 0) code += '-';
                for (let j = 0; j < 4; j++) {
                    code += chars.charAt(Math.floor(Math.random() * chars.length));
                }
            }
            return code;
        }

        // Load access codes from database
        async function loadAccessCodes() {
            const { data, error } = await db
                .from('access_codes')
                .select('*')
                .order('created_at', { ascending: false });
            
            if (error) {
                console.error('Error loading access codes:', error);
                return;
            }
            
            accessCodes = (data || []).map(c => ({
                id: c.id,
                code: c.code,
                note: c.note,
                created: c.created_at,
                redeemed: c.redeemed,
                redeemedAt: c.redeemed_at,
                redeemedBy: c.redeemed_by,
                max_uses: c.max_uses || null,
                times_used: c.times_used || 0,
                expires_at: c.expires_at
            }));
            
            renderAccessCodes();
        }

        // Load user's redeemed codes from database
        async function loadRedeemedCodes() {
            if (!currentUser) return;
            
            const { data, error } = await db
                .from('access_codes')
                .select('code')
                .eq('redeemed_by', currentUser.id);
            
            if (error) {
                console.error('Error loading redeemed codes:', error);
                return;
            }
            
            redeemedCodes = (data || []).map(c => c.code);
        }

        function renderAccessCodes() {
            const tbody = document.getElementById('accessCodesTable');
            if (!tbody) return;
            if (accessCodes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#6b7280;">No access codes yet</td></tr>';
                return;
            }
            tbody.innerHTML = accessCodes.map(c => {
                let status = 'Active';
                let statusColor = '#f97316';
                if (c.expires_at && new Date() > new Date(c.expires_at)) {
                    status = 'Expired';
                    statusColor = '#ef4444';
                }
                if (c.max_uses && c.times_used >= c.max_uses) {
                    status = 'Maxed Out';
                    statusColor = '#6b7280';
                }
                if (c.redeemed) {
                    status = 'Fully Used';
                    statusColor = '#22c55e';
                }
                const usesDisplay = c.max_uses ? `${c.times_used} / ${c.max_uses}` : `${c.times_used} / `;
                return `
                <tr>
                    <td><code style="background:#1e293b;padding:4px 8px;border-radius:4px;font-family:monospace;">${c.code}</code></td>
                    <td>${c.note || '-'}</td>
                    <td>${usesDisplay}</td>
                    <td>${new Date(c.created).toLocaleDateString()}</td>
                    <td><span style="color:${statusColor}">${status}</span></td>
                    <td>
                        <button onclick="copyCode('${c.code}')" style="padding:4px 10px;background:#3b82f6;border:none;border-radius:4px;color:#fff;cursor:pointer;font-size:12px;margin-right:4px;">Copy</button>
                        <button onclick="deleteCode('${c.id}')" style="padding:4px 10px;background:#ef4444;border:none;border-radius:4px;color:#fff;cursor:pointer;font-size:12px;">Delete</button>
                    </td>
                </tr>
                `;
            }).join('');
        }

        window.copyCode = function(code) {
            navigator.clipboard.writeText(code);
            alert('Code copied: ' + code);
        };

        window.deleteCode = async function(id) {
            if (!confirm('Delete this access code?')) return;
            
            const { error } = await db
                .from('access_codes')
                .delete()
                .eq('id', id);
            
            if (error) {
                alert('Error deleting code: ' + error.message);
                return;
            }
            
            await loadAccessCodes();
        };

        document.getElementById('generateAccessCode').onclick = async () => {
            const note = document.getElementById('accessCodeNote').value.trim();
            const duration = parseInt(document.getElementById('accessCodeDuration').value, 10);
            const maxUses = parseInt(document.getElementById('accessCodeMaxUses').value, 10);
            const newCode = generateCode();
            let expires_at = null;
            if (!isNaN(duration) && duration > 0) {
                expires_at = new Date(Date.now() + duration * 60 * 60 * 1000).toISOString();
            }
            const insertData = {
                code: newCode,
                note: note || null,
                redeemed: false,
                expires_at,
                times_used: 0
            };
            if (!isNaN(maxUses) && maxUses > 0) {
                insertData.max_uses = maxUses;
            }
            const { data, error } = await db
                .from('access_codes')
                .insert([insertData])
                .select()
                .single();
            if (error) {
                alert('Error creating access code: ' + error.message);
                return;
            }
            document.getElementById('accessCodeNote').value = '';
            document.getElementById('accessCodeDuration').value = '';
            document.getElementById('accessCodeMaxUses').value = '';
            await loadAccessCodes();
            alert('Access code generated: ' + newCode);
        };

        // Check if user has redeemed access
        function hasCADAccess() {
            return redeemedCodes.length > 0;
        }

        // ERLC API & Live Map System
        const liveMapModal = document.getElementById('liveMapModal');
        const closeLiveMap = document.getElementById('closeLiveMap');
        const refreshLiveMap = document.getElementById('refreshLiveMap');
        const liveMapPlayers = document.getElementById('liveMapPlayers');
        const liveMapPlayerList = document.getElementById('liveMapPlayerList');
        const liveMapPlayerCount = document.getElementById('liveMapPlayerCount');
        
        let liveMapInterval = null;
        let liveMapLoaded = false;

        // Load the ERLC map by stitching tiles from erlc-maps.pages.dev
        function loadLiveMapTiles() {
            if (liveMapLoaded) return;
            const canvas = document.getElementById('liveMapCanvas');
            const ctx = canvas.getContext('2d');
            let tilesLoaded = 0;
            const totalTiles = 16; // 4x4 grid at zoom 0
            for (let ty = 0; ty < 4; ty++) {
                for (let tx = 0; tx < 4; tx++) {
                    const tile = new Image();
                    tile.crossOrigin = 'anonymous';
                    tile.onload = function() {
                        ctx.drawImage(tile, tx * 256, ty * 256, 256, 256);
                        tilesLoaded++;
                        if (tilesLoaded === totalTiles) liveMapLoaded = true;
                    };
                    tile.src = `https://erlc-maps.pages.dev/map/0/${tx}/${ty}.png`;
                }
            }
        }

        // Check if current user is PulseCAD staff (for ERLC beta access)
        async function checkPulseStaffAccess() {
            if (!currentUser) return false;
            
            const isHardcodedStaff = currentUser.username.toLowerCase() === 'rya';
            
            const { data: staffAccess } = await db
                .from('staff_access')
                .select('*')
                .eq('user_id', currentUser.id)
                .single();
            
            isPulseStaff = isHardcodedStaff || !!staffAccess;
            return isPulseStaff;
        }

        // Show/hide ERLC settings based on staff access
        // ERLC API is fully locked during beta  set to true when ready to allow staff access
        const ERLC_BETA_ENABLED = true;
        
        async function updateErlcPanelAccess() {
            const staffRequired = document.getElementById('erlcStaffRequired');
            const staffSettings = document.getElementById('erlcStaffSettings');
            // ERLC API is now unlocked for all community admins
            staffRequired.style.display = 'none';
            staffSettings.style.display = 'block';
            await loadErlcApiKey();
        }

        // Load ERLC API key from database for current community
        async function loadErlcApiKey() {
            if (!currentCommunityId) return;
            
            const { data: community } = await db
                .from('communities')
                .select('erlc_api_key')
                .eq('id', currentCommunityId)
                .single();
            
            currentErlcApiKey = community?.erlc_api_key || '';
            if (document.getElementById('erlcApiKey')) {
                document.getElementById('erlcApiKey').value = currentErlcApiKey;
            }
        }

        // Save ERLC API Key to database
        document.getElementById('saveErlcApiKey').onclick = async () => {
            const apiKey = document.getElementById('erlcApiKey').value.trim();
            
            if (!currentCommunityId) {
                document.getElementById('erlcApiStatus').textContent = 'No community selected.';
                document.getElementById('erlcApiStatus').style.color = '#ef4444';
                return;
            }
            
            const { error } = await db
                .from('communities')
                .update({ erlc_api_key: apiKey })
                .eq('id', currentCommunityId);
            
            if (error) {
                document.getElementById('erlcApiStatus').textContent = 'Error saving API key: ' + error.message;
                document.getElementById('erlcApiStatus').style.color = '#ef4444';
                return;
            }
            
            currentErlcApiKey = apiKey;
            document.getElementById('erlcApiStatus').textContent = 'API key saved to database!';
            document.getElementById('erlcApiStatus').style.color = '#22c55e';
            setTimeout(() => {
                document.getElementById('erlcApiStatus').textContent = '';
            }, 3000);
        };

        // CORS Proxy for ERLC API calls
        const CORS_PROXY = 'https://corsproxy.io/?';
        
        async function fetchErlcApi(endpoint, apiKey) {
            const url = `${CORS_PROXY}${encodeURIComponent(`https://api.policeroleplay.community/v1/${endpoint}`)}`;
            const response = await fetch(url, {
                headers: { 'Server-Key': apiKey }
            });
            return response;
        }
        
        // V2 API for player locations
        async function fetchErlcApiV2(apiKey, includeOptions = {}) {
            const params = new URLSearchParams();
            if (includeOptions.players) params.append('Players', 'true');
            if (includeOptions.vehicles) params.append('Vehicles', 'true');
            if (includeOptions.staff) params.append('Staff', 'true');
            
            const url = `${CORS_PROXY}${encodeURIComponent(`https://api.policeroleplay.community/v2/server?${params.toString()}`)}`;
            const response = await fetch(url, {
                headers: { 'Server-Key': apiKey }
            });
            return response;
        }

        // Test ERLC API Connection
        document.getElementById('testErlcApi').onclick = async () => {
            const apiKey = document.getElementById('erlcApiKey').value.trim();
            const statusEl = document.getElementById('erlcApiStatus');
            
            if (!apiKey) {
                statusEl.textContent = 'Please enter an API key first.';
                statusEl.style.color = '#ef4444';
                return;
            }
            
            statusEl.textContent = 'Testing connection...';
            statusEl.style.color = '#f97316';
            
            try {
                const response = await fetchErlcApi('server', apiKey);
                
                if (response.ok) {
                    const data = await response.json();
                    statusEl.textContent = `Connected! Server: ${data.Name || 'ERLC Server'} (${data.CurrentPlayers || 0} players)`;
                    statusEl.style.color = '#22c55e';
                } else {
                    statusEl.textContent = 'Invalid API key or connection failed.';
                    statusEl.style.color = '#ef4444';
                }
            } catch (error) {
                console.error('ERLC API Error:', error);
                statusEl.textContent = 'Connection error. Check your API key.';
                statusEl.style.color = '#ef4444';
            }
        };

        // Open Live Map (from Dispatch)
        document.getElementById('dispatchLiveMap').onclick = () => {
            liveMapModal.classList.add('active');
            loadLiveMapTiles();
            loadLiveMapPlayers();
            liveMapInterval = setInterval(loadLiveMapPlayers, 5000);
        };

        // Open Live Map (from Police MDT)
        document.getElementById('policeLiveMap').onclick = () => {
            liveMapModal.classList.add('active');
            loadLiveMapTiles();
            loadLiveMapPlayers();
            liveMapInterval = setInterval(loadLiveMapPlayers, 5000);
        };

        // Close Live Map
        closeLiveMap.onclick = () => {
            liveMapModal.classList.remove('active');
            if (liveMapInterval) {
                clearInterval(liveMapInterval);
                liveMapInterval = null;
            }
        };

        liveMapModal.onclick = e => {
            if (e.target === liveMapModal) {
                liveMapModal.classList.remove('active');
                if (liveMapInterval) {
                    clearInterval(liveMapInterval);
                    liveMapInterval = null;
                }
            }
        };

        // Refresh button
        if (refreshLiveMap) {
            refreshLiveMap.onclick = loadLiveMapPlayers;
        }

        // Test Map button - shows demo markers using v2 API format
        const testLiveMapBtn = document.getElementById('testLiveMap');
        if (testLiveMapBtn) {
        testLiveMapBtn.onclick = () => {
            const demoPlayers = [
                { Player: 'Officer_Smith:123', Team: 'Police', Callsign: '1A-01', Location: { LocationX: 1085, LocationZ: 2302, StreetName: 'Park Street', PostalCode: '218' }, Permission: 'Normal' },
                { Player: 'Deputy_Jones:456', Team: 'Sheriff', Callsign: '2B-05', Location: { LocationX: 2370, LocationZ: 2510, StreetName: 'Industrial Park', PostalCode: '300' }, Permission: 'Admin' },
                { Player: 'Firefighter_Mike:789', Team: 'Fire', Callsign: 'E-51', Location: { LocationX: 1420, LocationZ: 2430, StreetName: 'Downtown', PostalCode: '207' }, Permission: 'Normal' },
                { Player: 'John_Doe:101', Team: 'Civilian', Location: { LocationX: 520, LocationZ: 1940, StreetName: 'Housing Suburbs', PostalCode: '700' }, Permission: 'Normal' },
                { Player: 'Jane_Smith:202', Team: 'Civilian', Location: { LocationX: 2330, LocationZ: 1070, StreetName: 'Springfield', PostalCode: '1100' }, Permission: 'Normal' },
                { Player: 'Medic_Sarah:303', Team: 'Fire', Callsign: 'M-12', Location: { LocationX: 1740, LocationZ: 1820, StreetName: 'Farms', PostalCode: '502' }, Permission: 'Moderator' },
                { Player: 'Sergeant_Williams:404', Team: 'Police', Callsign: '1S-01', Location: { LocationX: 840, LocationZ: 2508, StreetName: 'River City PD', PostalCode: '206' }, Permission: 'Admin' },
            ];
            
            liveMapPlayerCount.textContent = `${demoPlayers.length} players online (TEST MODE)`;
            
            liveMapPlayerList.innerHTML = demoPlayers.map(p => {
                const playerName = p.Player.split(':')[0];
                const teamColor = p.Team === 'Police' || p.Team === 'Sheriff' ? '#3b82f6' : p.Team === 'Fire' ? '#ef4444' : '#22c55e';
                const streetName = p.Location?.StreetName || '';
                return `
                    <div class="live-map-player" onclick="focusPlayerV2(${p.Location.LocationX}, ${p.Location.LocationZ})">
                        <div class="live-map-player-dot" style="background:${teamColor}"></div>
                        <div style="flex:1;min-width:0;">
                            <div class="live-map-player-name">${playerName}</div>
                            <div style="font-size:10px;color:#6b7280;">
                                ${p.Team || 'Civilian'}${p.Callsign ? '  ' + p.Callsign : ''}
                            </div>
                            ${streetName ? `<div style="font-size:9px;color:#52525b;">${streetName}</div>` : ''}
                        </div>
                        <div style="text-align:right;">
                            <div style="font-size:10px;color:${teamColor};">${p.Permission}</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            renderMapMarkersV2(demoPlayers);
        };
        }

        // Load players from ERLC API v2 (includes location data)
        async function loadLiveMapPlayers() {
            // Load API key from database if not already loaded
            if (!currentErlcApiKey && currentCommunityId) {
                const { data: community } = await db
                    .from('communities')
                    .select('erlc_api_key')
                    .eq('id', currentCommunityId)
                    .single();
                currentErlcApiKey = community?.erlc_api_key || '';
            }
            
            const apiKey = currentErlcApiKey;
            
            if (!apiKey) {
                liveMapPlayerList.innerHTML = '<p style="color:#f97316;font-size:13px;">No API key configured. Contact a PulseCAD staff member to enable ERLC API.</p>';
                liveMapPlayerCount.textContent = '0 players online';
                liveMapPlayers.innerHTML = '';
                return;
            }
            
            liveMapPlayerCount.textContent = 'Loading...';
            
            try {
                // Use v2 API which includes player location data
                const response = await fetchErlcApiV2(apiKey, { players: true });
                
                if (!response.ok) {
                    liveMapPlayerList.innerHTML = '<p style="color:#ef4444;font-size:13px;">Failed to fetch players. Check your API key.</p>';
                    liveMapPlayerCount.textContent = '0 players online';
                    return;
                }
                
                const data = await response.json();
                const players = data.Players || [];
                console.log('ERLC Players (v2):', players);
                
                liveMapPlayerCount.textContent = `${players.length} players online`;
                document.getElementById('liveMapLastUpdate').textContent = `Updated ${new Date().toLocaleTimeString()}`;
                
                // Render player list
                if (players.length === 0) {
                    liveMapPlayerList.innerHTML = '<p style="color:#6b7280;font-size:13px;">No players online</p>';
                    liveMapPlayers.innerHTML = '';
                    return;
                }
                
                liveMapPlayerList.innerHTML = players.map(p => {
                    const playerName = p.Player ? p.Player.split(':')[0] : 'Unknown';
                    const teamColor = p.Team === 'Police' || p.Team === 'Sheriff' ? '#3b82f6' : p.Team === 'Fire' ? '#ef4444' : '#22c55e';
                    const callsign = p.Callsign || '';
                    const permission = p.Permission || 'Normal';
                    const location = p.Location ? `${p.Location.StreetName || 'Unknown'}` : '';
                    return `
                        <div class="live-map-player" onclick="focusPlayerV2(${p.Location?.LocationX || 0}, ${p.Location?.LocationZ || 0})">
                            <div class="live-map-player-dot" style="background:${teamColor}"></div>
                            <div style="flex:1;min-width:0;">
                                <div class="live-map-player-name">${playerName}</div>
                                <div style="font-size:10px;color:#6b7280;">
                                    ${p.Team || 'Civilian'}${callsign ? '  ' + callsign : ''}
                                </div>
                                ${location ? `<div style="font-size:9px;color:#52525b;">${location}</div>` : ''}
                            </div>
                            <div style="text-align:right;">
                                <div style="font-size:10px;color:${teamColor};">${permission}</div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Render map markers with real location data
                renderMapMarkersV2(players);
                
            } catch (error) {
                console.error('ERLC API Error:', error);
                liveMapPlayerList.innerHTML = '<p style="color:#ef4444;font-size:13px;">Error connecting to ERLC API</p>';
            }
        }

        // Render markers using v2 API location data
        function renderMapMarkersV2(players) {
            // Clear existing markers
            liveMapPlayers.innerHTML = '';
            
            // PRC API v2: LocationX and LocationZ map to the Syce tile map (erlc-maps.pages.dev)
            // Derived from known reference point: Postal 218 (Park Street)
            //   API coords: LocationX=1085, LocationZ=2302
            //   Syce Leaflet coords: lng=373.65, lat=-749.83
            //   Tile map is 1024x1024 Leaflet units
            // Scale: MAP_WIDTH = 1085 / 373.65 * 1024  2974
            //        MAP_HEIGHT = 2302 / 749.83 * 1024  3143
            const MAP_WIDTH = 2974;
            const MAP_HEIGHT = 3143;
            
            players.forEach(player => {
                if (player.Location && player.Location.LocationX !== undefined && player.Location.LocationZ !== undefined) {
                    const locX = player.Location.LocationX;
                    const locZ = player.Location.LocationZ;
                    
                    // Convert API coordinates to percentage position on the 1024x1024 tile map
                    let xPercent = (locX / MAP_WIDTH) * 100;
                    let yPercent = (locZ / MAP_HEIGHT) * 100;
                    
                    // Clamp to map bounds
                    xPercent = Math.max(0, Math.min(100, xPercent));
                    yPercent = Math.max(0, Math.min(100, yPercent));
                    
                    const playerName = player.Player ? player.Player.split(':')[0] : 'Unknown';
                    const teamClass = player.Team === 'Police' || player.Team === 'Sheriff' ? 'police' : player.Team === 'Fire' ? 'fire' : 'civilian';
                    const callsign = player.Callsign ? `[${player.Callsign}] ` : '';
                    const streetName = player.Location.StreetName || '';
                    
                    const marker = document.createElement('div');
                    marker.className = `map-marker ${teamClass}`;
                    marker.style.left = `${xPercent}%`;
                    marker.style.top = `${yPercent}%`;
                    marker.innerHTML = `<div class="map-marker-tooltip">${callsign}${playerName}<br><span style="font-size:10px;opacity:0.8;">${player.Team || 'Civilian'}${streetName ? '  ' + streetName : ''}</span></div>`;
                    marker.id = `marker-${playerName.replace(/\s+/g, '-')}`;
                    
                    liveMapPlayers.appendChild(marker);
                    
                    console.log(`Player ${playerName} at ${streetName}: X=${locX.toFixed(0)}, Z=${locZ.toFixed(0)} -> ${xPercent.toFixed(1)}%, ${yPercent.toFixed(1)}%`);
                }
            });
        }

        // Focus on a player by coordinates
        window.focusPlayerV2 = function(locX, locZ) {
            // Find and highlight the player's marker
            const markers = document.querySelectorAll('#liveMapPlayers .map-marker');
            markers.forEach(marker => {
                marker.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });
                marker.style.transform = 'translate(-50%, -50%) scale(2)';
                setTimeout(() => {
                    marker.style.transform = 'translate(-50%, -50%) scale(1)';
                }, 1000);
            });
        };

        // Focus on a player when clicked in list
        window.focusPlayer = function(playerName) {
            const marker = document.getElementById(`marker-${playerName.replace(/\s+/g, '-')}`);
            if (marker) {
                marker.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });
                marker.style.transform = 'translate(-50%, -50%) scale(2)';
                setTimeout(() => {
                    marker.style.transform = 'translate(-50%, -50%) scale(1)';
                }, 1000);
            }
        };

        // Snow Effect
        function createSnowflakes() {
            const snowflakesContainer = document.getElementById('snowflakes');
            if (!snowflakesContainer) return;
            const snowflakeChars = ['', '', '', ''];
            
            for (let i = 0; i < 150; i++) {
                const snowflake = document.createElement('div');
                snowflake.className = 'snowflake';
                snowflake.innerHTML = snowflakeChars[Math.floor(Math.random() * snowflakeChars.length)];
                snowflake.style.left = Math.random() * 100 + '%';
                snowflake.style.fontSize = (Math.random() * 10 + 8) + 'px';
                snowflake.style.opacity = Math.random() * 0.6 + 0.4;
                snowflake.style.animationDuration = (Math.random() * 5 + 5) + 's';
                snowflake.style.animationDelay = (Math.random() * 10) + 's';
                snowflakesContainer.appendChild(snowflake);
            }
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', createSnowflakes);
        } else {
            createSnowflakes();
        }

        // Staff Dashboard Navigation
        function showStaffPage(pageName) {
            // Hide old dashboard content
            const oldContent = document.getElementById('oldStaffContent');
            if (oldContent) oldContent.style.display = 'none';
            
            // Hide all pages
            document.querySelectorAll('.staff-page').forEach(page => {
                page.classList.remove('active');
                page.style.display = 'none';
            });

            // Remove active from all buttons
            document.querySelectorAll('[data-page]').forEach(btn => {
                btn.classList.remove('active');
            });

            // Determine actual page ID
            let pageId = pageName + 'Page';
            if (pageName === 'access-codes') {
                pageId = 'accessCodesPage';
            } else if (pageName === 'active-users') {
                pageId = 'activeUsersPage';
            }

            // Show selected page
            const pageEl = document.getElementById(pageId);
            if (pageEl) {
                pageEl.classList.add('active');
                pageEl.style.display = 'block';
            }

            // Mark button as active
            const btnEl = document.getElementById(pageName + 'NavBtn');
            if (btnEl) {
                btnEl.classList.add('active');
            }
        }

        // Sidebar button listeners
        document.getElementById('communitiesNavBtn')?.addEventListener('click', () => showStaffPage('communities'));
        document.getElementById('usersNavBtn')?.addEventListener('click', () => showStaffPage('users'));
        document.getElementById('activeUsersNavBtn')?.addEventListener('click', () => showStaffPage('active-users'));
        document.getElementById('accessCodesNavBtn')?.addEventListener('click', () => showStaffPage('access-codes'));

        // Show staff dashboard sidebar when staff button is clicked
        function showStaffDashboardPages() {
            const dashboard = document.getElementById('staffDashboard');
            
            // Load data when staff dashboard is shown
            loadAllCommunities();
            loadAllUsers();
            loadActiveUsers();
            loadStaffAccessCodes();
            
            // Auto-refresh active users every 2 seconds
            if (staffDashboardRefreshInterval) clearInterval(staffDashboardRefreshInterval);
            staffDashboardRefreshInterval = setInterval(() => {
                loadActiveUsers();
            }, 2000);
            
            // Show Communities by default
            showStaffPage('communities');
        }
        
        let staffDashboardRefreshInterval = null;

        // Hook into existing staff dashboard button click handlers
        setTimeout(() => {
            const originalStaffClick = document.getElementById('staffDashboardBtn')?.onclick;
            if (originalStaffClick) {
                document.getElementById('staffDashboardBtn').onclick = function(e) {
                    originalStaffClick.call(this, e);
                    showStaffDashboardPages();
                };
            }
            
            const originalStaffClickOld = document.getElementById('staffDashboardBtnOld')?.onclick;
            if (originalStaffClickOld) {
                document.getElementById('staffDashboardBtnOld').onclick = function(e) {
                    originalStaffClickOld.call(this, e);
                    showStaffDashboardPages();
                };
            }
        }, 100);

        // Data loaders
        async function loadAllCommunities() {
            const list = document.getElementById('allCommunitiesList');
            if (!list) return;
            
            try {
                const { data, error } = await db.from('communities').select('*');
                if (error) throw error;
                
                if (!data || data.length === 0) {
                    list.innerHTML = '<div style="color: #a1a1aa; text-align: center; padding: 40px;">No communities found</div>';
                    return;
                }

                list.innerHTML = data.map(c => `
                    <div class="staff-item">
                         <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                             <div class="staff-item-title">${c.name || 'Unnamed'}</div>
                             ${c.suspended ? '<span style="background:#ef4444;color:#fff;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600;">SUSPENDED</span>' : ''}
                         </div>
                         <div class="staff-item-desc">ID: ${c.id}</div>
                         <div class="staff-item-desc">Code: ${c.code || 'N/A'}</div>
                         <div style="margin-top:12px;display:flex;gap:8px;">
                             <button class="suspend-btn" data-id="${c.id}" data-suspended="${c.suspended || false}" style="padding:6px 10px;background:${c.suspended ? '#22c55e' : '#ef4444'};border:none;border-radius:6px;color:#fff;font-size:11px;font-weight:600;cursor:pointer;width:auto;">
                                 ${c.suspended ? 'Unsuspend' : 'Suspend'}
                             </button>
                         </div>
                     </div>
                `).join('');
                
                // Add suspend handlers
                setTimeout(() => {
                    document.querySelectorAll('.suspend-btn').forEach(btn => {
                        btn.addEventListener('click', async () => {
                            const communityId = btn.dataset.id;
                            const isSuspended = btn.dataset.suspended === 'true';
                            const action = isSuspended ? 'Unsuspend' : 'Suspend';
                            
                            if (confirm(action + ' this community?')) {
                                try {
                                    const { error } = await db.from('communities').update({ suspended: !isSuspended }).eq('id', communityId);
                                    if (error) {
                                        alert('Error: ' + error.message);
                                    } else {
                                        loadAllCommunities();
                                    }
                                } catch (err) {
                                    alert('Error: ' + err.message);
                                }
                            }
                        });
                    });
                }, 0);
            } catch (err) {
                if (list) {
                    list.innerHTML = `<div style="color: #ef4444; padding: 20px;">Error loading communities: ${err.message}</div>`;
                }
            }
        }

        async function loadAllUsers() {
            const list = document.getElementById('allUsersList');
            if (!list) return;
            
            try {
                const { data, error } = await db.from('users').select('*');
                if (error) throw error;
                
                if (!data || data.length === 0) {
                    list.innerHTML = '<div style="color: #a1a1aa; text-align: center; padding: 40px;">No users found</div>';
                    return;
                }

                list.innerHTML = data.map(u => `
                    <div class="staff-item">
                        <div class="staff-item-title">${u.username || u.email || 'Unnamed'}</div>
                        <div class="staff-item-desc">Email: ${u.email} | Role: ${u.role || 'user'}</div>
                    </div>
                `).join('');
            } catch (err) {
                if (list) {
                    list.innerHTML = `<div style="color: #ef4444; padding: 20px;">Error loading users: ${err.message}</div>`;
                }
            }
        }

        async function loadActiveUsers() {
            const countEl = document.getElementById('activeUsersCount');
            if (!countEl) return;
            
            try {
                const { data, error } = await db.from('login_sessions').select('*');
                console.log('Login sessions query:', {data, error});
                if (error) throw error;
                
                const count = (data || []).length;
                console.log('Active users count:', count);
                countEl.textContent = count;
            } catch (err) {
                console.error('Error loading active users count:', err);
                countEl.textContent = '0';
            }
        }

        // Load staff dashboard access codes (for staff panel)
        function loadStaffAccessCodes() {
            const list = document.getElementById('accessCodesList');
            if (!list) return;
            
            try {
                // Use existing accessCodes array
                if (accessCodes.length === 0) {
                    list.innerHTML = '<div style="color: #a1a1aa; text-align: center; padding: 40px;">No access codes found</div>';
                    return;
                }

                list.innerHTML = accessCodes.map(ac => `
                    <div class="staff-item">
                        <div class="staff-item-title">${ac.code || 'N/A'}</div>
                        <div class="staff-item-desc">Status: ${ac.redeemed ? 'Used' : 'Available'} | Created: ${ac.created ? new Date(ac.created).toLocaleDateString() : 'N/A'}</div>
                    </div>
                `).join('');
            } catch (err) {
                if (list) {
                    list.innerHTML = `<div style="color: #ef4444; padding: 20px;">Error loading access codes: ${err.message}</div>`;
                }
            }
        }

        // Community Banner Management - Admin Panel
        let selectedAdminBannerFile = null;
        
        function setupAdminBannerHandlers() {
            const adminBannerDropZone = document.getElementById('adminBannerDropZone');
            const adminBannerFileInput = document.getElementById('adminBannerFileInput');
            const adminBannerPreview = document.getElementById('adminBannerPreview');
            const adminBannerUploadPrompt = document.getElementById('adminBannerUploadPrompt');
            const saveAdminBannerBtn = document.getElementById('saveAdminBanner');
            const removeAdminBannerBtn = document.getElementById('removeAdminBanner');

            // Early return if elements don't exist
            if (!adminBannerDropZone || !adminBannerFileInput || !saveAdminBannerBtn || !removeAdminBannerBtn) {
                console.warn('Banner elements not found');
                return;
            }

            // Click to upload
            adminBannerDropZone.addEventListener('click', () => {
                adminBannerFileInput.click();
            });

            // File selected
            adminBannerFileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    if (file.size > 5 * 1024 * 1024) {
                        alert('File must be smaller than 5MB');
                        return;
                    }
                    selectedAdminBannerFile = file;
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        adminBannerPreview.src = event.target.result;
                        adminBannerPreview.style.display = 'block';
                        adminBannerUploadPrompt.style.display = 'none';
                    };
                    reader.readAsDataURL(file);
                }
            });

            // Drag and drop
            adminBannerDropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                adminBannerDropZone.style.background = '#1a1d2e';
            });

            adminBannerDropZone.addEventListener('dragleave', () => {
                adminBannerDropZone.style.background = 'transparent';
            });

            adminBannerDropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                adminBannerDropZone.style.background = 'transparent';
                const file = e.dataTransfer.files[0];
                if (file) {
                    adminBannerFileInput.files = e.dataTransfer.files;
                    const event = new Event('change', { bubbles: true });
                    adminBannerFileInput.dispatchEvent(event);
                }
            });

            // Save banner
            if (saveAdminBannerBtn) {
                saveAdminBannerBtn.addEventListener('click', async () => {
                    if (!selectedAdminBannerFile) {
                        alert('Please select an image first');
                        return;
                    }
                    if (!currentCommunityId) {
                        alert('No community selected');
                        return;
                    }

                    try {
                        // Convert image to base64
                        const reader = new FileReader();
                        reader.onload = async (event) => {
                            try {
                                const base64Data = event.target.result;
                                
                                // Save directly to database
                                const { error } = await db.from('communities').update({ 
                                    banner_url: base64Data,
                                    banner_updated_at: new Date().toISOString()
                                }).eq('id', currentCommunityId);
                                
                                if (error) {
                                    alert('Error saving banner: ' + error.message);
                                    console.error('Save error:', error);
                                } else {
                                    alert('Banner saved successfully!');
                                    selectedAdminBannerFile = null;
                                    adminBannerPreview.style.display = 'none';
                                    adminBannerUploadPrompt.style.display = 'block';
                                    adminBannerFileInput.value = '';
                                }
                            } catch (err) {
                                alert('Error: ' + err.message);
                                console.error('Error:', err);
                            }
                        };
                        reader.readAsDataURL(selectedAdminBannerFile);
                    } catch (err) {
                        alert('Error: ' + err.message);
                        console.error('Banner error:', err);
                    }
                });
            }

            // Remove banner
            if (removeAdminBannerBtn) {
                removeAdminBannerBtn.addEventListener('click', async () => {
                    if (!currentCommunityId) {
                        alert('No community selected');
                        return;
                    }
                    try {
                        const { error } = await db.from('communities').update({ banner_url: null }).eq('id', currentCommunityId);
                        if (error) {
                            alert('Error removing banner: ' + error.message);
                            console.error('Banner remove error:', error);
                        } else {
                            alert('Banner removed successfully!');
                            adminBannerPreview.style.display = 'none';
                            adminBannerUploadPrompt.style.display = 'block';
                            adminBannerFileInput.value = '';
                            selectedAdminBannerFile = null;
                        }
                    } catch (err) {
                        alert('Error: ' + err.message);
                        console.error('Banner error:', err);
                    }
                });
            }
        }

        // Remove officer and session when tab closes
        const cleanupSession = () => {
            if (currentOfficer && currentCommunityId) {
                db.from('active_units').delete().eq('id', String(currentOfficer.id)).catch(e => console.error('Delete error:', e));
            }
            if (currentUser) {
                db.from('login_sessions').delete().eq('user_id', currentUser.id).catch(e => console.error('Session delete error:', e));
            }
        };
        
        window.addEventListener('beforeunload', cleanupSession);
        window.addEventListener('pagehide', cleanupSession);
        window.addEventListener('unload', cleanupSession);

        // Setup handlers when page loads - wait for DOM to be ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', setupAdminBannerHandlers);
        } else {
            setupAdminBannerHandlers();
        }
        </script>
        </body>
        </html>