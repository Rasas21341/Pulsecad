<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PulseCad</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .civilian-btn {
            border: none;
            border-radius: 30px;
            background: linear-gradient(45deg, #50c878, #21cbf3);
            color: white;
            font-size: 1rem;
            font-weight: bold;
            padding: 1rem 2.5rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.2);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .civilian-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(33, 150, 243, 0.3);
        }
    </style>
</head>
<body>
    <nav class="top-nav">
        <button class="login-button" onclick="toggleLogin()" id="loginBtn">Login</button>
        <button class="updates-button" onclick="showUpdates()" id="updatesBtn">Updates <span id="updatesBadge" class="updates-badge" style="display:none;">0</span></button>
        <button class="logout-button" onclick="handleLogout()" id="logoutBtn" style="display: none;">Logout</button>
    </nav>

    <div class="community-info" id="communityInfo" style="display: none;">
        <h3>Your Communities</h3>
        <div id="communityList"></div>
    </div>

    <div class="login-modal" id="loginModal">
        <div class="login-content">
            <span class="close-button" onclick="toggleLogin()">&times;</span>
            <h2>Login</h2>
            <form class="login-form" id="loginForm" onsubmit="handleLogin(event)">
                <input type="text" name="username" placeholder="Username" required>
                <input type="password" name="password" placeholder="Password" required>
                <button type="submit" class="login-submit">Sign In</button>
                <button type="button" class="create-account-btn" onclick="toggleRegister()">Create an Account</button>
            </form>
        </div>
    </div>

    <div class="login-modal" id="registerModal">
        <div class="login-content">
            <span class="close-button" onclick="toggleRegister()">&times;</span>
            <h2>Create Account</h2>
            <form class="login-form" id="registerForm" onsubmit="handleRegister(event)">
                <input type="text" name="username" placeholder="Username" required>
                <input type="password" name="password" placeholder="Password" required>
                <button type="submit" class="login-submit">Create Account</button>
            </form>
        </div>
    </div>

    <div class="dashboard" id="dashboard" style="display: none;">
        <div class="dashboard-content">
            <h2>Dashboard</h2>
            <div class="dashboard-buttons">
                <button onclick="showCreateCommunity()" class="dashboard-btn">Create</button>
                <button onclick="showJoinCommunity()" class="dashboard-btn">Join Community</button>
                <button onclick="showAdminPanel()" class="dashboard-btn admin-btn" id="adminButton" style="display: none;">Admin Panel</button>
            </div>
        </div>
    </div>

    <div class="modal" id="adminModal">
        <div class="modal-content admin-panel">
            <span class="close-button" onclick="toggleModal('adminModal')">&times;</span>
            <h2>Admin Panel</h2>
            <div class="admin-actions">
                <div class="data-section">
                    <h3>Data Management</h3>
                    <div class="data-buttons">
                        <button onclick="downloadData()" class="admin-action-btn">Download Data</button>
                        <input type="file" id="uploadFile" style="display: none;" onchange="handleFileUpload(event)">
                        <button onclick="document.getElementById('uploadFile').click()" class="admin-action-btn">Upload Data</button>
                        <button onclick="openCopyDataModal()" class="admin-action-btn">Copy Data</button>
                        <button onclick="openPasteDataModal()" class="admin-action-btn">Paste Data</button>
                    </div>
                    <div style="margin-top:1.5rem;">
                        <span style="color:#2196f3;font-weight:bold;font-size:1.1rem;">Server Management</span>
                        <button onclick="showServers()" class="admin-action-btn" style="margin-left:1rem;">Servers</button>
                            <button onclick="showCreateUpdateModal()" class="admin-action-btn" style="margin-left:1rem;">Create Update</button>
                    </div>
                    <div id="serversList" style="margin-top:1rem;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Updates Modal (view list) -->
    <div class="modal" id="updatesModal">
        <div class="modal-content">
            <span class="close-button" onclick="toggleModal('updatesModal')">&times;</span>
            <h2>Updates</h2>
            <div id="updatesList" style="max-height:60vh;overflow:auto;padding-top:0.5rem;"></div>
        </div>
    </div>

    <!-- Create Update Modal (admin) -->
    <div class="modal" id="createUpdateModal">
        <div class="modal-content">
            <span class="close-button" onclick="toggleModal('createUpdateModal')">&times;</span>
            <h2>Create Update</h2>
            <form id="createUpdateForm" onsubmit="handleCreateUpdate(event)">
                <input type="text" name="title" placeholder="Name of Update" required style="width:100%;padding:0.5rem;margin:0.4rem 0;">
                <input type="date" name="date" placeholder="Date" required style="width:100%;padding:0.5rem;margin:0.4rem 0;">
                <textarea name="body" placeholder="Updates" rows="6" style="width:100%;padding:0.5rem;margin:0.4rem 0;" required></textarea>
                <button type="submit" style="padding:0.6rem 1rem;border-radius:8px;background:#2196f3;color:white;border:none;">Send</button>
            </form>
        </div>
    </div>

    <!-- Copy Data Modal -->
    <div class="modal" id="copyDataModal">
        <div class="modal-content">
            <span class="close-button" onclick="toggleModal('copyDataModal')">&times;</span>
            <h2>Copy Data (to other browser)</h2>
            <p>Copy the JSON below and paste it into the other browser's Paste Data dialog or save it as a file.</p>
            <textarea id="copyDataTextarea" style="width:100%;height:200px;background:rgba(0,0,0,0.6);color:#fff;padding:0.6rem;border-radius:8px;border:1px solid rgba(255,255,255,0.08);"></textarea>
            <div style="margin-top:0.6rem;display:flex;gap:0.6rem;justify-content:flex-end;">
                <button onclick="copyTextFromTextarea('copyDataTextarea')" class="admin-action-btn">Copy to Clipboard</button>
                <button onclick="toggleModal('copyDataModal')" class="admin-action-btn">Close</button>
            </div>
        </div>
    </div>

    <!-- Paste Data Modal -->
    <div class="modal" id="pasteDataModal">
        <div class="modal-content">
            <span class="close-button" onclick="toggleModal('pasteDataModal')">&times;</span>
            <h2>Paste Data (from other browser)</h2>
            <p>Paste JSON data copied from another browser here to import. This will overwrite local data where applicable.</p>
            <textarea id="pasteDataTextarea" style="width:100%;height:200px;background:rgba(0,0,0,0.6);color:#fff;padding:0.6rem;border-radius:8px;border:1px solid rgba(255,255,255,0.08);"></textarea>
            <div style="margin-top:0.6rem;display:flex;gap:0.6rem;justify-content:flex-end;">
                <button onclick="handlePasteImport()" class="admin-action-btn">Import</button>
                <button onclick="toggleModal('pasteDataModal')" class="admin-action-btn">Close</button>
            </div>
        </div>
    </div>

    <div class="modal" id="createCommunityModal">
        <div class="modal-content">
            <span class="close-button" onclick="toggleModal('createCommunityModal')">&times;</span>
            <h2>Create Community</h2>
            <form id="createCommunityForm" onsubmit="handleCreateCommunity(event)">
                <input type="text" name="serverName" placeholder="Server Name" required>
                <button type="submit">Create</button>
            </form>
        </div>
    </div>

    <div class="modal" id="joinCommunityModal">
        <div class="modal-content">
            <span class="close-button" onclick="toggleModal('joinCommunityModal')">&times;</span>
            <h2>Join Community</h2>
            <form id="joinCommunityForm" onsubmit="handleJoinCommunity(event)">
                <input type="text" name="communityCode" placeholder="Community Code" required>
                <button type="submit">Join</button>
            </form>
        </div>
    </div>

    <div class="modal" id="viewCommunityModal">
        <div class="modal-content">
            <span class="close-button" onclick="toggleModal('viewCommunityModal')">&times;</span>
            <h2 id="communityModalName">Community Details</h2>
            <div id="communityModalDetails"></div>
        </div>
    </div>

    <div class="container">
        <img src="https://cdn.discordapp.com/icons/1398629066092974130/7c19f1e2d3767c197514e817cf3ac88d.png?size=4096" alt="PulseCad logo featuring a geometric minimalist pulse wave design in white against a transparent background" class="logo">
        <h1 class="welcome-text">Welcome to PulseCad</h1>
        <button onclick="showTeam()" class="team-button">Team</button>
    </div>

    <div class="modal team-modal" id="teamModal">
        <div class="modal-content team-content">
            <span class="close-button" onclick="toggleModal('teamModal')">&times;</span>
            <h2>Our Team</h2>
            
            <div class="team-section">
                <h3 class="role-title">Founders</h3>
                <div class="team-grid">
                    <div class="team-member">
                        <div class="member-avatar founder"></div>
                        <h4>Ryan</h4>
                        <p>Lead Developer</p>
                    </div>
                    <div class="team-member">
                        <div class="member-avatar founder"></div>
                        <h4>Hunter</h4>
                        <p>Lead Developer/Overseer</p>
                    </div>
                </div>
            </div>

            <div class="team-section">
                <h3 class="role-title">Managers</h3>
                <div class="team-grid">
                    <div class="team-member">
                        <div class="member-avatar manager"></div>
                        <h4>Devin</h4>
                        <p>Community Manager</p>
                    </div>
                    <div class="team-member">
                        <div class="member-avatar manager"></div>
                        <h4>Open</h4>
                        <p>Project Manager</p>
                    </div>
                </div>
            </div>

            <div class="team-section">
                <h3 class="role-title">Support Team</h3>
                <div class="team-grid">
                    <div class="team-member">
                        <div class="member-avatar support"></div>
                        <h4>Open</h4>
                        <p>Technical Support</p>
                    </div>
                    <div class="team-member">
                        <div class="member-avatar support"></div>
                        <h4>Open</h4>
                        <p>Community Support</p>
                    </div>
                    <div class="team-member">
                        <div class="member-avatar support"></div>
                        <h4>Open</h4>
                        <p>Help Desk</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Store for users and communities
        function initializeData() {
            // Always ensure the admin account exists
            let currentUsers = JSON.parse(localStorage.getItem('users') || '{}');
            currentUsers['Ryan'] = { password: 'STAFF', isAdmin: true };
            localStorage.setItem('users', JSON.stringify(currentUsers));
            
            // Initialize other data stores if they don't exist
            if (!localStorage.getItem('communities')) {
                localStorage.setItem('communities', '[]');
            }
            if (!localStorage.getItem('civilians')) {
                localStorage.setItem('civilians', '[]');
            }
            if (!localStorage.getItem('citations')) {
                localStorage.setItem('citations', '[]');
            }
            if (!localStorage.getItem('servers')) {
                localStorage.setItem('servers', '[]');
            }
            if (!localStorage.getItem('updates')) {
                localStorage.setItem('updates', '[]');
            }
            
            // Load all data from localStorage
            users = JSON.parse(localStorage.getItem('users'));
            communities = JSON.parse(localStorage.getItem('communities'));
            currentUser = localStorage.getItem('currentUser');
            
            console.log('Data initialized:', {
                users: users,
                communities: communities,
                currentUser: currentUser
            });
            // Update updates badge
            updateUpdatesBadge();
        }
        
        // Initialize data when page loads
        initializeData();

        function toggleLogin() {
            const modal = document.getElementById('loginModal');
            modal.classList.toggle('show');
        }

        function toggleRegister() {
            const loginModal = document.getElementById('loginModal');
            const registerModal = document.getElementById('registerModal');
            loginModal.classList.toggle('show');
            registerModal.classList.toggle('show');
        }

        function handleLogin(event) {
            event.preventDefault();
            const form = event.target;
            const username = form.username.value;
            const password = form.password.value;

            // Get fresh user data
            users = JSON.parse(localStorage.getItem('users') || '{}');
            
            // Simple login check
            if (username === 'Ryan' && password === 'STAFF') {
                currentUser = 'Ryan';
                localStorage.setItem('currentUser', 'Ryan');
                
                console.log('Logged in as:', {
                    currentUser: currentUser,
                    isAdmin: users[currentUser].isAdmin
                });
                
                toggleLogin();
                showDashboard();
                
                // Show admin button for admin accounts
                const adminButton = document.getElementById('adminButton');
                if (users[username].isAdmin) {
                    adminButton.style.display = 'inline-block';
                } else {
                    adminButton.style.display = 'none';
                }
            } else {
                alert('Invalid username or password');
            }
        }

        function handleRegister(event) {
            event.preventDefault();
            const form = event.target;
            const username = form.username.value;
            const password = form.password.value;

            // Get fresh users data
            let currentUsers = JSON.parse(localStorage.getItem('users') || '{}');

            if (currentUsers[username]) {
                alert('Username already exists');
                return;
            }

            // Add new user
            currentUsers[username] = { 
                password: password,
                isAdmin: false  // New users are not admins by default
            };

            // Save to localStorage
            localStorage.setItem('users', JSON.stringify(currentUsers));
            users = currentUsers;

            console.log('New user registered:', username);
            alert('Account created successfully!');
            toggleRegister();
        }

        function showDashboard() {
            document.querySelector('.container').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            document.getElementById('loginBtn').style.display = 'none';
            document.getElementById('logoutBtn').style.display = 'block';
            document.getElementById('communityInfo').style.display = 'block';
            updateCommunityList();
        }

        function handleLogout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            document.querySelector('.container').style.display = 'flex';
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('loginBtn').style.display = 'block';
            document.getElementById('logoutBtn').style.display = 'none';
            document.getElementById('communityInfo').style.display = 'none';
        }

        function updateCommunityList() {
            const communityList = document.getElementById('communityList');
            communityList.innerHTML = '';

            // Get fresh data from localStorage
            const currentCommunities = JSON.parse(localStorage.getItem('communities') || '[]');
            communities = currentCommunities; // Update local variable
            
            // Get suspended server codes from stored servers
            const storedServers = JSON.parse(localStorage.getItem('servers') || '[]');
            const suspendedCodes = new Set(storedServers.filter(s => s.active === false).map(s => s.code));

            const userCommunities = currentCommunities.filter(c => c.members.includes(currentUser));
            
            console.log('Updating community list:', {
                currentUser: currentUser,
                allCommunities: currentCommunities,
                userCommunities: userCommunities
            });
            
            if (userCommunities.length === 0) {
                communityList.innerHTML = '<p class="no-communities">No communities joined yet</p>';
                return;
            }

            userCommunities.forEach(community => {
                const communityCard = document.createElement('div');
                communityCard.className = 'community-card';
                // If this community is suspended, show SUSPENDED label and disable view
                const isSuspended = suspendedCodes.has(community.code);
                const suspendedLabel = isSuspended ? "<span style='color:#d32f2f;font-weight:bold;margin-left:0.5rem;'>(SUSPENDED)</span>" : '';
                const viewButton = isSuspended
                    ? `<button class='view-community-btn' onclick='alert("This community is suspended and cannot be accessed.")' disabled style='opacity:0.6;cursor:not-allowed;'>View</button>`
                    : `<button class='view-community-btn' onclick='viewCommunity("${community.code}")'>View</button>`;

                communityCard.innerHTML = `
                    <h4>${community.name} ${suspendedLabel}</h4>
                    <p>Owner: ${community.owner}</p>
                    <p>Code: ${community.code}</p>
                    <p>Members: ${community.members.length}</p>
                    ${viewButton}
                `;
                communityList.appendChild(communityCard);
            });
        }

        function toggleModal(modalId) {
            document.getElementById(modalId).classList.toggle('show');
        }

        function showCreateCommunity() {
            toggleModal('createCommunityModal');
        }

        function showJoinCommunity() {
            toggleModal('joinCommunityModal');
        }

        function handleCreateCommunity(event) {
            event.preventDefault();
            const serverName = event.target.serverName.value;
            const communityCode = Math.random().toString(36).substring(2, 8).toUpperCase();
            
            const community = {
                name: serverName,
                owner: currentUser,
                code: communityCode,
                members: [currentUser]
            };

            // Get fresh data from localStorage
            let currentCommunities = JSON.parse(localStorage.getItem('communities') || '[]');
            currentCommunities.push(community);
            
            // Update both localStorage and local variable
            localStorage.setItem('communities', JSON.stringify(currentCommunities));
            communities = currentCommunities;
            
            console.log('Community created:', {
                community: community,
                allCommunities: communities
            });
            
            updateCommunityList(); // Update the community list immediately
            alert(`Community created! Share this code with others: ${communityCode}`);
            toggleModal('createCommunityModal');
        }

        function showAdminPanel() {
            if (users[currentUser] && users[currentUser].isAdmin) {
                toggleModal('adminModal');
            }
        }

        function downloadData() {
            // Collect all data from localStorage
            const data = {
                users: JSON.parse(localStorage.getItem('users') || '{}'),
                communities: JSON.parse(localStorage.getItem('communities') || '[]'),
                civilians: JSON.parse(localStorage.getItem('civilians') || '[]'),
                citations: JSON.parse(localStorage.getItem('citations') || '[]'),
                servers: JSON.parse(localStorage.getItem('servers') || '[]'),
                updates: JSON.parse(localStorage.getItem('updates') || '[]')
            };
            const dataStr = JSON.stringify(data, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'pulsecad_data.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Open modal and populate copy textarea with JSON string of all app data
        function openCopyDataModal() {
            const data = {
                users: JSON.parse(localStorage.getItem('users') || '{}'),
                communities: JSON.parse(localStorage.getItem('communities') || '[]'),
                civilians: JSON.parse(localStorage.getItem('civilians') || '[]'),
                citations: JSON.parse(localStorage.getItem('citations') || '[]'),
                servers: JSON.parse(localStorage.getItem('servers') || '[]'),
                updates: JSON.parse(localStorage.getItem('updates') || '[]')
            };
            const json = JSON.stringify(data, null, 2);
            document.getElementById('copyDataTextarea').value = json;
            toggleModal('copyDataModal');
        }

        // Try to copy text content of a textarea to the clipboard
        function copyTextFromTextarea(id) {
            const ta = document.getElementById(id);
            if (!ta) return;
            ta.select();
            try {
                // navigator.clipboard preferred
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(ta.value).then(() => {
                        alert('Copied to clipboard');
                    }).catch(err => {
                        // fallback
                        document.execCommand('copy');
                        alert('Copied to clipboard');
                    });
                } else {
                    document.execCommand('copy');
                    alert('Copied to clipboard');
                }
            } catch (e) {
                alert('Copy failed: ' + e.message);
            }
        }

        function openPasteDataModal() {
            document.getElementById('pasteDataTextarea').value = '';
            toggleModal('pasteDataModal');
        }

        function handlePasteImport() {
            const raw = document.getElementById('pasteDataTextarea').value.trim();
            if (!raw) { alert('Please paste JSON data first.'); return; }
            try {
                const data = JSON.parse(raw);
                if (!data.users || !data.communities) {
                    alert('Invalid data format: expected users and communities');
                    return;
                }

                // Preserve admin
                const adminAccount = { 'Ryan': { password: 'STAFF', isAdmin: true } };

                // Merge users but prefer uploaded ones, then ensure admin preserved
                const mergedUsers = { ...data.users, ...adminAccount };
                localStorage.setItem('users', JSON.stringify(mergedUsers));

                // Overwrite other stores with uploaded ones where present
                localStorage.setItem('communities', JSON.stringify(data.communities || []));
                if (data.civilians) localStorage.setItem('civilians', JSON.stringify(data.civilians));
                if (data.citations) localStorage.setItem('citations', JSON.stringify(data.citations));
                if (data.servers) localStorage.setItem('servers', JSON.stringify(data.servers));
                if (data.updates) localStorage.setItem('updates', JSON.stringify(data.updates));

                // Refresh local variables and UI
                users = JSON.parse(localStorage.getItem('users'));
                communities = JSON.parse(localStorage.getItem('communities'));
                updateCommunityList();
                updateUpdatesBadge();
                toggleModal('pasteDataModal');
                alert('Data imported successfully');
            } catch (err) {
                alert('Error parsing JSON: ' + err.message);
            }
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.users && data.communities) {
                            // Preserve the Ryan admin account
                            const adminAccount = {
                                'Ryan': { password: 'STAFF', isAdmin: true }
                            };
                            
                            // Merge the uploaded users with admin account
                            users = { ...data.users, ...adminAccount };
                            communities = data.communities;
                            
                            // Save to localStorage
                            localStorage.setItem('users', JSON.stringify(users));
                            localStorage.setItem('communities', JSON.stringify(communities));
                            
                            // Save other data if present
                            if (data.civilians) {
                                localStorage.setItem('civilians', JSON.stringify(data.civilians));
                            }
                            if (data.citations) {
                                localStorage.setItem('citations', JSON.stringify(data.citations));
                            }
                            if (data.servers) {
                                localStorage.setItem('servers', JSON.stringify(data.servers));
                            }
                            if (data.updates) {
                                // Overwrite local updates with uploaded ones
                                localStorage.setItem('updates', JSON.stringify(data.updates));
                            }
                            
                            updateCommunityList();
                            // refresh updates badge if present
                            updateUpdatesBadge();
                            alert('Data uploaded successfully!');
                            
                            // Refresh admin button visibility
                            const adminButton = document.getElementById('adminButton');
                            if (currentUser === 'Ryan') {
                                adminButton.style.display = 'inline-block';
                            }
                        } else {
                            alert('Invalid data format');
                        }
                    } catch (error) {
                        alert('Error reading file: ' + error.message);
                    }
                };
                reader.readAsText(file);
            }
        }

        function showTeam() {
            toggleModal('teamModal');
        }

        // Show the Updates page/modal for all users
        function showUpdates() {
            // Load updates from localStorage
            const updates = JSON.parse(localStorage.getItem('updates') || '[]');
            const container = document.getElementById('updatesList');
            container.innerHTML = '';

            if (!updates || updates.length === 0) {
                container.innerHTML = '<p>No updates have been posted yet.</p>';
                toggleModal('updatesModal');
                return;
            }

            // Build list of collapsible updates
            updates.forEach((u, idx) => {
                const wrapper = document.createElement('div');
                wrapper.style.border = '1px solid #e0e0e0';
                wrapper.style.padding = '0.6rem';
                wrapper.style.marginBottom = '0.6rem';
                wrapper.style.borderRadius = '8px';

                const title = document.createElement('div');
                title.style.display = 'flex';
                title.style.justifyContent = 'space-between';
                title.style.alignItems = 'center';

                const left = document.createElement('div');
                left.innerHTML = `<strong>${u.title}</strong> <small style='color:#666;margin-left:0.5rem;'>${u.date}</small>`;

                const toggleBtn = document.createElement('button');
                toggleBtn.textContent = 'Show';
                toggleBtn.style.background = '#2196f3';
                toggleBtn.style.color = 'white';
                toggleBtn.style.border = 'none';
                toggleBtn.style.borderRadius = '6px';
                toggleBtn.style.padding = '0.25rem 0.5rem';
                toggleBtn.style.cursor = 'pointer';

                const body = document.createElement('div');
                body.style.display = 'none';
                body.style.marginTop = '0.5rem';
                body.innerText = u.body;

                toggleBtn.addEventListener('click', () => {
                    if (body.style.display === 'none') {
                        body.style.display = 'block';
                        toggleBtn.textContent = 'Hide';
                    } else {
                        body.style.display = 'none';
                        toggleBtn.textContent = 'Show';
                    }
                });

                // Admin controls: Edit / Delete
                const controls = document.createElement('div');
                controls.style.display = 'inline-flex';
                controls.style.gap = '0.4rem';

                if (users[currentUser] && users[currentUser].isAdmin) {
                    const editBtn = document.createElement('button');
                    editBtn.textContent = 'Edit';
                    editBtn.style.background = '#ffb300';
                    editBtn.style.border = 'none';
                    editBtn.style.color = '#000';
                    editBtn.style.padding = '0.25rem 0.5rem';
                    editBtn.style.borderRadius = '6px';
                    editBtn.style.cursor = 'pointer';
                    editBtn.addEventListener('click', () => editUpdate(idx));

                    const delBtn = document.createElement('button');
                    delBtn.textContent = 'Delete';
                    delBtn.style.background = '#e53935';
                    delBtn.style.border = 'none';
                    delBtn.style.color = '#fff';
                    delBtn.style.padding = '0.25rem 0.5rem';
                    delBtn.style.borderRadius = '6px';
                    delBtn.style.cursor = 'pointer';
                    delBtn.addEventListener('click', () => deleteUpdate(idx));

                    controls.appendChild(editBtn);
                    controls.appendChild(delBtn);
                }

                title.appendChild(left);
                const rightGroup = document.createElement('div');
                rightGroup.style.display = 'flex';
                rightGroup.style.gap = '0.5rem';
                rightGroup.appendChild(toggleBtn);
                rightGroup.appendChild(controls);
                title.appendChild(rightGroup);
                wrapper.appendChild(title);
                wrapper.appendChild(body);

                container.appendChild(wrapper);
            });

            toggleModal('updatesModal');
        }

        function showCreateUpdateModal() {
            // Only admins can create updates
            if (!users[currentUser] || !users[currentUser].isAdmin) {
                alert('Only admins can create updates.');
                return;
            }
            // reset edit index when opening as create
            window.editUpdateIndex = null;
            document.getElementById('createUpdateForm').reset();
            toggleModal('createUpdateModal');
        }

        function handleCreateUpdate(event) {
            event.preventDefault();
            const form = event.target;
            const title = form.title.value.trim();
            const date = form.date.value;
            const body = form.body.value.trim();

            if (!title || !date || !body) {
                alert('Please fill all fields');
                return;
            }

            const updates = JSON.parse(localStorage.getItem('updates') || '[]');
            if (window.editUpdateIndex !== null && window.editUpdateIndex >= 0 && window.editUpdateIndex < updates.length) {
                // edit existing
                updates[window.editUpdateIndex] = { title, date, body };
                alert('Update edited');
            } else {
                updates.unshift({ title, date, body }); // newest first
                alert('Update posted');
            }
            localStorage.setItem('updates', JSON.stringify(updates));
            form.reset();
            window.editUpdateIndex = null;
            toggleModal('createUpdateModal');
            updateUpdatesBadge();
        }

        function editUpdate(idx) {
            const updates = JSON.parse(localStorage.getItem('updates') || '[]');
            if (!updates[idx]) return;
            const u = updates[idx];
            // populate form and open modal
            const form = document.getElementById('createUpdateForm');
            form.title.value = u.title;
            form.date.value = u.date;
            form.body.value = u.body;
            window.editUpdateIndex = idx;
            toggleModal('createUpdateModal');
        }

        function deleteUpdate(idx) {
            if (!confirm('Delete this update?')) return;
            const updates = JSON.parse(localStorage.getItem('updates') || '[]');
            updates.splice(idx, 1);
            localStorage.setItem('updates', JSON.stringify(updates));
            updateUpdatesBadge();
            // refresh updates modal if open
            const modal = document.getElementById('updatesModal');
            if (modal.classList.contains('show')) showUpdates();
        }

        function updateUpdatesBadge() {
            const badge = document.getElementById('updatesBadge');
            const updates = JSON.parse(localStorage.getItem('updates') || '[]');
            if (!updates || updates.length === 0) {
                badge.style.display = 'none';
            } else {
                badge.style.display = 'inline-block';
                badge.textContent = updates.length;
            }
        }

        // Update Police button in community view modal to navigate to police.html instead of showing popup.
        function viewCommunity(code) {
            // Prevent opening modal if community is suspended
            const storedServers = JSON.parse(localStorage.getItem('servers') || '[]');
            const suspended = storedServers.find(s => s.code === code && s.active === false);
            if (suspended) {
                alert('This community is suspended and cannot be accessed.');
                return;
            }

            document.getElementById('communityModalName').textContent = 'Community Actions';
            document.getElementById('communityModalDetails').innerHTML = `
                <div style='display:flex;gap:1rem;'>
                    <button class='police-btn' onclick='window.location.href="police.html"'>Police</button>
                    <button class='civilian-btn' onclick='window.location.href="police.html?civilian=1"'>Civilian</button>
                </div>
            `;
            toggleModal('viewCommunityModal');
        }

        function showServers() {
            // Load servers and communities from localStorage and display them together.
            let storedServers = JSON.parse(localStorage.getItem('servers') || '[]');
            let storedCommunities = JSON.parse(localStorage.getItem('communities') || '[]');

            console.log('showServers loaded servers:', storedServers, 'communities:', storedCommunities);

            // Map communities into a server-like shape (origin: 'community')
            const communityServers = storedCommunities.map(c => ({
                name: c.name,
                code: c.code,
                active: true,
                origin: 'community'
            }));

            const serverItems = storedServers.map(s => ({ ...s, origin: 'server' }));

            // Combine and deduplicate by code, prefer explicit server entries over community-derived ones
            const combined = [...serverItems, ...communityServers];
            const seen = new Set();
            const dedup = [];
            for (const item of combined) {
                if (!item.code) continue; // skip malformed
                if (!seen.has(item.code)) {
                    dedup.push(item);
                    seen.add(item.code);
                }
            }

            let html = '<h4>Active Servers</h4>';
            if (dedup.length === 0) {
                html += "<p class='no-servers'>No servers or communities found. Upload data or add entries via admin tools.</p>";
                document.getElementById('serversList').innerHTML = html;
                return;
            }

            dedup.forEach((server) => {
                const statusLabel = server.active === false ? "<span style='color:#d32f2f;'>[Suspended]</span>" : "<span style='color:#2e7d32;'>[Active]</span>";
                const originLabel = server.origin === 'community' ? "<span style='background:#e3f2fd;color:#0d47a1;padding:2px 6px;border-radius:6px;margin-left:8px;font-size:0.8rem;'>Community</span>" : "<span style='background:#e8f5e9;color:#1b5e20;padding:2px 6px;border-radius:6px;margin-left:8px;font-size:0.8rem;'>Server</span>";

                // Button text depends on origin and current active state
                let buttonText = '';
                if (server.origin === 'community') {
                    buttonText = server.active === false ? 'UNSUSPEND' : 'SUSPEND';
                } else {
                    buttonText = server.active === false ? 'Unsuspend' : 'Suspend';
                }

                html += `<div style='margin-bottom:0.5rem;padding:0.5rem 1rem;border-radius:8px;background:#f5faff;border:1px solid #2196f3;display:flex;align-items:center;justify-content:space-between;'>
                    <span><strong>${server.name}</strong> <span style='color:#2196f3;'>[${server.code}]</span> ${statusLabel}${originLabel}</span>
                    <div>
                        <button onclick="suspendServer('${server.code}')" style='background:#2196f3;color:white;border:none;border-radius:20px;padding:0.3rem 1rem;font-size:0.9rem;cursor:pointer;margin-right:0.5rem;'>${buttonText}</button>
                    </div>
                </div>`;
            });

            document.getElementById('serversList').innerHTML = html;
        }
        function suspendServer(code) {
            // Toggle suspension by code. If a server entry exists, flip its `active` flag; otherwise create a suspended server entry.
            let servers = JSON.parse(localStorage.getItem('servers') || '[]');
            const idx = servers.findIndex(s => s.code === code);
            if (idx !== -1) {
                // Toggle active state
                servers[idx].active = !servers[idx].active;
            } else {
                // Look up community name if available
                const communities = JSON.parse(localStorage.getItem('communities') || '[]');
                const comm = communities.find(c => c.code === code);
                const name = comm ? comm.name : code;
                // Create a new server entry; default to suspended (active: false)
                servers.push({ name: name, code: code, active: false });
            }
            localStorage.setItem('servers', JSON.stringify(servers));
            showServers();
        }
    </script>
</body>
</html>