<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pulsecad</title>
    <link rel="icon" type="image/webp" href="https://cdn.discordapp.com/icons/1455410644634304725/75220689ed872e2ee4c7101f479813a5.webp?size=512">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #0c0e12;
            min-height: 100vh;
            color: #e4e4e7;
        }

        header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 64px;
            background: rgba(12,14,18,.92);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid #1e222d;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 32px;
            z-index: 50;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .brand img {
            width: 36px;
            height: 36px;
            border-radius: 50%;
        }

        .brand span {
            font-size: 18px;
            font-weight: 600;
            letter-spacing: -.3px;
        }

        .nav-btn {
            padding: 9px 20px;
            background: #3b82f6;
            border: none;
            border-radius: 8px;
            color: #fff;
            font-size: 13px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
        }

        .nav-btn:hover { background: #2563eb; }

        .nav-links {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }

        .nav-link {
            background: none;
            border: none;
            color: #a1a1aa;
            font-size: 14px;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            padding: 8px 16px;
            border-radius: 6px;
        }

        .nav-link:hover {
            color: #e4e4e7;
            background: rgba(255,255,255,.06);
        }

        .hero {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 100px 24px 60px;
            position: relative;
            overflow: hidden;
        }

        .hero h1 {
            font-size: 42px;
            font-weight: 700;
            letter-spacing: -.5px;
            margin-bottom: 14px;
        }

        .hero p {
            color: #71717a;
            font-size: 16px;
            max-width: 420px;
        }

        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.75);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 99;
            padding: 20px;
        }

        .overlay.active { display: flex; }

        .modal {
            background: #14171f;
            border: 1px solid #1e222d;
            border-radius: 12px;
            width: 100%;
            max-width: 380px;
            padding: 32px 28px;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            color: #71717a;
            cursor: pointer;
            padding: 4px;
        }

        .modal-close:hover { color: #a1a1aa; }

        .modal-close svg { width: 20px; height: 20px; }

        .modal-logo {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: block;
            margin: 0 auto 16px;
        }

        .modal h2 {
            color: #e4e4e7;
            font-size: 18px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 4px;
        }

        .modal .sub {
            color: #71717a;
            font-size: 13px;
            text-align: center;
            margin-bottom: 22px;
        }

        .field { margin-bottom: 14px; text-align: left; }

        .field label {
            display: block;
            color: #a1a1aa;
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 5px;
        }

        .field input {
            width: 100%;
            padding: 11px 13px;
            background: #0c0e12;
            border: 1px solid #27272a;
            border-radius: 8px;
            color: #fafafa;
            font-size: 13px;
            font-family: inherit;
        }

        .field input:focus { outline: none; border-color: #3b82f6; }
        .field input::placeholder { color: #52525b; }

        .btn-primary {
            width: 100%;
            padding: 11px;
            background: #3b82f6;
            border: none;
            border-radius: 8px;
            color: #fff;
            font-size: 13px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            margin-top: 6px;
        }

        .btn-primary:hover { background: #2563eb; }

        .sep {
            display: flex;
            align-items: center;
            margin: 20px 0;
            color: #52525b;
            font-size: 11px;
        }

        .sep::before, .sep::after { content: ''; flex: 1; height: 1px; background: #27272a; }
        .sep::before { margin-right: 10px; }
        .sep::after { margin-left: 10px; }

        .btn-secondary {
            width: 100%;
            padding: 11px;
            background: transparent;
            border: 1px solid #27272a;
            border-radius: 8px;
            color: #a1a1aa;
            font-size: 13px;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
        }

        .btn-secondary:hover { background: #18181b; border-color: #3f3f46; }

        .panel { display: none; }
        .panel.active { display: block; }

        .alert {
            padding: 10px 12px;
            border-radius: 8px;
            font-size: 12px;
            margin-bottom: 14px;
            display: none;
        }

        .alert-error { background: rgba(239,68,68,.12); border: 1px solid #991b1b; color: #fca5a5; }
        .alert-success { background: rgba(34,197,94,.12); border: 1px solid #166534; color: #86efac; }

        .link {
            color: #3b82f6;
            font-size: 13px;
            cursor: pointer;
            display: inline-block;
            margin-top: 16px;
        }

        .link:hover { text-decoration: underline; }

        .dashboard {
            min-height: 100vh;
            padding: 88px 32px 40px;
            display: none;
        }

        .dashboard.active { display: block; }

        .dash-header {
            max-width: 600px;
            margin: 0 auto 28px;
        }

        .dash-header h1 { font-size: 24px; font-weight: 600; margin-bottom: 4px; }
        .dash-header p { color: #71717a; font-size: 14px; }

        .dash-content { max-width: 600px; margin: 0 auto; }

        .actions { display: flex; flex-direction: row; gap: 12px; margin-bottom: 28px; }

        .btn-action {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 14px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
        }

        .btn-action svg { width: 18px; height: 18px; }

        .btn-join { background: #3b82f6; border: none; color: #fff; }
        .btn-join:hover { background: #2563eb; }

        .btn-create { background: transparent; border: 1px solid #22c55e; color: #4ade80; }
        .btn-create:hover { background: rgba(34,197,94,.1); }

        .section-title {
            color: #71717a;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: .6px;
            margin-bottom: 12px;
        }

        .list { display: flex; flex-direction: column; gap: 8px; }

        .item {
            background: #14171f;
            border: 1px solid #1e222d;
            border-radius: 8px;
            padding: 14px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .item:hover { border-color: #27272a; }
        .item-info { text-align: left; }
        .item-name { color: #e4e4e7; font-size: 14px; font-weight: 500; }
        .item-url { color: #3b82f6; font-size: 12px; text-decoration: none; margin-top: 2px; display: block; }
        .item-url:hover { text-decoration: underline; }

        .btn-enter {
            background: #3b82f6;
            border: none;
            border-radius: 6px;
            color: #fff;
            padding: 7px 14px;
            font-size: 12px;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
        }

        .btn-enter:hover { background: #2563eb; }

        .empty { color: #52525b; font-size: 13px; text-align: center; padding: 20px; }

        .opt { color: #52525b; font-weight: 400; }

        .modal-sm { max-width: 360px; padding: 26px 24px; }
        .modal-sm h2 { font-size: 16px; margin-bottom: 18px; text-align: left; }

        .modal-btns { display: flex; gap: 10px; margin-top: 18px; }
        .modal-btns button { flex: 1; padding: 10px; border-radius: 8px; font-size: 13px; font-weight: 500; font-family: inherit; cursor: pointer; }

        .btn-cancel { background: transparent; border: 1px solid #27272a; color: #a1a1aa; }
        .btn-cancel:hover { background: #18181b; }

        .btn-confirm { background: #22c55e; border: none; color: #fff; font-weight: 600; }
        .btn-confirm:hover { background: #16a34a; }

        .logged-in .hero { display: none !important; }
        .logged-in .pricing-section { display: none !important; }
        .logged-in .team-section { display: none !important; }
        .logged-in .support-ticket-page { display: none !important; }
        .logged-in .dashboard:not(.hidden) { display: block; }
        .logged-in .dashboard.hidden { display: none !important; }
        .logged-in .nav-btn { display: none; }
        .logged-in .nav-links { display: none; }

        .nav-user {
            display: none;
            align-items: center;
            gap: 14px;
        }

        .nav-user span { color: #a1a1aa; font-size: 13px; }

        .nav-logout {
            padding: 8px 16px;
            background: transparent;
            border: 1px solid #27272a;
            border-radius: 8px;
            color: #a1a1aa;
            font-size: 12px;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
        }

        .nav-logout:hover { background: #18181b; border-color: #3f3f46; }

        .logged-in .nav-user { display: flex; }

        .in-community header { display: none; }
        .in-community .community-screen { padding-top: 40px; }

        .pricing-section {
            display: none;
            min-height: 100vh;
            padding: 100px 32px 60px;
        }

        .pricing-section.active { display: block; }
        .pricing-section.active ~ .hero { display: none; }

        .pricing-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .pricing-header h1 { font-size: 32px; margin-bottom: 8px; }
        .pricing-header p { color: #71717a; font-size: 15px; }

        .pricing-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            max-width: 960px;
            margin: 0 auto;
        }

        .price-card {
            background: linear-gradient(145deg, #151921 0%, #111318 100%);
            border: 1px solid #1e2530;
            border-radius: 12px;
            padding: 28px 26px;
        }

        .price-card h3 {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #f0f0f2;
        }

        .price-card .desc {
            color: #6b7280;
            font-size: 13px;
            line-height: 1.5;
            min-height: 54px;
            margin-bottom: 20px;
        }

        .price-amount {
            margin-bottom: 22px;
        }

        .price-amount span {
            font-size: 38px;
            font-weight: 700;
            color: #fff;
        }

        .price-amount small {
            color: #6b7280;
            font-size: 14px;
            margin-left: 4px;
        }

        .price-btn {
            width: 100%;
            padding: 12px;
            background: #2563eb;
            border: none;
            border-radius: 8px;
            color: #fff;
            font-size: 13px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            margin-bottom: 24px;
        }

        .price-btn:hover { background: #1d4ed8; }

        .features-title {
            color: #e4e4e7;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 14px;
        }

        .features-list {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .features-list li {
            color: #9ca3af;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .features-list li svg {
            width: 16px;
            height: 16px;
            color: #22c55e;
            flex-shrink: 0;
        }

        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: none;
            border: none;
            color: #71717a;
            font-size: 13px;
            font-family: inherit;
            cursor: pointer;
            margin-bottom: 24px;
        }

        .back-btn:hover { color: #a1a1aa; }
        .back-btn svg { width: 16px; height: 16px; }

        .community-screen {
            display: none;
            min-height: 100vh;
            padding: 88px 32px 40px;
        }

        .community-screen.active { display: block; }

        .btn-back-dashboard {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: #374151;
            border: none;
            border-radius: 8px;
            color: #fff;
            font-size: 13px;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            margin-bottom: 16px;
        }

        .btn-back-dashboard:hover { background: #4b5563; }

        .community-header {
            max-width: 800px;
            margin: 0 auto 32px;
        }

        .community-info-header {
            margin-top: 16px;
        }

        .community-info-header h1 {
            font-size: 26px;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .community-info-header p {
            color: #52525b;
            font-size: 13px;
        }

        .community-content {
            max-width: 800px;
            margin: 0 auto;
        }

        .community-actions {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
        }

        .btn-police {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: #3b82f6;
            border: none;
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
        }

        .btn-police:hover { background: #2563eb; }

        .btn-admin {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: #f59e0b;
            border: none;
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
        }

        .btn-admin:hover { background: #d97706; }

        .police-login-modal .modal { max-width: 400px; }

        .police-mdt {
            display: none;
            min-height: 100vh;
            padding: 20px;
            background: #0a0d14;
        }

        .police-mdt.active { display: block; }

        .mdt-grid {
            display: grid;
            grid-template-columns: 250px 1fr 320px;
            gap: 16px;
            margin-bottom: 16px;
        }

        .mdt-panel {
            background: #111827;
            border: 1px solid #1e293b;
            border-radius: 10px;
            padding: 20px;
        }

        .mdt-panel h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            text-align: center;
        }

        .officer-timer {
            font-size: 32px;
            font-weight: 300;
            color: #6b7280;
            text-align: center;
            margin-bottom: 24px;
            font-family: monospace;
        }

        .officer-info-item {
            text-align: center;
            margin-bottom: 16px;
        }

        .officer-info-item .label {
            color: #6b7280;
            font-size: 12px;
            margin-bottom: 4px;
        }

        .officer-info-item .value {
            color: #e4e4e7;
            font-size: 14px;
            font-weight: 500;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-10-8 { background: #22c55e; color: #fff; }
        .status-10-7 { background: #ef4444; color: #fff; }
        .status-10-6 { background: #eab308; color: #000; }
        .status-10-11 { background: #3b82f6; color: #fff; }
        .status-10-15 { background: #3b82f6; color: #fff; }
        .status-10-23 { background: #3b82f6; color: #fff; }
        .status-10-26 { background: #f97316; color: #fff; }
        .status-10-45 { background: #f97316; color: #fff; }
        .status-10-97 { background: #f97316; color: #fff; }
        .status-10-99 { background: #ef4444; color: #fff; }
        .status-signal { background: #a855f7; color: #fff; }
        .status-panic { background: #dc2626; color: #fff; animation: panic-flash 0.5s infinite; }
        @keyframes panic-flash { 0%, 100% { background: #dc2626; } 50% { background: #7f1d1d; } }

        .control-section {
            margin-bottom: 20px;
        }

        .control-section .section-label {
            color: #6b7280;
            font-size: 12px;
            text-align: center;
            margin-bottom: 12px;
        }

        .status-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .status-btn {
            padding: 8px 16px;
            border: 1px solid;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            background: transparent;
        }

        .status-btn.green { border-color: #22c55e; color: #22c55e; }
        .status-btn.green:hover { background: rgba(34,197,94,.15); }
        .status-btn.red { border-color: #ef4444; color: #ef4444; }
        .status-btn.red:hover { background: rgba(239,68,68,.15); }
        .status-btn.yellow { border-color: #eab308; color: #eab308; }
        .status-btn.yellow:hover { background: rgba(234,179,8,.15); }
        .status-btn.blue { border-color: #3b82f6; color: #3b82f6; }
        .status-btn.blue:hover { background: rgba(59,130,246,.15); }
        .status-btn.orange { border-color: #f97316; color: #f97316; }
        .status-btn.orange:hover { background: rgba(249,115,22,.15); }
        .status-btn.purple { border-color: #a855f7; color: #a855f7; }
        .status-btn.purple:hover { background: rgba(168,85,247,.15); }

        .quick-actions {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .quick-btn {
            padding: 8px 16px;
            background: transparent;
            border: 1px solid #3b82f6;
            border-radius: 6px;
            color: #3b82f6;
            font-size: 12px;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
        }

        .quick-btn:hover { background: rgba(59,130,246,.15); }

        .chat-messages {
            height: 280px;
            overflow-y: auto;
            margin-bottom: 12px;
            padding: 10px;
            background: #0a0d14;
            border-radius: 6px;
        }

        .chat-message {
            font-size: 12px;
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .chat-message .time { color: #6b7280; }
        .chat-message .sender { color: #fff; font-weight: 600; }
        .chat-message .text { color: #9ca3af; }

        .chat-input-wrap {
            display: flex;
            gap: 8px;
        }

        .chat-input {
            flex: 1;
            padding: 10px 14px;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 6px;
            color: #fff;
            font-size: 13px;
            font-family: inherit;
        }

        .chat-input::placeholder { color: #6b7280; }
        .chat-input:focus { outline: none; border-color: #3b82f6; }

        .chat-send {
            padding: 10px 20px;
            background: #3b82f6;
            border: none;
            border-radius: 6px;
            color: #fff;
            font-size: 13px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
        }

        .chat-send:hover { background: #2563eb; }

        .mdt-bottom-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .calls-table, .bolos-table {
            width: 100%;
            border-collapse: collapse;
        }

        .calls-table th, .bolos-table th {
            background: #1e293b;
            color: #6b7280;
            font-size: 12px;
            font-weight: 500;
            padding: 10px 12px;
            text-align: left;
        }

        .calls-table td, .bolos-table td {
            padding: 12px;
            font-size: 13px;
            color: #9ca3af;
            border-bottom: 1px solid #1e293b;
        }

        .btn-details {
            padding: 6px 14px;
            background: transparent;
            border: 1px solid #3b82f6;
            border-radius: 4px;
            color: #3b82f6;
            font-size: 11px;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
        }

        .btn-details:hover { background: rgba(59,130,246,.15); }

        .mdt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 0 10px;
        }

        .mdt-header h2 {
            font-size: 20px;
            font-weight: 600;
        }

        .btn-off-duty {
            padding: 10px 20px;
            background: #ef4444;
            border: none;
            border-radius: 8px;
            color: #fff;
            font-size: 13px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
        }

        .btn-off-duty:hover { background: #dc2626; }

        .lookup-result {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 14px;
            margin-bottom: 10px;
        }

        .lookup-result:hover { border-color: #3b82f6; }

        .lookup-result .name {
            font-size: 14px;
            font-weight: 600;
            color: #e4e4e7;
            margin-bottom: 6px;
        }

        .lookup-result .info {
            font-size: 12px;
            color: #9ca3af;
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }

        .lookup-result .info span { display: flex; align-items: center; gap: 4px; }

        .lookup-empty {
            text-align: center;
            color: #6b7280;
            font-size: 13px;
            padding: 20px;
        }

        .btn-civilian {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: #22c55e;
            border: none;
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
        }

        .btn-civilian:hover { background: #16a34a; }

        .civilian-page {
            display: none;
            min-height: 100vh;
            background: #0a0d14;
        }

        .civilian-page.active { display: block; }

        .civilian-toolbar {
            background: #1a1a1a;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid #333;
        }

        .toolbar-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 18px;
            border: none;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            text-transform: uppercase;
        }

        .toolbar-btn svg { width: 16px; height: 16px; }

        .toolbar-btn.green { background: #22c55e; color: #fff; }
        .toolbar-btn.green:hover { background: #16a34a; }

        .toolbar-btn.teal { background: #14b8a6; color: #fff; }
        .toolbar-btn.teal:hover { background: #0d9488; }

        .toolbar-btn.gray { background: #4b5563; color: #fff; }
        .toolbar-btn.gray:hover { background: #374151; }

        .toolbar-btn.orange { background: #f97316; color: #fff; }
        .toolbar-btn.orange:hover { background: #ea580c; }

        .toolbar-btn.red { background: #ef4444; color: #fff; }
        .toolbar-btn.red:hover { background: #dc2626; }

        .toolbar-divider {
            width: 1px;
            height: 32px;
            background: #333;
            margin: 0 8px;
        }

        .civilian-content {
            padding: 30px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .civilian-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .civilian-header h2 {
            font-size: 24px;
            font-weight: 600;
        }

        .btn-back-community {
            padding: 10px 20px;
            background: #374151;
            border: none;
            border-radius: 8px;
            color: #fff;
            font-size: 13px;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
        }

        .btn-back-community:hover { background: #4b5563; }

        .characters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
        }

        .character-card {
            background: #111827;
            border: 1px solid #1e293b;
            border-radius: 10px;
            padding: 20px;
        }

        .character-card .name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .character-card .info {
            font-size: 13px;
            color: #9ca3af;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .character-card .actions {
            margin-top: 16px;
            display: flex;
            gap: 10px;
        }

        .no-characters {
            text-align: center;
            color: #6b7280;
            padding: 60px 20px;
            font-size: 14px;
        }

        .btn-ticket {
            margin-top: 10px;
            padding: 8px 16px;
            background: #f97316;
            border: none;
            border-radius: 6px;
            color: #fff;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-ticket:hover { background: #ea580c; }

        .charges-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 12px;
        }

        .charge-item {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .charge-item input {
            flex: 1;
        }

        .btn-add-charge {
            padding: 8px 14px;
            background: #22c55e;
            border: none;
            border-radius: 6px;
            color: #fff;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
        }

        .btn-add-charge:hover { background: #16a34a; }

        .btn-remove-charge {
            padding: 6px 10px;
            background: #ef4444;
            border: none;
            border-radius: 4px;
            color: #fff;
            font-size: 11px;
            cursor: pointer;
        }

        .btn-remove-charge:hover { background: #dc2626; }

        .signature-pad {
            width: 100%;
            height: 100px;
            background: #0c0e12;
            border: 1px solid #27272a;
            border-radius: 8px;
            cursor: crosshair;
        }

        .signature-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .btn-clear-sig {
            padding: 6px 12px;
            background: #374151;
            border: none;
            border-radius: 4px;
            color: #fff;
            font-size: 11px;
            cursor: pointer;
        }

        .btn-clear-sig:hover { background: #4b5563; }

        .civilian-tabs {
            display: flex;
            gap: 0;
            margin-bottom: 20px;
            border-bottom: 1px solid #333;
        }

        .civilian-tab {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            color: #6b7280;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
        }

        .civilian-tab:hover { color: #9ca3af; }

        .civilian-tab.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .ticket-card {
            background: #111827;
            border: 1px solid #1e293b;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 12px;
        }

        .ticket-card .ticket-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .ticket-card .ticket-id {
            font-size: 14px;
            font-weight: 600;
            color: #f97316;
        }

        .ticket-card .ticket-date {
            font-size: 12px;
            color: #6b7280;
        }

        .ticket-card .ticket-info {
            font-size: 13px;
            color: #9ca3af;
            margin-bottom: 8px;
        }

        .ticket-card .ticket-charges {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #1e293b;
        }

        .ticket-card .ticket-charges h4 {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 8px;
        }

        .ticket-card .charge {
            padding: 6px 10px;
            background: #1e293b;
            border-radius: 4px;
            font-size: 12px;
            color: #e4e4e7;
            margin-bottom: 6px;
        }

        .ticket-card .ticket-signature {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #1e293b;
        }

        .ticket-card .ticket-signature h4 {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 8px;
        }

        .ticket-card .ticket-signature img {
            max-width: 200px;
            max-height: 60px;
            border: 1px solid #333;
            border-radius: 4px;
            background: #0c0e12;
        }

        .no-tickets {
            text-align: center;
            color: #6b7280;
            padding: 40px 20px;
            font-size: 14px;
        }

        .team-section {
            display: none;
            min-height: 100vh;
            padding: 100px 32px 60px;
        }

        .team-section.active { display: block; }

        .team-header {
            text-align: center;
            margin-bottom: 50px;
        }

        .team-header h1 {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .team-header p {
            color: #71717a;
            font-size: 15px;
        }

        .team-grid {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
            max-width: 1000px;
            margin: 0 auto;
        }

        .team-card {
            background: linear-gradient(145deg, #151921 0%, #111318 100%);
            border: 1px solid #1e2530;
            border-radius: 16px;
            padding: 30px;
            text-align: center;
            width: 280px;
        }

        .team-card .team-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #3b82f6;
            margin-bottom: 16px;
        }

        .team-card .team-name {
            font-size: 22px;
            font-weight: 600;
            color: #f0f0f2;
            margin-bottom: 6px;
        }

        .team-card .team-role {
            font-size: 14px;
            font-weight: 600;
            color: #3b82f6;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
        }

        .team-card .team-role.owner {
            color: #f59e0b;
        }

        .team-card .team-role.coowner {
            color: #a855f7;
        }

        .team-card .team-role.director {
            color: #ef4444;
        }

        .team-card .team-role.admin {
            color: #22c55e;
        }

        .team-card .team-role.support {
            color: #3b82f6;
        }

        .team-card .vacant-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 3px dashed #6b7280;
            margin: 0 auto 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            color: #6b7280;
            background: #1e2530;
        }

        .team-card .team-desc {
            color: #6b7280;
            font-size: 13px;
            line-height: 1.5;
        }

        /* Support Ticket System */
        .support-ticket-page {
            display: none;
            min-height: 100vh;
            padding: 88px 32px 40px;
            background: #0a0d14;
        }

        .support-ticket-page.active {
            display: block;
        }

        .support-container {
            max-width: 1100px;
            margin: 0 auto;
        }

        .support-grid {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 24px;
        }

        @media (max-width: 768px) {
            .support-grid {
                grid-template-columns: 1fr;
            }
        }

        .support-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .support-header h2 {
            font-size: 24px;
            font-weight: 600;
        }

        .ticket-form-card {
            background: #14171f;
            border: 1px solid #1e222d;
            border-radius: 12px;
            padding: 28px;
            margin-bottom: 30px;
        }

        .ticket-form-card h3 {
            font-size: 18px;
            margin-bottom: 20px;
            color: #e4e4e7;
        }

        .ticket-chat-container {
            display: none;
            background: #14171f;
            border: 1px solid #1e222d;
            border-radius: 12px;
            overflow: hidden;
        }

        .ticket-chat-container.active {
            display: block;
        }

        .ticket-chat-header {
            background: #1e222d;
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ticket-chat-header .ticket-id {
            font-size: 14px;
            color: #3b82f6;
            font-weight: 600;
        }

        .ticket-chat-header .ticket-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }

        .ticket-status.open {
            background: rgba(34,197,94,.2);
            color: #4ade80;
        }

        .ticket-status.claimed {
            background: rgba(59,130,246,.2);
            color: #60a5fa;
        }

        .ticket-status.closed {
            background: rgba(107,114,128,.2);
            color: #9ca3af;
        }

        .ticket-chat-messages {
            height: 350px;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .ticket-message {
            max-width: 75%;
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 13px;
            line-height: 1.5;
        }

        .ticket-message.user {
            align-self: flex-end;
            background: #3b82f6;
            color: #fff;
            border-bottom-right-radius: 4px;
        }

        .ticket-message.staff {
            align-self: flex-start;
            background: #1e293b;
            color: #e4e4e7;
            border-bottom-left-radius: 4px;
        }

        .ticket-message .sender {
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 4px;
            opacity: 0.8;
        }

        .ticket-message .time {
            font-size: 10px;
            opacity: 0.6;
            margin-top: 6px;
        }

        .ticket-chat-input {
            display: flex;
            gap: 10px;
            padding: 16px 20px;
            background: #0c0e12;
            border-top: 1px solid #1e222d;
        }

        .ticket-chat-input input {
            flex: 1;
            padding: 12px 16px;
            background: #14171f;
            border: 1px solid #27272a;
            border-radius: 8px;
            color: #fafafa;
            font-size: 13px;
            font-family: inherit;
        }

        .ticket-chat-input input:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .ticket-chat-input button {
            padding: 12px 24px;
            background: #3b82f6;
            border: none;
            border-radius: 8px;
            color: #fff;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }

        .ticket-chat-input button:hover {
            background: #2563eb;
        }

        .my-tickets-list {
            margin-top: 0;
        }

        .my-ticket-item {
            background: #14171f;
            border: 1px solid #1e222d;
            border-radius: 10px;
            padding: 16px 20px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .my-ticket-item:hover {
            border-color: #3b82f6;
        }

        .my-ticket-info h4 {
            font-size: 14px;
            color: #e4e4e7;
            margin-bottom: 4px;
        }

        .my-ticket-info p {
            font-size: 12px;
            color: #6b7280;
        }

        /* Staff Tickets Section */
        .staff-tickets-grid {
            display: grid;
            gap: 16px;
        }

        .staff-ticket-card {
            background: #111827;
            border: 1px solid #1e293b;
            border-radius: 10px;
            padding: 20px;
        }

        .staff-ticket-card .ticket-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .staff-ticket-card .ticket-info h4 {
            font-size: 15px;
            color: #e4e4e7;
            margin-bottom: 4px;
        }

        .staff-ticket-card .ticket-info p {
            font-size: 12px;
            color: #6b7280;
        }

        .staff-ticket-card .ticket-reason {
            background: #1e293b;
            padding: 12px;
            border-radius: 6px;
            font-size: 13px;
            color: #9ca3af;
            margin-bottom: 16px;
        }

        .staff-ticket-card .ticket-actions {
            display: flex;
            gap: 10px;
        }

        .btn-claim {
            padding: 8px 16px;
            background: #22c55e;
            border: none;
            border-radius: 6px;
            color: #fff;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-claim:hover {
            background: #16a34a;
        }

        .btn-respond {
            padding: 8px 16px;
            background: #3b82f6;
            border: none;
            border-radius: 6px;
            color: #fff;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-respond:hover {
            background: #2563eb;
        }

        .btn-close-ticket {
            padding: 8px 16px;
            background: #ef4444;
            border: none;
            border-radius: 6px;
            color: #fff;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-close-ticket:hover {
            background: #dc2626;
        }

        .staff-chat-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.75);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
            padding: 20px;
        }

        .staff-chat-modal.active {
            display: flex;
        }

        .staff-chat-content {
            background: #14171f;
            border: 1px solid #1e222d;
            border-radius: 12px;
            width: 100%;
            max-width: 600px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }

        .staff-chat-content .ticket-chat-messages {
            flex: 1;
            min-height: 300px;
        }

        .no-support-tickets {
            text-align: center;
            color: #6b7280;
            padding: 40px 20px;
            font-size: 14px;
        }

        .tones-context-menu {
            position: fixed;
            background: #1f2937;
            border: 1px solid #374151;
            border-radius: 8px;
            padding: 8px 0;
            min-width: 180px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            z-index: 10000;
            display: none;
        }

        .tones-context-menu.active {
            display: block;
        }

        .tones-context-menu .menu-title {
            padding: 8px 16px;
            font-size: 11px;
            font-weight: 600;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid #374151;
            margin-bottom: 4px;
        }

        .tones-context-menu .tone-item {
            padding: 10px 16px;
            font-size: 13px;
            color: #e4e4e7;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.15s;
        }

        .tones-context-menu .tone-item:hover {
            background: #374151;
        }

        .tones-context-menu .tone-item .tone-icon {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .tones-context-menu .tone-item.tone-1 .tone-icon { background: #ef4444; }
        .tones-context-menu .tone-item.tone-2 .tone-icon { background: #f59e0b; }
        .tones-context-menu .tone-item.tone-3 .tone-icon { background: #3b82f6; }

        /* Staff Dropdown */
        .staff-dropdown {
            position: relative;
            z-index: 1000;
        }

        .staff-dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: #1f2937;
            border: 1px solid #374151;
            border-radius: 8px;
            padding: 8px 0;
            min-width: 180px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            z-index: 1001;
        }

        .staff-dropdown-menu.active {
            display: block;
        }

        .staff-dropdown-menu .dropdown-item {
            display: block;
            width: 100%;
            padding: 10px 16px;
            background: none;
            border: none;
            color: #e4e4e7;
            font-size: 13px;
            text-align: left;
            cursor: pointer;
            transition: background 0.15s;
        }

        .staff-dropdown-menu .dropdown-item:hover {
            background: #374151;
        }

        .dropdown-submenu {
            position: relative;
        }

        .dropdown-submenu-content {
            display: none;
            position: absolute;
            left: 100%;
            top: 0;
            background: #1f2937;
            border: 1px solid #374151;
            border-radius: 8px;
            padding: 8px 0;
            min-width: 160px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            z-index: 1002;
        }

        .dropdown-submenu:hover .dropdown-submenu-content {
            display: block;
        }

        .dropdown-submenu .dropdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Staff Settings Modal */
        .staff-settings-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .staff-settings-modal.active {
            display: flex;
        }

        .staff-settings-content {
            background: #14171f;
            border: 1px solid #1e222d;
            border-radius: 16px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .staff-settings-content h3 {
            font-size: 20px;
            margin-bottom: 20px;
            color: #e4e4e7;
        }

        /* Snow Effect */
        .snowflakes {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            overflow: hidden;
        }

        .hero h1, .hero p {
            position: relative;
            z-index: 2;
        }

        .snowflake {
            position: absolute;
            top: -10px;
            color: #fff;
            font-size: 1em;
            text-shadow: 0 0 5px rgba(255,255,255,0.5);
            animation: snowfall linear infinite;
            opacity: 0.8;
        }

        @keyframes snowfall {
            0% {
                transform: translateY(0) rotate(0deg);
            }
            100% {
                transform: translateY(100vh) rotate(360deg);
            }
        }

    </style>
</head>
<body>
    <!-- Tones Context Menu -->
    <div class="tones-context-menu" id="tonesContextMenu">
        <div class="menu-title">Tones</div>
        <div class="tone-item tone-1" data-tone="1">
            <span class="tone-icon"></span>
            <span>Tone 1 - Priority</span>
        </div>
        <div class="tone-item tone-2" data-tone="2">
            <span class="tone-icon"></span>
            <span>Tone 2 - Alert</span>
        </div>
        <div class="tone-item tone-3" data-tone="3">
            <span class="tone-icon"></span>
            <span>Tone 3 - Routine</span>
        </div>
    </div>

    <header>
        <div class="brand">
            <img src="https://cdn.discordapp.com/icons/1455410644634304725/75220689ed872e2ee4c7101f479813a5.webp?size=512" alt="Pulsecad">
            <span>Pulsecad</span>
        </div>
        <nav class="nav-links">
            <button class="nav-link" id="homeBtn">Home</button>
            <button class="nav-link" id="pricesBtn">Prices</button>
            <a class="nav-link" href="https://discord.gg/FXNTFaQWt9" target="_blank" style="text-decoration: none;">Discord</a>
            <button class="nav-link" id="teamBtn">Team</button>
            <!-- Support button removed -->
        </nav>
        <button class="nav-btn" id="openLogin">Login</button>
        <div class="nav-user">
            <span id="navUsername"></span>
            <button class="nav-logout" id="logoutBtn">Log out</button>
        </div>
    </header>

    <section class="pricing-section" id="pricingSection">
        <button class="back-btn" id="backFromPricing">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
            Back
        </button>
        <div class="pricing-header">
            <h1>Pricing</h1>
            <p>Choose the plan that fits your community</p>
        </div>
        <div class="pricing-grid">
            <div class="price-card">
                <h3>Starter</h3>
                <p class="desc">Perfect for small teams just getting started. Everything you need to launch your community.</p>
                <div class="price-amount">
                    <span>$10.00</span><small>/ 3 months</small>
                </div>
                <button class="price-btn">Login to Subscribe</button>
                <div class="features-title">What is Included?</div>
                <ul class="features-list">
                    <li>30 Members</li>
                    <li>50 Civilian characters</li>
                    <li>50 Vehicles</li>
                    <li>50 Reports</li>
                    <li>2 Departments</li>
                    <li>2 Businesses</li>
                    <li> Webhooks</li>
                    <li><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>Permission Keys</li>
                    <li><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>Internal Messaging</li>
                </ul>
            </div>
            <div class="price-card">
                <h3>Standard</h3>
                <p class="desc">Ideal for established groups ready to scale. Unlock more features and capacity for your growing team.</p>
                <div class="price-amount">
                    <span>$30.00</span><small>/ 3 months</small>
                </div>
                <button class="price-btn">Login to Subscribe</button>
                <div class="features-title">What is Included?</div>
                <ul class="features-list">
                    <li>150 Members</li>
                    <li>500 Civilian characters</li>
                    <li>500 Vehicles</li>
                    <li>500 Reports</li>
                    <li>6 Departments</li>
                    <li>6 Businesses</li>
                    <li> Webhooks</li>
                    <li><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>Permission Keys</li>
                    <li><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>Internal Messaging</li>
                    <li><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>FiveM Integration (Basic)</li>
                </ul>
            </div>
            <div class="price-card">
                <h3>Advanced</h3>
                <p class="desc">Built for serious communities that demand the best. Maximum power, priority support, full integration.</p>
                <div class="price-amount">
                    <span>$55.00</span><small>/ 3 months</small>
                </div>
                <button class="price-btn">Login to Subscribe</button>
                <div class="features-title">What is Included?</div>
                <ul class="features-list">
                    <li>250 Members</li>
                    <li>1,000 Civilian characters</li>
                    <li>1,000 Vehicles</li>
                    <li>1,000 Reports</li>
                    <li>12 Departments</li>
                    <li> Businesses</li>
                    <li> Webhooks</li>
                    <li><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>Permission Keys</li>
                    <li><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>Internal Messaging</li>
                    <li><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>FiveM Integration (Advanced)</li>
                </ul>
            </div>
        </div>
    </section>

    <section class="team-section" id="teamSection">
        <button class="back-btn" id="backFromTeam">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
            Back
        </button>
        <div class="team-header">
            <h1>Our Team</h1>
            <p>Meet the people behind Pulsecad</p>
        </div>
        <div class="team-grid">
            <div class="team-card">
                <img src="https://media1.tenor.com/m/2yNT5ibnFU8AAAAC/driving-fast.gif" alt="Ryan" class="team-avatar">
                <div class="team-name">Ryan</div>
                <div class="team-role owner">Owner</div>
                <div class="team-desc">Founder and owner of Pulsecad. Building the future of CAD/MDT systems.</div>
            </div>
            <div class="team-card">
                <img src="https://cdn.discordapp.com/avatars/926889740345679903/a_2cb92e0fe61cf965b984eadbd740fab8.gif?size=1024&animated=true" alt="Devin" class="team-avatar">
                <div class="team-name">Devin</div>
                <div class="team-role coowner">Co-Owner</div>
                <div class="team-desc">Co-owner of Pulsecad. Helping shape the vision and direction of the platform.</div>
            </div>
            <div class="team-card">
                <img src="https://cdn.discordapp.com/avatars/1249645229141659658/a_f4476c98c388dd0194c4ee0e38bc6161.gif?size=1024&animated=true" alt="Cayden" class="team-avatar">
                <div class="team-name">Cayden</div>
                <div class="team-role director">Operations Director</div>
                <div class="team-desc">Operations Director of Pulsecad. Overseeing daily operations and team coordination.</div>
            </div>
            <div class="team-card">
                <img src="https://cdn.discordapp.com/avatars/1089659592406999091/370574078a1f00b53b368aaf6cb24315.webp?size=1024" alt="ItzMisty" class="team-avatar">
                <div class="team-name">ItzMisty</div>
                <div class="team-role support">Senior Support</div>
                <div class="team-desc">Senior support team member helping users with any questions or issues.</div>
            </div>
            <div class="team-card">
                <img src="https://cdn.discordapp.com/avatars/937822760091156591/8010fe9317f640d842a8201a7b33ade0.webp?size=1024" alt="Joseh" class="team-avatar">
                <div class="team-name">Joseh</div>
                <div class="team-role support">Senior Support</div>
                <div class="team-desc">Senior support team member helping users with any questions or issues.</div>
            </div>
                <div class="team-card">
                    <img src="https://cdn.discordapp.com/attachments/1461861937913794705/1461863696476278907/372c588a10d88498ca22bafedd660386.png?ex=696c1a29&is=696ac8a9&hm=2cef8263e1821a4c1ed61a00f721dbee38efb3cdbf48c161816ea1eba3717d26&" alt="candychriss98" class="team-avatar">
                    <div class="team-name">candychriss98</div>
                    <div class="team-role support">Senior Support</div>
                    <div class="team-desc">Senior support team member helping users with any questions or issues.</div>
                </div>
            <div class="team-card">
                <div class="team-avatar vacant-avatar">?</div>
                <div class="team-name">Vacant</div>
                <div class="team-role support">Support</div>
                <div class="team-desc">This position is currently open. Join our Discord to apply!</div>
            </div>
            <div class="team-card">
                <div class="team-avatar vacant-avatar">?</div>
                <div class="team-name">Vacant</div>
                <div class="team-role support">Support</div>
                <div class="team-desc">This position is currently open. Join our Discord to apply!</div>
            </div>
            <div class="team-card">
                <div class="team-avatar vacant-avatar">?</div>
                <div class="team-name">Vacant</div>
                <div class="team-role support">Support</div>
                <div class="team-desc">This position is currently open. Join our Discord to apply!</div>
            </div>
        </div>
    </section>

    <section class="contact-section" id="contactSection" style="display:none;min-height:100vh;padding:100px 32px 60px;">
        <button class="back-btn" id="backFromContact">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
            Back
        </button>
        <div style="max-width:500px;margin:0 auto;">
            <div style="text-align:center;margin-bottom:40px;">
                <h1 style="font-size:32px;margin-bottom:8px;">Contact Us</h1>
                <p style="color:#71717a;font-size:15px;">Have a question? Send us a message!</p>
            </div>
            <div class="mdt-panel" style="padding:30px;">
                <form id="contactForm">
                    <div class="field">
                        <label>Your Name</label>
                        <input type="text" id="contactName" placeholder="Enter your name" required>
                    </div>
                    <div class="field">
                        <label>Email</label>
                        <input type="email" id="contactEmail" placeholder="Enter your email" required>
                    </div>
                    <div class="field">
                        <label>Subject</label>
                        <input type="text" id="contactSubject" placeholder="What is this about?" required>
                    </div>
                    <div class="field">
                        <label>Message</label>
                        <textarea id="contactMessage" placeholder="Your message..." rows="5" style="width:100%;padding:11px 13px;background:#0c0e12;border:1px solid #27272a;border-radius:8px;color:#fafafa;font-size:13px;font-family:inherit;resize:vertical;" required></textarea>
                    </div>
                    <button type="submit" class="btn-primary" style="width:100%;margin-top:10px;">Send Message</button>
                </form>
                <div id="contactStatus" style="text-align:center;margin-top:16px;font-size:13px;"></div>
            </div>
            <div style="text-align:center;margin-top:30px;">
                <p style="color:#71717a;font-size:13px;">Or reach us on Discord</p>
                <a href="https://discord.gg/FXNTFaQWt9" target="_blank" style="display:inline-block;margin-top:10px;padding:10px 20px;background:#5865F2;border-radius:8px;color:#fff;font-size:13px;font-weight:600;text-decoration:none;">Join Discord</a>
            </div>
        </div>
    </section>

    <main class="hero" id="heroSection">
        <div class="snowflakes" id="snowflakes"></div>
        <h1>Welcome to Pulsecad</h1>
        <p>Create and join communities. Connect with others and build something together.</p>
    </main>

    <section class="dashboard" id="dashboardSection">
        <div class="dash-content">
            <div class="actions">
                <button class="btn-action btn-join" id="joinCommunity">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 00-4-4H6a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/></svg>
                    Join Community
                </button>
                <button class="btn-action btn-create" id="createCommunity">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
                    Create Community
                </button>
                <button class="btn-action btn-staff" id="staffDashboardBtn" style="display:none;background:#a855f7;border:none;color:#fff;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
                    Staff Dashboard
                </button>
            </div>
            <div class="section-title">Your Communities</div>
            <div class="list" id="communityList">
                <div class="empty">No communities yet</div>
            </div>
        </div>
    </section>

    <div class="overlay" id="authModal">
        <div class="modal">
            <button class="modal-close" id="closeAuth"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
            <img src="https://cdn.discordapp.com/icons/1455410644634304725/75220689ed872e2ee4c7101f479813a5.webp?size=512" alt="Pulsecad" class="modal-logo">

            <div id="loginPanel" class="panel active">
                <h2>Welcome back</h2>
                <p class="sub">Sign in to continue</p>
                <div id="loginError" class="alert alert-error"></div>
                <div id="loginSuccess" class="alert alert-success"></div>
                <form id="loginForm">
                    <div class="field">
                        <label>Username</label>
                        <input type="text" id="loginUsername" placeholder="Enter username" required>
                    </div>
                    <div class="field">
                        <label>Password</label>
                        <input type="password" id="loginPassword" placeholder="Enter password" required>
                    </div>
                    <button type="submit" class="btn-primary">Log In</button>
                </form>
                <button class="btn-secondary" id="showRegister" style="margin-top:12px;">Create Account</button>
            </div>

            <div id="registerPanel" class="panel">
                <h2>Create Account</h2>
                <p class="sub">Join Pulsecad</p>
                <div id="registerError" class="alert alert-error"></div>
                <form id="registerForm">
                    <div class="field">
                        <label>Username</label>
                        <input type="text" id="regUsername" placeholder="Choose username" required>
                    </div>
                    <div class="field">
                        <label>Password</label>
                        <input type="password" id="regPassword" placeholder="Create password" required>
                    </div>
                    <div class="field">
                        <label>Confirm Password</label>
                        <input type="password" id="regConfirm" placeholder="Confirm password" required>
                    </div>
                    <button type="submit" class="btn-primary">Create Account</button>
                </form>
                <span class="link" id="showLogin">Back to Login</span>
            </div>
        </div>
    </div>

    <div class="overlay" id="createModal">
        <div class="modal modal-sm">
            <h2>Create Community</h2>
            <form id="createCommunityForm">
                <div class="field">
                    <label>Community Name</label>
                    <input type="text" id="communityName" placeholder="Enter name" required>
                </div>
                <div class="field">
                    <label>Website <span class="opt">(optional)</span></label>
                    <input type="url" id="communityWebsite" placeholder="https://www.pulsecadsystems.xyz/">
                </div>
                <div class="modal-btns">
                    <button type="button" class="btn-cancel" id="cancelCreate">Cancel</button>
                    <button type="submit" class="btn-confirm">Create</button>
                </div>
            </form>
        </div>
    </div>

    <div class="overlay" id="joinModal">
        <div class="modal modal-sm">
            <h2>Join Community</h2>
            <form id="joinCommunityForm">
                <div class="field">
                    <label>Community Code</label>
                    <input type="text" id="joinCode" placeholder="Enter community code" required>
                </div>
                <div id="joinError" class="alert alert-error"></div>
                <div class="modal-btns">
                    <button type="button" class="btn-cancel" id="cancelJoin">Cancel</button>
                    <button type="submit" class="btn-confirm">Join</button>
                </div>
            </form>
        </div>
    </div>

    <section class="community-screen" id="communityScreen">
        <div class="community-header">
            <button class="btn-back-dashboard" id="backToDashboard">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                Back to Dashboard
            </button>
            <div class="community-info-header">
                <h1 id="communityViewName"></h1>
                <p id="communityViewCode"></p>
            </div>
        </div>
        <div class="community-content">
            <div class="community-actions">
                <button class="btn-police" id="policeBtn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                    Police
                </button>
                <button class="btn-civilian" id="civilianBtn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                    Civilian
                </button>
                <button class="btn-admin" id="adminBtn">
                                    <!-- Roster Modal Triggered by Admin Button -->
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1Z"/></svg>
                    Admin
                                </button>

                                <!-- Roster Modal -->
                                <div class="overlay" id="rosterModal">
                                    <div class="modal" style="max-width:400px;">
                                        <button class="modal-close" id="closeRosterModal"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
                                        <h2>Community Roster</h2>
                                        <div class="field" style="margin-bottom:16px;">
                                            <label style="display:block;color:#a1a1aa;font-size:12px;margin-bottom:6px;">Name</label>
                                            <input type="text" id="rosterName" placeholder="Enter name" style="width:100%;padding:10px;background:#0c0e12;border:1px solid #27272a;border-radius:6px;color:#fff;font-size:13px;">
                                        </div>
                                        <div class="field" style="margin-bottom:16px;">
                                            <label style="display:block;color:#a1a1aa;font-size:12px;margin-bottom:6px;">Role</label>
                                            <input type="text" id="rosterRole" placeholder="Enter role" style="width:100%;padding:10px;background:#0c0e12;border:1px solid #27272a;border-radius:6px;color:#fff;font-size:13px;">
                                        </div>
                                        <button id="addRosterBtn" style="width:100%;padding:10px 0;background:#3b82f6;border:none;border-radius:6px;color:#fff;font-size:13px;font-weight:600;cursor:pointer;margin-bottom:16px;">Add to Roster</button>
                                        <div id="rosterList" style="max-height:180px;overflow-y:auto;"></div>
                                    </div>
                                </div>
                </button>
            </div>
        </div>
    </section>

    <section class="admin-page" id="adminPage" style="display:none;min-height:100vh;padding:30px;background:#0a0d14;">
        <div style="max-width:1000px;margin:0 auto;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:30px;">
                <h2 style="font-size:24px;font-weight:600;">Community Admin</h2>
                <button class="btn-back-community" id="backFromAdmin">Back to Community</button>
            </div>
            <div class="mdt-panel">
                <h3>Webhooks</h3>
                <p style="color:#6b7280;font-size:13px;margin-bottom:16px;">Set Discord webhooks for notifications</p>
                <button class="btn-primary" id="openWebhooksModal" style="margin-bottom:10px;">Discord Webhooks</button>
                <div id="webhookStatus" style="color:#6b7280;font-size:12px;"></div>
                <!-- Discord Webhooks Modal -->
                <div class="overlay" id="webhooksModal">
                    <div class="modal" style="max-width:400px;">
                        <button class="modal-close" id="closeWebhooksModal"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
                        <h2>Discord Webhooks</h2>
                        <p class="sub">Set the webhooks for logging character and ticket creation</p>
                        <div class="field" style="margin-bottom:16px;">
                            <label style="display:block;color:#a1a1aa;font-size:12px;margin-bottom:6px;">Character Created Webhook</label>
                            <input type="text" id="webhookCharacterCreated" placeholder="https://discord.com/api/webhooks/..." style="width:100%;padding:10px;background:#0c0e12;border:1px solid #27272a;border-radius:6px;color:#fff;font-size:13px;">
                        </div>
                        <div class="field" style="margin-bottom:16px;">
                            <label style="display:block;color:#a1a1aa;font-size:12px;margin-bottom:6px;">Ticket Created Webhook</label>
                            <input type="text" id="webhookTicketCreated" placeholder="https://discord.com/api/webhooks/..." style="width:100%;padding:10px;background:#0c0e12;border:1px solid #27272a;border-radius:6px;color:#fff;font-size:13px;">
                        </div>
                        <button id="saveWebhookBtn" style="width:100%;padding:10px 0;background:#3b82f6;border:none;border-radius:6px;color:#fff;font-size:13px;font-weight:600;cursor:pointer;">Save Webhooks</button>
                    </div>
                </div>
            </div>
            <!-- Departments section removed as requested -->
            <div class="mdt-panel" style="margin-top:24px;">
                <!-- Discord Settings section removed as requested -->
            </div>
        </div>
    </section>

    <div class="overlay police-login-modal" id="policeLoginModal">
        <div class="modal">
            <button class="modal-close" id="closePoliceLogin"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
            <img src="https://cdn.discordapp.com/icons/1455410644634304725/75220689ed872e2ee4c7101f479813a5.webp?size=512" alt="Pulsecad" class="modal-logo">
            <h2>Police Login</h2>
            <p class="sub">Enter your officer information</p>
            <form id="policeLoginForm">
                <div class="field">
                    <label>Name</label>
                    <input type="text" id="officerName" placeholder="Enter your name" required>
                </div>
                <div class="field">
                    <label>Callsign</label>
                    <input type="text" id="officerCallsign" placeholder="e.g. 1B-01" required>
                </div>
                <div class="field">
                    <label>Rank</label>
                    <input type="text" id="officerRank" placeholder="e.g. Deputy, Sergeant" required>
                </div>
                <button type="submit" class="btn-primary" style="background:#22c55e;margin-top:12px;">Go on Duty</button>
            </form>
        </div>
    </div>

    <section class="staff-dashboard" id="staffDashboard" style="display:none;min-height:100vh;padding:30px;background:#0a0d14;">
        <div style="max-width:1200px;margin:0 auto;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:30px;">
                <h2 style="font-size:24px;font-weight:600;">Staff Dashboard</h2>
                <div style="display:flex;gap:10px;align-items:center;">
                    <div class="staff-dropdown" style="position:relative;">
                        <button class="btn-back-community" id="adminDropdownBtn" style="background:#a855f7;">Admin </button>
                        <div class="staff-dropdown-menu" id="adminDropdownMenu">
                            <button class="dropdown-item" id="discordSettingsBtn">Discord Settings</button>
                            <button class="dropdown-item" id="charactersAdminBtn">Characters</button>
                            <div class="dropdown-submenu">
                                <button class="dropdown-item" id="accountsSubmenuBtn">Accounts </button>
                                <div class="dropdown-submenu-content" id="accountsSubmenu">
                                    <button class="dropdown-item" id="accountsBtn">Accounts</button>
                                    <button class="dropdown-item" id="permissionsKeyBtn">Permissions Key</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button class="btn-back-community" id="backFromStaff">Back to Dashboard</button>
                </div>
            </div>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-bottom:30px;">
                <div class="mdt-panel">
                    <h3>Total Users</h3>
                    <div id="totalUsers" style="font-size:36px;font-weight:700;color:#3b82f6;text-align:center;margin-top:10px;">0</div>
                </div>
                <div class="mdt-panel">
                    <h3>Total Communities</h3>
                    <div id="totalCommunities" style="font-size:36px;font-weight:700;color:#22c55e;text-align:center;margin-top:10px;">0</div>
                </div>
                <div class="mdt-panel">
                    <h3>Total Characters</h3>
                    <div id="totalCharacters" style="font-size:36px;font-weight:700;color:#a855f7;text-align:center;margin-top:10px;">0</div>
                </div>
            </div>
            <!-- Departments section removed as requested -->
                    </tbody>
                </table>
            </div>
            <div class="mdt-panel">
                <h3>All Users</h3>
                <table class="calls-table" style="margin-top:16px;">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Username</th>
                            <th>Display Name</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="staffUsersTable">
                        <tr><td colspan="5" style="text-align:center;color:#6b7280;">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="mdt-panel" style="margin-top:20px;">
                <h3>Support Tickets</h3>
                <p style="color:#6b7280;font-size:12px;margin-bottom:16px;">Manage user support tickets</p>
                <div id="staffSupportTickets" class="staff-tickets-grid">
                    <div class="no-support-tickets">Loading tickets...</div>
                </div>
            </div>
        </div>
    </section>

    <!-- Discord Settings Modal -->
    <div class="staff-settings-modal" id="discordSettingsModal">
        <div class="staff-settings-content">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                <h3 style="margin:0;">Discord Settings</h3>
                <button class="modal-close" id="closeDiscordSettings"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
            </div>
            <div class="discord-settings-tabs" style="display:flex;gap:10px;margin-bottom:18px;">
                <button class="discord-settings-tab active" id="discordSettingsTabBtn">Settings</button>
                <button class="discord-settings-tab" id="charactersSettingsTabBtn">Characters</button>
            </div>
            <div class="discord-settings-panel" id="discordSettingsPanel">
                <div class="field">
                    <label>Discord Webhook URL</label>
                    <input type="text" id="discordWebhookUrl" placeholder="https://discord.com/api/webhooks/..." style="width:100%;padding:11px 13px;background:#0c0e12;border:1px solid #27272a;border-radius:8px;color:#fafafa;font-size:13px;">
                </div>
                <div class="field">
                    <label>Bot Token</label>
                    <input type="password" id="discordBotToken" placeholder="Enter bot token" style="width:100%;padding:11px 13px;background:#0c0e12;border:1px solid #27272a;border-radius:8px;color:#fafafa;font-size:13px;">
                </div>
                <div class="field">
                    <label>Server ID</label>
                    <input type="text" id="discordServerId" placeholder="Enter server ID" style="width:100%;padding:11px 13px;background:#0c0e12;border:1px solid #27272a;border-radius:8px;color:#fafafa;font-size:13px;">
                </div>
                <button class="btn-primary" id="saveDiscordSettings" style="margin-top:10px;">Save Settings</button>
            </div>
            <div class="discord-settings-panel" id="charactersSettingsPanel" style="display:none;max-height:400px;overflow-y:auto;">
                <h4 style="margin-bottom:10px;">Character Management</h4>
                <div class="characters-grid" id="adminCharactersGrid">
                    <!-- Character cards will be rendered here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Accounts Modal -->
    <div class="staff-settings-modal" id="accountsModal">
        <div class="staff-settings-content">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                <h3 style="margin:0;">Accounts</h3>
                <button class="modal-close" id="closeAccountsModal"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
            </div>
            <p style="color:#6b7280;margin-bottom:16px;">Manage user accounts and access.</p>
            <div id="accountsListContainer">
                <p style="color:#6b7280;text-align:center;">Loading accounts...</p>
            </div>
        </div>
    </div>

    <!-- Permissions Key Modal -->
    <div class="staff-settings-modal" id="permissionsKeyModal">
        <div class="staff-settings-content">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                <h3 style="margin:0;">Permissions Key</h3>
                <button class="modal-close" id="closePermissionsKeyModal"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
            </div>
            <div class="field">
                <label>Current Permissions Key</label>
                <div style="display:flex;gap:10px;">
                    <input type="text" id="permissionsKeyDisplay" readonly style="flex:1;padding:11px 13px;background:#0c0e12;border:1px solid #27272a;border-radius:8px;color:#fafafa;font-size:13px;">
                    <button class="btn-primary" id="copyPermissionsKey" style="padding:11px 16px;">Copy</button>
                </div>
            </div>
            <div class="field" style="margin-top:16px;">
                <label>Generate New Key</label>
                <button class="btn-primary" id="generateNewKey" style="background:#f59e0b;">Generate New Permissions Key</button>
            </div>
            <p style="color:#ef4444;font-size:12px;margin-top:12px;">Warning: Generating a new key will invalidate the old one.</p>
        </div>
    </div>

    <div id="maintenancePage" style="display:none;position:fixed;inset:0;background:#0c0e12;z-index:9999;align-items:center;justify-content:center;">
        <div style="text-align:center;padding:40px;">
            <img src="https://cdn.discordapp.com/icons/1455410644634304725/75220689ed872e2ee4c7101f479813a5.webp?size=512" alt="Pulsecad" style="width:80px;height:80px;border-radius:50%;margin-bottom:20px;">
            <h1 style="font-size:32px;font-weight:700;color:#e4e4e7;margin-bottom:12px;">Under Maintenance</h1>
            <p style="color:#6b7280;font-size:16px;">Pulsecad is currently undergoing maintenance. Please check back soon.</p>
        </div>
    </div>

    <section class="support-ticket-page" id="supportTicketPage">
        <div class="support-container">
            <div class="support-header">
                <h2>Support Tickets</h2>
                <button class="btn-back-community" id="backFromSupport">Back</button>
            </div>
            
            <div class="support-grid">
                <div class="my-tickets-list" id="myTicketsList">
                    <h3 style="font-size:16px;margin-bottom:16px;color:#a1a1aa;">Your Tickets</h3>
                    <div id="myTicketsContainer">
                        <div class="no-support-tickets">No support tickets yet.</div>
                    </div>
                </div>

                <div>
                    <div class="ticket-form-card" id="ticketFormCard">
                        <h3>Create a Support Ticket</h3>
                        <form id="supportTicketForm">
                            <div class="field">
                                <label>Email</label>
                                <input type="email" id="supportEmail" placeholder="Enter your email" required>
                            </div>
                            <div class="field">
                                <label>Username</label>
                                <input type="text" id="supportUsername" placeholder="Enter your username" required>
                            </div>
                            <div class="field">
                                <label>Reason</label>
                                <textarea id="supportReason" placeholder="Describe your issue or question..." rows="4" style="width:100%;padding:11px 13px;background:#0c0e12;border:1px solid #27272a;border-radius:8px;color:#fafafa;font-size:13px;font-family:inherit;resize:vertical;" required></textarea>
                            </div>
                            <button type="submit" class="btn-primary" style="margin-top:10px;">Create Ticket</button>
                        </form>
                    </div>

                    <div class="ticket-chat-container" id="ticketChatContainer">
                        <div class="ticket-chat-header">
                            <div>
                                <span class="ticket-id" id="activeTicketId">Ticket #0001</span>
                                <span style="color:#6b7280;font-size:12px;margin-left:10px;" id="activeTicketSubject"></span>
                            </div>
                            <span class="ticket-status open" id="activeTicketStatus">Open</span>
                        </div>
                        <div class="ticket-chat-messages" id="ticketChatMessages">
                        </div>
                        <div class="ticket-chat-input" id="ticketChatInputArea">
                            <input type="text" id="ticketMessageInput" placeholder="Type your message...">
                            <button id="sendTicketMessage">Send</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <div class="staff-chat-modal" id="staffChatModal">
        <div class="staff-chat-content">
            <div class="ticket-chat-header">
                <div>
                    <span class="ticket-id" id="staffActiveTicketId">Ticket #0001</span>
                    <span style="color:#6b7280;font-size:12px;margin-left:10px;" id="staffActiveTicketInfo"></span>
                </div>
                <button class="modal-close" id="closeStaffChat" style="position:static;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
            </div>
            <div class="ticket-chat-messages" id="staffChatMessages">
            </div>
            <div class="ticket-chat-input">
                <input type="text" id="staffMessageInput" placeholder="Type your response...">
                <button id="sendStaffMessage">Send</button>
            </div>
        </div>
    </div>

    <section class="civilian-page" id="civilianPage">
        <div class="civilian-toolbar">
            <button class="toolbar-btn green" id="newCharacterBtn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                New Character
            </button>
            <button class="toolbar-btn teal" id="editCharacterBtn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                Edit Character
            </button>
            <button class="toolbar-btn gray" id="recordsBtn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                Records
            </button>
            <div class="toolbar-divider"></div>
            <button class="toolbar-btn orange" id="dmvBtn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="3" width="15" height="13" rx="2"/><path d="M16 8h4a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2v-2"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg>
                DMV
            </button>
            <button class="toolbar-btn red" id="call911Btn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
                911
            </button>
        </div>
        <div class="civilian-content">
            <div class="civilian-header">
                <h2>Civilian Portal</h2>
                <button class="btn-back-community" id="backFromCivilian">Back to Community</button>
            </div>
            <div class="civilian-tabs">
                <button class="civilian-tab active" data-tab="characters">My Characters</button>
                <button class="civilian-tab" data-tab="tickets">My Tickets</button>
            </div>
            <div class="tab-content active" id="charactersTab">
                <div class="characters-grid" id="charactersGrid">
                    <div class="no-characters">No characters yet. Click "New Character" to create one.</div>
                </div>
            </div>
            <div class="tab-content" id="ticketsTab">
                <div id="ticketsList">
                    <div class="no-tickets">No tickets issued to your characters.</div>
                </div>
            </div>
        </div>
    </section>

    <div class="overlay" id="newCharacterModal">
        <div class="modal" style="max-width:450px;">
            <button class="modal-close" id="closeNewCharacter"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
            <h2>New Character</h2>
            <p class="sub">Create a new civilian character</p>
            <form id="newCharacterForm">
                <div class="field">
                    <label>First Name</label>
                    <input type="text" id="charFirstName" placeholder="Enter first name" required>
                </div>
                <div class="field">
                    <label>Last Name</label>
                    <input type="text" id="charLastName" placeholder="Enter last name" required>
                </div>
                <div class="field">
                    <label>Date of Birth</label>
                    <input type="date" id="charDob" required>
                </div>
                <div class="field">
                    <label>Gender</label>
                    <select id="charGender" style="width:100%;padding:11px 13px;background:#0c0e12;border:1px solid #27272a;border-radius:8px;color:#fafafa;font-size:13px;font-family:inherit;">
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="field">
                    <label>Phone Number</label>
                    <input type="text" id="charPhone" placeholder="e.g. 555-1234">
                </div>
                <div class="modal-btns">
                    <button type="button" class="btn-cancel" id="cancelNewCharacter">Cancel</button>
                    <button type="submit" class="btn-confirm">Create</button>
                </div>
            </form>
        </div>
    </div>

    <div class="overlay" id="call911Modal">
        <div class="modal modal-sm">
            <button class="modal-close" id="closeCall911"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
            <h2 style="color:#ef4444;">Emergency 911 Call</h2>
            <form id="call911Form">
                <div class="field">
                    <label>Location</label>
                    <input type="text" id="emergency911Location" placeholder="Where is the emergency?" required>
                </div>
                <div class="field">
                    <label>Description</label>
                    <textarea id="emergency911Desc" placeholder="Describe the emergency..." rows="4" style="width:100%;padding:11px 13px;background:#0c0e12;border:1px solid #27272a;border-radius:8px;color:#fafafa;font-size:13px;font-family:inherit;resize:vertical;"></textarea>
                </div>
                <div class="modal-btns">
                    <button type="button" class="btn-cancel" id="cancelCall911">Cancel</button>
                    <button type="submit" class="btn-confirm" style="background:#ef4444;">Call 911</button>
                </div>
            </form>
        </div>
    </div>

    <div class="overlay" id="lookupModal">
        <div class="modal" style="max-width:500px;">
            <button class="modal-close" id="closeLookup"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
            <h2>Civilian Lookup</h2>
            <p class="sub">Search for civilian records</p>
            <div style="display:flex;gap:10px;">
                <div class="field" style="flex:1;">
                    <label>First Name</label>
                    <input type="text" id="lookupFirstName" placeholder="First name">
                </div>
                <div class="field" style="flex:1;">
                    <label>Last Name</label>
                    <input type="text" id="lookupLastName" placeholder="Last name">
                </div>
            </div>
            <button type="button" class="btn-primary" id="lookupSearchBtn" style="width:100%;margin-top:10px;">Search</button>
            <div id="lookupResults" style="margin-top:20px;">
                <div class="section-label">Results</div>
                <div id="lookupResultsList" style="max-height:300px;overflow-y:auto;"></div>
            </div>
        </div>
    </div>

    <div class="overlay" id="ticketModal">
        <div class="modal" style="max-width:500px;">
            <button class="modal-close" id="closeTicket"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
            <h2 style="color:#f97316;">Issue Citation/Ticket</h2>
            <p class="sub">Issue a ticket to: <span id="ticketCivilianName" style="color:#e4e4e7;font-weight:600;"></span></p>
            <form id="ticketForm">
                <input type="hidden" id="ticketCivilianId">
                <div class="field">
                    <label>Ticket Type</label>
                    <select id="ticketType" style="width:100%;padding:11px 13px;background:#0c0e12;border:1px solid #27272a;border-radius:8px;color:#fafafa;font-size:13px;font-family:inherit;">
                        <option value="Speeding">Speeding</option>
                        <option value="Reckless Driving">Reckless Driving</option>
                        <option value="Running Red Light">Running Red Light</option>
                        <option value="Illegal Parking">Illegal Parking</option>
                        <option value="Failure to Yield">Failure to Yield</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="field">
                    <label>Location</label>
                    <input type="text" id="ticketLocation" placeholder="Location of offense" required>
                </div>
                <div class="field">
                    <label>Fine Amount ($)</label>
                    <input type="number" id="ticketFine" placeholder="e.g. 150" required>
                </div>
                <div class="field">
                    <label>Charges</label>
                    <div class="charges-list" id="chargesList">
                        <div class="charge-item">
                            <input type="text" class="charge-input" placeholder="Enter charge (e.g. 10+ MPH over limit)">
                            <button type="button" class="btn-remove-charge" onclick="this.parentElement.remove()"></button>
                        </div>
                    </div>
                    <button type="button" class="btn-add-charge" id="addChargeBtn">+ Add Charge</button>
                </div>
                <div class="field">
                    <label>Notes</label>
                    <textarea id="ticketNotes" placeholder="Additional notes..." rows="2" style="width:100%;padding:11px 13px;background:#0c0e12;border:1px solid #27272a;border-radius:8px;color:#fafafa;font-size:13px;font-family:inherit;resize:vertical;"></textarea>
                </div>
                <div class="field">
                    <label>Officer E-Signature</label>
                    <canvas id="signaturePad" class="signature-pad"></canvas>
                    <div class="signature-actions">
                        <button type="button" class="btn-clear-sig" id="clearSignature">Clear Signature</button>
                    </div>
                </div>
                <div class="modal-btns">
                    <button type="button" class="btn-cancel" id="cancelTicket">Cancel</button>
                    <button type="submit" class="btn-confirm" style="background:#f97316;">Issue Ticket</button>
                </div>
            </form>
        </div>
    </div>

    <div class="overlay" id="createCallModal">
        <div class="modal modal-sm">
            <button class="modal-close" id="closeCreateCall"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
            <h2>Create Call</h2>
            <form id="createCallForm">
                <div class="field">
                    <label>Call Number</label>
                    <input type="text" id="callNumber" readonly style="background:#1e293b;color:#6b7280;">
                </div>
                <div class="field">
                    <label>Call Type</label>
                    <input type="text" id="callType" placeholder="e.g. Traffic Stop, Domestic" required>
                </div>
                <div class="field">
                    <label>Location</label>
                    <input type="text" id="callLocation" placeholder="Enter location" required>
                </div>
                <div class="field">
                    <label>Postal</label>
                    <input type="text" id="callPostal" placeholder="Enter postal code" required>
                </div>
                <div class="modal-btns">
                    <button type="button" class="btn-cancel" id="cancelCreateCall">Cancel</button>
                    <button type="submit" class="btn-confirm">Create</button>
                </div>
            </form>
        </div>
    </div>

    <div class="overlay" id="createBoloModal">
        <div class="modal modal-sm">
            <button class="modal-close" id="closeCreateBolo"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
            <h2 style="color:#f59e0b;">Create BOLO</h2>
            <p class="sub">Be On the Lookout</p>
            <form id="createBoloForm">
                <div class="field">
                    <label>Type</label>
                    <select id="boloType" style="width:100%;padding:11px 13px;background:#0c0e12;border:1px solid #27272a;border-radius:8px;color:#fafafa;font-size:13px;font-family:inherit;">
                        <option value="Person">Person</option>
                        <option value="Vehicle">Vehicle</option>
                    </select>
                </div>
                <div class="field">
                    <label>Details</label>
                    <textarea id="boloDetails" placeholder="Enter BOLO details (description, plate, clothing, etc.)" rows="4" style="width:100%;padding:11px 13px;background:#0c0e12;border:1px solid #27272a;border-radius:8px;color:#fafafa;font-size:13px;font-family:inherit;resize:vertical;" required></textarea>
                </div>
                <div class="modal-btns">
                    <button type="button" class="btn-cancel" id="cancelCreateBolo">Cancel</button>
                    <button type="submit" class="btn-confirm" style="background:#f59e0b;">Create BOLO</button>
                </div>
            </form>
        </div>
    </div>

    <section class="police-mdt" id="policeMdt">
        <div class="mdt-header">
            <h2>Police MDT</h2>
            <button class="btn-off-duty" id="offDutyBtn">Go Off Duty</button>
        </div>
        <div class="mdt-grid">
            <div class="mdt-panel">
                <h3>Officer Information</h3>
                <div class="officer-timer" id="dutyTimer">00:00:00</div>
                <div class="officer-info-item">
                    <div class="label">Identifier</div>
                    <div class="value" id="mdtCallsign">1B-01</div>
                </div>
                <div class="officer-info-item">
                    <div class="label">Department</div>
                    <div class="value" id="mdtDepartment">BCSO</div>
                </div>
                <div class="officer-info-item">
                    <div class="label">Status</div>
                    <div class="value"><span class="status-badge status-10-8" id="currentStatus">10-8</span></div>
                </div>
                <div class="officer-info-item">
                    <div class="label">Subdivision</div>
                    <div class="value" id="mdtSubdivision">None</div>
                </div>
            </div>
            <div class="mdt-panel">
                <h3>Control Panel</h3>
                <div class="control-section">
                    <div class="section-label">Status Controls</div>
                    <div class="status-buttons">
                        <button class="status-btn green" data-status="10-8">10-8 | In Service</button>
                        <button class="status-btn red" data-status="10-7">10-7 | Out of Service</button>
                    </div>
                </div>
                <div class="control-section">
                    <div class="status-buttons">
                        <button class="status-btn yellow" data-status="10-6">10-6 | Busy</button>
                        <button class="status-btn yellow" data-status="10-6">10-6 | Busy / Unavailable</button>
                        <button class="status-btn blue" data-status="10-11">10-11 | Traffic Stop</button>
                        <button class="status-btn blue" data-status="10-15">10-15 | Subject in Custody</button>
                        <button class="status-btn blue" data-status="10-23">10-23 | Arrived on Scene</button>
                    </div>
                </div>
                <div class="control-section">
                    <div class="status-buttons">
                        <button class="status-btn orange" data-status="10-26">10-26 | Detaining Subject</button>
                        <button class="status-btn orange" data-status="10-45">10-45 | Meal Break</button>
                        <button class="status-btn orange" data-status="10-97">10-97 | En Route to Scene</button>
                    </div>
                </div>
                <div class="control-section">
                    <div class="status-buttons">
                        <button class="status-btn red" data-status="10-99">10-99 | Emergency</button>
                        <button class="status-btn purple" data-status="Signal 11">Signal 11 | Running Radar</button>
                        <button class="status-btn purple" data-status="Signal 7">Signal 7 | Investigation</button>
                        <button class="status-btn red" data-status="PANIC">Panic Button</button>
                    </div>
                </div>
                <div class="control-section">
                    <div class="section-label">Quick Actions</div>
                    <div class="quick-actions">
                        <button class="quick-btn">10 Codes</button>
                        <button class="quick-btn">Notepad</button>
                        <button class="quick-btn">Select Subdivision</button>
                        <button class="quick-btn" id="createBoloBtn">Create Bolo</button>
                        <button class="quick-btn" id="createCallBtn">Create Call</button>
                        <button class="quick-btn" id="lookupBtn">Lookup</button>
                    </div>
                </div>
            </div>
            <div class="mdt-panel">
                <h3>Live Chat</h3>
                <div class="chat-messages" id="chatMessages">
                    <div class="chat-message"><span class="time">10:41 AM</span> <span class="text">test</span></div>
                </div>
                <div class="chat-input-wrap">
                    <input type="text" class="chat-input" id="chatInput" placeholder="Type a message...">
                    <button class="chat-send" id="chatSend">Send</button>
                </div>
            </div>
        </div>
        <div class="mdt-bottom-grid">
            <div class="mdt-panel">
                <h3>Active Units</h3>
                <table class="calls-table">
                    <thead>
                        <tr>
                            <th>Callsign</th>
                            <th>Name</th>
                            <th>Status</th>
                            <th>Subdivision</th>
                        </tr>
                    </thead>
                    <tbody id="activeUnitsTableBody">
                        
                    </tbody>
                </table>
            </div>
            <div class="mdt-panel">
                <h3>Your Calls</h3>
                <table class="calls-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Type</th>
                            <th>Location</th>
                            <th>Postal</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="callsTableBody">
                        
                    </tbody>
                </table>
            </div>
            <div class="mdt-panel">
                <h3>Active Bolos</h3>
                <table class="bolos-table">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Details</th>
                            <th>Date & Time</th>
                            <th>Issued By</th>
                        </tr>
                    </thead>
                    <tbody id="bolosTableBody">
                        
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <script>
        const SUPABASE_URL = 'https://lfyooplqmyrqebefiomf.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxmeW9vcGxxbXlycWViZWZpb21mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2NjY2NjUsImV4cCI6MjA4MzI0MjY2NX0.j7ORtHhF2qWSJEhURXd2891JKUP9umijCo3SaDHTmGA';
        const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Maintenance mode disabled
        async function checkMaintenanceMode() {
            // Disabled
        }
        checkMaintenanceMode();

        const body = document.body;
        const authModal = document.getElementById('authModal');
        const createModal = document.getElementById('createModal');
        const loginPanel = document.getElementById('loginPanel');
        const registerPanel = document.getElementById('registerPanel');
        const openLogin = document.getElementById('openLogin');
        const closeAuth = document.getElementById('closeAuth');
        const showRegister = document.getElementById('showRegister');
        const showLogin = document.getElementById('showLogin');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const loginError = document.getElementById('loginError');
        const loginSuccess = document.getElementById('loginSuccess');
        const registerError = document.getElementById('registerError');
        const navUsername = document.getElementById('navUsername');
        const logoutBtn = document.getElementById('logoutBtn');
        const createCommunityBtn = document.getElementById('createCommunity');
        const cancelCreate = document.getElementById('cancelCreate');
        const createCommunityForm = document.getElementById('createCommunityForm');
        const communityList = document.getElementById('communityList');
        const joinModal = document.getElementById('joinModal');
        const joinCommunityBtn = document.getElementById('joinCommunity');
        const cancelJoin = document.getElementById('cancelJoin');
        const joinCommunityForm = document.getElementById('joinCommunityForm');
        const joinError = document.getElementById('joinError');
        const communityScreen = document.getElementById('communityScreen');
        const communityViewName = document.getElementById('communityViewName');
        const communityViewCode = document.getElementById('communityViewCode');
        const dashboardSection = document.getElementById('dashboardSection');

        let currentUser = null;

        const homeBtn = document.getElementById('homeBtn');
        const pricesBtn = document.getElementById('pricesBtn');
        const pricingSection = document.getElementById('pricingSection');
        const heroSection = document.getElementById('heroSection');
        const backFromPricing = document.getElementById('backFromPricing');
        const teamBtn = document.getElementById('teamBtn');
        const teamSection = document.getElementById('teamSection');
        const backFromTeam = document.getElementById('backFromTeam');

        homeBtn.onclick = () => {
            pricingSection.classList.remove('active');
            teamSection.classList.remove('active');
            heroSection.style.display = 'flex';
        };

        pricesBtn.onclick = () => {
            pricingSection.classList.add('active');
            teamSection.classList.remove('active');
            heroSection.style.display = 'none';
        };

        backFromPricing.onclick = () => {
            pricingSection.classList.remove('active');
            heroSection.style.display = 'flex';
        };

        teamBtn.onclick = () => {
            teamSection.classList.add('active');
            pricingSection.classList.remove('active');
            heroSection.style.display = 'none';
        };

        backFromTeam.onclick = () => {
            teamSection.classList.remove('active');
            heroSection.style.display = 'flex';
        };

        async function loadCommunities() {
            if (!currentUser) {
                communityList.innerHTML = '<div class="empty">No communities yet</div>';
                return;
            }
            
            const { data: owned, error: ownedError } = await db
                .from('communities')
                .select('*')
                .eq('owner_id', currentUser.id);
            
            if (ownedError) console.error('Error loading owned communities:', ownedError);
            
            const { data: memberOf, error: memberError } = await db
                .from('community_members')
                .select('community_id, communities(id, name, website, code, owner_id)')
                .eq('user_id', currentUser.id);
            
            if (memberError) console.error('Error loading joined communities:', memberError);
            
            const ownedCommunities = (owned || []).map(c => ({ ...c, type: 'owned' }));
            const joinedCommunities = (memberOf || [])
                .filter(m => m.communities)
                .map(m => ({ ...m.communities, type: 'joined' }));
            
            const all = [...ownedCommunities, ...joinedCommunities];
            
            if (all.length === 0) {
                communityList.innerHTML = '<div class="empty">No communities yet</div>';
                return;
            }
            
            communityList.innerHTML = all.map(c => `
                <div class="item" data-id="${c.id}" data-type="${c.type}">
                    <div class="item-info">
                        <div class="item-name">${c.name} <span style="color:#52525b;font-size:11px;">${c.type === 'owned' ? '(Owner)' : '(Member)'}</span></div>
                        ${c.website ? `<a href="${c.website}" target="_blank" class="item-url">${c.website}</a>` : ''}
                        <div style="color:#52525b;font-size:11px;margin-top:4px;">Code: ${c.code}</div>
                    </div>
                    <button class="btn-enter" data-id="${c.id}" data-name="${c.name}" data-code="${c.code}" data-website="${c.website || ''}">Enter</button>
                </div>
            `).join('');

            document.querySelectorAll('.btn-enter').forEach(btn => {
                btn.onclick = () => openCommunity(btn.dataset.id, btn.dataset.name, btn.dataset.code, btn.dataset.website);
            });
        }

        function openCommunity(id, name, code, website) {
            currentCommunityId = id;
            communityViewName.textContent = name;
            communityViewCode.textContent = 'Code: ' + code;
            dashboardSection.classList.add('hidden');
            communityScreen.classList.add('active');
            body.classList.add('in-community');
        }

        let currentCommunityId = null;

        const backToDashboard = document.getElementById('backToDashboard');
        backToDashboard.onclick = () => {
            communityScreen.classList.remove('active');
            dashboardSection.classList.remove('hidden');
            body.classList.remove('in-community');
        };

        openLogin.onclick = () => authModal.classList.add('active');
        closeAuth.onclick = () => { authModal.classList.remove('active'); resetAuthForms(); };
        authModal.onclick = e => { if (e.target === authModal) { authModal.classList.remove('active'); resetAuthForms(); } };

        function resetAuthForms() {
            loginForm.reset(); registerForm.reset();
            loginError.style.display = 'none'; loginSuccess.style.display = 'none'; registerError.style.display = 'none';
            loginPanel.classList.add('active'); registerPanel.classList.remove('active');
        }

        showRegister.onclick = () => { loginPanel.classList.remove('active'); registerPanel.classList.add('active'); loginError.style.display = 'none'; loginSuccess.style.display = 'none'; };
        showLogin.onclick = () => { registerPanel.classList.remove('active'); loginPanel.classList.add('active'); registerError.style.display = 'none'; };

        createCommunityBtn.onclick = () => createModal.classList.add('active');
        cancelCreate.onclick = () => { createModal.classList.remove('active'); createCommunityForm.reset(); };
        createModal.onclick = e => { if (e.target === createModal) { createModal.classList.remove('active'); createCommunityForm.reset(); } };

        createCommunityForm.onsubmit = async e => {
            e.preventDefault();
            const name = document.getElementById('communityName').value.trim();
            const website = document.getElementById('communityWebsite').value.trim();
            const code = Math.random().toString(36).substr(2, 8).toUpperCase();
            
            const { data, error } = await db
                .from('communities')
                .insert([{ name, website, code, owner_id: currentUser.id }])
                .select();
            
            if (error) {
                alert('Error creating community: ' + error.message);
                return;
            }
            
            createModal.classList.remove('active');
            createCommunityForm.reset();
            loadCommunities();
        };

        joinCommunityBtn.onclick = () => joinModal.classList.add('active');
        cancelJoin.onclick = () => { joinModal.classList.remove('active'); joinCommunityForm.reset(); joinError.style.display = 'none'; };
        joinModal.onclick = e => { if (e.target === joinModal) { joinModal.classList.remove('active'); joinCommunityForm.reset(); joinError.style.display = 'none'; } };

        joinCommunityForm.onsubmit = async e => {
            e.preventDefault();
            const code = document.getElementById('joinCode').value.trim().toUpperCase();
            
            const { data: community, error: findError } = await db
                .from('communities')
                .select('*')
                .eq('code', code)
                .single();
            
            if (findError || !community) {
                joinError.textContent = 'Community not found';
                joinError.style.display = 'block';
                return;
            }
            
            if (community.owner_id === currentUser.id) {
                joinError.textContent = 'You already own this community';
                joinError.style.display = 'block';
                return;
            }
            
            const { data: existing } = await db
                .from('community_members')
                .select('*')
                .eq('community_id', community.id)
                .eq('user_id', currentUser.id)
                .single();
            
            if (existing) {
                joinError.textContent = 'Already a member of this community';
                joinError.style.display = 'block';
                return;
            }
            
            const { error: joinErr } = await db
                .from('community_members')
                .insert([{ community_id: community.id, user_id: currentUser.id }]);
            
            if (joinErr) {
                joinError.textContent = 'Error joining community: ' + joinErr.message;
                joinError.style.display = 'block';
                return;
            }
            
            joinModal.classList.remove('active');
            joinCommunityForm.reset();
            joinError.style.display = 'none';
            loadCommunities();
        };

        registerForm.onsubmit = async e => {
            e.preventDefault();
            const username = document.getElementById('regUsername').value.trim();
            const password = document.getElementById('regPassword').value;
            const confirm = document.getElementById('regConfirm').value;

            if (password !== confirm) { registerError.textContent = 'Passwords do not match'; registerError.style.display = 'block'; return; }
            if (password.length < 6) { registerError.textContent = 'Password must be at least 6 characters'; registerError.style.display = 'block'; return; }

            const { data: existing } = await db
                .from('users')
                .select('id')
                .eq('username', username.toLowerCase())
                .single();
            
            if (existing) {
                registerError.textContent = 'Username already exists';
                registerError.style.display = 'block';
                return;
            }

            const { data, error } = await db
                .from('users')
                .insert([{ username: username.toLowerCase(), display_name: username, password }])
                .select()
                .single();

            if (error) {
                registerError.textContent = error.message;
                registerError.style.display = 'block';
                return;
            }

            registerForm.reset();
            registerPanel.classList.remove('active');
            loginPanel.classList.add('active');
            loginSuccess.textContent = 'Account created. Please log in.';
            loginSuccess.style.display = 'block';
        };

        loginForm.onsubmit = async e => {
            e.preventDefault();
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            const { data: user, error } = await db
                .from('users')
                .select('*')
                .eq('username', username.toLowerCase())
                .eq('password', password)
                .single();

            if (error || !user) {
                loginError.textContent = 'Invalid username or password';
                loginError.style.display = 'block';
                loginSuccess.style.display = 'none';
                return;
            }

            currentUser = user;
            body.classList.add('logged-in');
            navUsername.textContent = user.display_name;
            authModal.classList.remove('active');
            resetAuthForms();
            loadCommunities();

            const staffBtn = document.getElementById('staffDashboardBtn');
            console.log('Logged in user:', user.username, user.display_name);
            
            // Check if user has staff access (hardcoded 'rya' OR in staff_access table)
            const isHardcodedStaff = user.display_name.toLowerCase().includes('rya') || user.username.toLowerCase().includes('rya');
            
            const { data: staffAccess } = await db
                .from('staff_access')
                .select('*')
                .eq('user_id', user.id)
                .single();
            
            const isStaff = isHardcodedStaff || !!staffAccess;
            
            if (isStaff) {
                staffBtn.style.display = 'flex';
            } else {
                staffBtn.style.display = 'none';
            }
        };

        logoutBtn.onclick = async () => {
            await db.auth.signOut();
            currentUser = null;
            body.classList.remove('logged-in');
            navUsername.textContent = '';
            document.getElementById('staffDashboardBtn').style.display = 'none';
        };

        // Check for OAuth callback and existing session on page load
        async function checkAuthSession() {
            const { data: { session } } = await db.auth.getSession();
            
            if (session && session.user) {
                const discordUser = session.user;
                const discordName = discordUser.user_metadata?.full_name || discordUser.user_metadata?.name || discordUser.email?.split('@')[0] || 'Discord User';
                const discordUsername = (discordUser.user_metadata?.preferred_username || discordName).toLowerCase().replace(/\s+/g, '_');
                
                // Check if user exists in our users table
                let { data: existingUser } = await db
                    .from('users')
                    .select('*')
                    .eq('discord_id', discordUser.id)
                    .single();
                
                if (!existingUser) {
                    // Create user in our table
                    const { data: newUser, error: createError } = await db
                        .from('users')
                        .insert([{
                            username: discordUsername,
                            display_name: discordName,
                            password: 'discord_oauth',
                            discord_id: discordUser.id,
                            discord_avatar: discordUser.user_metadata?.avatar_url
                        }])
                        .select()
                        .single();
                    
                    if (createError) {
                        console.error('Error creating Discord user:', createError);
                        return;
                    }
                    existingUser = newUser;
                }
                
                // Log in the user
                currentUser = existingUser;
                body.classList.add('logged-in');
                navUsername.textContent = existingUser.display_name;
                authModal.classList.remove('active');
                loadCommunities();
                
                // Check staff access
                const staffBtn = document.getElementById('staffDashboardBtn');
                const isHardcodedStaff = existingUser.display_name.toLowerCase().includes('rya') || existingUser.username.toLowerCase().includes('rya');
                const { data: staffAccess } = await db
                    .from('staff_access')
                    .select('*')
                    .eq('user_id', existingUser.id)
                    .single();
                const isStaff = isHardcodedStaff || !!staffAccess;
                staffBtn.style.display = isStaff ? 'flex' : 'none';
            }
        }
        
        checkAuthSession();

        const policeBtn = document.getElementById('policeBtn');
        const policeLoginModal = document.getElementById('policeLoginModal');
        const closePoliceLogin = document.getElementById('closePoliceLogin');
        const policeLoginForm = document.getElementById('policeLoginForm');
        const policeMdt = document.getElementById('policeMdt');
        const offDutyBtn = document.getElementById('offDutyBtn');
        const dutyTimer = document.getElementById('dutyTimer');
        const mdtCallsign = document.getElementById('mdtCallsign');
        const currentStatusBadge = document.getElementById('currentStatus');
        const chatInput = document.getElementById('chatInput');
        const chatSend = document.getElementById('chatSend');
        const chatMessages = document.getElementById('chatMessages');

        let dutyStartTime = null;
        let timerInterval = null;
        let activeUnits = [];
        const activeUnitsTableBody = document.getElementById('activeUnitsTableBody');

        function renderActiveUnits() {
            if (activeUnits.length === 0) {
                activeUnitsTableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#6b7280;">No active units</td></tr>';
                return;
            }
            activeUnitsTableBody.innerHTML = activeUnits.map(u => `
                <tr>
                    <td><span style="padding:4px 8px;background:#3b82f6;border-radius:4px;font-size:11px;color:#fff;">${u.callsign}</span></td>
                    <td>${u.name}</td>
                    <td><span class="status-badge status-${u.status.replace(/\s+/g, '-').toLowerCase()}">${u.status}</span></td>
                    <td>${u.subdivision || 'None'}</td>
                </tr>
            `).join('');
        }

        policeBtn.onclick = () => policeLoginModal.classList.add('active');
        closePoliceLogin.onclick = () => { policeLoginModal.classList.remove('active'); policeLoginForm.reset(); };
        policeLoginModal.onclick = e => { if (e.target === policeLoginModal) { policeLoginModal.classList.remove('active'); policeLoginForm.reset(); } };

        const mdtDepartment = document.getElementById('mdtDepartment');

        let currentOfficer = null;

        policeLoginForm.onsubmit = e => {
            e.preventDefault();
            const name = document.getElementById('officerName').value.trim();
            const callsign = document.getElementById('officerCallsign').value.trim();
            const rank = document.getElementById('officerRank').value.trim();
            
            mdtCallsign.textContent = callsign;
            
            currentOfficer = {
                id: Date.now(),
                name: name,
                callsign: callsign,
                rank: rank,
                status: '10-8',
                subdivision: 'None'
            };
            
            activeUnits.push(currentOfficer);
            renderActiveUnits();
            
            policeLoginModal.classList.remove('active');
            policeLoginForm.reset();
            communityScreen.classList.remove('active');
            policeMdt.classList.add('active');
            
            dutyStartTime = Date.now();
            timerInterval = setInterval(updateTimer, 1000);
            updateTimer();
        };

        function updateTimer() {
            const elapsed = Math.floor((Date.now() - dutyStartTime) / 1000);
            const hours = String(Math.floor(elapsed / 3600)).padStart(2, '0');
            const minutes = String(Math.floor((elapsed % 3600) / 60)).padStart(2, '0');
            const seconds = String(elapsed % 60).padStart(2, '0');
            dutyTimer.textContent = `${hours}:${minutes}:${seconds}`;
        }

        offDutyBtn.onclick = () => {
            clearInterval(timerInterval);
            timerInterval = null;
            dutyStartTime = null;
            dutyTimer.textContent = '00:00:00';
            
            if (currentOfficer) {
                activeUnits = activeUnits.filter(u => u.id !== currentOfficer.id);
                renderActiveUnits();
                currentOfficer = null;
            }
            
            policeMdt.classList.remove('active');
            communityScreen.classList.add('active');
        };

        // Tones Context Menu
        const tonesContextMenu = document.getElementById('tonesContextMenu');
        
        policeMdt.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            tonesContextMenu.style.left = e.clientX + 'px';
            tonesContextMenu.style.top = e.clientY + 'px';
            tonesContextMenu.classList.add('active');
        });

        document.addEventListener('click', () => {
            tonesContextMenu.classList.remove('active');
        });

        document.querySelectorAll('.tone-item').forEach(item => {
            item.onclick = () => {
                const tone = item.dataset.tone;
                const toneNames = { '1': 'Priority', '2': 'Alert', '3': 'Routine' };
                alert(`Tone ${tone} - ${toneNames[tone]} activated!`);
                tonesContextMenu.classList.remove('active');
            };
        });

        document.querySelectorAll('.status-btn[data-status]').forEach(btn => {
            btn.onclick = () => {
                const status = btn.dataset.status;
                currentStatusBadge.textContent = status;
                
                let statusClass = 'status-badge ';
                if (status === '10-8') statusClass += 'status-10-8';
                else if (status === '10-7') statusClass += 'status-10-7';
                else if (status === '10-6') statusClass += 'status-10-6';
                else if (status === '10-11') statusClass += 'status-10-11';
                else if (status === '10-15') statusClass += 'status-10-15';
                else if (status === '10-23') statusClass += 'status-10-23';
                else if (status === '10-26') statusClass += 'status-10-26';
                else if (status === '10-45') statusClass += 'status-10-45';
                else if (status === '10-97') statusClass += 'status-10-97';
                else if (status === '10-99') statusClass += 'status-10-99';
                else if (status.startsWith('Signal')) statusClass += 'status-signal';
                else if (status === 'PANIC') statusClass += 'status-panic';
                else statusClass += 'status-10-7';
                
                currentStatusBadge.className = statusClass;
                
                if (currentOfficer) {
                    currentOfficer.status = status;
                    renderActiveUnits();
                }
            };
        });

        chatSend.onclick = () => {
            const msg = chatInput.value.trim();
            if (!msg) return;
            const now = new Date();
            const time = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            const callsign = mdtCallsign.textContent;
            const msgEl = document.createElement('div');
            msgEl.className = 'chat-message';
            msgEl.innerHTML = `<span class="time">${time}</span> <span class="sender">${callsign}</span> <span class="text">${msg}</span>`;
            chatMessages.appendChild(msgEl);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            chatInput.value = '';
        };

        chatInput.onkeypress = e => { if (e.key === 'Enter') chatSend.onclick(); };

        const createCallBtn = document.getElementById('createCallBtn');
        const createCallModal = document.getElementById('createCallModal');
        const closeCreateCall = document.getElementById('closeCreateCall');
        const cancelCreateCall = document.getElementById('cancelCreateCall');
        const createCallForm = document.getElementById('createCallForm');
        const callNumberInput = document.getElementById('callNumber');
        const callsTableBody = document.getElementById('callsTableBody');

        let callCounter = 1;

        function generateCallNumber() {
            const prefix = 'CALL';
            const num = String(callCounter).padStart(4, '0');
            const rand = Math.random().toString(36).substring(2, 6).toUpperCase();
            return `${prefix}-${num}-${rand}`;
        }

        createCallBtn.onclick = () => {
            callNumberInput.value = generateCallNumber();
            createCallModal.classList.add('active');
        };

        closeCreateCall.onclick = () => { createCallModal.classList.remove('active'); createCallForm.reset(); };
        cancelCreateCall.onclick = () => { createCallModal.classList.remove('active'); createCallForm.reset(); };
        createCallModal.onclick = e => { if (e.target === createCallModal) { createCallModal.classList.remove('active'); createCallForm.reset(); } };

        createCallForm.onsubmit = e => {
            e.preventDefault();
            const callNum = callNumberInput.value;
            const type = document.getElementById('callType').value.trim();
            const location = document.getElementById('callLocation').value.trim();
            const postal = document.getElementById('callPostal').value.trim();

            const existingEmpty = callsTableBody.querySelector('td');
            if (existingEmpty && existingEmpty.textContent === '1') {
                callsTableBody.innerHTML = '';
            }

            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${callCounter}</td>
                <td>${type}</td>
                <td>${location}</td>
                <td>${postal}</td>
                <td>
                    <button class="btn-details">View Details</button>
                    <button class="btn-delete" style="margin-left:8px;background:#ef4444;border:none;color:#fff;padding:6px 14px;border-radius:4px;font-size:11px;font-weight:500;cursor:pointer;">Delete</button>
                </td>
            `;
            // Add delete functionality
            row.querySelector('.btn-delete').onclick = function() {
                row.remove();
            };
            callsTableBody.appendChild(row);
            callCounter++;

            createCallModal.classList.remove('active');
            createCallForm.reset();
        };

        const lookupBtn = document.getElementById('lookupBtn');
        const lookupModal = document.getElementById('lookupModal');
        const closeLookup = document.getElementById('closeLookup');
        const lookupFirstName = document.getElementById('lookupFirstName');
        const lookupLastName = document.getElementById('lookupLastName');
        const lookupSearchBtn = document.getElementById('lookupSearchBtn');
        const lookupResultsList = document.getElementById('lookupResultsList');

        lookupBtn.onclick = () => {
            lookupResultsList.innerHTML = '<div class="lookup-empty">Enter a name to search</div>';
            lookupFirstName.value = '';
            lookupLastName.value = '';
            lookupModal.classList.add('active');
        };

        closeLookup.onclick = () => lookupModal.classList.remove('active');
        lookupModal.onclick = e => { if (e.target === lookupModal) lookupModal.classList.remove('active'); };

        lookupSearchBtn.onclick = async () => {
            const firstName = lookupFirstName.value.trim().toLowerCase();
            const lastName = lookupLastName.value.trim().toLowerCase();
            
            if (!firstName && !lastName) {
                lookupResultsList.innerHTML = '<div class="lookup-empty">Enter a first or last name to search</div>';
                return;
            }

            lookupResultsList.innerHTML = '<div class="lookup-empty">Searching...</div>';

            const { data: allChars, error } = await db
                .from('characters')
                .select('*')
                .eq('community_id', currentCommunityId);

            console.log('All characters from DB:', allChars);
            console.log('Error:', error);

            if (error) {
                lookupResultsList.innerHTML = '<div class="lookup-empty">Error: ' + error.message + '</div>';
                console.error(error);
                return;
            }

            if (!allChars || allChars.length === 0) {
                lookupResultsList.innerHTML = '<div class="lookup-empty">No civilians in database</div>';
                return;
            }

            const results = allChars.filter(c => {
                const matchFirst = !firstName || c.first_name.toLowerCase().includes(firstName);
                const matchLast = !lastName || c.last_name.toLowerCase().includes(lastName);
                return matchFirst && matchLast;
            });

            console.log('Filtered results:', results);

            if (results.length === 0) {
                lookupResultsList.innerHTML = '<div class="lookup-empty">No civilians found</div>';
                return;
            }

            // Fetch tickets for all matching civilians in this community
            const civilianIds = results.map(c => c.id);
            const { data: allTickets } = await db
                .from('tickets')
                .select('*')
                .in('civilian_id', civilianIds)
                .eq('community_id', currentCommunityId)
                .order('issued_at', { ascending: false });

            const ticketsByCivilian = {};
            (allTickets || []).forEach(t => {
                if (!ticketsByCivilian[t.civilian_id]) ticketsByCivilian[t.civilian_id] = [];
                ticketsByCivilian[t.civilian_id].push(t);
            });

            lookupResultsList.innerHTML = results.map(c => {
                const civTickets = ticketsByCivilian[c.id] || [];
                const ticketCount = civTickets.length;
                const totalFines = civTickets.reduce((sum, t) => sum + (t.fine || 0), 0);
                
                return `
                <div class="lookup-result">
                    <div class="name">${c.first_name} ${c.last_name}</div>
                    <div class="info">
                        <span><strong>DOB:</strong> ${c.date_of_birth}</span>
                        <span><strong>Gender:</strong> ${c.gender}</span>
                        <span><strong>Phone:</strong> ${c.phone || 'N/A'}</span>
                        <span><strong>License:</strong> ${c.license_status || 'Valid'}</span>
                    </div>
                    <div class="lookup-tickets-summary" style="margin-top:10px;padding:10px;background:#0f172a;border-radius:6px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                            <span style="color:#f97316;font-weight:600;">Tickets: ${ticketCount}</span>
                            <span style="color:#ef4444;font-weight:600;">Total Fines: $${totalFines.toFixed(2)}</span>
                        </div>
                        ${ticketCount > 0 ? `
                            <div class="lookup-tickets-list" style="max-height:150px;overflow-y:auto;">
                                ${civTickets.map(t => `
                                    <div style="padding:8px;background:#1e293b;border-radius:4px;margin-bottom:6px;font-size:12px;">
                                        <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
                                            <span style="color:#f97316;font-weight:500;">${t.ticket_number}</span>
                                            <span style="color:#6b7280;">${new Date(t.issued_at).toLocaleDateString()}</span>
                                        </div>
                                        <div style="color:#9ca3af;"><strong>Type:</strong> ${t.ticket_type} | <strong>Fine:</strong> $${t.fine.toFixed(2)}</div>
                                        <div style="color:#9ca3af;"><strong>Location:</strong> ${t.location}</div>
                                        ${t.charges && t.charges.length > 0 ? `<div style="color:#9ca3af;margin-top:4px;"><strong>Charges:</strong> ${t.charges.join(', ')}</div>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<div style="color:#6b7280;font-size:12px;">No prior tickets</div>'}
                    </div>
                    <button class="btn-ticket" onclick="openTicketModal('${c.id}', '${c.first_name} ${c.last_name}')">Issue Ticket</button>
                </div>
            `}).join('');
        };

        lookupFirstName.onkeypress = e => { if (e.key === 'Enter') lookupSearchBtn.onclick(); };
        lookupLastName.onkeypress = e => { if (e.key === 'Enter') lookupSearchBtn.onclick(); };

        // Civilian Page
        const civilianBtn = document.getElementById('civilianBtn');
        const civilianPage = document.getElementById('civilianPage');
        const backFromCivilian = document.getElementById('backFromCivilian');
        const newCharacterBtn = document.getElementById('newCharacterBtn');
        const newCharacterModal = document.getElementById('newCharacterModal');
        const closeNewCharacter = document.getElementById('closeNewCharacter');
        const cancelNewCharacter = document.getElementById('cancelNewCharacter');
        const newCharacterForm = document.getElementById('newCharacterForm');
        const charactersGrid = document.getElementById('charactersGrid');
        const call911Btn = document.getElementById('call911Btn');
        const call911Modal = document.getElementById('call911Modal');
        const closeCall911 = document.getElementById('closeCall911');
        const cancelCall911 = document.getElementById('cancelCall911');
        const call911Form = document.getElementById('call911Form');

        let characters = [];

        civilianBtn.onclick = async () => {
            communityScreen.classList.remove('active');
            civilianPage.classList.add('active');
            await loadCharacters();
        };

        backFromCivilian.onclick = () => {
            civilianPage.classList.remove('active');
            communityScreen.classList.add('active');
        };

        async function loadCharacters() {
            if (!currentUser || !currentCommunityId) return;
            
            const { data, error } = await db
                .from('characters')
                .select('*')
                .eq('user_id', currentUser.id)
                .eq('community_id', currentCommunityId);
            
            if (error) {
                console.error('Error loading characters:', error);
                return;
            }
            
            characters = data || [];
            renderCharacters();
        }

        newCharacterBtn.onclick = () => newCharacterModal.classList.add('active');
        closeNewCharacter.onclick = () => { newCharacterModal.classList.remove('active'); newCharacterForm.reset(); };
        cancelNewCharacter.onclick = () => { newCharacterModal.classList.remove('active'); newCharacterForm.reset(); };
        newCharacterModal.onclick = e => { if (e.target === newCharacterModal) { newCharacterModal.classList.remove('active'); newCharacterForm.reset(); } };

        newCharacterForm.onsubmit = async e => {
            e.preventDefault();
            const firstName = document.getElementById('charFirstName').value.trim();
            const lastName = document.getElementById('charLastName').value.trim();
            const dob = document.getElementById('charDob').value;
            const gender = document.getElementById('charGender').value;
            const phone = document.getElementById('charPhone').value.trim() || null;

            console.log('Creating character:', { firstName, lastName, dob, gender, phone });
            console.log('User ID:', currentUser?.id);
            console.log('Community ID:', currentCommunityId);

            const insertData = {
                user_id: currentUser.id,
                first_name: firstName,
                last_name: lastName,
                date_of_birth: dob,
                gender: gender,
                phone: phone
            };

            if (currentCommunityId) {
                insertData.community_id = currentCommunityId;
            }

            const { data, error } = await db
                .from('characters')
                .insert([insertData])
                .select()
                .single();

            console.log('Insert result:', data);
            console.log('Insert error:', error);

            if (error) {
                alert('Error creating character: ' + error.message);
                return;
            }

            alert('Character created successfully!');
            characters.push(data);
            renderCharacters();
            sendCharacterWebhook(data);

            newCharacterModal.classList.remove('active');
            newCharacterForm.reset();
        };

        function renderCharacters() {
            if (characters.length === 0) {
                charactersGrid.innerHTML = '<div class="no-characters">No characters yet. Click "New Character" to create one.</div>';
                return;
            }

            charactersGrid.innerHTML = characters.map(c => `
                <div class="character-card" data-id="${c.id}">
                    <div class="name">${c.first_name} ${c.last_name}</div>
                    <div class="info">
                        <span><strong>DOB:</strong> ${c.date_of_birth}</span>
                        <span><strong>Gender:</strong> ${c.gender}</span>
                        <span><strong>Phone:</strong> ${c.phone || 'N/A'}</span>
                    </div>
                    <div class="actions">
                        <button class="btn-details" onclick="selectCharacter('${c.id}')">Select</button>
                        <button class="btn-delete" style="background:#ef4444;border:none;color:#fff;padding:6px 14px;border-radius:4px;font-size:11px;font-weight:500;cursor:pointer;" onclick="deleteCharacter('${c.id}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        window.selectCharacter = function(id) {
            const char = characters.find(c => c.id === id);
            if (char) alert(`Selected: ${char.first_name} ${char.last_name}`);
        };

        window.deleteCharacter = async function(id) {
            const { error } = await db
                .from('characters')
                .delete()
                .eq('id', id);
            
            if (error) {
                alert('Error deleting character: ' + error.message);
                return;
            }
            
            characters = characters.filter(c => c.id !== id);
            renderCharacters();
        };

        // 911 Call
        call911Btn.onclick = () => call911Modal.classList.add('active');
        closeCall911.onclick = () => { call911Modal.classList.remove('active'); call911Form.reset(); };
        cancelCall911.onclick = () => { call911Modal.classList.remove('active'); call911Form.reset(); };
        call911Modal.onclick = e => { if (e.target === call911Modal) { call911Modal.classList.remove('active'); call911Form.reset(); } };

        call911Form.onsubmit = e => {
            e.preventDefault();
            const location = document.getElementById('emergency911Location').value.trim();
            const desc = document.getElementById('emergency911Desc').value.trim();
            alert(`911 Call Placed!\nLocation: ${location}\nDescription: ${desc}`);
            call911Modal.classList.remove('active');
            call911Form.reset();
        };

        // Staff Dashboard
        const staffDashboardBtn = document.getElementById('staffDashboardBtn');
        const staffDashboard = document.getElementById('staffDashboard');
        const backFromStaff = document.getElementById('backFromStaff');

        staffDashboardBtn.onclick = async () => {
            dashboardSection.classList.add('hidden');
            staffDashboard.style.display = 'block';
            await loadStaffData();
            if (typeof loadStaffSupportTickets === 'function') {
                loadStaffSupportTickets();
            }
        };

        backFromStaff.onclick = () => {
            staffDashboard.style.display = 'none';
            dashboardSection.classList.remove('hidden');
        };

        // Admin Dropdown
        const adminDropdownBtn = document.getElementById('adminDropdownBtn');
        const adminDropdownMenu = document.getElementById('adminDropdownMenu');
        const discordSettingsBtn = document.getElementById('discordSettingsBtn');
        const discordSettingsModal = document.getElementById('discordSettingsModal');
        const closeDiscordSettings = document.getElementById('closeDiscordSettings');
        const charactersAdminBtn = document.getElementById('charactersAdminBtn');
                const addRosterBtn = document.getElementById('addRosterBtn');
                const rosterName = document.getElementById('rosterName');
                const rosterRole = document.getElementById('rosterRole');
                const rosterList = document.getElementById('rosterList');

                // Roster logic
                let rosterEntries = JSON.parse(localStorage.getItem('communityRoster') || '[]');

                function renderRoster() {
                    rosterList.innerHTML = '';
                    if (rosterEntries.length === 0) {
                        rosterList.innerHTML = '<div style="color:#a1a1aa;text-align:center;">No roster entries yet.</div>';
                        return;
                    }
                    rosterEntries.forEach((entry, idx) => {
                        const div = document.createElement('div');
                        div.style = 'padding:8px 0;border-bottom:1px solid #23232b;display:flex;justify-content:space-between;align-items:center;';
                        div.innerHTML = `<span><b>${entry.name}</b> - ${entry.role}</span><button style="background:#ef4444;color:#fff;border:none;border-radius:4px;padding:2px 8px;font-size:12px;cursor:pointer;" data-idx="${idx}">Remove</button>`;
                        div.querySelector('button').onclick = function() {
                            rosterEntries.splice(idx, 1);
                            localStorage.setItem('communityRoster', JSON.stringify(rosterEntries));
                            renderRoster();
                        };
                        rosterList.appendChild(div);
                    });
                }

                addRosterBtn.onclick = () => {
                    const name = rosterName.value.trim();
                    const role = rosterRole.value.trim();
                    if (!name || !role) return;
                    rosterEntries.push({ name, role });
                    localStorage.setItem('communityRoster', JSON.stringify(rosterEntries));
                    renderRoster();
                    rosterName.value = '';
                    rosterRole.value = '';
                };

                // Render roster on page load
                renderRoster();
        const discordSettingsTabBtn = document.getElementById('discordSettingsTabBtn');
        const charactersSettingsTabBtn = document.getElementById('charactersSettingsTabBtn');
        const discordSettingsPanel = document.getElementById('discordSettingsPanel');
        const charactersSettingsPanel = document.getElementById('charactersSettingsPanel');
        const adminCharactersGrid = document.getElementById('adminCharactersGrid');
        const accountsBtn = document.getElementById('accountsBtn');
        const accountsModal = document.getElementById('accountsModal');
        const closeAccountsModal = document.getElementById('closeAccountsModal');
        const permissionsKeyBtn = document.getElementById('permissionsKeyBtn');
        const permissionsKeyModal = document.getElementById('permissionsKeyModal');
        const closePermissionsKeyModal = document.getElementById('closePermissionsKeyModal');

        // Admin Dropdown Toggle
        adminDropdownBtn.onclick = (e) => {
            e.stopPropagation();
            adminDropdownMenu.classList.toggle('active');
        };

        document.addEventListener('click', () => {
            adminDropdownMenu.classList.remove('active');
        });

        // Discord Settings
        discordSettingsBtn.onclick = () => {
            adminDropdownMenu.classList.remove('active');
            discordSettingsModal.classList.add('active');
            discordSettingsTabBtn.classList.add('active');
            charactersSettingsTabBtn.classList.remove('active');
            discordSettingsPanel.style.display = '';
            charactersSettingsPanel.style.display = 'none';
        };
        closeDiscordSettings.onclick = () => discordSettingsModal.classList.remove('active');
        discordSettingsModal.onclick = e => { if (e.target === discordSettingsModal) discordSettingsModal.classList.remove('active'); };

        // Tab switching for Discord Settings modal
        discordSettingsTabBtn.onclick = () => {
            discordSettingsTabBtn.classList.add('active');
            charactersSettingsTabBtn.classList.remove('active');
            discordSettingsPanel.style.display = '';
            charactersSettingsPanel.style.display = 'none';
        };
        charactersSettingsTabBtn.onclick = async () => {
            discordSettingsTabBtn.classList.remove('active');
            charactersSettingsTabBtn.classList.add('active');
            discordSettingsPanel.style.display = 'none';
            charactersSettingsPanel.style.display = '';
            await loadAdminCharacters();
        };

        // Open Discord Settings modal directly to Characters tab
        charactersAdminBtn.onclick = async () => {
            adminDropdownMenu.classList.remove('active');
            discordSettingsModal.classList.add('active');
            discordSettingsTabBtn.classList.remove('active');
            charactersSettingsTabBtn.classList.add('active');
            discordSettingsPanel.style.display = 'none';
            charactersSettingsPanel.style.display = '';
            await loadAdminCharacters();
        };

        // Render all characters for admin
        async function loadAdminCharacters() {
            if (!currentCommunityId) return;
            const { data, error } = await db
                .from('characters')
                .select('*')
                .eq('community_id', currentCommunityId);
            if (error) {
                adminCharactersGrid.innerHTML = '<div class="no-characters">Error loading characters.</div>';
                return;
            }
            if (!data || data.length === 0) {
                adminCharactersGrid.innerHTML = '<div class="no-characters">No characters found in this community.</div>';
                return;
            }
            adminCharactersGrid.innerHTML = data.map(c => `
                <div class="character-card" data-id="${c.id}">
                    <div class="name">${c.first_name} ${c.last_name}</div>
                    <div class="info">
                        <span><strong>DOB:</strong> ${c.date_of_birth}</span>
                        <span><strong>Gender:</strong> ${c.gender}</span>
                        <span><strong>Phone:</strong> ${c.phone || 'N/A'}</span>
                        <span><strong>User ID:</strong> ${c.user_id}</span>
                    </div>
                </div>
            `).join('');
        }

        // Accounts Modal
        accountsBtn.onclick = (e) => {
            e.stopPropagation();
            adminDropdownMenu.classList.remove('active');
            accountsModal.classList.add('active');
        };
        closeAccountsModal.onclick = () => accountsModal.classList.remove('active');
        accountsModal.onclick = e => { if (e.target === accountsModal) accountsModal.classList.remove('active'); };

        // Permissions Key Modal
        permissionsKeyBtn.onclick = (e) => {
            e.stopPropagation();
            adminDropdownMenu.classList.remove('active');
            const key = localStorage.getItem('permissionsKey') || generatePermissionsKey();
            document.getElementById('permissionsKeyDisplay').value = key;
            permissionsKeyModal.classList.add('active');
        };
        closePermissionsKeyModal.onclick = () => permissionsKeyModal.classList.remove('active');
        permissionsKeyModal.onclick = e => { if (e.target === permissionsKeyModal) permissionsKeyModal.classList.remove('active'); };

        function generatePermissionsKey() {
            const key = 'PK-' + Math.random().toString(36).substr(2, 16).toUpperCase();
            localStorage.setItem('permissionsKey', key);
            return key;
        }

        document.getElementById('copyPermissionsKey').onclick = () => {
            const keyInput = document.getElementById('permissionsKeyDisplay');
            keyInput.select();
            document.execCommand('copy');
            alert('Permissions key copied!');
        };

        document.getElementById('generateNewKey').onclick = () => {
            if (confirm('Are you sure? This will invalidate the old key.')) {
                const newKey = generatePermissionsKey();
                document.getElementById('permissionsKeyDisplay').value = newKey;
                alert('New permissions key generated!');
            }
        };

        async function loadStaffData() {
            const { data: users } = await db.from('users').select('*');
            const { data: communities } = await db.from('communities').select('*');
            const { data: chars } = await db.from('characters').select('*');

            document.getElementById('totalUsers').textContent = users?.length || 0;
            document.getElementById('totalCommunities').textContent = communities?.length || 0;
            document.getElementById('totalCharacters').textContent = chars?.length || 0;

            // Load communities table
            const communitiesTable = document.getElementById('staffCommunitiesTable');
            if (!communities || communities.length === 0) {
                communitiesTable.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#6b7280;">No communities found</td></tr>';
            } else {
                communitiesTable.innerHTML = communities.map(c => {
                    const plan = c.plan || 'free';
                    const planColors = {
                        free: '#6b7280',
                        starter: '#3b82f6',
                        standard: '#a855f7',
                        advanced: '#f59e0b'
                    };
                    return `
                    <tr>
                        <td>${c.name}</td>
                        <td><span style="padding:4px 8px;background:#3b82f6;border-radius:4px;font-size:11px;color:#fff;">${c.code}</span></td>
                        <td style="font-size:11px;color:#6b7280;">${c.owner_id ? c.owner_id.substring(0, 8) + '...' : 'N/A'}</td>
                        <td>${c.website || 'N/A'}</td>
                        <td>
                            <select onchange="updateCommunityPlan('${c.id}', this.value)" style="padding:4px 8px;background:#1f2937;border:1px solid #374151;border-radius:4px;color:#fff;font-size:11px;cursor:pointer;">
                                <option value="free" ${plan === 'free' ? 'selected' : ''}>Free</option>
                                <option value="starter" ${plan === 'starter' ? 'selected' : ''}>Starter</option>
                                <option value="standard" ${plan === 'standard' ? 'selected' : ''}>Standard</option>
                                <option value="advanced" ${plan === 'advanced' ? 'selected' : ''}>Advanced</option>
                            </select>
                        </td>
                        <td><button onclick="deleteCommunity('${c.id}')" style="padding:4px 8px;background:#ef4444;border:none;border-radius:4px;color:#fff;font-size:10px;cursor:pointer;">Delete</button></td>
                    </tr>
                `}).join('');
            }

            // Load users table with staff access info
            const usersTable = document.getElementById('staffUsersTable');
            if (!users || users.length === 0) {
                usersTable.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#6b7280;">No users found</td></tr>';
                return;
            }

            // Get all staff access records
            const { data: staffAccessList } = await db.from('staff_access').select('user_id');
            const staffUserIds = (staffAccessList || []).map(s => s.user_id);

            usersTable.innerHTML = users.map(u => {
                const hasStaffAccess = staffUserIds.includes(u.id);
                const isHardcodedStaff = u.display_name.toLowerCase().includes('rya') || u.username.toLowerCase().includes('rya');
                return `
                <tr>
                    <td style="font-size:11px;color:#6b7280;">${u.id.substring(0, 8)}...</td>
                    <td>${u.username}</td>
                    <td>${u.display_name}${isHardcodedStaff ? ' <span style="color:#a855f7;font-size:10px;">(Owner)</span>' : hasStaffAccess ? ' <span style="color:#22c55e;font-size:10px;">(Staff)</span>' : ''}</td>
                    <td>${u.created_at ? new Date(u.created_at).toLocaleDateString() : 'N/A'}</td>
                    <td style="display:flex;gap:6px;">
                        ${!isHardcodedStaff ? (hasStaffAccess 
                            ? `<button onclick="revokeStaffAccess('${u.id}')" style="padding:4px 8px;background:#ef4444;border:none;border-radius:4px;color:#fff;font-size:10px;cursor:pointer;">Revoke Staff</button>`
                            : `<button onclick="grantStaffAccess('${u.id}')" style="padding:4px 8px;background:#22c55e;border:none;border-radius:4px;color:#fff;font-size:10px;cursor:pointer;">Make Staff</button>`) 
                        : ''}
                        <button onclick="deleteUser('${u.id}')" style="padding:4px 8px;background:#374151;border:none;border-radius:4px;color:#fff;font-size:10px;cursor:pointer;">Delete</button>
                    </td>
                </tr>
            `}).join('');

        }

        window.deleteUser = async function(id) {
            if (!confirm('Are you sure you want to delete this user?')) return;
            
            const { error } = await db.from('users').delete().eq('id', id);
            if (error) {
                alert('Error deleting user: ' + error.message);
                return;
            }
            loadStaffData();
        };

        window.deleteCommunity = async function(id) {
            if (!confirm('Are you sure you want to delete this community? This will also remove all members.')) return;
            
            // Delete community members first
            await db.from('community_members').delete().eq('community_id', id);
            
            const { error } = await db.from('communities').delete().eq('id', id);
            if (error) {
                alert('Error deleting community: ' + error.message);
                return;
            }
            loadStaffData();
        };

        window.updateCommunityPlan = async function(id, plan) {
            const { error } = await db
                .from('communities')
                .update({ plan: plan })
                .eq('id', id);
            
            if (error) {
                alert('Error updating plan: ' + error.message);
                loadStaffData();
                return;
            }
            
            const planNames = { free: 'Free', starter: 'Starter', standard: 'Standard', advanced: 'Advanced' };
            alert(`Community plan updated to ${planNames[plan]}`);
        };

        // Civilian Tabs
        document.querySelectorAll('.civilian-tab').forEach(tab => {
            tab.onclick = () => {
                document.querySelectorAll('.civilian-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                const tabId = tab.dataset.tab + 'Tab';
                document.getElementById(tabId).classList.add('active');
                if (tab.dataset.tab === 'tickets') {
                    loadMyTickets();
                }
            };
        });

        // Ticket System
        const ticketModal = document.getElementById('ticketModal');
        const closeTicket = document.getElementById('closeTicket');
        const cancelTicket = document.getElementById('cancelTicket');
        const ticketForm = document.getElementById('ticketForm');
        const addChargeBtn = document.getElementById('addChargeBtn');
        const chargesList = document.getElementById('chargesList');
        const signaturePad = document.getElementById('signaturePad');
        const clearSignature = document.getElementById('clearSignature');

        let signatureCtx = null;
        let isDrawing = false;

        function initSignaturePad() {
            signatureCtx = signaturePad.getContext('2d');
            signaturePad.width = signaturePad.offsetWidth;
            signaturePad.height = signaturePad.offsetHeight;
            signatureCtx.strokeStyle = '#3b82f6';
            signatureCtx.lineWidth = 2;
            signatureCtx.lineCap = 'round';

            signaturePad.onmousedown = (e) => {
                isDrawing = true;
                signatureCtx.beginPath();
                signatureCtx.moveTo(e.offsetX, e.offsetY);
            };

            signaturePad.onmousemove = (e) => {
                if (!isDrawing) return;
                signatureCtx.lineTo(e.offsetX, e.offsetY);
                signatureCtx.stroke();
            };

            signaturePad.onmouseup = () => isDrawing = false;
            signaturePad.onmouseleave = () => isDrawing = false;

            signaturePad.ontouchstart = (e) => {
                e.preventDefault();
                const rect = signaturePad.getBoundingClientRect();
                const touch = e.touches[0];
                isDrawing = true;
                signatureCtx.beginPath();
                signatureCtx.moveTo(touch.clientX - rect.left, touch.clientY - rect.top);
            };

            signaturePad.ontouchmove = (e) => {
                if (!isDrawing) return;
                e.preventDefault();
                const rect = signaturePad.getBoundingClientRect();
                const touch = e.touches[0];
                signatureCtx.lineTo(touch.clientX - rect.left, touch.clientY - rect.top);
                signatureCtx.stroke();
            };

            signaturePad.ontouchend = () => isDrawing = false;
        }

        clearSignature.onclick = () => {
            if (signatureCtx) {
                signatureCtx.clearRect(0, 0, signaturePad.width, signaturePad.height);
            }
        };

        window.openTicketModal = function(civilianId, civilianName) {
            document.getElementById('ticketCivilianId').value = civilianId;
            document.getElementById('ticketCivilianName').textContent = civilianName;
            ticketModal.classList.add('active');
            setTimeout(initSignaturePad, 100);
        };

        closeTicket.onclick = () => { ticketModal.classList.remove('active'); ticketForm.reset(); resetCharges(); };
        cancelTicket.onclick = () => { ticketModal.classList.remove('active'); ticketForm.reset(); resetCharges(); };
        ticketModal.onclick = e => { if (e.target === ticketModal) { ticketModal.classList.remove('active'); ticketForm.reset(); resetCharges(); } };

        function resetCharges() {
            chargesList.innerHTML = `
                <div class="charge-item">
                    <input type="text" class="charge-input" placeholder="Enter charge (e.g. 10+ MPH over limit)">
                    <button type="button" class="btn-remove-charge" onclick="this.parentElement.remove()"></button>
                </div>
            `;
        }

        addChargeBtn.onclick = () => {
            const chargeItem = document.createElement('div');
            chargeItem.className = 'charge-item';
            chargeItem.innerHTML = `
                <input type="text" class="charge-input" placeholder="Enter charge">
                <button type="button" class="btn-remove-charge" onclick="this.parentElement.remove()"></button>
            `;
            chargesList.appendChild(chargeItem);
        };

        ticketForm.onsubmit = async e => {
            e.preventDefault();
            
            const civilianId = document.getElementById('ticketCivilianId').value;
            const civilianName = document.getElementById('ticketCivilianName').textContent;
            const ticketType = document.getElementById('ticketType').value;
            const location = document.getElementById('ticketLocation').value.trim();
            const fine = document.getElementById('ticketFine').value;
            const notes = document.getElementById('ticketNotes').value.trim();
            
            const charges = [];
            document.querySelectorAll('.charge-input').forEach(input => {
                if (input.value.trim()) charges.push(input.value.trim());
            });

            const signatureData = signaturePad.toDataURL();
            const ticketNumber = 'TKT-' + Date.now().toString(36).toUpperCase();

            const ticketData = {
                ticket_number: ticketNumber,
                civilian_id: civilianId,
                civilian_name: civilianName,
                ticket_type: ticketType,
                location: location,
                fine: parseFloat(fine),
                charges: charges,
                notes: notes,
                officer_signature: signatureData,
                officer_callsign: mdtCallsign.textContent,
                issued_at: new Date().toISOString(),
                community_id: currentCommunityId
            };

            const { data, error } = await db
                .from('tickets')
                .insert([ticketData])
                .select()
                .single();

            if (error) {
                alert('Error issuing ticket: ' + error.message);
                console.error(error);
                return;
            }

            // Send Discord webhook for ticket creation
            sendTicketWebhook(data);

            alert(`Ticket ${ticketNumber} issued successfully to ${civilianName}!`);
            ticketModal.classList.remove('active');
            ticketForm.reset();
            resetCharges();
            if (signatureCtx) signatureCtx.clearRect(0, 0, signaturePad.width, signaturePad.height);
        };

        async function loadMyTickets() {
            if (!currentUser || !currentCommunityId) return;
            
            const { data: myChars } = await db
                .from('characters')
                .select('id')
                .eq('user_id', currentUser.id)
                .eq('community_id', currentCommunityId);
            
            if (!myChars || myChars.length === 0) {
                document.getElementById('ticketsList').innerHTML = '<div class="no-tickets">No tickets issued to your characters.</div>';
                return;
            }

            const charIds = myChars.map(c => c.id);
            
            const { data: tickets, error } = await db
                .from('tickets')
                .select('*')
                .in('civilian_id', charIds)
                .eq('community_id', currentCommunityId)
                .order('issued_at', { ascending: false });

            if (error) {
                console.error('Error loading tickets:', error);
                document.getElementById('ticketsList').innerHTML = '<div class="no-tickets">Error loading tickets.</div>';
                return;
            }

            if (!tickets || tickets.length === 0) {
                document.getElementById('ticketsList').innerHTML = '<div class="no-tickets">No tickets issued to your characters.</div>';
                return;
            }

            document.getElementById('ticketsList').innerHTML = tickets.map(t => `
                <div class="ticket-card">
                    <div class="ticket-header">
                        <span class="ticket-id">${t.ticket_number}</span>
                        <span class="ticket-date">${new Date(t.issued_at).toLocaleString()}</span>
                    </div>
                    <div class="ticket-info"><strong>Type:</strong> ${t.ticket_type}</div>
                    <div class="ticket-info"><strong>Issued To:</strong> ${t.civilian_name}</div>
                    <div class="ticket-info"><strong>Location:</strong> ${t.location}</div>
                    <div class="ticket-info"><strong>Fine:</strong> $${t.fine.toFixed(2)}</div>
                    ${t.notes ? `<div class="ticket-info"><strong>Notes:</strong> ${t.notes}</div>` : ''}
                    <div class="ticket-charges">
                        <h4>Charges</h4>
                        ${(t.charges || []).map(charge => `<div class="charge">${charge}</div>`).join('')}
                    </div>
                    <div class="ticket-signature">
                        <h4>Officer Signature (${t.officer_callsign})</h4>
                        <img src="${t.officer_signature}" alt="Officer Signature">
                    </div>
                </div>
            `).join('');
        }

        // BOLO System
        const createBoloBtn = document.getElementById('createBoloBtn');
        const createBoloModal = document.getElementById('createBoloModal');
        const closeCreateBolo = document.getElementById('closeCreateBolo');
        const cancelCreateBolo = document.getElementById('cancelCreateBolo');
        const createBoloForm = document.getElementById('createBoloForm');
        const bolosTableBody = document.getElementById('bolosTableBody');

        createBoloBtn.onclick = () => createBoloModal.classList.add('active');
        closeCreateBolo.onclick = () => { createBoloModal.classList.remove('active'); createBoloForm.reset(); };
        cancelCreateBolo.onclick = () => { createBoloModal.classList.remove('active'); createBoloForm.reset(); };
        createBoloModal.onclick = e => { if (e.target === createBoloModal) { createBoloModal.classList.remove('active'); createBoloForm.reset(); } };

        createBoloForm.onsubmit = async e => {
            e.preventDefault();
            const type = document.getElementById('boloType').value;
            const details = document.getElementById('boloDetails').value.trim();
            const issuedBy = mdtCallsign.textContent;

            const { data, error } = await db
                .from('bolos')
                .insert([{
                    type: type,
                    details: details,
                    issued_by: issuedBy,
                    created_at: new Date().toISOString()
                }])
                .select()
                .single();

            if (error) {
                alert('Error creating BOLO: ' + error.message);
                return;
            }

            createBoloModal.classList.remove('active');
            createBoloForm.reset();
            loadBolos();
        };

        async function loadBolos() {
            const { data: bolos, error } = await db
                .from('bolos')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error loading BOLOs:', error);
                bolosTableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#6b7280;">Error loading BOLOs</td></tr>';
                return;
            }

            if (!bolos || bolos.length === 0) {
                bolosTableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#6b7280;">No active BOLOs</td></tr>';
                return;
            }

            bolosTableBody.innerHTML = bolos.map(b => `
                <tr>
                    <td><span style="padding:4px 8px;background:${b.type === 'Person' ? '#3b82f6' : '#22c55e'};border-radius:4px;font-size:11px;color:#fff;">${b.type}</span></td>
                    <td>${b.details}</td>
                    <td>${new Date(b.created_at).toLocaleString()}</td>
                    <td>
                        ${b.issued_by}
                        <button onclick="deleteBolo('${b.id}')" style="margin-left:8px;padding:4px 8px;background:#ef4444;border:none;border-radius:4px;color:#fff;font-size:10px;cursor:pointer;">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        window.deleteBolo = async function(id) {
            const { error } = await db
                .from('bolos')
                .delete()
                .eq('id', id);

            if (error) {
                alert('Error deleting BOLO: ' + error.message);
                return;
            }
            loadBolos();
        };

        loadBolos();

        // Admin Page
                // Webhooks Modal logic
                const openWebhooksModal = document.getElementById('openWebhooksModal');
                const webhooksModal = document.getElementById('webhooksModal');
                const closeWebhooksModal = document.getElementById('closeWebhooksModal');

                openWebhooksModal.onclick = async () => {
                    // Load webhooks for current community from Supabase
                    if (!currentCommunityId) return;
                    const { data, error } = await db
                        .from('community_webhooks')
                        .select('*')
                        .eq('community_id', currentCommunityId)
                        .single();
                    if (data) {
                        document.getElementById('webhookCharacterCreated').value = data.character_created_webhook || '';
                        document.getElementById('webhookTicketCreated').value = data.ticket_created_webhook || '';
                    } else {
                        document.getElementById('webhookCharacterCreated').value = '';
                        document.getElementById('webhookTicketCreated').value = '';
                    }
                    webhooksModal.classList.add('active');
                };
                closeWebhooksModal.onclick = () => webhooksModal.classList.remove('active');
                webhooksModal.onclick = e => { if (e.target === webhooksModal) webhooksModal.classList.remove('active'); };

                document.getElementById('saveWebhookBtn').onclick = async () => {
                    if (!currentCommunityId) {
                        alert('Error: currentCommunityId is not set.');
                        return;
                    }
                    const characterWebhook = document.getElementById('webhookCharacterCreated').value.trim();
                    const ticketWebhook = document.getElementById('webhookTicketCreated').value.trim();
                    try {
                        const { data, error } = await db
                            .from('community_webhooks')
                            .upsert({
                                community_id: currentCommunityId,
                                character_created_webhook: characterWebhook,
                                ticket_created_webhook: ticketWebhook
                            }, { onConflict: ['community_id'] });
                        if (error) {
                            console.error('Supabase upsert error:', error);
                            alert('Error saving webhooks: ' + error.message);
                            webhooksModal.classList.remove('active');
                            return;
                        }
                        if (!data) {
                            console.error('Supabase upsert returned no data.');
                            alert('Error: No data returned from Supabase.');
                            webhooksModal.classList.remove('active');
                            return;
                        }
                        webhooksModal.classList.remove('active');
                        alert('Webhooks saved!');
                    } catch (e) {
                        console.error('Exception during Supabase upsert:', e);
                        alert('Exception saving webhooks: ' + e.message);
                        webhooksModal.classList.remove('active');
                    }
                };
        const adminBtn = document.getElementById('adminBtn');
                const rosterModal = document.getElementById('rosterModal');
                const closeRosterModal = document.getElementById('closeRosterModal');
                // The following variables are already declared above, so do not redeclare:
                // const addRosterBtn = document.getElementById('addRosterBtn');
                // const rosterName = document.getElementById('rosterName');
                // const rosterRole = document.getElementById('rosterRole');
                // const rosterList = document.getElementById('rosterList');

                // Roster Modal logic
                // let rosterEntries = JSON.parse(localStorage.getItem('communityRoster') || '[]');
                // function renderRoster() { ... } // Already declared above

                adminBtn.onclick = () => {
                    renderRoster();
                    rosterModal.classList.add('active');
                };
                closeRosterModal.onclick = () => rosterModal.classList.remove('active');
                rosterModal.onclick = e => { if (e.target === rosterModal) rosterModal.classList.remove('active'); };
                addRosterBtn.onclick = () => {
                    const name = rosterName.value.trim();
                    const role = rosterRole.value.trim();
                    if (!name || !role) return;
                    rosterEntries.push({ name, role });
                    localStorage.setItem('communityRoster', JSON.stringify(rosterEntries));
                    renderRoster();
                    rosterName.value = '';
                    rosterRole.value = '';
                };
        const adminPage = document.getElementById('adminPage');
        const backFromAdmin = document.getElementById('backFromAdmin');
        const openDiscordSettingsFromAdmin = document.getElementById('openDiscordSettingsFromAdmin');

        adminBtn.onclick = () => {
            communityScreen.classList.remove('active');
            adminPage.style.display = 'block';
            loadWebhooks();
        };

        backFromAdmin.onclick = () => {
            adminPage.style.display = 'none';
            communityScreen.classList.add('active');
        };
        // Discord Settings button and logic removed as requested

        // Departments System


        // Webhooks System
        const webhookCharacterCreated = document.getElementById('webhookCharacterCreated');
        const saveWebhookBtn = document.getElementById('saveWebhookBtn');
        const webhookStatus = document.getElementById('webhookStatus');

        async function loadWebhooks() {
            const { data, error } = await db
                .from('settings')
                .select('*')
                .eq('key', 'webhook_character_created')
                .single();

            if (data) {
                webhookCharacterCreated.value = data.value || '';
            }
        }

        saveWebhookBtn.onclick = async () => {
            const url = webhookCharacterCreated.value.trim();

            const { data: existing } = await db
                .from('settings')
                .select('*')
                .eq('key', 'webhook_character_created')
                .single();

            let error;
            if (existing) {
                const result = await db
                    .from('settings')
                    .update({ value: url })
                    .eq('key', 'webhook_character_created');
                error = result.error;
            } else {
                const result = await db
                    .from('settings')
                    .insert([{ key: 'webhook_character_created', value: url }]);
                error = result.error;
            }

            if (error) {
                webhookStatus.textContent = 'Error saving webhook: ' + error.message;
                webhookStatus.style.color = '#ef4444';
            } else {
                webhookStatus.textContent = 'Webhook saved!';
                webhookStatus.style.color = '#22c55e';
                setTimeout(() => { webhookStatus.textContent = ''; }, 3000);
            }
        };


        async function sendCharacterWebhook(character) {
            const { data } = await db
                .from('settings')
                .select('value')
                .eq('key', 'webhook_character_created')
                .single();

            if (!data || !data.value) return;

            try {
                await fetch(data.value, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        embeds: [{
                            title: 'New Character Created',
                            color: 3447003,
                            fields: [
                                { name: 'Name', value: `${character.first_name} ${character.last_name}`, inline: true },
                                { name: 'Gender', value: character.gender, inline: true },
                                { name: 'DOB', value: character.date_of_birth, inline: true },
                                { name: 'Phone', value: character.phone || 'N/A', inline: true }
                            ],
                            timestamp: new Date().toISOString()
                        }]
                    })
                });
            } catch (e) {
                console.error('Webhook error:', e);
            }
        }

        // Send Discord webhook for ticket creation
        async function sendTicketWebhook(ticket) {
            if (!ticket || !ticket.community_id) {
                console.log('sendTicketWebhook: No ticket or community_id', ticket);
                return;
            }
            // Get webhook for this community from community_webhooks table
            const { data, error } = await db
                .from('community_webhooks')
                .select('ticket_created_webhook')
                .eq('community_id', ticket.community_id)
                .single();
            if (error) {
                console.error('Error fetching ticket webhook:', error);
                return;
            }
            if (!data || !data.ticket_created_webhook) {
                console.log('sendTicketWebhook: No webhook URL configured');
                return;
            }
            console.log('Sending ticket webhook to:', data.ticket_created_webhook);
            try {
                const response = await fetch(data.ticket_created_webhook, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        embeds: [{
                            title: 'New Ticket Issued',
                            color: 16753920,
                            fields: [
                                { name: 'Ticket Number', value: ticket.ticket_number || 'N/A', inline: true },
                                { name: 'Civilian', value: ticket.civilian_name || 'N/A', inline: true },
                                { name: 'Type', value: ticket.ticket_type || 'N/A', inline: true },
                                { name: 'Location', value: ticket.location || 'N/A', inline: true },
                                { name: 'Fine', value: `$${(ticket.fine || 0).toFixed(2)}`, inline: true },
                                { name: 'Charges', value: (ticket.charges && ticket.charges.length > 0 ? ticket.charges.join(', ') : 'None'), inline: false },
                                { name: 'Notes', value: ticket.notes || 'None', inline: false },
                                { name: 'Officer', value: ticket.officer_callsign || 'N/A', inline: true }
                            ],
                            timestamp: ticket.issued_at
                        }]
                    })
                });
                console.log('Ticket webhook response:', response.status);
            } catch (e) {
                console.error('Ticket webhook error:', e);
            }
        }

        loadWebhooks();

        // =====================
        // SUPPORT TICKET SYSTEM
        // =====================
        const supportBtn = document.getElementById('supportBtn');
        const supportTicketPage = document.getElementById('supportTicketPage');
        const backFromSupport = document.getElementById('backFromSupport');
        const supportTicketForm = document.getElementById('supportTicketForm');
        const ticketFormCard = document.getElementById('ticketFormCard');
        const ticketChatContainer = document.getElementById('ticketChatContainer');
        const ticketChatMessages = document.getElementById('ticketChatMessages');
        const ticketMessageInput = document.getElementById('ticketMessageInput');
        const sendTicketMessage = document.getElementById('sendTicketMessage');
        const myTicketsList = document.getElementById('myTicketsList');
        const myTicketsContainer = document.getElementById('myTicketsContainer');
        const activeTicketId = document.getElementById('activeTicketId');
        const activeTicketSubject = document.getElementById('activeTicketSubject');
        const activeTicketStatus = document.getElementById('activeTicketStatus');
        const ticketChatInputArea = document.getElementById('ticketChatInputArea');
        
        const staffChatModal = document.getElementById('staffChatModal');
        const closeStaffChat = document.getElementById('closeStaffChat');
        const staffChatMessages = document.getElementById('staffChatMessages');
        const staffMessageInput = document.getElementById('staffMessageInput');
        const sendStaffMessage = document.getElementById('sendStaffMessage');
        const staffActiveTicketId = document.getElementById('staffActiveTicketId');
        const staffActiveTicketInfo = document.getElementById('staffActiveTicketInfo');
        const staffSupportTickets = document.getElementById('staffSupportTickets');

        let currentSupportTicketId = null;
        let currentStaffTicketId = null;

        supportBtn.onclick = () => {
            heroSection.style.display = 'none';
            pricingSection.classList.remove('active');
            teamSection.classList.remove('active');
            supportTicketPage.classList.add('active');
            loadMyTickets();
        };

        backFromSupport.onclick = () => {
            supportTicketPage.classList.remove('active');
            ticketChatContainer.classList.remove('active');
            ticketFormCard.style.display = 'block';
            currentSupportTicketId = null;
            heroSection.style.display = 'flex';
        };

        function generateTicketNumber() {
            return 'TKT-' + Math.random().toString(36).substr(2, 8).toUpperCase();
        }

        supportTicketForm.onsubmit = async (e) => {
            e.preventDefault();
            const email = document.getElementById('supportEmail').value.trim();
            const username = document.getElementById('supportUsername').value.trim();
            const reason = document.getElementById('supportReason').value.trim();
            const ticketNumber = generateTicketNumber();

            const { data: ticket, error } = await db
                .from('support_tickets')
                .insert([{
                    ticket_number: ticketNumber,
                    email: email,
                    username: username,
                    reason: reason,
                    status: 'open',
                    user_id: currentUser ? currentUser.id : null
                }])
                .select()
                .single();

            if (error) {
                alert('Error creating ticket: ' + error.message);
                return;
            }

            const { error: msgError } = await db
                .from('support_messages')
                .insert([{
                    ticket_id: ticket.id,
                    sender_type: 'user',
                    sender_name: username,
                    message: reason
                }]);

            if (msgError) {
                console.error('Error adding initial message:', msgError);
            }

            supportTicketForm.reset();
            currentSupportTicketId = ticket.id;
            openTicketChat(ticket);
            loadMyTickets();
        };

        function openTicketChat(ticket) {
            ticketFormCard.style.display = 'none';
            ticketChatContainer.classList.add('active');
            currentSupportTicketId = ticket.id;
            
            activeTicketId.textContent = ticket.ticket_number;
            activeTicketSubject.textContent = ticket.reason.substring(0, 50) + (ticket.reason.length > 50 ? '...' : '');
            
            activeTicketStatus.textContent = ticket.status.charAt(0).toUpperCase() + ticket.status.slice(1);
            activeTicketStatus.className = 'ticket-status ' + ticket.status;
            
            if (ticket.status === 'closed') {
                ticketChatInputArea.style.display = 'none';
            } else {
                ticketChatInputArea.style.display = 'flex';
            }
            
            loadTicketMessages(ticket.id, false);
        }

        async function loadTicketMessages(ticketId, isStaff = false) {
            const container = isStaff ? staffChatMessages : ticketChatMessages;
            
            const { data: messages, error } = await db
                .from('support_messages')
                .select('*')
                .eq('ticket_id', ticketId)
                .order('created_at', { ascending: true });

            if (error) {
                console.error('Error loading messages:', error);
                container.innerHTML = '<div style="text-align:center;color:#ef4444;padding:20px;">Error loading messages</div>';
                return;
            }

            if (!messages || messages.length === 0) {
                container.innerHTML = '<div style="text-align:center;color:#6b7280;padding:20px;">No messages yet</div>';
                return;
            }

            container.innerHTML = messages.map(m => `
                <div class="ticket-message ${m.sender_type}">
                    <div class="sender">${m.sender_name}${m.sender_type === 'staff' ? ' (Staff)' : ''}</div>
                    <div>${m.message}</div>
                    <div class="time">${new Date(m.created_at).toLocaleString()}</div>
                </div>
            `).join('');

            container.scrollTop = container.scrollHeight;
        }

        sendTicketMessage.onclick = async () => {
            const message = ticketMessageInput.value.trim();
            if (!message || !currentSupportTicketId) return;

            const senderName = currentUser ? currentUser.display_name : 'User';

            const { error } = await db
                .from('support_messages')
                .insert([{
                    ticket_id: currentSupportTicketId,
                    sender_type: 'user',
                    sender_name: senderName,
                    message: message
                }]);

            if (error) {
                alert('Error sending message: ' + error.message);
                return;
            }

            ticketMessageInput.value = '';
            loadTicketMessages(currentSupportTicketId, false);
        };

        ticketMessageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendTicketMessage.onclick();
        });

        async function loadMyTickets() {
            if (!currentUser) {
                myTicketsContainer.innerHTML = '<div class="no-support-tickets">Login to see your tickets.</div>';
                return;
            }

            const { data: tickets, error } = await db
                .from('support_tickets')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error loading tickets:', error);
                myTicketsContainer.innerHTML = '<div class="no-support-tickets">Error loading tickets.</div>';
                return;
            }

            if (!tickets || tickets.length === 0) {
                myTicketsContainer.innerHTML = '<div class="no-support-tickets">No support tickets yet.</div>';
                return;
            }

            myTicketsContainer.innerHTML = tickets.map(t => `
                <div class="my-ticket-item" onclick="openExistingTicket('${t.id}')">
                    <div class="my-ticket-info">
                        <h4>${t.ticket_number}</h4>
                        <p>${t.reason.substring(0, 60)}${t.reason.length > 60 ? '...' : ''}</p>
                    </div>
                    <span class="ticket-status ${t.status}">${t.status.charAt(0).toUpperCase() + t.status.slice(1)}</span>
                </div>
            `).join('');
        }

        window.openExistingTicket = async function(ticketId) {
            const { data: ticket, error } = await db
                .from('support_tickets')
                .select('*')
                .eq('id', ticketId)
                .single();

            if (error || !ticket) {
                alert('Error loading ticket');
                return;
            }

            openTicketChat(ticket);
        };

        // Staff Ticket Functions
        async function loadStaffSupportTickets() {
            const ticketsContainer = document.getElementById('staffSupportTickets');
            if (!ticketsContainer) return;
            
            const { data: tickets, error } = await db
                .from('support_tickets')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error loading support tickets:', error);
                ticketsContainer.innerHTML = '<div class="no-support-tickets">Error loading tickets.</div>';
                return;
            }

            if (!tickets || tickets.length === 0) {
                ticketsContainer.innerHTML = '<div class="no-support-tickets">No support tickets.</div>';
                return;
            }

            ticketsContainer.innerHTML = tickets.map(t => `
                <div class="staff-ticket-card">
                    <div class="ticket-header">
                        <div class="ticket-info">
                            <h4>${t.ticket_number}</h4>
                            <p>From: ${t.username} (${t.email})</p>
                            <p>Created: ${new Date(t.created_at).toLocaleString()}</p>
                            ${t.claimed_by ? `<p style="color:#3b82f6;">Claimed by: ${t.claimed_by}</p>` : ''}
                        </div>
                        <span class="ticket-status ${t.status}">${t.status.charAt(0).toUpperCase() + t.status.slice(1)}</span>
                    </div>
                    <div class="ticket-reason">${t.reason}</div>
                    <div class="ticket-actions">
                        ${t.status === 'open' ? `<button class="btn-claim" onclick="claimTicket('${t.id}')">Claim</button>` : ''}
                        ${t.status !== 'closed' ? `<button class="btn-close-ticket" onclick="closeTicket('${t.id}')">Close</button>` : ''}
                        <!-- Respond/View Chat button removed -->
                    </div>
                </div>
            `).join('');
        }

        window.claimTicket = async function(ticketId) {
            const claimedBy = currentUser ? currentUser.display_name : 'Staff';
            
            const { error } = await db
                .from('support_tickets')
                .update({ status: 'claimed', claimed_by: claimedBy })
                .eq('id', ticketId);

            if (error) {
                alert('Error claiming ticket: ' + error.message);
                return;
            }

            loadStaffSupportTickets();
        };

        window.closeTicket = async function(ticketId) {
            if (!confirm('Are you sure you want to close this ticket?')) return;

            const { error } = await db
                .from('support_tickets')
                .update({ status: 'closed' })
                .eq('id', ticketId);

            if (error) {
                alert('Error closing ticket: ' + error.message);
                return;
            }

            loadStaffSupportTickets();
        };

        window.openStaffChat = async function(ticketId) {
            const { data: ticket, error } = await db
                .from('support_tickets')
                .select('*')
                .eq('id', ticketId)
                .single();

            if (error || !ticket) {
                alert('Error loading ticket');
                return;
            }

            currentStaffTicketId = ticketId;
            staffActiveTicketId.textContent = ticket.ticket_number;
            staffActiveTicketInfo.textContent = `${ticket.username} - ${ticket.email}`;
            
            staffChatModal.classList.add('active');
            loadTicketMessages(ticketId, true);

            if (ticket.status === 'closed') {
                document.querySelector('#staffChatModal .ticket-chat-input').style.display = 'none';
            } else {
                document.querySelector('#staffChatModal .ticket-chat-input').style.display = 'flex';
            }
        };

        closeStaffChat.onclick = () => {
            staffChatModal.classList.remove('active');
            currentStaffTicketId = null;
        };

        staffChatModal.onclick = (e) => {
            if (e.target === staffChatModal) {
                staffChatModal.classList.remove('active');
                currentStaffTicketId = null;
            }
        };

        sendStaffMessage.onclick = async () => {
            const message = staffMessageInput.value.trim();
            if (!message || !currentStaffTicketId) return;

            const senderName = currentUser ? currentUser.display_name : 'Staff';

            const { error } = await db
                .from('support_messages')
                .insert([{
                    ticket_id: currentStaffTicketId,
                    sender_type: 'staff',
                    sender_name: senderName,
                    message: message
                }]);

            if (error) {
                alert('Error sending message: ' + error.message);
                return;
            }

            staffMessageInput.value = '';
            loadTicketMessages(currentStaffTicketId, true);
        };

        staffMessageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendStaffMessage.onclick();
        });

        // Override staff dashboard load to include tickets
        const originalLoadStaffDashboard = window.loadStaffDashboard || function(){};
        window.loadStaffDashboard = function() {
            originalLoadStaffDashboard();
            loadStaffSupportTickets();
        };

        // Load staff tickets when entering staff dashboard
        const backFromStaffOriginal = document.getElementById('backFromStaff').onclick;
        document.getElementById('backFromStaff').onclick = function() {
            if (backFromStaffOriginal) backFromStaffOriginal();
            staffDashboard.style.display = 'none';
            dashboardSection.classList.remove('hidden');
        };

        // =====================
        // STAFF ACCESS MANAGEMENT
        // =====================
        window.grantStaffAccess = async function(userId) {
            const { error } = await db
                .from('staff_access')
                .insert([{ user_id: userId }]);

            if (error) {
                alert('Error granting access: ' + error.message);
                return;
            }

            loadStaffData();
        };

        window.revokeStaffAccess = async function(userId) {
            if (!confirm('Are you sure you want to revoke staff access?')) return;

            const { error } = await db
                .from('staff_access')
                .delete()
                .eq('user_id', userId);

            if (error) {
                alert('Error revoking access: ' + error.message);
                return;
            }

            loadStaffData();
        };

        // Snow Effect
        function createSnowflakes() {
            const snowflakesContainer = document.getElementById('snowflakes');
            if (!snowflakesContainer) return;
            const snowflakeChars = ['', '', '', ''];
            
            for (let i = 0; i < 150; i++) {
                const snowflake = document.createElement('div');
                snowflake.className = 'snowflake';
                snowflake.innerHTML = snowflakeChars[Math.floor(Math.random() * snowflakeChars.length)];
                snowflake.style.left = Math.random() * 100 + '%';
                snowflake.style.fontSize = (Math.random() * 10 + 8) + 'px';
                snowflake.style.opacity = Math.random() * 0.6 + 0.4;
                snowflake.style.animationDuration = (Math.random() * 5 + 5) + 's';
                snowflake.style.animationDelay = (Math.random() * 10) + 's';
                snowflakesContainer.appendChild(snowflake);
            }
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', createSnowflakes);
        } else {
            createSnowflakes();
        }
    </script>
</body>
</html>